# 用户管理功能测试文档

## 文档信息
- **模块名称**: 用户管理
- **页面路径**: /users.html
- **API路由**: /api/users
- **测试目的**: 验证用户创建、编辑、删除、状态管理等功能的数据库操作正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

用户管理模块负责系统用户的全生命周期管理，包括用户的创建、信息维护、角色分配、状态控制和密码管理。

### 核心功能
1. 用户信息管理（CRUD）
2. 用户角色分配（多对多关系）
3. 用户状态控制（启用/停用/锁定）
4. 密码管理（创建、重置、修改）
5. 用户统计分析

---

## 二、数据库表结构

### 2.1 主表：users

```sql
CREATE TABLE `users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '登录用户名',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希值',
  `real_name` varchar(50) NOT NULL COMMENT '真实姓名',
  `org_id` bigint unsigned NOT NULL COMMENT '所属组织ID',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `gender` enum('male','female','other') DEFAULT NULL COMMENT '性别',
  `avatar_url` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `position` varchar(50) DEFAULT NULL COMMENT '职位',
  `status` enum('active','inactive','locked') NOT NULL DEFAULT 'active' COMMENT '状态',
  `last_login_at` timestamp NULL DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `login_count` int unsigned NOT NULL DEFAULT '0' COMMENT '登录次数',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` bigint unsigned DEFAULT NULL COMMENT '创建人ID',
  `updated_by` bigint unsigned DEFAULT NULL COMMENT '更新人ID',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '软删除标记',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_org_id` (`org_id`),
  KEY `idx_phone` (`phone`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| username | varchar(50) | 是 | 登录账号 | 唯一，不可修改 |
| password_hash | varchar(255) | 是 | 密码哈希 | bcrypt加密，默认123456 |
| real_name | varchar(50) | 是 | 真实姓名 | 用于显示 |
| org_id | bigint | 是 | 组织ID | 外键关联organizations表 |
| phone | varchar(20) | 否 | 手机号 | 支持索引查询 |
| email | varchar(100) | 否 | 邮箱 | - |
| gender | enum | 否 | 性别 | male/female/other |
| position | varchar(50) | 否 | 职位 | 如：美容顾问 |
| status | enum | 是 | 状态 | active/inactive/locked |
| last_login_at | timestamp | 否 | 最后登录时间 | 登录时自动更新 |
| login_count | int | 是 | 登录次数 | 默认0 |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

### 2.2 关联表：user_roles

```sql
CREATE TABLE `user_roles` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `role_id` bigint unsigned NOT NULL COMMENT '角色ID',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `created_by` bigint unsigned DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_role` (`user_id`,`role_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| user_id | bigint | 是 | 用户ID | 外键，级联删除 |
| role_id | bigint | 是 | 角色ID | 外键 |
| created_by | bigint | 否 | 创建人 | 操作审计 |

**唯一约束**: `(user_id, role_id)` - 同一用户不能重复分配同一角色

---

## 三、业务流程

### 3.1 创建用户流程

```
开始
  ↓
前端：填写用户信息 + 选择角色
  ↓
API: POST /api/users
  ↓
验证：用户名唯一性
  ↓
生成：密码哈希（bcrypt）
  ↓
插入：users 表
  ↓
获取：新用户ID
  ↓
API: POST /api/roles/assign-user
  ↓
批量插入：user_roles 表
  ↓
返回：成功
  ↓
结束
```

### 3.2 编辑用户流程

```
开始
  ↓
前端：加载用户信息 + 当前角色
  ↓
API: GET /api/users/:id
API: GET /api/roles/user/:userId
  ↓
前端：修改信息 + 重新选择角色
  ↓
API: PUT /api/users/:id
  ↓
更新：users 表
  ↓
API: POST /api/roles/assign-user
  ↓
删除：旧的 user_roles 记录
插入：新的 user_roles 记录
  ↓
返回：成功
  ↓
结束
```

### 3.3 删除用户流程

```
开始
  ↓
API: DELETE /api/users/:id
  ↓
软删除：UPDATE users SET is_deleted=1
  ↓
保留：user_roles 记录（用于审计）
  ↓
返回：成功
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建用户测试

#### 测试场景1：创建单角色用户

**前置条件**:
- 已登录系统
- 有创建用户权限
- 存在可用角色

**操作步骤**:
1. 访问 http://8.210.246.101:5002/users.html
2. 点击"新建用户"按钮
3. 填写信息：
   - 用户名：`test_user_001`
   - 真实姓名：`测试用户001`
   - 手机号：`13900000001`
   - 邮箱：`test001@example.com`
   - 职位：`测试专员`
   - 性别：`female`
4. 选择角色：勾选"美容顾问"
5. 状态：`活跃`
6. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证用户创建
SELECT
    id, username, real_name, phone, email,
    position, gender, status, org_id, is_deleted
FROM users
WHERE username = 'test_user_001';

-- 预期结果：
-- id: (新ID)
-- username: test_user_001
-- real_name: 测试用户001
-- phone: 13900000001
-- email: test001@example.com
-- position: 测试专员
-- gender: female
-- status: active
-- org_id: (当前组织ID)
-- is_deleted: 0

-- 2. 验证密码哈希
SELECT
    username,
    password_hash,
    LENGTH(password_hash) as hash_length
FROM users
WHERE username = 'test_user_001';

-- 预期结果：
-- password_hash: $2b$10$... (bcrypt格式，60字符)
-- hash_length: 60

-- 3. 验证角色分配
SELECT
    ur.id, ur.user_id, ur.role_id,
    u.username, r.role_name
FROM user_roles ur
JOIN users u ON ur.user_id = u.id
JOIN roles r ON ur.role_id = r.id
WHERE u.username = 'test_user_001';

-- 预期结果：
-- role_name: 美容顾问
```

**预期结果**:
- ✅ users表新增1条记录
- ✅ user_roles表新增1条记录
- ✅ password_hash为bcrypt格式（$2b$10$开头，60字符）
- ✅ status默认为'active'
- ✅ is_deleted默认为0
- ✅ created_at自动设置为当前时间

#### 测试场景2：创建多角色用户

**操作步骤**:
1. 创建用户：`test_user_002`
2. 选择多个角色：勾选"美容顾问"、"销售专员"、"数据分析师"
3. 保存

**数据库验证SQL**:

```sql
-- 验证多角色分配
SELECT
    u.username,
    u.real_name,
    GROUP_CONCAT(r.role_name ORDER BY r.role_name) as roles,
    COUNT(ur.role_id) as role_count
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.username = 'test_user_002'
GROUP BY u.id;

-- 预期结果：
-- roles: 数据分析师,美容顾问,销售专员
-- role_count: 3
```

**预期结果**:
- ✅ users表新增1条记录
- ✅ user_roles表新增3条记录
- ✅ 每个角色关联记录的user_id相同

#### 测试场景3：用户名重复校验

**操作步骤**:
1. 创建用户：`test_user_001`（与已存在用户重复）
2. 保存

**数据库验证SQL**:

```sql
-- 验证用户名唯一性约束
SELECT COUNT(*) as count
FROM users
WHERE username = 'test_user_001' AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"用户名已存在"
- ✅ 数据库无新增记录

### 4.2 编辑用户测试

#### 测试场景4：修改用户基本信息

**前置条件**: 用户test_user_001已存在

**操作步骤**:
1. 点击test_user_001的"编辑"按钮
2. 修改：
   - 真实姓名：`测试用户001-已修改`
   - 职位：`高级测试专员`
   - 邮箱：`test001_new@example.com`
3. 保存

**数据库验证SQL**:

```sql
-- 验证信息更新
SELECT
    username, real_name, position, email,
    updated_at
FROM users
WHERE username = 'test_user_001';

-- 预期结果：
-- real_name: 测试用户001-已修改
-- position: 高级测试专员
-- email: test001_new@example.com
-- updated_at: (更新为当前时间)
```

**预期结果**:
- ✅ 对应字段已更新
- ✅ updated_at自动更新
- ✅ username未改变（编辑时不可修改）

#### 测试场景5：修改用户角色

**前置条件**: test_user_002有3个角色

**操作步骤**:
1. 编辑test_user_002
2. 取消勾选"销售专员"
3. 新增勾选"门店经理"
4. 保存

**数据库验证SQL**:

```sql
-- 验证角色变更前
SELECT r.role_name
FROM user_roles ur
JOIN roles r ON ur.role_id = r.id
JOIN users u ON ur.user_id = u.id
WHERE u.username = 'test_user_002'
ORDER BY r.role_name;

-- 操作前结果：数据分析师, 美容顾问, 销售专员

-- 验证角色变更后
-- 执行更新操作后再次查询

-- 预期结果：数据分析师, 美容顾问, 门店经理
```

**预期结果**:
- ✅ 旧的user_roles记录被删除
- ✅ 新的user_roles记录被插入
- ✅ 最终角色数量正确（3个）

### 4.3 状态管理测试

#### 测试场景6：停用用户

**操作步骤**:
1. 点击test_user_001的停用按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT username, status, updated_at
FROM users
WHERE username = 'test_user_001';

-- 预期结果：
-- status: inactive
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status从'active'变为'inactive'
- ✅ updated_at自动更新

#### 测试场景7：启用用户

**操作步骤**:
1. 点击test_user_001的启用按钮
2. 确认操作

**数据库验证SQL**:

```sql
SELECT username, status
FROM users
WHERE username = 'test_user_001';

-- 预期结果：
-- status: active
```

**预期结果**:
- ✅ status从'inactive'变为'active'

### 4.4 密码管理测试

#### 测试场景8：重置密码

**操作步骤**:
1. 点击test_user_001的重置密码按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 记录重置前的密码哈希
SELECT username, password_hash as old_hash
FROM users
WHERE username = 'test_user_001';

-- 执行重置操作

-- 验证重置后的密码哈希
SELECT
    username,
    password_hash as new_hash,
    updated_at
FROM users
WHERE username = 'test_user_001';

-- 使用bcrypt验证默认密码
-- Node.js测试代码：
-- bcrypt.compare('123456', new_hash) 应返回 true
```

**预期结果**:
- ✅ password_hash已改变
- ✅ 新密码哈希对应'123456'
- ✅ updated_at已更新

### 4.5 删除用户测试

#### 测试场景9：软删除用户

**操作步骤**:
1. 点击test_user_001的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    username, status, is_deleted, updated_at
FROM users
WHERE username = 'test_user_001';

-- 预期结果：
-- is_deleted: 1
-- 其他字段保持不变

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM users
WHERE username = 'test_user_001' AND is_deleted = 0;

-- 预期结果：
-- count: 0

-- 验证角色关联保留
SELECT COUNT(*) as role_count
FROM user_roles ur
JOIN users u ON ur.user_id = u.id
WHERE u.username = 'test_user_001';

-- 预期结果：
-- role_count > 0 (角色关联保留，用于审计)
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ user_roles关联记录保留
- ✅ 列表查询中不再显示

---

## 五、统计功能测试

### 测试场景10：用户统计

**API**: `GET /api/users/stats?org_id=7`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(CASE WHEN status = 'locked' THEN 1 ELSE 0 END) as locked_count
FROM users
WHERE org_id = 7 AND is_deleted = 0;

-- 对比API返回结果
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试用户名最大长度（50字符）
INSERT INTO users (username, password_hash, real_name, org_id)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '$2b$10$test',
    '测试',
    7
);

-- 预期：成功

-- 测试超长用户名（51字符）
-- 预期：失败，超出长度限制
```

### 6.2 必填字段测试

```sql
-- 测试缺少必填字段
INSERT INTO users (username, password_hash) -- 缺少real_name和org_id
VALUES ('test', '$2b$10$test');

-- 预期：失败，NOT NULL约束
```

### 6.3 枚举值测试

```sql
-- 测试非法状态值
UPDATE users
SET status = 'invalid_status'
WHERE id = 1;

-- 预期：失败，枚举值约束
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试username唯一索引
EXPLAIN SELECT * FROM users WHERE username = 'test_user_001';
-- 预期：type=const, key=uk_username

-- 测试org_id索引
EXPLAIN SELECT * FROM users WHERE org_id = 7;
-- 预期：type=ref, key=idx_org_id

-- 测试phone索引
EXPLAIN SELECT * FROM users WHERE phone = '13900000001';
-- 预期：type=ref, key=idx_phone

-- 测试多表关联查询
EXPLAIN
SELECT u.*, GROUP_CONCAT(r.role_name) as roles
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.org_id = 7 AND u.is_deleted = 0
GROUP BY u.id;
-- 验证索引使用情况
```

---

## 八、数据完整性检查

### 8.1 孤儿记录检查

```sql
-- 检查user_roles中是否有孤儿记录（用户已删除但关联未删除）
SELECT ur.id, ur.user_id, ur.role_id
FROM user_roles ur
LEFT JOIN users u ON ur.user_id = u.id
WHERE u.id IS NULL;

-- 预期结果：0条记录

-- 检查无效的org_id
SELECT id, username, org_id
FROM users
WHERE org_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0)
AND is_deleted = 0;

-- 预期结果：0条记录
```

### 8.2 数据一致性检查

```sql
-- 检查用户角色关联的完整性
SELECT
    u.id as user_id,
    u.username,
    COUNT(ur.id) as role_count
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
WHERE u.is_deleted = 0
GROUP BY u.id
HAVING role_count = 0;

-- 预期：活跃用户应该至少有一个角色
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 1. 删除测试用户的角色关联
DELETE FROM user_roles
WHERE user_id IN (
    SELECT id FROM users
    WHERE username LIKE 'test_user_%'
);

-- 2. 删除测试用户
DELETE FROM users
WHERE username LIKE 'test_user_%';

-- 3. 验证清理结果
SELECT COUNT(*) as remaining_test_users
FROM users
WHERE username LIKE 'test_user_%';

-- 预期结果：0
```

---

## 十、常见问题排查

### 问题1：创建用户失败

**排查SQL**:
```sql
-- 检查用户名是否已存在
SELECT id, username, is_deleted
FROM users
WHERE username = 'xxx';

-- 检查org_id是否有效
SELECT id, org_name
FROM organizations
WHERE id = xxx AND is_deleted = 0;
```

### 问题2：角色分配失败

**排查SQL**:
```sql
-- 检查角色是否存在
SELECT id, role_name, status
FROM roles
WHERE id IN (1,2,3);

-- 检查是否已有重复关联
SELECT * FROM user_roles
WHERE user_id = xxx AND role_id = xxx;
```

### 问题3：密码登录失败

**排查SQL**:
```sql
-- 检查用户状态
SELECT username, status, is_deleted
FROM users
WHERE username = 'xxx';

-- 检查密码哈希格式
SELECT
    username,
    password_hash,
    LEFT(password_hash, 7) as hash_prefix,
    LENGTH(password_hash) as hash_length
FROM users
WHERE username = 'xxx';

-- 预期：
-- hash_prefix: $2b$10$
-- hash_length: 60
```

---

## 十一、测试检查清单

### 功能测试
- [ ] 创建单角色用户
- [ ] 创建多角色用户
- [ ] 用户名重复校验
- [ ] 编辑用户基本信息
- [ ] 编辑用户角色
- [ ] 停用用户
- [ ] 启用用户
- [ ] 重置密码
- [ ] 软删除用户
- [ ] 用户统计准确性

### 数据库测试
- [ ] users表记录正确插入
- [ ] user_roles表记录正确插入
- [ ] 唯一约束生效
- [ ] 外键约束生效
- [ ] 索引使用正确
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新
- [ ] 密码哈希格式正确

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验
- [ ] 特殊字符处理

### 性能测试
- [ ] 索引效率
- [ ] 查询性能
- [ ] 批量操作性能

---

## 附录A：快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试用户
INSERT INTO users (username, password_hash, real_name, org_id, phone, position, status)
VALUES ('test_auto_001', '$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhqG', '自动测试用户', 7, '13999999999', '测试员', 'active');

SET @test_user_id = LAST_INSERT_ID();

-- 2. 分配角色
INSERT INTO user_roles (user_id, role_id, created_by)
VALUES (@test_user_id, 3, 1), (@test_user_id, 4, 1);

-- 3. 验证创建
SELECT
    u.id, u.username, u.real_name,
    GROUP_CONCAT(r.role_name) as roles
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.id = @test_user_id
GROUP BY u.id;

-- 4. 更新用户
UPDATE users
SET real_name = '自动测试用户-已修改', position = '高级测试员'
WHERE id = @test_user_id;

-- 5. 停用用户
UPDATE users SET status = 'inactive' WHERE id = @test_user_id;

-- 6. 验证更新
SELECT id, username, real_name, position, status
FROM users
WHERE id = @test_user_id;

-- 7. 清理测试数据
DELETE FROM user_roles WHERE user_id = @test_user_id;
DELETE FROM users WHERE id = @test_user_id;
```

---

## 附录B：监控查询

```sql
-- 实时监控用户操作
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_users
FROM users
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计各状态用户数
SELECT
    status,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM users WHERE is_deleted = 0), 2) as percentage
FROM users
WHERE is_deleted = 0
GROUP BY status;

-- 统计角色分配情况
SELECT
    r.role_name,
    COUNT(DISTINCT ur.user_id) as user_count
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
GROUP BY r.id, r.role_name
ORDER BY user_count DESC;
```

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
