<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据验证报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold mb-2">美业客户后台 - 数据验证报告</h1>
            <p class="text-gray-600">检查所有数据的完整性和勾稽关系</p>
        </div>

        <!-- 数据统计 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">客户总数</div>
                <div id="customerCount" class="text-3xl font-bold text-purple-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">订单总数</div>
                <div id="orderCount" class="text-3xl font-bold text-blue-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">任务总数</div>
                <div id="taskCount" class="text-3xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">模板总数</div>
                <div id="templateCount" class="text-3xl font-bold text-orange-600">-</div>
            </div>
        </div>

        <!-- 客户详情列表 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">客户数据详情</h2>
            <div id="customerDetails" class="space-y-4"></div>
        </div>

        <!-- 数据完整性检查 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4">数据完整性检查</h2>
            <div id="validationResults" class="space-y-2"></div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            runValidation();
        });

        function runValidation() {
            console.log('===== 开始数据验证 =====');

            // 获取所有数据
            const customers = db.getCustomers();
            const orders = db.getOrders();
            const tasks = db.getTasks();
            const templates = db.getTemplates();

            console.log('客户数据:', customers);
            console.log('订单数据:', orders);
            console.log('任务数据:', tasks);
            console.log('模板数据:', templates);

            // 更新统计数字
            document.getElementById('customerCount').textContent = customers.length;
            document.getElementById('orderCount').textContent = orders.length;
            document.getElementById('taskCount').textContent = tasks.length;
            document.getElementById('templateCount').textContent = templates.length;

            // 渲染客户详情
            const customerDetailsContainer = document.getElementById('customerDetails');
            let customerHTML = '';

            customers.forEach(customer => {
                const customerOrders = db.getOrdersByCustomerId(customer.id);
                const customerTasks = db.getTasksByCustomerId(customer.id);
                const basicInfo = customer.data?.tpl_basic_info || {};

                const hasAIDiagnosis = customer.aiDiagnosis ? '✅' : '❌';
                const hasBodyComp = customer.bodyComposition ? '✅' : '❌';
                const hasChatHistory = customer.chatHistory && customer.chatHistory.length > 0 ? '✅' : '❌';

                customerHTML += `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-lg font-bold">${customer.name}</h3>
                                <p class="text-sm text-gray-600">${customer.phone} | ID: ${customer.id}</p>
                            </div>
                            <a href="customer-detail.html?id=${customer.id}"
                               class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                查看详情
                            </a>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-gray-600">基础信息</div>
                                <div class="font-medium">
                                    ${basicInfo.gender || '-'} · ${basicInfo.age || '-'}岁
                                </div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-gray-600">订单数量</div>
                                <div class="font-medium text-blue-600">${customerOrders.length} 个</div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-gray-600">任务数量</div>
                                <div class="font-medium text-green-600">${customerTasks.length} 个</div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="text-gray-600">会员等级</div>
                                <div class="font-medium">${basicInfo.vip_level || '-'}</div>
                            </div>
                        </div>

                        <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
                            <div class="flex items-center space-x-1">
                                <span>${hasAIDiagnosis}</span>
                                <span class="text-gray-600">AI诊断</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>${hasBodyComp}</span>
                                <span class="text-gray-600">身体数据</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>${hasChatHistory}</span>
                                <span class="text-gray-600">对话记录 (${customer.chatHistory?.length || 0}条)</span>
                            </div>
                        </div>

                        ${customerOrders.length > 0 ? `
                        <div class="mt-3 pt-3 border-t">
                            <div class="text-xs text-gray-600 mb-1">订单列表:</div>
                            ${customerOrders.map(order => `
                                <div class="text-xs text-gray-700 ml-2">
                                    • ${order.orderNumber} - ${order.items.map(i => i.planTemplateName).join(', ')}
                                    - ¥${order.finalAmount}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        ${customerTasks.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-xs text-gray-600 mb-1">任务统计:</div>
                            <div class="flex space-x-3 text-xs">
                                <span class="text-yellow-600">
                                    待执行: ${customerTasks.filter(t => t.status === 'pending').length}
                                </span>
                                <span class="text-blue-600">
                                    进行中: ${customerTasks.filter(t => t.status === 'in_progress').length}
                                </span>
                                <span class="text-green-600">
                                    已完成: ${customerTasks.filter(t => t.status === 'completed').length}
                                </span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            customerDetailsContainer.innerHTML = customerHTML;

            // 数据完整性检查
            const validationResults = [];

            // 1. 检查客户-订单关联
            orders.forEach(order => {
                const customer = db.getCustomerById(order.customerId);
                if (!customer) {
                    validationResults.push({
                        level: 'error',
                        message: `订单 ${order.orderNumber} 关联的客户 ${order.customerId} 不存在`
                    });
                }
            });

            // 2. 检查客户-任务关联
            tasks.forEach(task => {
                const customer = db.getCustomerById(task.customerId);
                if (!customer) {
                    validationResults.push({
                        level: 'error',
                        message: `任务 ${task.id} 关联的客户 ${task.customerId} 不存在`
                    });
                }
            });

            // 3. 检查客户数据完整性
            customers.forEach(customer => {
                if (!customer.data || Object.keys(customer.data).length === 0) {
                    validationResults.push({
                        level: 'warning',
                        message: `客户 ${customer.name} (${customer.id}) 缺少详细资料数据`
                    });
                }

                if (!customer.aiDiagnosis) {
                    validationResults.push({
                        level: 'info',
                        message: `客户 ${customer.name} 缺少AI诊断数据`
                    });
                }

                if (!customer.bodyComposition) {
                    validationResults.push({
                        level: 'info',
                        message: `客户 ${customer.name} 缺少身体组成数据`
                    });
                }

                if (!customer.chatHistory || customer.chatHistory.length === 0) {
                    validationResults.push({
                        level: 'info',
                        message: `客户 ${customer.name} 缺少AI对话记录`
                    });
                }
            });

            // 渲染验证结果
            const validationContainer = document.getElementById('validationResults');
            if (validationResults.length === 0) {
                validationContainer.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">✅</span>
                            <div>
                                <h3 class="font-bold text-green-800">数据完整性检查通过!</h3>
                                <p class="text-sm text-green-700">所有数据勾稽关系正常,没有发现问题。</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                let resultHTML = '';
                const errorCount = validationResults.filter(r => r.level === 'error').length;
                const warningCount = validationResults.filter(r => r.level === 'warning').length;
                const infoCount = validationResults.filter(r => r.level === 'info').length;

                resultHTML += `
                    <div class="bg-gray-50 border-l-4 border-gray-400 p-4 mb-4">
                        <div class="font-bold mb-2">检查摘要:</div>
                        <div class="text-sm space-x-4">
                            ${errorCount > 0 ? `<span class="text-red-600">❌ 错误: ${errorCount}</span>` : ''}
                            ${warningCount > 0 ? `<span class="text-yellow-600">⚠️ 警告: ${warningCount}</span>` : ''}
                            ${infoCount > 0 ? `<span class="text-blue-600">ℹ️ 提示: ${infoCount}</span>` : ''}
                        </div>
                    </div>
                `;

                validationResults.forEach(result => {
                    const colorMap = {
                        error: 'red',
                        warning: 'yellow',
                        info: 'blue'
                    };
                    const iconMap = {
                        error: '❌',
                        warning: '⚠️',
                        info: 'ℹ️'
                    };
                    const color = colorMap[result.level];
                    const icon = iconMap[result.level];

                    resultHTML += `
                        <div class="bg-${color}-50 border-l-4 border-${color}-500 p-3 mb-2">
                            <div class="flex items-center text-sm">
                                <span class="mr-2">${icon}</span>
                                <span class="text-${color}-800">${result.message}</span>
                            </div>
                        </div>
                    `;
                });

                validationContainer.innerHTML = resultHTML;
            }

            console.log('===== 验证完成 =====');
            console.log('验证结果:', validationResults);
        }
    </script>
</body>
</html>
