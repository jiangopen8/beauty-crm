# æ¨¡å—åŒ–é‡æ„ - å¿«é€Ÿå…¥é—¨æŒ‡å—

## ğŸš€ ç«‹å³å¼€å§‹

å·²åˆ›å»ºçš„æ ¸å¿ƒæ–‡ä»¶ï¼š
- âœ… `js/core/module-loader.js` - æ¨¡å—åŠ è½½å™¨
- âœ… `js/core/tab-manager.js` - Tabç®¡ç†å™¨
- âœ… `js/modules/` - æ¨¡å—ç›®å½•ï¼ˆç©ºï¼Œå¾…æ·»åŠ æ¨¡å—ï¼‰

---

## ğŸ“ ç¬¬ä¸€æ­¥ï¼šæ‹†åˆ†å®¢æˆ·èµ„æ–™æ¨¡å—ï¼ˆç¤ºä¾‹ï¼‰

### 1. å°†ç°æœ‰çš„å®¢æˆ·èµ„æ–™ä»£ç é‡æ„ä¸ºæ¨¡å—

å°† `js/customerProfile.js` é‡æ„ä¸º `js/modules/customer-profile.js`ï¼š

```javascript
/**
 * å®¢æˆ·èµ„æ–™æ¨¡å—
 * ç‹¬ç«‹çš„å®¢æˆ·èµ„æ–™ç®¡ç†åŠŸèƒ½
 */
class CustomerProfileModule {
    constructor(options = {}) {
        this.customerId = options.customerId;
        this.container = null;
        this.currentTemplate = null;
        this.currentProfileData = null;
    }

    /**
     * æŒ‚è½½æ¨¡å—åˆ°å®¹å™¨
     */
    mount(container) {
        this.container = container;
        this.init();
    }

    /**
     * åˆå§‹åŒ–æ¨¡å—
     */
    async init() {
        try {
            await this.loadStandardTemplate();
            await this.loadCustomerProfile();
            this.render();
        } catch (error) {
            console.error('åˆå§‹åŒ–å®¢æˆ·èµ„æ–™æ¨¡å—å¤±è´¥:', error);
            this.showError(error.message);
        }
    }

    /**
     * åŠ è½½æ ‡å‡†å®¢æˆ·èµ„æ–™æ¨¡æ¿
     */
    async loadStandardTemplate() {
        const response = await fetch('http://8.210.246.101:3000/api/customer-profile-templates');
        const result = await response.json();

        if (result.success && result.data && result.data.list) {
            this.currentTemplate = result.data.list.find(t =>
                t.apply_scene === 'all' || t.template_name.includes('æ ‡å‡†')
            ) || result.data.list[0];
        }
    }

    /**
     * åŠ è½½å®¢æˆ·çš„è¯¦ç»†èµ„æ–™
     */
    async loadCustomerProfile() {
        if (!this.customerId || !this.currentTemplate) return;

        const response = await fetch(
            `http://8.210.246.101:3000/api/customer-profiles/customer/${this.customerId}/template/${this.currentTemplate.id}`
        );
        const result = await response.json();

        if (result.success && result.data) {
            this.currentProfileData = result.data;
        }
    }

    /**
     * æ¸²æŸ“UI
     */
    render() {
        if (!this.currentTemplate) {
            this.container.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— æ¨¡æ¿é…ç½®</p>';
            return;
        }

        const fields = typeof this.currentTemplate.fields === 'string'
            ? JSON.parse(this.currentTemplate.fields)
            : this.currentTemplate.fields;

        const savedData = this.currentProfileData?.profile_data || {};
        const profileData = typeof savedData === 'string' ? JSON.parse(savedData) : savedData;

        const groupedFields = this.groupFields(fields);

        let html = `
            <div class="form-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        <i data-lucide="user" class="w-5 h-5 inline mr-2 text-purple-600"></i>
                        å®¢æˆ·è¯¦ç»†èµ„æ–™
                    </h3>
                    <span class="text-sm text-gray-500">
                        æ¨¡æ¿: ${this.currentTemplate.template_name}
                    </span>
                </div>
                <form id="profileForm">
        `;

        for (const [groupName, groupFields] of Object.entries(groupedFields)) {
            html += `
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 pb-2 border-b border-gray-200">
                        ${groupName}
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            groupFields.forEach(field => {
                html += this.renderField(field, profileData[field.field_key]);
            });

            html += '</div></div>';
        }

        html += `
                <div class="mt-6 pt-6 border-t border-gray-200 flex justify-end">
                    <button type="button" id="saveProfileBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                        ä¿å­˜èµ„æ–™
                    </button>
                </div>
            </form>
        </div>
        `;

        this.container.innerHTML = html;

        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        if (window.lucide) {
            lucide.createIcons();
        }

        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    bindEvents() {
        const saveBtn = this.container.querySelector('#saveProfileBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.saveProfile());
        }
    }

    /**
     * æŒ‰åˆ†ç»„ç»„ç»‡å­—æ®µ
     */
    groupFields(fields) {
        const grouped = {};
        fields.forEach(field => {
            const group = field.group || 'åŸºæœ¬ä¿¡æ¯';
            if (!grouped[group]) {
                grouped[group] = [];
            }
            grouped[group].push(field);
        });
        return grouped;
    }

    /**
     * æ¸²æŸ“å•ä¸ªå­—æ®µï¼ˆå¤ç”¨ç°æœ‰çš„customerProfile.jsä»£ç ï¼‰
     */
    renderField(field, value) {
        const fieldKey = field.field_key;
        const fieldName = field.field_name;
        const fieldType = field.field_type;
        const required = field.required ? '<span class="text-red-500">*</span>' : '';
        const placeholder = field.placeholder || `è¯·è¾“å…¥${fieldName}`;

        let inputHtml = '';

        switch (fieldType) {
            case 'text':
            case 'email':
            case 'tel':
                inputHtml = `
                    <input type="${fieldType}" name="${fieldKey}" value="${value || ''}"
                        placeholder="${placeholder}" ${field.required ? 'required' : ''}
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                `;
                break;

            case 'textarea':
                inputHtml = `
                    <textarea name="${fieldKey}" rows="3" placeholder="${placeholder}"
                        ${field.required ? 'required' : ''}
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">${value || ''}</textarea>
                `;
                break;

            case 'select':
                const options = field.options || [];
                inputHtml = `
                    <select name="${fieldKey}" ${field.required ? 'required' : ''}
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        <option value="">è¯·é€‰æ‹©${fieldName}</option>
                        ${options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                `;
                break;

            case 'checkbox':
                const checkboxOptions = field.options || [];
                const selectedValues = Array.isArray(value) ? value : (value ? [value] : []);
                inputHtml = `
                    <div class="flex flex-wrap gap-3">
                        ${checkboxOptions.map(opt => `
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="${fieldKey}[]" value="${opt}"
                                    ${selectedValues.includes(opt) ? 'checked' : ''}
                                    class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500" />
                                <span class="ml-2 text-sm text-gray-700">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                break;

            // å…¶ä»–å­—æ®µç±»å‹...
            default:
                inputHtml = `<input type="text" name="${fieldKey}" value="${value || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />`;
        }

        return `
            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    ${fieldName} ${required}
                </label>
                ${inputHtml}
            </div>
        `;
    }

    /**
     * æ”¶é›†è¡¨å•æ•°æ®
     */
    collectFormData() {
        const form = this.container.querySelector('#profileForm');
        if (!form || !this.currentTemplate) return null;

        const fields = typeof this.currentTemplate.fields === 'string'
            ? JSON.parse(this.currentTemplate.fields)
            : this.currentTemplate.fields;

        const formData = {};

        fields.forEach(field => {
            const fieldKey = field.field_key;
            const fieldType = field.field_type;

            if (fieldType === 'checkbox') {
                const checkboxes = form.querySelectorAll(`input[name="${fieldKey}[]"]:checked`);
                formData[fieldKey] = Array.from(checkboxes).map(cb => cb.value);
            } else if (fieldType === 'radio') {
                const radio = form.querySelector(`input[name="${fieldKey}"]:checked`);
                formData[fieldKey] = radio ? radio.value : '';
            } else {
                const input = form.querySelector(`[name="${fieldKey}"]`);
                formData[fieldKey] = input ? input.value : '';
            }
        });

        return formData;
    }

    /**
     * ä¿å­˜å®¢æˆ·è¯¦ç»†èµ„æ–™
     */
    async saveProfile() {
        const profileData = this.collectFormData();
        if (!profileData) {
            alert('æ— æ³•æ”¶é›†è¡¨å•æ•°æ®');
            return false;
        }

        try {
            let response;

            if (this.currentProfileData && this.currentProfileData.id) {
                // æ›´æ–°ç°æœ‰èµ„æ–™
                response = await fetch(
                    `http://8.210.246.101:3000/api/customer-profiles/customer/${this.customerId}/template/${this.currentTemplate.id}`,
                    {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            profile_data: profileData,
                            updated_by: 1
                        })
                    }
                );
            } else {
                // åˆ›å»ºæ–°èµ„æ–™
                response = await fetch('http://8.210.246.101:3000/api/customer-profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: this.customerId,
                        template_id: this.currentTemplate.id,
                        org_id: 1,
                        profile_data: profileData,
                        created_by: 1
                    })
                });
            }

            const result = await response.json();

            if (result.success) {
                alert('ä¿å­˜æˆåŠŸï¼');
                await this.loadCustomerProfile();
                return true;
            } else {
                alert('ä¿å­˜å¤±è´¥ï¼š' + result.message);
                return false;
            }
        } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            return false;
        }
    }

    /**
     * å¸è½½æ¨¡å—
     */
    unmount() {
        if (this.container) {
            this.container.innerHTML = '';
            this.container = null;
        }
    }

    /**
     * æ˜¾ç¤ºé”™è¯¯
     */
    showError(message) {
        this.container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-red-600">
                <i data-lucide="alert-circle" class="w-12 h-12 mb-3"></i>
                <p class="text-lg font-semibold">åŠ è½½å¤±è´¥</p>
                <p class="text-sm mt-2">${message}</p>
            </div>
        `;
        if (window.lucide) {
            lucide.createIcons();
        }
    }
}

// å¯¼å‡ºåˆ°å…¨å±€
window.CustomerProfileModule = CustomerProfileModule;
```

---

## ğŸ“‹ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç®€åŒ–çš„ä¸»é¡µé¢

åˆ›å»ºä¸€ä¸ªæ–°çš„æµ‹è¯•é¡µé¢ `customer-detail-v2.html`ï¼ˆä¿ç•™åŸé¡µé¢ä½œä¸ºå¤‡ä»½ï¼‰ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·è¯¦æƒ… - æ¨¡å—åŒ–ç‰ˆæœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="css/styles.css">

    <style>
        /* å¤ç”¨åŸæœ‰çš„æ ·å¼ */
        .tab-btn { /* ... */ }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        .loading-spinner { /* ... */ }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-sm border-b">
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="customers.html" class="p-2 text-gray-600 hover:text-purple-600">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h1 class="text-xl font-bold">å®¢æˆ·è¯¦æƒ…</h1>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        <!-- å®¢æˆ·åŸºæœ¬ä¿¡æ¯å¡ç‰‡ï¼ˆä¿æŒä¸å˜ï¼‰ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-lg font-bold">å®¢æˆ·åŸºæœ¬ä¿¡æ¯</h2>
            <!-- ... -->
        </div>

        <!-- Tabå¯¼èˆªæ  -->
        <div class="bg-white rounded-t-lg shadow-sm border-b overflow-x-auto">
            <div class="flex">
                <button class="tab-btn active" data-tab="profile">å®¢æˆ·èµ„æ–™</button>
                <button class="tab-btn" data-tab="diagnosis">è¯Šæ–­ç®¡ç†</button>
                <button class="tab-btn" data-tab="plans">æ–¹æ¡ˆç®¡ç†</button>
                <button class="tab-btn" data-tab="orders">è®¢å•ç®¡ç†</button>
                <button class="tab-btn" data-tab="tasks">ä»»åŠ¡ç®¡ç†</button>
                <button class="tab-btn" data-tab="chat">AIå¯¹è¯</button>
            </div>
        </div>

        <!-- Tabå†…å®¹åŒºåŸŸï¼ˆç©ºå®¹å™¨ï¼Œç”±æ¨¡å—åŠ¨æ€å¡«å……ï¼‰ -->
        <div class="bg-white rounded-b-lg shadow-sm p-6">
            <div id="profileTab" class="tab-content active"></div>
            <div id="diagnosisTab" class="tab-content"></div>
            <div id="plansTab" class="tab-content"></div>
            <div id="ordersTab" class="tab-content"></div>
            <div id="tasksTab" class="tab-content"></div>
            <div id="chatTab" class="tab-content"></div>
        </div>
    </main>

    <!-- å¼•å…¥æ ¸å¿ƒæ¨¡å— -->
    <script src="js/core/module-loader.js"></script>
    <script src="js/core/tab-manager.js"></script>

    <script>
        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        // è·å–å®¢æˆ·ID
        const customerId = new URLSearchParams(window.location.search).get('id') || 1;

        // åˆå§‹åŒ–Tabç®¡ç†å™¨
        const tabManager = new TabManager({
            customerId: customerId,
            defaultTab: 'profile'
        });

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', () => {
            tabManager.init();
        });

        // ç›‘å¬Tabåˆ‡æ¢äº‹ä»¶
        window.addEventListener('tabChange', (e) => {
            console.log('Tabåˆ‡æ¢åˆ°:', e.detail.tabName);
        });
    </script>
</body>
</html>
```

---

## ğŸ§ª ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•

### 1. åˆ›å»ºå®¢æˆ·èµ„æ–™æ¨¡å—æ–‡ä»¶

å°†ä¸Šé¢çš„ `CustomerProfileModule` ä»£ç ä¿å­˜ä¸ºï¼š
`js/modules/customer-profile.js`

### 2. è®¿é—®æµ‹è¯•é¡µé¢

```
http://8.210.246.101:5002/customer-detail-v2.html?id=1
```

### 3. éªŒè¯åŠŸèƒ½

- âœ… é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤º"å®¢æˆ·èµ„æ–™"Tab
- âœ… æ¨¡å—åŠ¨æ€åŠ è½½æˆåŠŸ
- âœ… æ•°æ®æ­£ç¡®æ˜¾ç¤º
- âœ… è¡¨å•å¯ä»¥æ­£å¸¸ä¿å­˜
- âœ… åˆ‡æ¢å…¶ä»–Tabæ—¶æ˜¾ç¤º"æ­£åœ¨åŠ è½½..."ï¼ˆå› ä¸ºå…¶ä»–æ¨¡å—è¿˜æœªåˆ›å»ºï¼‰

---

## ğŸ“ˆ é€æ­¥æ‰©å±•

### æŒ‰ä¼˜å…ˆçº§æ·»åŠ å…¶ä»–æ¨¡å—

1. **P0 - è®¢å•ç®¡ç†**ï¼ˆæœ€ç®€å•ï¼‰
   - åˆ›å»º `js/modules/orders.js`
   - æ¸²æŸ“è®¢å•åˆ—è¡¨
   - æµ‹è¯•

2. **P1 - è¯Šæ–­ç®¡ç†**
   - åˆ›å»º `js/modules/diagnosis.js`
   - å®ç°è¯Šæ–­åˆ—è¡¨å’Œè¡¨å•
   - æµ‹è¯•

3. **P1 - æ–¹æ¡ˆç®¡ç†**
   - åˆ›å»º `js/modules/plans.js`
   - å®ç°æ–¹æ¡ˆç”Ÿæˆå’Œé€‰æ‹©
   - æµ‹è¯•

4. **P2 - ä»»åŠ¡ç®¡ç†**
   - åˆ›å»º `js/modules/tasks.js`
   - å®ç°ä»»åŠ¡åˆ—è¡¨å’Œç­›é€‰
   - æµ‹è¯•

5. **P2 - AIå¯¹è¯**
   - åˆ›å»º `js/modules/chat.js`
   - å®ç°èŠå¤©ç•Œé¢
   - æµ‹è¯•

---

## ğŸ‰ éªŒè¯æˆåŠŸæ ‡å‡†

å½“ä½ å®Œæˆç¬¬ä¸€ä¸ªæ¨¡å—ï¼ˆå®¢æˆ·èµ„æ–™ï¼‰çš„æ‹†åˆ†åï¼Œåº”è¯¥è¾¾åˆ°ä»¥ä¸‹æ•ˆæœï¼š

1. âœ… `customer-detail-v2.html` æ–‡ä»¶å¤§å°æ˜¾è‘—å‡å°
2. âœ… å®¢æˆ·èµ„æ–™åŠŸèƒ½å®Œå…¨æ­£å¸¸
3. âœ… ä»£ç æ›´æ¸…æ™°ã€æ˜“äºè°ƒè¯•
4. âœ… ç”¨æˆ·ä½“éªŒæ— å˜åŒ–
5. âœ… å¯ä»¥è½»æ¾æ·»åŠ å…¶ä»–æ¨¡å—

---

## ğŸ’¡ ä¸‹ä¸€æ­¥

å®Œæˆç¬¬ä¸€ä¸ªæ¨¡å—åï¼Œä½ å¯ä»¥ï¼š

1. **æ¸è¿›å¼è¿ç§»å…¶ä»–æ¨¡å—**ï¼ˆæ¨èï¼‰
   - é€ä¸ªæ¨¡å—æ‹†åˆ†å’Œæµ‹è¯•
   - é™ä½é£é™©

2. **å…¨é¢é‡æ„**
   - ä¸€æ¬¡æ€§æ‹†åˆ†æ‰€æœ‰æ¨¡å—
   - é€‚åˆæœ‰å……è¶³æ—¶é—´çš„æƒ…å†µ

3. **ç°åº¦å‘å¸ƒ**
   - æ–°æ—§ç‰ˆæœ¬å¹¶å­˜
   - é€šè¿‡URLå‚æ•°åˆ‡æ¢

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- è¯¦ç»†æ–¹æ¡ˆï¼š`å®¢æˆ·è¯¦æƒ…é¡µé¢æ¨¡å—åŒ–é‡æ„æ–¹æ¡ˆ.md`
- å½“å‰å·²åˆ›å»ºæ–‡ä»¶ï¼š
  - `js/core/module-loader.js`
  - `js/core/tab-manager.js`
  - `js/modules/` ç›®å½•

---

**å¼€å§‹ç¬¬ä¸€æ­¥å§ï¼** ğŸš€
