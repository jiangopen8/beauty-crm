<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>客户详情 - 美业客户洞察 CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile-optimizations.css">
    <style>
        /* 移动端优化样式 */
        @media (max-width: 768px) {
            .mobile-hidden { display: none !important; }
            .mobile-full { width: 100% !important; }
            .mobile-p-2 { padding: 0.5rem !important; }
            .mobile-text-sm { font-size: 0.875rem !important; }
            .mobile-stack { flex-direction: column !important; }

            /* 确保表单卡片在移动端有适当的间距 */
            .form-card {
                padding: 1rem;
            }

            /* 订单卡片移动端优化 */
            .order-card {
                padding: 1rem;
            }

            /* 聊天气泡在移动端占更多宽度 */
            .chat-bubble {
                max-width: 85%;
            }

            /* AI画像模态框移动端优化 */
            #aiProfileModal > div {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }

            /* 任务筛选按钮移动端优化 */
            .task-filter-btn {
                white-space: nowrap;
                flex-shrink: 0;
            }
        }

        /* 标签页样式 */
        .tab-btn {
            position: relative;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .tab-btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }

            /* 隐藏桌面端的标签导航 */
            .tabs-container {
                display: none !important;
            }
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* 移动端底部导航 */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem 0;
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .mobile-bottom-nav {
                display: block;
            }

            /* 为底部导航留出空间 */
            main {
                padding-bottom: 80px !important;
            }
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            color: #9ca3af;
            transition: all 0.2s ease;
            text-decoration: none;
            cursor: pointer;
            border: none;
            background: none;
            flex: 1;
        }

        .mobile-nav-btn.active {
            color: #667eea;
        }

        .mobile-nav-btn i {
            margin-bottom: 0.25rem;
        }

        .mobile-nav-btn span {
            font-size: 0.65rem;
            font-weight: 500;
        }

        /* 表单卡片 */
        .form-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .form-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* AI分析卡片 */
        .ai-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* 方案卡片 */
        .plan-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .plan-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .plan-card.selected {
            border-color: #667eea;
            background: #f3f4f6;
        }

        @media (max-width: 768px) {
            .plan-card {
                padding: 0.875rem;
            }
        }

        /* 对话气泡 */
        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
        }

        .chat-bubble.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-bubble.ai {
            background: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
        }

        /* 侧边栏过渡 */
        .sidebar {
            transition: transform 0.3s ease;
        }

        .sidebar.closed {
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar.closed {
                transform: translateX(0);
            }
        }

        /* 标签页内容切换 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 加载动画 */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 分栏布局 */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
        }

        /* 诊断结果卡片 */
        .diagnosis-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            min-height: 200px;
        }

        /* 订单状态徽章 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #dbeafe; color: #1e40af; }
        .status-paid { background: #c7d2fe; color: #4338ca; }
        .status-in-progress { background: #e0e7ff; color: #3730a3; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }

        /* 任务状态 */
        .task-pending { border-left: 4px solid #f59e0b; }
        .task-in_progress { border-left: 4px solid #3b82f6; }
        .task-completed { border-left: 4px solid #10b981; }
        .task-skipped { border-left: 4px solid #6b7280; }

        /* 标签页滚动 */
        .tabs-container {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .tabs-container::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 768px) {
            .tabs-container {
                padding-bottom: 0.25rem;
            }
        }

        /* 头像样式 */
        .customer-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }

        @media (max-width: 768px) {
            .customer-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        /* 诊断历史卡片 */
        .diagnosis-history-item {
            background: #f9fafb;
            border-left: 3px solid #667eea;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .diagnosis-history-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }

        @media (max-width: 768px) {
            .diagnosis-history-item {
                padding: 0.75rem;
            }
        }

        /* 订单卡片 */
        .order-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* 任务状态样式 */
        .task-status-pending,
        .task-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .task-status-in_progress,
        .task-in_progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .task-status-completed,
        .task-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .task-status-cancelled,
        .task-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .task-status-overdue,
        .task-overdue {
            background: #fde68a;
            color: #78350f;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
        <div class="px-4 md:px-6 py-3 md:py-4">
            <div class="flex items-center justify-between">
                <!-- 左侧Logo和返回按钮 -->
                <div class="flex items-center space-x-3 md:space-x-4">
                    <button onclick="window.location.href='customers.html'" class="p-2 text-gray-600 hover:text-blue-600 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <i data-lucide="sparkles" class="w-6 h-6 md:w-8 md:h-8 text-purple-600"></i>
                        <h1 class="text-lg md:text-xl font-bold text-gray-900">美业洞察CRM
                                <span id="header-org-name" class="hidden md:inline text-purple-600"></span>
                            </h1>
                    </div>
                </div>

                <!-- 右侧用户信息 -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <!-- 保存按钮 -->
                    <button onclick="saveCustomerData()" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>保存</span>
                    </button>

                    <!-- 通知铃铛 -->
                    <div class="relative">
                        <button class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- 用户菜单 -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition-colors">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-medium">李</span>
                            </div>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                                个人资料
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                系统设置
                            </a>
                            <hr class="my-2 border-gray-200">
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-20 md:pt-16">
        <!-- 主要内容区域 -->
        <main class="max-w-7xl mx-auto p-3 md:p-6">
            <!-- 客户基本信息头部 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 md:p-6 mb-4 md:mb-6">
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6">
                    <!-- 头像 -->
                    <div class="customer-avatar" id="customerAvatar">?</div>

                    <!-- 基本信息 -->
                    <div class="flex-1">
                        <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-2">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-900" id="customerName">加载中...</h2>
                            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                <span class="badge badge-purple" id="customerVipLevel">金卡会员</span>
                                <span class="badge badge-green">活跃</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm text-gray-600">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                                <span id="customerPhone">加载中...</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>注册于 <span id="customerRegDate">2024-10-28</span></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                <span>最后联系 <span id="customerLastContact">2天前</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- 快速操作 -->
                    <div class="flex space-x-2 w-full md:w-auto">
                        <button onclick="generateAIProfile()" class="flex-1 md:flex-initial flex items-center justify-center space-x-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>AI画像</span>
                        </button>
                        <button onclick="saveCustomerData()" class="md:hidden flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i data-lucide="save" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 标签页导航 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="tabs-container flex border-b border-gray-200 px-4">
                    <button class="tab-btn active" onclick="switchTab('profile')">
                        <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                        客户资料
                    </button>
                    <button class="tab-btn" onclick="switchTab('diagnosis')">
                        <i data-lucide="activity" class="w-4 h-4 inline mr-1"></i>
                        诊断管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('plans')">
                        <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                        方案管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('orders')">
                        <i data-lucide="shopping-cart" class="w-4 h-4 inline mr-1"></i>
                        订单管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('tasks')">
                        <i data-lucide="check-square" class="w-4 h-4 inline mr-1"></i>
                        任务管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('chat')">
                        <i data-lucide="message-circle" class="w-4 h-4 inline mr-1"></i>
                        AI对话
                    </button>
                </div>

                <!-- 标签页内容 -->
                <div class="p-4 md:p-6">
                    <!-- 客户资料标签页 -->
                    <div id="profileTab" class="tab-content active">
                        <div id="profileFormsContainer">
                            <!-- 使用 CustomerProfileModule 动态加载的表单 -->
                        </div>
                    </div>

                    <!-- 诊断管理标签页 -->
                    <div id="diagnosisTab" class="tab-content">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">诊断历史记录</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="showNewDiagnosisModal()" class="px-4 py-2 border border-purple-600 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors text-sm">
                                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                    新建诊断
                                </button>
                                <button onclick="showCreateDiagnosisGroupModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                    <i data-lucide="layers" class="w-4 h-4 inline mr-1"></i>
                                    创建诊断组
                                </button>
                            </div>
                        </div>
                        <div id="diagnosisHistoryContainer">
                            <!-- 动态加载诊断历史 -->
                        </div>
                    </div>

                    <!-- 方案管理标签页 -->
                    <div id="plansTab" class="tab-content">
                        <div class="split-layout">
                            <!-- 左侧：待选方案列表 -->
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">方案模板库</h3>
                                    <button onclick="refreshPlans()" class="text-sm text-purple-600 hover:text-purple-700">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i>
                                        刷新
                                    </button>
                                </div>
                                <div id="availablePlansContainer" class="space-y-3 mb-4">
                                    <!-- 动态加载的方案列表 -->
                                </div>
                                <button onclick="addSelectedPlans()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium" id="addPlansBtn" disabled>
                                    <i data-lucide="plus-circle" class="w-5 h-5 inline mr-2"></i>
                                    添加已选方案 (<span id="selectedCount">0</span>)
                                </button>
                            </div>

                            <!-- 右侧：客户方案组 -->
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">客户方案组</h3>
                                </div>
                                <div id="customerSolutionGroupsContainer" class="space-y-4">
                                    <!-- 动态加载客户的方案组 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 订单管理标签页 -->
                    <div id="ordersTab" class="tab-content">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold text-gray-900">客户订单列表</h3>
                        </div>
                        <div id="ordersContainer">
                            <!-- 动态加载的订单列表 -->
                        </div>
                    </div>

                    <!-- 任务管理标签页 -->
                    <div id="tasksTab" class="tab-content">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-3">客户任务列表</h3>
                            <div class="flex space-x-2 overflow-x-auto">
                                <button onclick="filterTasks('all')" class="task-filter-btn active px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium" data-status="all">
                                    全部
                                </button>
                                <button onclick="filterTasks('pending')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="pending">
                                    待执行
                                </button>
                                <button onclick="filterTasks('in_progress')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="in_progress">
                                    进行中
                                </button>
                                <button onclick="filterTasks('completed')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="completed">
                                    已完成
                                </button>
                                <button onclick="filterTasks('cancelled')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="cancelled">
                                    已取消
                                </button>
                            </div>
                        </div>
                        <div id="tasksContainer">
                            <!-- 动态加载的任务列表 -->
                        </div>
                    </div>

                    <!-- AI对话记录标签页 -->
                    <div id="chatTab" class="tab-content">
                        <div class="bg-white rounded-lg border border-gray-200 h-[600px] flex flex-col">
                            <!-- 对话头部 -->
                            <div class="px-4 py-3 border-b border-gray-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                            <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900">AI美容助手</h3>
                                            <p class="text-xs text-gray-500">24/7在线服务</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- 日期筛选 -->
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-600">日期筛选:</label>
                                    <input type="date" id="chatStartDate" class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500" onchange="loadChatHistory()">
                                    <span class="text-sm text-gray-500">至</span>
                                    <input type="date" id="chatEndDate" class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500" onchange="loadChatHistory()">
                                    <button onclick="resetChatDateFilter()" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50">
                                        重置
                                    </button>
                                </div>
                            </div>

                            <!-- 对话内容区 -->
                            <div id="chatMessagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                <!-- 动态加载的对话消息 -->
                            </div>

                            <!-- 输入区 -->
                            <div class="px-4 py-3 border-t border-gray-200">
                                <div class="flex space-x-2">
                                    <input type="text" id="chatInput" placeholder="输入消息..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onkeypress="handleChatKeyPress(event)">
                                    <button onclick="sendChatMessage()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI客户画像模态框 -->
    <div id="aiProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-xl font-bold text-gray-900">AI客户画像分析</h3>
                        <button id="viewHistoryBtn" onclick="toggleProfileView()" class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors hidden">
                            <i data-lucide="history" class="w-4 h-4 inline-block mr-1"></i>
                            <span id="viewHistoryText">查看历史</span>
                        </button>
                    </div>
                    <button onclick="closeAIProfileModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- 当前画像内容 -->
                <div id="aiProfileContent" class="space-y-4">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <!-- 历史版本列表 -->
                <div id="aiProfileHistory" class="hidden space-y-4">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 诊断组选择模态框 -->
    <div id="diagnosisGroupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">创建诊断组</h2>
                    <p class="text-sm text-gray-500 mt-1">选择多个诊断模板，一次性构建诊断组</p>
                </div>
                <button onclick="closeDiagnosisGroupModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- 推荐模板区 -->
                <div id="recommendedTemplatesSection" class="mb-8">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="star" class="w-5 h-5 text-amber-500"></i>
                        <h3 class="text-lg font-semibold text-gray-900">推荐模板</h3>
                    </div>
                    <div id="recommendedTemplatesList" class="space-y-2">
                        <!-- 动态生成推荐模板复选框列表 -->
                    </div>
                </div>

                <!-- 其他模板区 -->
                <div id="otherTemplatesSection">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="list" class="w-5 h-5 text-gray-400"></i>
                        <h3 class="text-lg font-semibold text-gray-900">其他模板</h3>
                    </div>
                    <div id="otherTemplatesList" class="space-y-2">
                        <!-- 动态生成其他模板复选框列表 -->
                    </div>
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between">
                <div class="text-sm text-gray-600">
                    已选择 <span id="selectedDiagnosisTemplatesCount" class="font-semibold text-purple-600">0</span> 个模板
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="closeDiagnosisGroupModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button onclick="confirmCreateDiagnosisGroup()" id="createDiagnosisGroupBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        创建并填写诊断
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建诊断模态框 -->
    <div id="diagnosisModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">新建诊断</h2>
                <button onclick="closeDiagnosisModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="diagnosisForm" class="space-y-6">
                    <!-- 基本信息 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">诊断日期 *</label>
                            <input type="date" id="diagnoseDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">诊断人 *</label>
                            <select id="diagnosedBy" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">请选择诊断人</option>
                                <option value="1">李美容师</option>
                                <!-- 动态加载用户列表 -->
                            </select>
                        </div>
                    </div>

                    <!-- 动态表单字段容器 -->
                    <div id="dynamicFieldsContainer" class="space-y-6">
                        <!-- 根据模板动态渲染 -->
                    </div>

                    <!-- 诊断建议 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">诊断建议</label>
                        <textarea id="suggestions" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="记录诊断建议和注意事项..."></textarea>
                    </div>
                </form>
            </div>

            <!-- 模态框底部 -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="closeDiagnosisModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button onclick="saveDiagnosis()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    保存诊断
                </button>
            </div>
        </div>
    </div>

    <!-- 诊断组填写模态框 -->
    <div id="diagnosisGroupFillModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- 头部：标题和进度 -->
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">填写诊断组</h2>
                <div class="flex items-center gap-4 mt-3">
                    <div class="text-sm text-gray-600">
                        进度: <span id="diagnosisGroupProgressCount" class="font-semibold text-purple-600">0 / 0</span>
                    </div>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div id="diagnosisGroupProgressBar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Tab导航 -->
            <div class="px-6 pt-4 border-b overflow-x-auto">
                <div id="diagnosisGroupTabsContainer" class="flex gap-2 pb-2">
                    <!-- 动态生成Tab按钮 -->
                </div>
            </div>

            <!-- 内容区 -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="diagnosisGroupFormsContainer">
                    <!-- 动态生成每个诊断表单 -->
                </div>
            </div>

            <!-- 底部操作按钮 -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between">
                <button onclick="closeDiagnosisGroupFillModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <div class="flex items-center gap-3">
                    <button onclick="skipCurrentDiagnosisInGroup()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="skip-forward" class="w-4 h-4 inline mr-1"></i>
                        跳过此项
                    </button>
                    <button onclick="saveCurrentDiagnosisInGroup()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-1"></i>
                        保存当前
                    </button>
                    <button onclick="completeAllDiagnoses()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                        完成所有
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 生成订单确认模态框 -->
    <div id="generateOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">确认生成订单</h2>
                    <p class="text-sm text-gray-500 mt-1">请确认方案信息,可调整周期、次数和价格</p>
                </div>
                <button onclick="closeGenerateOrderModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="orderSolutionsContainer" class="space-y-4">
                    <!-- 动态加载的方案列表 -->
                </div>

                <!-- 总金额显示 -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-semibold text-gray-900">订单总金额</span>
                        <span class="text-2xl font-bold text-green-600" id="totalAmount">¥0.00</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">将为客户生成 <span id="orderCount" class="font-medium text-purple-600">0</span> 个订单</p>
                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="closeGenerateOrderModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button onclick="confirmGenerateOrders()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                    确认生成订单
                </button>
            </div>
        </div>
    </div>

    <!-- 修改订单模态框 -->
    <div id="editOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">修改订单</h2>
                    <p class="text-sm text-gray-500 mt-1">修改订单信息</p>
                </div>
                <button onclick="closeEditOrderModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="editOrderForm" class="space-y-4">
                    <input type="hidden" id="editOrderId" />

                    <!-- 服务日期 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">服务日期</label>
                        <input type="date" id="editServiceDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- 服务时间 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">开始时间</label>
                            <input type="time" id="editServiceStartTime"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">结束时间</label>
                            <input type="time" id="editServiceEndTime"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- 金额信息 -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">原价（元）</label>
                            <input type="number" id="editOriginalAmount" step="0.01" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onchange="calculateFinalAmount()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">折扣（元）</label>
                            <input type="number" id="editDiscountAmount" step="0.01" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   onchange="calculateFinalAmount()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">实付（元）</label>
                            <input type="number" id="editFinalAmount" step="0.01" min="0" readonly
                                   class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700 font-semibold">
                        </div>
                    </div>

                    <!-- 备注 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <textarea id="editRemark" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="订单备注信息..."></textarea>
                    </div>
                </form>
            </div>

            <!-- 模态框底部 -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="closeEditOrderModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button onclick="saveOrderEdit()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i data-lucide="save" class="w-4 h-4 inline mr-1"></i>
                    保存修改
                </button>
            </div>
        </div>
    </div>

    <!-- 生成任务模态框 -->
    <div id="generateTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">生成任务</h2>
                    <p class="text-xs text-gray-500 mt-1">为订单选择合适的任务模板</p>
                </div>
                <button onclick="closeGenerateTaskModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <!-- 订单信息摘要 -->
                <div id="orderSummaryForTask" class="mb-4 p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg border border-purple-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="shopping-cart" class="w-4 h-4 text-purple-600"></i>
                        <span class="font-semibold text-gray-900">订单信息</span>
                    </div>
                    <div class="text-sm text-gray-700">
                        <span id="orderServiceName">-</span> ·
                        <span id="orderServiceDate">-</span>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div id="taskTemplatesLoading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"></div>
                    <p class="text-sm text-gray-500 mt-2">加载任务模板...</p>
                </div>

                <!-- 推荐模板 -->
                <div id="recommendedTemplates" class="hidden mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="star" class="w-4 h-4 text-amber-500"></i>
                        <h3 class="font-semibold text-gray-900">推荐模板</h3>
                        <span class="text-xs text-gray-500">根据订单服务内容智能推荐</span>
                    </div>
                    <div id="recommendedTemplatesList" class="space-y-2">
                        <!-- 动态生成推荐的任务模板 -->
                    </div>
                </div>

                <!-- 其他模板 -->
                <div id="otherTemplates" class="hidden">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="list" class="w-4 h-4 text-gray-500"></i>
                        <h3 class="font-semibold text-gray-900">其他可用模板</h3>
                    </div>
                    <div id="otherTemplatesList" class="space-y-2">
                        <!-- 动态生成其他任务模板 -->
                    </div>
                </div>

                <!-- 空状态 -->
                <div id="noTemplatesMessage" class="hidden text-center py-8">
                    <i data-lucide="inbox" class="w-12 h-12 text-gray-300 mx-auto mb-2"></i>
                    <p class="text-gray-500">暂无可用的任务模板</p>
                </div>
            </div>

            <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    已选择 <span id="selectedTemplateCount" class="font-semibold text-purple-600">0</span> 个模板
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="closeGenerateTaskModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button onclick="confirmGenerateTasks()" class="px-4 py-2 bg-gradient-to-br from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-md">
                        <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                        生成任务
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 更新任务状态模态框 -->
    <div id="updateTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full modal-enter">
            <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-900">更新任务状态</h2>
                <button onclick="closeUpdateTaskModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6">
                <input type="hidden" id="updateTaskId">

                <!-- 任务信息显示 -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-900" id="updateTaskTitle">任务标题</h3>
                    <p class="text-sm text-gray-600 mt-1" id="updateTaskDescription">任务描述</p>
                    <div class="flex items-center space-x-3 mt-2 text-xs text-gray-500">
                        <span id="updateTaskDate">
                            <i data-lucide="calendar" class="w-3 h-3 inline"></i>
                            <span id="updateTaskDateText">-</span>
                        </span>
                        <span class="px-2 py-0.5 rounded text-xs font-medium" id="updateTaskCurrentStatus">当前状态</span>
                    </div>
                </div>

                <!-- 状态选择 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">更新状态 *</label>
                    <select id="newTaskStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="pending">待执行</option>
                        <option value="in_progress">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>

                <!-- 完成备注 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注说明</label>
                    <textarea id="taskCompletionNote" rows="3" placeholder="请输入备注信息（选填）" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <!-- 操作按钮 -->
                <div class="flex items-center justify-end space-x-3">
                    <button onclick="closeUpdateTaskModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button onclick="confirmUpdateTaskStatus()" class="px-4 py-2 bg-gradient-to-br from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-md">
                        确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/db.js"></script>
    <script src="js/core/ApiClient.js"></script>
    <script src="js/core/ApiModules.js"></script>
    <script src="js/modules/customer-profile.js"></script>
    <script>
        // 全局变量
        let currentCustomer = null;
        let currentTab = 'profile';
        let selectedPlans = [];
        let allTasks = [];
        let currentTaskFilter = 'all';
        let currentGeneratingOrder = null; // 当前要生成任务的订单

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('===== 客户详情页面初始化 =====');
            console.log('URL:', window.location.href);
            console.log('URL参数:', window.location.search);

            lucide.createIcons();

            // 更新顶部标题栏显示当前组织名称
            function updateHeaderOrgName() {
                const headerOrgNameEl = document.getElementById('header-org-name');
                const currentOrgName = localStorage.getItem('currentOrgName');
                if (headerOrgNameEl && currentOrgName) {
                    headerOrgNameEl.textContent = ' - ' + currentOrgName;
                }
            }

            // 页面加载时更新标题
            updateHeaderOrgName();

            try {
                loadCustomerData();
            } catch (error) {
                console.error('加载客户数据时出错:', error);
                UIUtils.notify('加载失败: ' + error.message, 'error');
            }
        });

        // 加载客户数据
        async function loadCustomerData() {
            const customerId = URLUtils.getParam('id');
            console.log('📍 获取到的客户ID:', customerId);

            if (!customerId) {
                UIUtils.notify('未找到客户ID，您可以创建新客户', 'warning');
                // 创建空客户对象，允许继续操作
                currentCustomer = createEmptyCustomer();
                displayCustomerHeader();
                loadProfileForms();
                return;
            }

            try {
                console.log('📡 从真实数据库 API 加载客户数据...');

                // 调用真实 API 获取客户详情
                const response = await window.apiClient.get(`/api/customers/${customerId}`);

                console.log('✅ API 响应:', response);

                if (response.success && response.data) {
                    // 转换 API 数据格式为页面需要的格式
                    const apiCustomer = response.data;

                    // 安全解析 JSON tags
                    let tags = [];
                    if (apiCustomer.tags) {
                        try {
                            tags = typeof apiCustomer.tags === 'string' ? JSON.parse(apiCustomer.tags) : apiCustomer.tags;
                            if (!Array.isArray(tags)) tags = [];
                        } catch (e) {
                            console.warn('解析tags失败:', e);
                            tags = [];
                        }
                    }

                    currentCustomer = {
                        id: apiCustomer.id,
                        name: apiCustomer.name,
                        phone: apiCustomer.phone,
                        gender: apiCustomer.gender || '未知',
                        age: calculateAge(apiCustomer.birth_date) || 0,
                        source: mapSourceChannel(apiCustomer.source_channel),
                        status: apiCustomer.status || 'active',
                        tags: tags,
                        notes: apiCustomer.remark || '',
                        createdAt: apiCustomer.created_at,
                        lastContact: apiCustomer.last_visit_at || apiCustomer.created_at,
                        // 兼容旧字段结构
                        data: {},
                        diagnosisHistory: [],
                        chatHistory: []
                    };

                    console.log('✅ 客户数据转换完成:', currentCustomer);

                    // 显示客户基本信息
                    displayCustomerHeader();

                    // 加载标签页内容
                    loadProfileForms();
                    loadDiagnosisHistory();
                    loadAvailablePlans();
                    loadCustomerSolutionGroups();
                    loadOrders();
                    loadTasks();
                    loadChatHistory();

                } else {
                    throw new Error(response.message || '获取客户数据失败');
                }

            } catch (error) {
                console.error('❌ 加载客户数据失败:', error);

                // 不跳转，而是创建空客户对象允许继续操作
                UIUtils.notify('客户数据加载失败，已创建空白资料供您填写', 'warning');

                currentCustomer = createEmptyCustomer(customerId);
                displayCustomerHeader();

                // 仍然尝试加载各个模块（可能部分功能可用）
                loadProfileForms();
                loadDiagnosisHistory();
                loadAvailablePlans();
                loadCustomerSolutionGroups();
                loadOrders();
                loadTasks();
                loadChatHistory();
            }
        }

        // 创建空客户对象
        function createEmptyCustomer(customerId = null) {
            return {
                id: customerId || 'new',
                name: '新客户',
                phone: '',
                gender: '未知',
                age: 0,
                source: '未知',
                status: 'active',
                tags: [],
                notes: '',
                createdAt: new Date().toISOString(),
                lastContact: new Date().toISOString(),
                data: {},
                diagnosisHistory: [],
                chatHistory: []
            };
        }

        // 计算年龄（从生日）
        function calculateAge(birthday) {
            if (!birthday) return null;
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // 映射来源渠道枚举值
        function mapSourceChannel(sourceChannel) {
            const sourceMap = {
                'walk_in': '到店',
                'referral': '推荐',
                'online': '线上',
                'event': '活动',
                'other': '其他'
            };
            return sourceMap[sourceChannel] || '未知';
        }

        // 注意：客户数据现在从真实数据库 API 获取，不再使用 localStorage
        // 如需更新客户数据，应调用 PUT /api/customers/:id

        // 显示客户头部信息
        function displayCustomerHeader() {
            document.getElementById('customerAvatar').textContent = currentCustomer.name.charAt(0);
            document.getElementById('customerName').textContent = currentCustomer.name;
            document.getElementById('customerPhone').textContent = currentCustomer.phone;
            document.getElementById('customerRegDate').textContent = DateUtils.format(new Date(currentCustomer.createdAt), 'YYYY-MM-DD');
            document.getElementById('customerLastContact').textContent = DateUtils.fromNow(currentCustomer.createdAt);

            // VIP等级
            const vipLevel = currentCustomer.data?.tpl_basic_info?.vip_level || '普通会员';
            document.getElementById('customerVipLevel').textContent = vipLevel;
        }

        // 初始化客户资料模块
        let profileModule = null;

        function loadProfileForms() {
            const container = document.getElementById('profileFormsContainer');

            // 创建并挂载 CustomerProfileModule
            profileModule = new CustomerProfileModule({
                customerId: currentCustomer.id
            });

            profileModule.mount(container);
        }

        // 保存客户数据（使用 CustomerProfileModule 的保存方法）
        function saveCustomerData() {
            if (profileModule && profileModule.saveProfile) {
                return profileModule.saveProfile();
            } else {
                UIUtils.notify('客户资料模块未初始化', 'error');
                return false;
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 更新桌面端标签按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target && event.target.closest('.tab-btn')) {
                event.target.closest('.tab-btn').classList.add('active');
            }

            // 更新移动端底部导航状态
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll(`.mobile-nav-btn[data-tab="${tabName}"]`).forEach(btn => {
                btn.classList.add('active');
            });

            // 更新标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            currentTab = tabName;
            lucide.createIcons();
        }


        // 加载诊断历史
        async function loadDiagnosisHistory() {
            const container = document.getElementById('diagnosisHistoryContainer');

            try {
                console.log('📡 加载诊断历史...');

                // 1. 加载单独诊断记录
                const diagnosisResponse = await fetch(`${API_BASE_URL}/api/customer-diagnoses?customer_id=${currentCustomer.id}`);
                const diagnosisResult = await diagnosisResponse.json();
                const singleDiagnoses = (diagnosisResult.success ? diagnosisResult.data : [])
                    .filter(d => !d.diagnosis_group_id); // 只显示没有诊断组的单独诊断

                // 2. 加载诊断组
                const groupResponse = await fetch(`${API_BASE_URL}/api/customer-diagnosis-groups?customer_id=${currentCustomer.id}`);
                const groupResult = await groupResponse.json();
                const diagnosisGroups = groupResult.success ? groupResult.data : [];

                console.log(`✅ 加载完成: ${singleDiagnoses.length} 条单独诊断, ${diagnosisGroups.length} 个诊断组`);

                // 3. 合并并排序
                const allItems = [
                    ...singleDiagnoses.map((d, i) => ({ type: 'single', data: d, index: i })),
                    ...diagnosisGroups.map((g, i) => ({ type: 'group', data: g, index: i }))
                ];

                // 按日期倒序排列
                allItems.sort((a, b) => {
                    const dateA = new Date(a.data.diagnose_date || a.data.created_at || 0);
                    const dateB = new Date(b.data.diagnose_date || b.data.created_at || 0);
                    return dateB - dateA;
                });

                if (allItems.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                            <i data-lucide="stethoscope" class="w-12 h-12 mx-auto mb-2"></i>
                            <p class="text-sm">暂无诊断记录</p>
                            <p class="text-xs mt-2 text-gray-500">点击"新建诊断"或"创建诊断组"开始记录</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // 4. 渲染所有项
                container.innerHTML = allItems.map((item, index) => {
                    if (item.type === 'single') {
                        return renderSingleDiagnosisCard(item.data, allItems.length - index);
                    } else {
                        return renderDiagnosisGroupCard(item.data, allItems.length - index);
                    }
                }).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('❌ 加载诊断历史失败:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 py-8 bg-red-50 rounded-lg border border-red-200">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p class="text-sm">加载诊断历史失败</p>
                        <p class="text-xs mt-2">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // 渲染单独诊断卡片
        function renderSingleDiagnosisCard(record, serialNumber) {
            const diagnoseData = typeof record.diagnose_data === 'string'
                ? JSON.parse(record.diagnose_data)
                : record.diagnose_data || {};

            return `
                <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow relative">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-900">
                            ${DateUtils.format(new Date(record.diagnose_date), 'YYYY-MM-DD HH:mm')}
                        </span>
                        <div class="flex items-center space-x-1">
                            <span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">
                                综合诊断
                            </span>
                            <button onclick="showDiagnosisSummary(${record.id})"
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-1"
                                    title="查看摘要">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                            </button>
                            <button onclick="editDiagnosis(${record.id})"
                                    class="text-green-500 hover:text-green-700 transition-colors p-1"
                                    title="编辑诊断">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteDiagnosis(${record.id})"
                                    class="text-red-500 hover:text-red-700 transition-colors p-1"
                                    title="删除诊断记录">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        ${record.skin_type ? `<div>肤质: ${translateSkinType(record.skin_type)}</div>` : ''}
                        ${record.hair_type ? `<div>发质: ${translateHairType(record.hair_type)}</div>` : ''}
                        ${Object.keys(diagnoseData).length > 0 ? `<div>记录项: ${Object.keys(diagnoseData).length} 项</div>` : ''}
                    </div>
                    ${record.suggestions ? `
                        <div class="text-xs text-gray-500 mt-2 line-clamp-2">
                            ${record.suggestions}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 渲染诊断组卡片（折叠式）
        function renderDiagnosisGroupCard(group, serialNumber) {
            const groupDate = new Date(group.created_at).toLocaleDateString('zh-CN');
            const templateCount = group.templates ? group.templates.length : 0;

            return `
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-300 p-4 hover:shadow-md transition-shadow">
                    <!-- 组头部 -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-semibold">
                                诊断组 #${serialNumber}
                            </div>
                            <span class="text-sm text-gray-700 font-medium">${groupDate}</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">
                                ${templateCount} 个模板
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleDiagnosisGroupDetail('${group.group_id}')"
                                    class="text-gray-600 hover:text-purple-600 transition-colors p-1"
                                    title="展开/折叠">
                                <i data-lucide="chevron-down" class="w-5 h-5 diagnosis-group-chevron-${group.group_id}" style="transition: transform 0.3s;"></i>
                            </button>
                            <button onclick="deleteDiagnosisGroup('${group.group_id}')"
                                    class="text-red-500 hover:text-red-700 transition-colors p-1"
                                    title="删除诊断组">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 模板标签 -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${(group.templates || []).map(t => `
                            <span class="px-2 py-1 bg-white border border-purple-200 rounded text-xs text-gray-700">
                                ${t.template_name}
                            </span>
                        `).join('')}
                    </div>

                    <!-- 展开的诊断详情 -->
                    <div id="diagnosisGroupDetail_${group.group_id}" class="hidden mt-4 border-t border-purple-200 pt-4 space-y-3">
                        <!-- 动态加载诊断内容 -->
                        <div class="text-center py-4 text-gray-500">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin inline"></i> 加载中...
                        </div>
                    </div>
                </div>
            `;
        }

        // 切换诊断组展开/折叠
        async function toggleDiagnosisGroupDetail(groupId) {
            const detailDiv = document.getElementById(`diagnosisGroupDetail_${groupId}`);
            const chevron = document.querySelector(`.diagnosis-group-chevron-${groupId}`);

            if (detailDiv.classList.contains('hidden')) {
                // 展开：加载诊断详情
                try {
                    const response = await fetch(`${API_BASE_URL}/api/customer-diagnoses?diagnosis_group_id=${groupId}`);
                    const result = await response.json();

                    if (result.success && result.data && result.data.length > 0) {
                        const diagnoses = result.data;
                        detailDiv.innerHTML = diagnoses.map(diagnosis => {
                            const diagnoseData = typeof diagnosis.diagnose_data === 'string'
                                ? JSON.parse(diagnosis.diagnose_data)
                                : diagnosis.diagnose_data || {};

                            return `
                                <div class="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-sm transition-shadow">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-gray-900">${diagnosis.template_name || '诊断'}</h4>
                                            <p class="text-xs text-gray-500 mt-1">${DateUtils.format(new Date(diagnosis.diagnose_date), 'YYYY-MM-DD HH:mm')}</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="editDiagnosis(${diagnosis.id})"
                                                    class="text-blue-600 hover:text-blue-800 transition-colors p-1"
                                                    title="编辑">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="deleteDiagnosis(${diagnosis.id})"
                                                    class="text-red-600 hover:text-red-800 transition-colors p-1"
                                                    title="删除">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        ${diagnosis.skin_type ? `<div>肤质: ${translateSkinType(diagnosis.skin_type)}</div>` : ''}
                                        ${diagnosis.hair_type ? `<div>发质: ${translateHairType(diagnosis.hair_type)}</div>` : ''}
                                        ${Object.keys(diagnoseData).length > 0 ? `<div>记录项: ${Object.keys(diagnoseData).length} 项</div>` : ''}
                                    </div>
                                    ${diagnosis.suggestions ? `
                                        <div class="text-xs text-gray-500 mt-2 line-clamp-2">
                                            <strong>建议:</strong> ${diagnosis.suggestions}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                        lucide.createIcons();
                    } else {
                        detailDiv.innerHTML = '<p class="text-gray-500 text-center py-4">暂无诊断记录</p>';
                    }
                } catch (error) {
                    console.error('加载诊断组详情失败:', error);
                    detailDiv.innerHTML = `<p class="text-red-500 text-center py-4">加载失败: ${error.message}</p>`;
                }

                detailDiv.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                // 折叠
                detailDiv.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // 删除诊断组
        async function deleteDiagnosisGroup(groupId) {
            if (!confirm('确定要删除这个诊断组吗？组内所有诊断记录都将被删除。')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/customer-diagnosis-groups/group/${groupId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    console.log('✅ 诊断组已删除');
                    UIUtils.notify('诊断组已删除', 'success');
                    await loadDiagnosisHistory();
                } else {
                    throw new Error(result.message || '删除失败');
                }
            } catch (error) {
                console.error('❌ 删除诊断组失败:', error);
                UIUtils.notify('删除失败: ' + error.message, 'error');
            }
        }

        // 翻译肤质类型
        function translateSkinType(type) {
            const types = {
                'dry': '干性',
                'oily': '油性',
                'combination': '混合性',
                'sensitive': '敏感性',
                'normal': '中性'
            };
            return types[type] || type;
        }

        // 翻译发质类型
        function translateHairType(type) {
            const types = {
                'dry': '干性',
                'oily': '油性',
                'normal': '中性',
                'damaged': '受损'
            };
            return types[type] || type;
        }


        // 加载可用方案模板
        async function loadAvailablePlans() {
            const container = document.getElementById('availablePlansContainer');

            try {
                console.log('📡 从真实数据库 API 加载方案模板...');

                // 调用真实 API 获取方案模板列表
                const response = await window.apiClient.get('/api/solution-templates', {
                    page: 1,
                    pageSize: 100
                });

                console.log('✅ 方案模板 API 响应:', response);

                if (!response.success || !response.data || !response.data.items) {
                    throw new Error(response.message || '获取方案模板失败');
                }

                const templates = response.data.items;

                if (templates.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                            <p>暂无方案模板</p>
                            <p class="text-xs mt-2 text-gray-500">请先在方案模板管理中添加方案模板</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // 渲染方案模板列表
                container.innerHTML = templates.map(template => `
                    <div class="plan-card" onclick="togglePlanSelection(${template.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 mr-3">
                                <h4 class="font-semibold text-gray-900">${template.template_name}</h4>
                                <p class="text-sm text-gray-600 mt-1 line-clamp-2">${template.expected_effects || '暂无描述'}</p>
                                <div class="flex items-center space-x-3 mt-2 text-xs text-gray-500">
                                    ${template.category ? `<span class="badge badge-blue">${template.category}</span>` : ''}
                                    ${template.course_duration ? `<span>${template.course_duration}</span>` : ''}
                                    ${template.estimated_price_min && template.estimated_price_max ?
                                        `<span class="text-purple-600 font-medium">¥${template.estimated_price_min}-${template.estimated_price_max}</span>` : ''}
                                </div>
                            </div>
                            <div class="ml-2">
                                <input type="checkbox" id="plan_${template.id}" class="w-5 h-5 text-purple-600 rounded pointer-events-none">
                            </div>
                        </div>
                    </div>
                `).join('');

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载方案模板失败:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 py-8 bg-red-50 rounded-lg border border-red-200">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>加载方案模板失败</p>
                        <p class="text-xs mt-2">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // 切换方案选择
        function togglePlanSelection(planId) {
            const checkbox = document.getElementById('plan_' + planId);
            checkbox.checked = !checkbox.checked;

            const card = checkbox.closest('.plan-card');
            if (checkbox.checked) {
                card.classList.add('selected');
                if (!selectedPlans.includes(planId)) {
                    selectedPlans.push(planId);
                }
            } else {
                card.classList.remove('selected');
                selectedPlans = selectedPlans.filter(id => id !== planId);
            }

            updateSelectedCount();
        }

        // 更新选中计数
        function updateSelectedCount() {
            const countSpan = document.getElementById('selectedCount');
            const addBtn = document.getElementById('addPlansBtn');

            countSpan.textContent = selectedPlans.length;

            if (selectedPlans.length > 0) {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // 添加已选方案(创建方案组)
        async function addSelectedPlans() {
            if (selectedPlans.length === 0) {
                UIUtils.notify('请先选择方案', 'warning');
                return;
            }

            try {
                console.log('📡 添加已选方案到客户方案组...', selectedPlans);

                // 提交到 API
                const response = await window.apiClient.post('/api/customer-solutions', {
                    customer_id: currentCustomer.id,
                    org_id: currentCustomer.org_id || 1,
                    solution_template_ids: selectedPlans,
                    created_by: 1  // TODO: 获取当前登录用户ID
                });

                console.log('✅ 添加方案成功:', response);

                if (!response.success) {
                    throw new Error(response.message || '添加方案失败');
                }

                UIUtils.notify(`✅ 成功添加 ${selectedPlans.length} 个方案`, 'success');

                // 清空选中状态
                selectedPlans.forEach(planId => {
                    const checkbox = document.getElementById('plan_' + planId);
                    if (checkbox) {
                        checkbox.checked = false;
                        checkbox.closest('.plan-card').classList.remove('selected');
                    }
                });
                selectedPlans = [];
                updateSelectedCount();

                // 重新加载客户方案组
                await loadCustomerSolutionGroups();

            } catch (error) {
                console.error('❌ 添加方案失败:', error);
                UIUtils.notify('添加失败: ' + error.message, 'error');
            }
        }

        // 加载客户方案组
        async function loadCustomerSolutionGroups() {
            const container = document.getElementById('customerSolutionGroupsContainer');

            try {
                console.log('📡 从真实数据库 API 加载客户方案组...');

                // 调用真实 API 获取客户方案组
                const response = await window.apiClient.get('/api/customer-solutions', {
                    customer_id: currentCustomer.id
                });

                console.log('✅ 客户方案组 API 响应:', response);

                if (!response.success) {
                    throw new Error(response.message || '获取客户方案组失败');
                }

                const groups = response.data || [];

                if (groups.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                            <p>暂无方案组</p>
                            <p class="text-xs mt-2 text-gray-500">请从左侧选择方案模板添加</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // 渲染方案组列表
                container.innerHTML = groups.map((group, index) => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h4 class="font-semibold text-gray-900">方案组 ${groups.length - index}</h4>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">
                                        ${group.solutions.length} 个方案
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500">
                                    创建时间: ${DateUtils.format(new Date(group.created_at), 'YYYY-MM-DD HH:mm')}
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${(() => {
                                    // 检查是否已生成订单（任一方案有order_generated=1则整个组已生成）
                                    const isGenerated = group.solutions.some(s => s.order_generated === 1);

                                    if (isGenerated) {
                                        return `
                                            <button disabled
                                                    class="px-3 py-1.5 bg-gray-400 text-white rounded-lg cursor-not-allowed text-sm font-medium"
                                                    title="该方案组已生成订单">
                                                <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                                已生成订单
                                            </button>
                                        `;
                                    } else {
                                        return `
                                            <button onclick="showGenerateOrderModal('${group.plan_group_id}')"
                                                    class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                                                    title="生成订单">
                                                <i data-lucide="plus-square" class="w-4 h-4 inline mr-1"></i>
                                                生成订单
                                            </button>
                                        `;
                                    }
                                })()}
                                <button onclick="deleteSolutionGroup('${group.plan_group_id}')"
                                        class="text-red-500 hover:text-red-700 transition-colors p-1"
                                        title="删除方案组">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${group.solutions.map(solution => `
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="font-medium text-gray-900 text-sm">${solution.template_name}</h5>
                                            ${solution.expected_effects ?
                                                `<p class="text-xs text-gray-600 mt-1 line-clamp-2">${solution.expected_effects}</p>` : ''}
                                            <div class="flex items-center space-x-2 mt-2 text-xs">
                                                ${solution.category ? `<span class="badge badge-blue">${solution.category}</span>` : ''}
                                                ${solution.course_duration ? `<span class="text-gray-500">${solution.course_duration}</span>` : ''}
                                                ${solution.estimated_price_min && solution.estimated_price_max ?
                                                    `<span class="text-purple-600 font-medium">¥${solution.estimated_price_min}-${solution.estimated_price_max}</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载客户方案组失败:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 py-8 bg-red-50 rounded-lg border border-red-200">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>加载客户方案组失败</p>
                        <p class="text-xs mt-2">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // 删除方案组
        async function deleteSolutionGroup(groupId) {
            if (!confirm('确定要删除这个方案组吗？此操作不可恢复。')) {
                return;
            }

            try {
                console.log('📡 删除方案组:', groupId);

                const response = await window.apiClient.delete(`/api/customer-solutions/group/${groupId}`);

                console.log('✅ 删除方案组成功:', response);

                if (!response.success) {
                    throw new Error(response.message || '删除方案组失败');
                }

                UIUtils.notify('方案组已删除', 'success');

                // 重新加载客户方案组
                await loadCustomerSolutionGroups();

            } catch (error) {
                console.error('❌ 删除方案组失败:', error);
                UIUtils.notify('删除失败: ' + error.message, 'error');
            }
        }

        // 刷新方案
        function refreshPlans() {
            loadAvailablePlans();
            UIUtils.notify('方案列表已刷新', 'success');
        }

        // 加载订单
        async function loadOrders() {
            const container = document.getElementById('ordersContainer');

            try {
                console.log('📡 从真实数据库 API 加载订单数据...');

                // 调用真实 API 获取客户订单列表
                const response = await window.apiClient.get('/api/orders', {
                    customer_id: currentCustomer.id,
                    page: 1,
                    pageSize: 100  // 获取所有订单
                });

                console.log('✅ 订单 API 响应:', response);

                if (!response.success || !response.data || !response.data.list) {
                    throw new Error(response.message || '获取订单数据失败');
                }

                const orders = response.data.list;

                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                            <i data-lucide="shopping-cart" class="w-12 h-12 mx-auto mb-2"></i>
                            <p>暂无订单记录</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = orders.map(order => {
                    const isPending = order.order_status === 'pending';
                    const canEdit = isPending;  // 只有待确认状态的订单可以修改

                    return `
                        <div class="order-card bg-white rounded-lg border border-gray-200 p-4 mb-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <h4 class="font-semibold text-gray-900">订单 ${order.order_no || order.id}</h4>
                                    <span class="status-badge status-${order.order_status || 'pending'}">${getOrderStatusText(order.order_status || 'pending')}</span>
                                </div>
                                <span class="text-lg font-bold text-purple-600">${NumberUtils.formatMoney(order.final_amount || 0)}</span>
                            </div>
                            <div class="space-y-1 mb-3">
                                <div class="text-sm text-gray-600">
                                    <p>服务日期: ${order.service_date || '待定'}</p>
                                    ${order.remark ? `<p class="mt-1 text-xs text-gray-500">备注: ${order.remark}</p>` : ''}
                                </div>
                            </div>
                            <div class="pt-3 border-t border-gray-200 flex items-center justify-between">
                                <span class="text-xs text-gray-500">创建时间: ${DateUtils.format(new Date(order.created_at), 'YYYY-MM-DD HH:mm')}</span>
                                <div class="flex items-center space-x-2">
                                    ${canEdit ? `
                                        <button onclick="event.stopPropagation(); showEditOrderModal(${order.id})"
                                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                            <i data-lucide="edit" class="w-3 h-3 inline mr-1"></i>
                                            修改
                                        </button>
                                        <button onclick="event.stopPropagation(); confirmOrder(${order.id})"
                                                class="px-3 py-1 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                            <i data-lucide="check" class="w-3 h-3 inline mr-1"></i>
                                            确认
                                        </button>
                                    ` : ''}
                                    ${(order.order_status === 'pending' || order.order_status === 'confirmed' || order.order_status === 'in_progress') ? `
                                        <button onclick="event.stopPropagation(); showGenerateTaskModal(${order.id})"
                                                class="px-3 py-1 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                            <i data-lucide="list-checks" class="w-3 h-3 inline mr-1"></i>
                                            生成任务
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载订单数据失败:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 py-8 bg-white rounded-lg border border-red-200">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>加载订单失败: ${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // 获取订单状态文本
        function getOrderStatusText(status) {
            const statusMap = {
                pending: '待确认',
                confirmed: '已确认',
                paid: '已支付',
                in_progress: '进行中',
                completed: '已完成',
                cancelled: '已取消'
            };
            return statusMap[status] || status;
        }

        // 查看订单详情
        function viewOrderDetail(orderId) {
            UIUtils.notify('订单详情页面开发中...', 'info');
            // TODO: 跳转到订单详情页面
            // window.location.href = `order-detail.html?id=${orderId}`;
        }

        // 创建新订单
        function createNewOrder() {
            // 切换到方案管理标签页
            switchTab('plans');
            UIUtils.notify('请在方案管理中选择方案后生成订单', 'info');
        }

        // 加载任务
        async function loadTasks() {
            try {
                console.log('📡 从真实数据库 API 加载任务数据...');

                // 调用真实 API 获取客户任务列表
                const response = await window.apiClient.get('/api/tasks', {
                    customer_id: currentCustomer.id,
                    page: 1,
                    pageSize: 100  // 获取所有任务
                });

                console.log('✅ 任务 API 响应:', response);

                if (!response.success || !response.data || !response.data.list) {
                    throw new Error(response.message || '获取任务数据失败');
                }

                allTasks = response.data.list;
                renderTasks();

            } catch (error) {
                console.error('❌ 加载任务数据失败:', error);
                allTasks = [];
                renderTasks();
            }
        }

        // 渲染任务列表
        function renderTasks() {
            const container = document.getElementById('tasksContainer');

            // 根据筛选条件过滤任务
            let filteredTasks = allTasks;
            if (currentTaskFilter !== 'all') {
                filteredTasks = allTasks.filter(t => t.status === currentTaskFilter);
            }

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                        <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无任务记录</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // 按状态分组
            const groupedTasks = {};
            filteredTasks.forEach(task => {
                if (!groupedTasks[task.status]) {
                    groupedTasks[task.status] = [];
                }
                groupedTasks[task.status].push(task);
            });

            let html = '';
            Object.keys(groupedTasks).forEach(status => {
                html += `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">${getTaskStatusText(status)} (${groupedTasks[status].length})</h4>
                        <div class="space-y-2">
                            ${groupedTasks[status].map(task => `
                                <div class="bg-white border-l-4 task-${task.status} rounded-lg p-4 border border-gray-200">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="font-semibold text-gray-900">${task.title}</h5>
                                            <p class="text-sm text-gray-600 mt-1">${task.description}</p>
                                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                                <span><i data-lucide="calendar" class="w-3 h-3 inline"></i> ${task.scheduledDate}</span>
                                                <span><i data-lucide="clock" class="w-3 h-3 inline"></i> ${task.scheduledTime}</span>
                                                ${task.frequency ? `<span class="badge badge-gray">${task.frequency === 'daily' ? '每日' : task.frequency === 'weekly' ? '每周' : '一次性'}</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="ml-4 flex flex-col space-y-2">
                                            ${task.status !== 'completed' && task.status !== 'cancelled' ? `
                                                <button onclick="showUpdateTaskModal(${task.id})" class="text-sm text-purple-600 hover:text-purple-700 px-3 py-1 border border-purple-600 rounded-lg hover:bg-purple-50 transition-colors whitespace-nowrap">
                                                    更新状态
                                                </button>
                                            ` : ''}
                                            <button onclick="viewTaskDetail(${task.id})" class="text-sm text-blue-600 hover:text-blue-700 px-3 py-1 border border-blue-600 rounded-lg hover:bg-blue-50 transition-colors whitespace-nowrap">
                                                查看详情
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons();
        }

        // 获取任务状态文本
        function getTaskStatusText(status) {
            const statusMap = {
                pending: '待执行',
                in_progress: '进行中',
                completed: '已完成',
                cancelled: '已取消',
                overdue: '已逾期'
            };
            return statusMap[status] || status;
        }

        // 筛选任务
        function filterTasks(status) {
            currentTaskFilter = status;

            // 更新按钮状态
            document.querySelectorAll('.task-filter-btn').forEach(btn => {
                btn.classList.remove('bg-purple-100', 'text-purple-700', 'active');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });

            const activeBtn = document.querySelector(`.task-filter-btn[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                activeBtn.classList.add('bg-purple-100', 'text-purple-700', 'active');
            }

            renderTasks();
        }

        // 显示更新任务状态模态框
        function showUpdateTaskModal(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) {
                UIUtils.notify('任务不存在', 'error');
                return;
            }

            // 填充任务信息
            document.getElementById('updateTaskId').value = task.id;
            document.getElementById('updateTaskTitle').textContent = task.title || '未命名任务';
            document.getElementById('updateTaskDescription').textContent = task.description || '暂无描述';

            // 显示日期信息
            const dateText = task.due_date
                ? DateUtils.format(new Date(task.due_date), 'YYYY-MM-DD')
                : (task.scheduledDate || '-');
            document.getElementById('updateTaskDateText').textContent = dateText;

            // 显示当前状态
            const statusEl = document.getElementById('updateTaskCurrentStatus');
            statusEl.textContent = getTaskStatusText(task.status);
            statusEl.className = `px-2 py-0.5 rounded text-xs font-medium task-status-${task.status}`;

            // 设置状态下拉框默认值
            document.getElementById('newTaskStatus').value = task.status;

            // 清空备注
            document.getElementById('taskCompletionNote').value = task.completion_note || '';

            // 显示模态框
            document.getElementById('updateTaskModal').classList.remove('hidden');
            document.body.classList.add('no-scroll');

            // 重新创建图标
            lucide.createIcons();
        }

        // 关闭更新任务状态模态框
        function closeUpdateTaskModal() {
            document.getElementById('updateTaskModal').classList.add('hidden');
            document.body.classList.remove('no-scroll');
        }

        // 确认更新任务状态
        async function confirmUpdateTaskStatus() {
            const taskId = document.getElementById('updateTaskId').value;
            const newStatus = document.getElementById('newTaskStatus').value;
            const completionNote = document.getElementById('taskCompletionNote').value;

            if (!taskId || !newStatus) {
                UIUtils.notify('请选择状态', 'warning');
                return;
            }

            try {
                console.log('📡 更新任务状态:', { taskId, newStatus, completionNote });

                // 调用API更新任务状态
                const response = await window.apiClient.patch(`/api/tasks/${taskId}`, {
                    status: newStatus,
                    completion_note: completionNote,
                    updated_by: 1  // TODO: 获取当前登录用户ID
                });

                if (response.success) {
                    UIUtils.notify(`任务状态已更新为"${getTaskStatusText(newStatus)}"`, 'success');
                    closeUpdateTaskModal();

                    // 重新加载任务列表
                    await loadTasks();
                } else {
                    throw new Error(response.message || '更新任务状态失败');
                }
            } catch (error) {
                console.error('❌ 更新任务状态失败:', error);
                UIUtils.notify('更新失败: ' + error.message, 'error');
            }
        }

        // 查看任务详情
        function viewTaskDetail(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) {
                UIUtils.notify('任务不存在', 'error');
                return;
            }

            // 构建详情HTML
            const detailHtml = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${task.title || '未命名任务'}</h3>
                        <p class="text-sm text-gray-600">${task.description || '暂无描述'}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">任务编号</div>
                            <div class="text-sm font-medium text-gray-900">${task.task_no || '-'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">任务状态</div>
                            <span class="px-2 py-1 rounded text-xs font-medium task-status-${task.status}">${getTaskStatusText(task.status)}</span>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">截止日期</div>
                            <div class="text-sm text-gray-900">${task.due_date ? DateUtils.format(new Date(task.due_date), 'YYYY-MM-DD') : '-'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">提醒时间</div>
                            <div class="text-sm text-gray-900">${task.reminder_time ? DateUtils.format(new Date(task.reminder_time), 'YYYY-MM-DD HH:mm') : '-'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">优先级</div>
                            <div class="text-sm text-gray-900">${task.priority === 'high' ? '高' : task.priority === 'medium' ? '中' : '低'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">分配给</div>
                            <div class="text-sm text-gray-900">${task.assigned_to_name || '-'}</div>
                        </div>
                    </div>

                    ${task.completion_note ? `
                        <div>
                            <div class="text-xs text-gray-500 mb-1">完成备注</div>
                            <div class="p-3 bg-blue-50 rounded-lg text-sm text-gray-900">${task.completion_note}</div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <div>
                            <div class="mb-1">创建时间</div>
                            <div>${task.created_at ? DateUtils.format(new Date(task.created_at), 'YYYY-MM-DD HH:mm') : '-'}</div>
                        </div>
                        <div>
                            <div class="mb-1">更新时间</div>
                            <div>${task.updated_at ? DateUtils.format(new Date(task.updated_at), 'YYYY-MM-DD HH:mm') : '-'}</div>
                        </div>
                    </div>
                </div>
            `;

            // 使用confirm样式的对话框显示详情
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 bg-white">
                        <h2 class="text-xl font-bold text-gray-900">任务详情</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        ${detailHtml}
                        <div class="mt-6 flex items-center justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                关闭
                            </button>
                            ${task.status !== 'completed' && task.status !== 'cancelled' ? `
                                <button onclick="this.closest('.fixed').remove(); showUpdateTaskModal(${task.id})" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                    更新状态
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // 加载对话历史 - 从真实数据库 API 加载,支持日期筛选
        async function loadChatHistory() {
            const container = document.getElementById('chatMessagesContainer');

            try {
                // 获取日期筛选条件
                const startDate = document.getElementById('chatStartDate')?.value;
                const endDate = document.getElementById('chatEndDate')?.value;

                // 构建API查询参数
                let apiUrl = `/api/chat-messages/${currentCustomer.id}`;
                const params = [];

                if (startDate) {
                    params.push(`start_date=${startDate}`);
                }
                if (endDate) {
                    // 结束日期加1天,以包含当天的所有消息
                    const end = new Date(endDate);
                    end.setDate(end.getDate() + 1);
                    params.push(`end_date=${end.toISOString().split('T')[0]}`);
                }

                if (params.length > 0) {
                    apiUrl += '?' + params.join('&');
                }

                console.log('📋 查询聊天历史:', apiUrl);

                // 从数据库 API 获取聊天记录
                const response = await window.apiClient.get(apiUrl);

                if (!response.success) {
                    throw new Error(response.error?.message || '加载聊天记录失败');
                }

                const chatHistory = response.data || [];

                // 显示筛选结果提示
                let filterText = '';
                if (startDate || endDate) {
                    filterText = ` (${startDate || '开始'} ~ ${endDate || '今天'})`;
                }

                if (chatHistory.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-2"></i>
                            <p>暂无对话记录${filterText}</p>
                            ${filterText ? '<p class="text-sm mt-1">尝试调整日期筛选条件</p>' : '<p class="text-sm mt-1">开始和AI美容助手对话吧</p>'}
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = chatHistory.map(msg => `
                    <div class="chat-bubble ${msg.role}" style="display: flex; flex-direction: column; ${msg.role === 'user' ? 'align-items: flex-end;' : 'align-items: flex-start;'}">
                        <p class="text-sm">${msg.content}</p>
                        <span class="text-xs opacity-75 mt-1">${DateUtils.format(new Date(msg.created_at), 'MM-DD HH:mm')}</span>
                    </div>
                `).join('');

                // 滚动到底部
                container.scrollTop = container.scrollHeight;
                lucide.createIcons();

                console.log(`✅ 加载了 ${chatHistory.length} 条聊天记录${filterText}`);

            } catch (error) {
                console.error('❌ 加载聊天记录失败:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>加载聊天记录失败</p>
                        <p class="text-sm mt-1">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // 重置日期筛选
        function resetChatDateFilter() {
            document.getElementById('chatStartDate').value = '';
            document.getElementById('chatEndDate').value = '';
            loadChatHistory();
        }

        // 发送聊天消息 - 保存到真实数据库
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // 清空输入框
            input.value = '';

            // 禁用输入框,防止重复提交
            input.disabled = true;

            try {
                // 保存用户消息到数据库
                const userMessageResponse = await window.apiClient.post('/api/chat-messages', {
                    customer_id: currentCustomer.id,
                    org_id: currentCustomer.org_id,
                    role: 'user',
                    content: message,
                    created_by: null  // 或者传入当前登录用户ID
                });

                if (!userMessageResponse.success) {
                    throw new Error('保存用户消息失败');
                }

                // 刷新聊天记录显示
                await loadChatHistory();

                // 模拟AI回复
                setTimeout(async () => {
                    const aiResponses = [
                        '感谢您的咨询,我们的专业美容顾问会尽快为您解答。',
                        '根据您的情况,我建议您可以尝试我们的深度清洁护理方案。',
                        '为了给您更准确的建议,请问您目前主要关注哪方面的美容需求?',
                        '您提到的问题很常见,通常我们会推荐结合内调和外养的方式来改善。',
                        '这是一个很好的问题!让我为您详细解答一下...'
                    ];

                    const aiMessage = aiResponses[Math.floor(Math.random() * aiResponses.length)];

                    // 保存AI回复到数据库
                    const aiMessageResponse = await window.apiClient.post('/api/chat-messages', {
                        customer_id: currentCustomer.id,
                        org_id: currentCustomer.org_id,
                        role: 'assistant',
                        content: aiMessage,
                        created_by: null
                    });

                    if (aiMessageResponse.success) {
                        // 刷新聊天记录显示
                        await loadChatHistory();
                    }

                    // 重新启用输入框
                    input.disabled = false;
                    input.focus();
                }, 1000);

            } catch (error) {
                console.error('❌ 发送消息失败:', error);
                UIUtils.notify('发送消息失败: ' + error.message, 'error');

                // 重新启用输入框
                input.disabled = false;
                input.value = message;  // 恢复用户输入的内容
            }
        }

        // 处理回车发送
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // 清空对话历史
        function clearChatHistory() {
            if (confirm('确定要清空所有对话记录吗?')) {
                currentCustomer.chatHistory = [];
                loadChatHistory();
                UIUtils.notify('对话记录已清空', 'success');
            }
        }

        // 生成AI客户画像
        async function generateAIProfile() {
            document.getElementById('aiProfileModal').classList.remove('hidden');

            // 显示加载动画
            const content = document.getElementById('aiProfileContent');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-600">AI 正在分析客户数据...</p>
                    <p class="text-sm text-gray-500 mt-2">这可能需要20-30秒</p>
                </div>
            `;

            try {
                console.log('📡 调用 AI 客户画像生成 API...');

                // 准备客户数据
                const customerData = {
                    name: currentCustomer.name,
                    age: currentCustomer.age || 30,
                    gender: currentCustomer.gender || 'female',
                    tags: currentCustomer.tags || [],
                    status: currentCustomer.status || 'active',
                    org_id: currentCustomer.org_id || 1
                };

                console.log('📋 客户数据:', customerData);

                // 调用 AI 生成 API
                const response = await window.apiClient.post('/api/ai/generate-customer-profile', {
                    customer_id: currentCustomer.id,
                    customer_data: customerData
                });

                console.log('✅ AI 画像生成成功:', response);

                if (!response.success || !response.data) {
                    throw new Error(response.message || 'AI 画像生成失败');
                }

                // 显示生成的画像
                displayAIProfile(response.data);

                // 显示"查看历史"按钮
                document.getElementById('viewHistoryBtn').classList.remove('hidden');

            } catch (error) {
                console.error('❌ AI 画像生成失败:', error);

                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <i data-lucide="alert-circle" class="w-16 h-16 text-red-400 mb-4"></i>
                        <p class="text-red-600 font-semibold mb-2">AI 画像生成失败</p>
                        <p class="text-sm text-gray-600">${error.message}</p>
                        <button onclick="generateAIProfile()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            重新生成
                        </button>
                    </div>
                `;

                lucide.createIcons();
            }
        }

        // 显示AI画像
        function displayAIProfile(profile) {
            const content = document.getElementById('aiProfileContent');
            content.innerHTML = `
                <div class="ai-card">
                    <h4 class="text-lg font-bold mb-2">AI智能分析结果</h4>
                    <p class="text-sm opacity-90">基于客户历史数据的深度分析</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">性格特征</h5>
                        <p class="text-gray-700">${profile.personalityType}</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">美容目标</h5>
                        <div class="flex flex-wrap gap-2">
                            ${profile.beautyGoals.map(goal => `
                                <span class="badge badge-purple">${goal}</span>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">消费能力</h5>
                        <p class="text-gray-700">${profile.purchasePower}</p>
                        <p class="text-sm text-gray-600 mt-1">预估终身价值: ${profile.lifetimeValue}</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">偏好分析</h5>
                        <p class="text-gray-700">${profile.preferences}</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">推荐服务</h5>
                        <div class="space-y-2">
                            ${profile.recommendedServices.map(service => `
                                <div class="flex items-start space-x-2">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
                                    <div>
                                        <div class="font-medium text-gray-900">${service.name}</div>
                                        <div class="text-sm text-gray-600">${service.reason}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">维护策略</h5>
                        <p class="text-gray-700">${profile.engagementStrategy}</p>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="shield-check" class="w-5 h-5 text-green-600"></i>
                            <span class="font-semibold text-green-900">${profile.riskLevel}</span>
                        </div>
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // 关闭AI画像模态框
        function closeAIProfileModal() {
            document.getElementById('aiProfileModal').classList.add('hidden');

            // 重置视图状态
            document.getElementById('aiProfileContent').classList.remove('hidden');
            document.getElementById('aiProfileHistory').classList.add('hidden');
            document.getElementById('viewHistoryText').textContent = '查看历史';
            document.getElementById('viewHistoryBtn').classList.add('hidden');
        }

        // 切换当前画像和历史版本视图
        function toggleProfileView() {
            const currentView = document.getElementById('aiProfileContent');
            const historyView = document.getElementById('aiProfileHistory');
            const toggleBtn = document.getElementById('viewHistoryText');

            if (currentView.classList.contains('hidden')) {
                // 当前显示历史,切换到当前画像
                currentView.classList.remove('hidden');
                historyView.classList.add('hidden');
                toggleBtn.textContent = '查看历史';
            } else {
                // 当前显示画像,切换到历史
                currentView.classList.add('hidden');
                historyView.classList.remove('hidden');
                toggleBtn.textContent = '返回当前';

                // 加载历史版本
                loadProfileHistory();
            }

            lucide.createIcons();
        }

        // 加载 AI 画像历史版本
        async function loadProfileHistory() {
            const container = document.getElementById('aiProfileHistory');

            // 显示加载动画
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-600">正在加载历史版本...</p>
                </div>
            `;

            try {
                console.log('📡 加载 AI 画像历史版本...');

                // 调用历史版本 API
                const response = await window.apiClient.get(`/api/ai/customer-profiles/${currentCustomer.id}/history`);

                console.log('✅ 历史版本数据:', response);

                if (!response.success || !response.data) {
                    throw new Error(response.message || '加载历史版本失败');
                }

                const historyList = response.data;

                if (historyList.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <i data-lucide="inbox" class="w-16 h-16 text-gray-300 mb-4"></i>
                            <p class="text-gray-500">暂无历史版本</p>
                            <p class="text-sm text-gray-400 mt-2">这是第一次生成 AI 客户画像</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // 显示历史版本列表
                displayProfileHistory(historyList);

            } catch (error) {
                console.error('❌ 加载历史版本失败:', error);

                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <i data-lucide="alert-circle" class="w-16 h-16 text-red-400 mb-4"></i>
                        <p class="text-red-600 font-semibold mb-2">加载历史版本失败</p>
                        <p class="text-sm text-gray-600">${error.message}</p>
                        <button onclick="loadProfileHistory()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            重新加载
                        </button>
                    </div>
                `;

                lucide.createIcons();
            }
        }

        // 显示历史版本列表
        function displayProfileHistory(historyList) {
            const container = document.getElementById('aiProfileHistory');

            const html = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900">历史版本 (${historyList.length})</h4>
                        <span class="text-sm text-gray-500">点击查看详情</span>
                    </div>

                    ${historyList.map((profile, index) => {
                        const isLatest = profile.is_latest;
                        const versionDate = new Date(profile.metadata.created_at);
                        const responseTime = profile.metadata.response_time || 0;

                        return `
                            <div class="border ${isLatest ? 'border-purple-300 bg-purple-50' : 'border-gray-200 bg-white'} rounded-lg p-4 hover:shadow-md transition-all cursor-pointer"
                                 onclick="viewHistoryVersion(${profile.id})">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-semibold text-gray-900">版本 ${profile.version}</span>
                                        ${isLatest ? '<span class="badge badge-purple">最新</span>' : ''}
                                    </div>
                                    <span class="text-xs text-gray-500">
                                        ${DateUtils.format(versionDate, 'YYYY-MM-DD HH:mm')}
                                    </span>
                                </div>

                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                                        <span class="text-gray-600 truncate" title="${profile.personalityType}">
                                            ${profile.personalityType.substring(0, 20)}...
                                        </span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="dollar-sign" class="w-4 h-4 text-gray-400"></i>
                                        <span class="text-gray-600">${profile.purchasePower}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="target" class="w-4 h-4 text-gray-400"></i>
                                        <span class="text-gray-600">${profile.beautyGoals.length} 个目标</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="clock" class="w-4 h-4 text-gray-400"></i>
                                        <span class="text-gray-600">${responseTime.toFixed(1)}s</span>
                                    </div>
                                </div>

                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 rounded-full ${
                                                profile.riskLevel === '高流失风险' ? 'bg-red-500' :
                                                profile.riskLevel === '中流失风险' ? 'bg-yellow-500' :
                                                'bg-green-500'
                                            }"></div>
                                            <span class="text-xs font-medium text-gray-700">${profile.riskLevel}</span>
                                        </div>
                                        <span class="text-xs text-purple-600">点击查看详情 →</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = html;
            lucide.createIcons();
        }

        // 查看历史版本详细内容
        async function viewHistoryVersion(profileId) {
            try {
                console.log('📡 加载历史版本详情:', profileId);

                // 调用单个版本详情 API
                const response = await window.apiClient.get(`/api/ai/customer-profiles/${profileId}`);

                if (!response.success || !response.data) {
                    throw new Error('加载版本详情失败');
                }

                const profile = response.data;
                console.log('✅ 版本详情:', profile);

                // 显示在当前画像区域
                displayAIProfile(profile);

                // 切换回当前画像视图
                document.getElementById('aiProfileContent').classList.remove('hidden');
                document.getElementById('aiProfileHistory').classList.add('hidden');
                document.getElementById('viewHistoryText').textContent = '查看历史';

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载版本详情失败:', error);
                UIUtils.notify('加载版本详情失败: ' + error.message, 'error');
            }
        }

        // 用户菜单切换
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }

        // 点击外部关闭用户菜单
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const userButton = event.target.closest('button[onclick="toggleUserMenu()"]');

            if (!userButton && !userMenu.contains(event.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // 点击模态框外部关闭
        document.getElementById('aiProfileModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeAIProfileModal();
            }
        });

        // ========================================
        // 诊断管理功能
        // ========================================

        // 存储诊断模板数据
        let diagnosisTemplate = null;

        // 加载诊断模板
        async function loadDiagnosisTemplate() {
            try {
                console.log('📡 加载综合健康诊断模板...');
                const response = await fetch(`${API_BASE_URL}/api/diagnosis-templates/2`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || '加载诊断模板失败');
                }

                diagnosisTemplate = result.data;
                console.log('✅ 诊断模板加载成功:', diagnosisTemplate.template_name);
            } catch (error) {
                console.error('❌ 加载诊断模板失败:', error);
                UIUtils.notify('加载诊断模板失败', 'error');
            }
        }

        // 显示新建诊断模态框
        async function showNewDiagnosisModal() {
            // 清除编辑状态
            window.currentEditingDiagnosisId = null;

            // 如果模板未加载，先加载模板
            if (!diagnosisTemplate) {
                await loadDiagnosisTemplate();
                if (!diagnosisTemplate) {
                    return; // 加载失败，不继续
                }
            }

            // 设置默认诊断日期为今天
            document.getElementById('diagnoseDate').valueAsDate = new Date();

            // 设置默认诊断人（当前用户，这里暂时用固定值）
            document.getElementById('diagnosedBy').value = '1';

            // 渲染动态表单字段
            renderDiagnosisFields(diagnosisTemplate.fields);

            // 显示模态框
            document.getElementById('diagnosisModal').classList.remove('hidden');

            // 设置模态框标题为"新建诊断"
            const modalTitle = document.querySelector('#diagnosisModal h2');
            if (modalTitle) {
                modalTitle.textContent = '新建诊断';
            }

            lucide.createIcons();
        }

        // 关闭诊断模态框
        function closeDiagnosisModal() {
            document.getElementById('diagnosisModal').classList.add('hidden');
            document.getElementById('diagnosisForm').reset();

            // 清除编辑状态
            window.currentEditingDiagnosisId = null;

            // 重置模态框标题
            const modalTitle = document.querySelector('#diagnosisModal h2');
            if (modalTitle) {
                modalTitle.textContent = '新建诊断';
            }
        }

        // 渲染诊断表单字段
        function renderDiagnosisFields(fields) {
            const container = document.getElementById('dynamicFieldsContainer');

            // 按group分组
            const groupedFields = {};
            fields.forEach(field => {
                if (!groupedFields[field.group]) {
                    groupedFields[field.group] = [];
                }
                groupedFields[field.group].push(field);
            });

            // 渲染每个分组
            container.innerHTML = Object.keys(groupedFields).map(groupName => {
                const groupFields = groupedFields[groupName];

                const fieldsHTML = groupFields.map(field => {
                    return renderField(field);
                }).join('');

                return `
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-900 border-b border-gray-200 pb-2">${groupName}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${fieldsHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 渲染单个字段
        function renderField(field) {
            const required = field.required ? 'required' : '';
            const requiredMark = field.required ? '<span class="text-red-500">*</span>' : '';

            switch (field.field_type) {
                case 'text':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name}  ${requiredMark}
                            </label>
                            <input
                                type="text"
                                id="field_${field.field_key}"
                                data-field-key="${field.field_key}"
                                ${required}
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                placeholder="${field.placeholder || ''}"
                            />
                        </div>
                    `;

                case 'number':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <input
                                type="number"
                                id="field_${field.field_key}"
                                data-field-key="${field.field_key}"
                                ${required}
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                placeholder="${field.placeholder || ''}"
                            />
                        </div>
                    `;

                case 'textarea':
                    return `
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <textarea
                                id="field_${field.field_key}"
                                data-field-key="${field.field_key}"
                                ${required}
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                placeholder="${field.placeholder || ''}"
                            ></textarea>
                        </div>
                    `;

                case 'radio':
                    return `
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <div class="flex flex-wrap gap-2">
                                ${(field.options || []).map((option, idx) => `
                                    <label class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input
                                            type="radio"
                                            name="field_${field.field_key}"
                                            data-field-key="${field.field_key}"
                                            value="${option}"
                                            ${required && idx === 0 ? 'checked' : ''}
                                            class="w-4 h-4 text-purple-600"
                                        />
                                        <span class="ml-2 text-sm text-gray-700">${option}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'checkbox':
                    return `
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <div class="flex flex-wrap gap-2">
                                ${(field.options || []).map(option => `
                                    <label class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input
                                            type="checkbox"
                                            name="field_${field.field_key}"
                                            data-field-key="${field.field_key}"
                                            value="${option}"
                                            class="w-4 h-4 text-purple-600 rounded"
                                        />
                                        <span class="ml-2 text-sm text-gray-700">${option}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'select':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <select
                                id="field_${field.field_key}"
                                data-field-key="${field.field_key}"
                                ${required}
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="">请选择</option>
                                ${(field.options || []).map(option => `
                                    <option value="${option}">${option}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;

                default:
                    return '';
            }
        }

        // 保存诊断
        async function saveDiagnosis() {
            try {
                // 验证必填字段
                const diagnoseDate = document.getElementById('diagnoseDate').value;
                const diagnosedBy = document.getElementById('diagnosedBy').value;

                if (!diagnoseDate || !diagnosedBy) {
                    UIUtils.notify('请填写诊断日期和诊断人', 'error');
                    return;
                }

                // 收集表单数据
                const diagnoseData = {};
                const allFields = document.querySelectorAll('[data-field-key]');

                allFields.forEach(field => {
                    const fieldKey = field.dataset.fieldKey;

                    if (field.type === 'checkbox') {
                        // checkbox类型：收集所有选中的值
                        const checkedValues = Array.from(
                            document.querySelectorAll(`[name="field_${fieldKey}"]:checked`)
                        ).map(cb => cb.value);

                        if (checkedValues.length > 0) {
                            diagnoseData[fieldKey] = checkedValues;
                        }
                    } else if (field.type === 'radio') {
                        // radio类型：只收集选中的值
                        const checkedRadio = document.querySelector(`[name="field_${fieldKey}"]:checked`);
                        if (checkedRadio) {
                            diagnoseData[fieldKey] = checkedRadio.value;
                        }
                    } else {
                        // 其他类型：直接获取值
                        if (field.value) {
                            diagnoseData[fieldKey] = field.value;
                        }
                    }
                });

                // 获取诊断建议
                const suggestions = document.getElementById('suggestions').value;

                // 准备提交数据
                const postData = {
                    customer_id: parseInt(currentCustomer.id),
                    org_id: currentCustomer.org_id || 1,
                    diagnose_date: diagnoseDate,
                    diagnosed_by: parseInt(diagnosedBy),
                    diagnose_data: diagnoseData,
                    suggestions: suggestions || null
                };

                console.log('📡 提交诊断数据:', postData);

                // 判断是创建还是更新
                const isEditing = window.currentEditingDiagnosisId;
                const url = isEditing
                    ? `${API_BASE_URL}/api/customer-diagnoses/${window.currentEditingDiagnosisId}`
                    : `${API_BASE_URL}/api/customer-diagnoses`;
                const method = isEditing ? 'PUT' : 'POST';

                console.log(`📡 ${isEditing ? '更新' : '创建'}诊断记录...`);

                // 提交到API
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || '保存诊断失败');
                }

                console.log(`✅ 诊断记录${isEditing ? '更新' : '保存'}成功:`, result.data);
                UIUtils.notify(`✅ 诊断记录${isEditing ? '更新' : '保存'}成功`, 'success');

                // 关闭模态框
                closeDiagnosisModal();

                // 重新加载诊断历史
                await loadDiagnosisHistory();

            } catch (error) {
                console.error('❌ 保存诊断失败:', error);
                UIUtils.notify('保存失败: ' + error.message, 'error');
            }
        }

        // 查看诊断详情
        async function viewDiagnosisDetail(diagnosisId) {
            try {
                console.log('📡 加载诊断详情:', diagnosisId);
                const response = await fetch(`${API_BASE_URL}/api/customer-diagnoses/${diagnosisId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || '加载诊断详情失败');
                }

                const diagnosis = result.data;
                console.log('✅ 诊断详情加载成功:', diagnosis);

                // 显示诊断详情（这里可以弹出一个详情模态框）
                const diagnoseData = typeof diagnosis.diagnose_data === 'string'
                    ? JSON.parse(diagnosis.diagnose_data)
                    : diagnosis.diagnose_data || {};

                let detailHtml = `
                    <div class="space-y-4">
                        <div><strong>诊断日期:</strong> ${diagnosis.diagnose_date}</div>
                        ${diagnosis.diagnosed_by_name ? `<div><strong>诊断人:</strong> ${diagnosis.diagnosed_by_name}</div>` : ''}
                        ${diagnosis.skin_type ? `<div><strong>肤质:</strong> ${translateSkinType(diagnosis.skin_type)}</div>` : ''}
                        ${diagnosis.hair_type ? `<div><strong>发质:</strong> ${translateHairType(diagnosis.hair_type)}</div>` : ''}
                `;

                // 显示诊断数据
                if (Object.keys(diagnoseData).length > 0) {
                    detailHtml += '<div><strong>详细诊断数据:</strong></div><ul class="list-disc list-inside">';
                    for (const [key, value] of Object.entries(diagnoseData)) {
                        detailHtml += `<li>${key}: ${Array.isArray(value) ? value.join(', ') : value}</li>`;
                    }
                    detailHtml += '</ul>';
                }

                if (diagnosis.suggestions) {
                    detailHtml += `<div><strong>诊断建议:</strong><p class="mt-2 text-gray-700">${diagnosis.suggestions}</p></div>`;
                }

                detailHtml += '</div>';

                // 使用alert显示（实际项目中应该用更好的UI）
                alert(detailHtml.replace(/<[^>]*>/g, '\n'));

            } catch (error) {
                console.error('❌ 加载诊断详情失败:', error);
                UIUtils.notify('加载诊断详情失败', 'error');
            }
        }

        // 删除诊断记录
        async function deleteDiagnosis(diagnosisId) {
            // 显示确认对话框
            if (!confirm('确定要删除这条诊断记录吗？此操作不可恢复。')) {
                return;
            }

            try {
                console.log('📡 删除诊断记录:', diagnosisId);

                // 调用删除API
                const response = await fetch(`${API_BASE_URL}/api/customer-diagnoses/${diagnosisId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || '删除诊断记录失败');
                }

                console.log('✅ 诊断记录删除成功');
                UIUtils.notify('诊断记录已删除', 'success');

                // 重新加载诊断历史列表
                await loadDiagnosisHistory();

            } catch (error) {
                console.error('❌ 删除诊断记录失败:', error);
                UIUtils.notify('删除失败: ' + error.message, 'error');
            }
        }

        // 显示诊断摘要
        async function showDiagnosisSummary(diagnosisId) {
            try {
                console.log('📡 加载诊断摘要:', diagnosisId);
                const response = await fetch(`${API_BASE_URL}/api/customer-diagnoses/${diagnosisId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || '加载诊断摘要失败');
                }

                const diagnosis = result.data;
                console.log('✅ 诊断摘要加载成功:', diagnosis);

                // 解析诊断数据
                const diagnoseData = typeof diagnosis.diagnose_data === 'string'
                    ? JSON.parse(diagnosis.diagnose_data)
                    : diagnosis.diagnose_data || {};

                // 构建摘要内容
                let summary = `━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                summary += `📋 诊断记录摘要\n`;
                summary += `━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;

                summary += `📅 诊断日期: ${DateUtils.format(new Date(diagnosis.diagnose_date), 'YYYY-MM-DD HH:mm')}\n`;
                if (diagnosis.diagnosed_by_name) {
                    summary += `👤 诊断人: ${diagnosis.diagnosed_by_name}\n`;
                }
                summary += `\n`;

                // 显示肤质和发质
                if (diagnosis.skin_type || diagnosis.hair_type) {
                    summary += `━━━ 基本信息 ━━━\n`;
                    if (diagnosis.skin_type) {
                        summary += `• 肤质: ${translateSkinType(diagnosis.skin_type)}\n`;
                    }
                    if (diagnosis.hair_type) {
                        summary += `• 发质: ${translateHairType(diagnosis.hair_type)}\n`;
                    }
                    summary += `\n`;
                }

                // 显示诊断数据摘要（只显示重要字段）
                if (Object.keys(diagnoseData).length > 0) {
                    summary += `━━━ 诊断数据 ━━━\n`;

                    // 睡眠相关
                    if (diagnoseData.wake_time || diagnoseData.sleep_time || diagnoseData.sleep_hours) {
                        summary += `💤 睡眠情况:\n`;
                        if (diagnoseData.wake_time) summary += `  • 起床时间: ${diagnoseData.wake_time}\n`;
                        if (diagnoseData.sleep_time) summary += `  • 睡觉时间: ${diagnoseData.sleep_time}\n`;
                        if (diagnoseData.sleep_hours) summary += `  • 睡眠时长: ${diagnoseData.sleep_hours}小时\n`;
                        if (diagnoseData.sleep_status) {
                            const status = Array.isArray(diagnoseData.sleep_status)
                                ? diagnoseData.sleep_status.join('、')
                                : diagnoseData.sleep_status;
                            summary += `  • 睡眠状况: ${status}\n`;
                        }
                    }

                    // 排便相关
                    if (diagnoseData.bowel_frequency || diagnoseData.bowel_status) {
                        summary += `\n🚽 排便情况:\n`;
                        if (diagnoseData.bowel_frequency) summary += `  • 排便频率: ${diagnoseData.bowel_frequency}次/天\n`;
                        if (diagnoseData.bowel_status) {
                            const status = Array.isArray(diagnoseData.bowel_status)
                                ? diagnoseData.bowel_status.join('、')
                                : diagnoseData.bowel_status;
                            summary += `  • 排便状态: ${status}\n`;
                        }
                    }

                    // 月经相关
                    if (diagnoseData.menstrual_cycle || diagnoseData.menstrual_status) {
                        summary += `\n🩸 月经情况:\n`;
                        if (diagnoseData.menstrual_cycle) summary += `  • 周期: ${diagnoseData.menstrual_cycle}天\n`;
                        if (diagnoseData.menstrual_status) {
                            const status = Array.isArray(diagnoseData.menstrual_status)
                                ? diagnoseData.menstrual_status.join('、')
                                : diagnoseData.menstrual_status;
                            summary += `  • 状态: ${status}\n`;
                        }
                    }

                    summary += `\n`;
                }

                // 显示诊断建议
                if (diagnosis.suggestions) {
                    summary += `━━━ 诊断建议 ━━━\n`;
                    summary += `${diagnosis.suggestions}\n\n`;
                }

                summary += `━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                summary += `记录ID: ${diagnosis.id} | 共${Object.keys(diagnoseData).length}项数据`;

                // 显示摘要
                alert(summary);

            } catch (error) {
                console.error('❌ 加载诊断摘要失败:', error);
                UIUtils.notify('加载诊断摘要失败: ' + error.message, 'error');
            }
        }

        // 编辑诊断记录
        async function editDiagnosis(diagnosisId) {
            try {
                console.log('📡 加载诊断记录进行编辑:', diagnosisId);

                // 加载诊断模板（如果未加载）
                if (!diagnosisTemplate) {
                    await loadDiagnosisTemplate();
                    if (!diagnosisTemplate) {
                        return; // 加载失败，不继续
                    }
                }

                // 获取诊断详情
                const response = await fetch(`${API_BASE_URL}/api/customer-diagnoses/${diagnosisId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || '加载诊断记录失败');
                }

                const diagnosis = result.data;
                console.log('✅ 诊断记录加载成功，准备编辑:', diagnosis);

                // 解析诊断数据
                const diagnoseData = typeof diagnosis.diagnose_data === 'string'
                    ? JSON.parse(diagnosis.diagnose_data)
                    : diagnosis.diagnose_data || {};

                // 设置诊断日期
                const diagnoseDate = new Date(diagnosis.diagnose_date);
                document.getElementById('diagnoseDate').valueAsDate = diagnoseDate;

                // 设置诊断人
                document.getElementById('diagnosedBy').value = diagnosis.diagnosed_by;

                // 渲染表单字段
                renderDiagnosisFields(diagnosisTemplate.fields);

                // 填充表单数据
                for (const [fieldKey, fieldValue] of Object.entries(diagnoseData)) {
                    const elements = document.querySelectorAll(`[data-field-key="${fieldKey}"]`);

                    elements.forEach(element => {
                        if (element.type === 'checkbox') {
                            // checkbox类型：检查值是否在数组中
                            if (Array.isArray(fieldValue) && fieldValue.includes(element.value)) {
                                element.checked = true;
                            }
                        } else if (element.type === 'radio') {
                            // radio类型：检查值是否匹配
                            if (element.value === fieldValue) {
                                element.checked = true;
                            }
                        } else {
                            // 其他类型：直接设置值
                            element.value = fieldValue;
                        }
                    });
                }

                // 设置诊断建议
                document.getElementById('suggestions').value = diagnosis.suggestions || '';

                // 存储当前编辑的诊断ID（用于保存时判断是创建还是更新）
                window.currentEditingDiagnosisId = diagnosisId;

                // 显示模态框
                document.getElementById('diagnosisModal').classList.remove('hidden');

                // 修改模态框标题为"编辑诊断"
                const modalTitle = document.querySelector('#diagnosisModal h2');
                if (modalTitle) {
                    modalTitle.textContent = '编辑诊断';
                }

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载诊断记录失败:', error);
                UIUtils.notify('加载诊断记录失败: ' + error.message, 'error');
            }
        }

        // 点击模态框外部关闭诊断模态框
        document.getElementById('diagnosisModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeDiagnosisModal();
            }
        });

        // ========================================
        // 诊断组功能
        // ========================================

        // 存储诊断组的模板数据
        let currentDiagnosisGroupData = null;

        // 显示创建诊断组模态框
        async function showCreateDiagnosisGroupModal() {
            try {
                console.log('🔄 加载诊断模板...');

                // 显示模态框
                document.getElementById('diagnosisGroupModal').classList.remove('hidden');

                // 显示加载状态
                document.getElementById('recommendedTemplatesList').innerHTML = '<p class="text-gray-500">加载中...</p>';
                document.getElementById('otherTemplatesList').innerHTML = '<p class="text-gray-500">加载中...</p>';

                // 加载所有激活的诊断模板
                const response = await window.apiClient.get('/api/diagnosis-templates', {
                    status: 'active'
                });

                console.log('✅ 模板加载响应:', response);

                if (!response.success || !response.data) {
                    throw new Error(response.message || '加载诊断模板失败');
                }

                const templates = response.data;
                console.log('📋 加载了', templates.length, '个诊断模板');

                if (templates.length === 0) {
                    document.getElementById('recommendedTemplatesList').innerHTML = '<p class="text-gray-500">暂无可用的诊断模板</p>';
                    return;
                }

                // 分类：推荐vs其他
                const recommended = templates.filter(t =>
                    t.apply_scene === 'new_customer' ||
                    t.template_code === 'COMPREHENSIVE_HEALTH_DIAGNOSIS' ||
                    t.category === 'routine'
                );
                const others = templates.filter(t => !recommended.includes(t));

                console.log('⭐ 推荐模板:', recommended.length, '个');
                console.log('📚 其他模板:', others.length, '个');

                // 渲染推荐模板
                if (recommended.length > 0) {
                    renderDiagnosisTemplateCheckboxes('recommendedTemplatesList', recommended, true);
                    document.getElementById('recommendedTemplatesSection').classList.remove('hidden');
                } else {
                    document.getElementById('recommendedTemplatesSection').classList.add('hidden');
                }

                // 渲染其他模板
                if (others.length > 0) {
                    renderDiagnosisTemplateCheckboxes('otherTemplatesList', others, false);
                    document.getElementById('otherTemplatesSection').classList.remove('hidden');
                } else {
                    document.getElementById('otherTemplatesSection').classList.add('hidden');
                }

                // 更新计数
                updateSelectedDiagnosisTemplatesCount();

                lucide.createIcons();
                console.log('✨ 诊断组选择模态框渲染完成');

            } catch (error) {
                console.error('❌ 加载诊断模板失败:', error);
                UIUtils.notify('加载模板失败: ' + error.message, 'error');
                document.getElementById('diagnosisGroupModal').classList.add('hidden');
            }
        }

        // 渲染诊断模板复选框列表
        function renderDiagnosisTemplateCheckboxes(containerId, templates, defaultChecked = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            templates.forEach(template => {
                // 计算字段数
                const fieldCount = Array.isArray(template.fields)
                    ? template.fields.length
                    : (template.fields ? JSON.parse(template.fields).length : 0);

                const label = document.createElement('label');
                label.className = 'flex items-start gap-3 p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 hover:border-purple-300 transition-all';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'diagnosis-group-template-checkbox mt-1 w-5 h-5 text-purple-600 rounded';
                checkbox.value = template.id;
                checkbox.dataset.templateName = template.template_name;
                checkbox.dataset.templateCode = template.template_code;
                checkbox.dataset.templateFields = JSON.stringify(template.fields || []);
                if (defaultChecked) checkbox.checked = true;
                checkbox.onchange = updateSelectedDiagnosisTemplatesCount;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-1 min-w-0';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'flex items-center gap-2 mb-1 flex-wrap';
                titleDiv.innerHTML = `
                    <div class="font-medium text-gray-900">${template.template_name}</div>
                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded">${fieldCount} 个字段</span>
                    ${template.apply_scene ? `<span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">${template.apply_scene}</span>` : ''}
                `;

                const descDiv = document.createElement('div');
                descDiv.className = 'text-sm text-gray-600';
                descDiv.textContent = template.description || '无描述';

                contentDiv.appendChild(titleDiv);
                contentDiv.appendChild(descDiv);

                label.appendChild(checkbox);
                label.appendChild(contentDiv);
                container.appendChild(label);
            });
        }

        // 更新选中的诊断模板计数
        function updateSelectedDiagnosisTemplatesCount() {
            const checkboxes = document.querySelectorAll('.diagnosis-group-template-checkbox:checked');
            const count = checkboxes.length;

            document.getElementById('selectedDiagnosisTemplatesCount').textContent = count;

            // 启用/禁用创建按钮
            const createBtn = document.getElementById('createDiagnosisGroupBtn');
            if (count > 0) {
                createBtn.disabled = false;
                createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                createBtn.disabled = true;
                createBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // 关闭诊断组选择模态框
        function closeDiagnosisGroupModal() {
            console.log('关闭诊断组选择模态框');
            document.getElementById('diagnosisGroupModal').classList.add('hidden');

            // 重置选中状态
            document.querySelectorAll('.diagnosis-group-template-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateSelectedDiagnosisTemplatesCount();

            currentDiagnosisGroupData = null;
        }

        // 确认创建诊断组
        async function confirmCreateDiagnosisGroup() {
            try {
                const checkboxes = document.querySelectorAll('.diagnosis-group-template-checkbox:checked');
                const selectedTemplateIds = Array.from(checkboxes).map(cb => ({
                    id: parseInt(cb.value),
                    name: cb.dataset.templateName,
                    code: cb.dataset.templateCode,
                    fields: JSON.parse(cb.dataset.templateFields)
                }));

                if (selectedTemplateIds.length === 0) {
                    UIUtils.notify('请至少选择一个诊断模板', 'warning');
                    return;
                }

                console.log('📡 创建诊断组，选中的模板:', selectedTemplateIds);

                // 调用API创建诊断组
                const response = await window.apiClient.post('/api/customer-diagnosis-groups', {
                    customer_id: parseInt(currentCustomer.id),
                    org_id: currentCustomer.org_id || 1,
                    diagnosis_template_ids: selectedTemplateIds.map(t => t.id),
                    created_by: 1  // TODO: 获取当前登录用户ID
                });

                console.log('✅ 诊断组创建响应:', response);

                if (!response.success) {
                    throw new Error(response.message || '创建诊断组失败');
                }

                UIUtils.notify(`✅ 成功创建诊断组，包含 ${selectedTemplateIds.length} 个模板`, 'success');

                // 保存诊断组数据
                currentDiagnosisGroupData = {
                    group_id: response.data.group_id,
                    templates: selectedTemplateIds
                };

                console.log('💾 诊断组数据已保存:', currentDiagnosisGroupData);

                // 关闭选择模态框
                closeDiagnosisGroupModal();

                // 打开诊断填写模态框
                showDiagnosisGroupFillModal();

            } catch (error) {
                console.error('❌ 创建诊断组失败:', error);
                UIUtils.notify('创建失败: ' + error.message, 'error');
            }
        }

        // 存储诊断组填写状态
        let diagnosisGroupFillState = {
            group_id: null,
            templates: [],
            currentIndex: 0,
            completedIndexes: [],
            formData: {}  // 存储每个表单的诊断数据
        };

        // 显示诊断组填写模态框
        function showDiagnosisGroupFillModal() {
            if (!currentDiagnosisGroupData || currentDiagnosisGroupData.templates.length === 0) {
                UIUtils.notify('诊断组数据丢失', 'error');
                return;
            }

            console.log('📋 显示诊断组填写模态框，包含', currentDiagnosisGroupData.templates.length, '个模板');

            // 初始化填写状态
            diagnosisGroupFillState = {
                group_id: currentDiagnosisGroupData.group_id,
                templates: currentDiagnosisGroupData.templates,
                currentIndex: 0,
                completedIndexes: [],
                formData: {}
            };

            // 渲染Tab导航
            renderDiagnosisGroupTabs();

            // 渲染所有诊断表单
            renderDiagnosisGroupForms();

            // 更新进度
            updateDiagnosisGroupProgress();

            // 显示模态框
            document.getElementById('diagnosisGroupFillModal').classList.remove('hidden');
            document.body.classList.add('no-scroll');

            // 激活第一个Tab
            switchDiagnosisGroupTab(0);

            lucide.createIcons();
        }

        // 渲染Tab导航
        function renderDiagnosisGroupTabs() {
            const container = document.getElementById('diagnosisGroupTabsContainer');
            container.innerHTML = diagnosisGroupFillState.templates.map((template, index) => `
                <button
                    id="diagnosisGroupTab_${index}"
                    onclick="switchDiagnosisGroupTab(${index})"
                    class="diagnosis-group-tab px-4 py-2 border-b-2 border-transparent text-sm font-medium transition-colors whitespace-nowrap ${index === 0 ? 'border-purple-600 text-purple-600' : 'text-gray-600 hover:text-gray-900'}">
                    ${template.name}
                    ${diagnosisGroupFillState.completedIndexes.includes(index) ? '<i data-lucide="check" class="w-4 h-4 inline ml-1 text-green-600"></i>' : ''}
                </button>
            `).join('');
        }

        // 渲染诊断组表单
        function renderDiagnosisGroupForms() {
            const container = document.getElementById('diagnosisGroupFormsContainer');

            container.innerHTML = diagnosisGroupFillState.templates.map((template, index) => {
                // 解析字段
                const fields = typeof template.fields === 'string'
                    ? JSON.parse(template.fields)
                    : template.fields || [];

                // 按group分组
                const groupedFields = {};
                fields.forEach(field => {
                    const group = field.group || '未分组';
                    if (!groupedFields[group]) groupedFields[group] = [];
                    groupedFields[group].push(field);
                });

                return `
                    <div id="diagnosisGroupForm_${index}" class="diagnosis-group-form ${index === 0 ? '' : 'hidden'}">
                        <h3 class="text-xl font-bold mb-2">${template.name}</h3>
                        <p class="text-sm text-gray-600 mb-6">${template.description || '暂无描述'}</p>

                        <form id="diagnosisGroupFormElement_${index}" class="space-y-6">
                            <!-- 基本信息 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">诊断日期 *</label>
                                    <input type="date"
                                           id="diagnosisGroupDate_${index}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                           value="${new Date().toISOString().split('T')[0]}"
                                           required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">诊断人 *</label>
                                    <select id="diagnosisGroupDiagnosedBy_${index}"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            required>
                                        <option value="1">李美容师</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">模板</label>
                                    <input type="text"
                                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600"
                                           value="${template.code || template.name}"
                                           disabled>
                                </div>
                            </div>

                            <!-- 动态字段 -->
                            <div id="diagnosisGroupDynamicFields_${index}" class="space-y-6">
                                ${Object.entries(groupedFields).map(([groupName, groupFields]) => `
                                    <div class="border-l-4 border-purple-500 pl-4">
                                        <h4 class="font-semibold text-gray-900 mb-3">${groupName}</h4>
                                        <div class="space-y-4">
                                            ${groupFields.map(field => renderDiagnosisGroupField(field, index)).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- 诊断建议 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">诊断建议</label>
                                <textarea id="diagnosisGroupSuggestions_${index}"
                                          rows="4"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                          placeholder="记录诊断建议和注意事项..."></textarea>
                            </div>
                        </form>
                    </div>
                `;
            }).join('');
        }

        // 渲染单个诊断字段
        function renderDiagnosisGroupField(field, templateIndex) {
            const required = field.required ? 'required' : '';
            const requiredMark = field.required ? '<span class="text-red-500">*</span>' : '';
            const fieldId = `diagnosisGroupField_${templateIndex}_${field.field_key}`;

            switch (field.field_type) {
                case 'text':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <input type="text"
                                   id="${fieldId}"
                                   data-field-key="${field.field_key}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                   placeholder="${field.placeholder || ''}"
                                   ${required}>
                        </div>
                    `;

                case 'number':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <input type="number"
                                   id="${fieldId}"
                                   data-field-key="${field.field_key}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                   placeholder="${field.placeholder || ''}"
                                   ${required}>
                        </div>
                    `;

                case 'date':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <input type="date"
                                   id="${fieldId}"
                                   data-field-key="${field.field_key}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                   ${required}>
                        </div>
                    `;

                case 'textarea':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <textarea id="${fieldId}"
                                      data-field-key="${field.field_key}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                      placeholder="${field.placeholder || ''}"
                                      ${required}></textarea>
                        </div>
                    `;

                case 'select':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <select id="${fieldId}"
                                    data-field-key="${field.field_key}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    ${required}>
                                <option value="">请选择</option>
                                ${(field.options || []).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;

                case 'radio':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <div class="flex flex-wrap gap-2">
                                ${(field.options || []).map((opt, idx) => `
                                    <label class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio"
                                               name="diagnosisGroupRadio_${templateIndex}_${field.field_key}"
                                               data-field-key="${field.field_key}"
                                               value="${opt}"
                                               class="w-4 h-4 text-purple-600"
                                               ${idx === 0 && required ? 'checked' : ''}>
                                        <span class="ml-2 text-sm text-gray-700">${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'checkbox':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ${field.field_name} ${requiredMark}
                            </label>
                            <div class="flex flex-wrap gap-2">
                                ${(field.options || []).map(opt => `
                                    <label class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="checkbox"
                                               name="diagnosisGroupCheckbox_${templateIndex}_${field.field_key}"
                                               data-field-key="${field.field_key}"
                                               value="${opt}"
                                               class="w-4 h-4 text-purple-600 rounded">
                                        <span class="ml-2 text-sm text-gray-700">${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;

                default:
                    return '';
            }
        }

        // 切换诊断组Tab
        function switchDiagnosisGroupTab(index) {
            diagnosisGroupFillState.currentIndex = index;

            // 更新Tab样式
            document.querySelectorAll('.diagnosis-group-tab').forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('border-purple-600', 'text-purple-600');
                    tab.classList.remove('border-transparent', 'text-gray-600');
                } else {
                    tab.classList.remove('border-purple-600', 'text-purple-600');
                    tab.classList.add('border-transparent', 'text-gray-600');
                }
            });

            // 切换表单显示
            document.querySelectorAll('.diagnosis-group-form').forEach((form, i) => {
                if (i === index) {
                    form.classList.remove('hidden');
                } else {
                    form.classList.add('hidden');
                }
            });

            console.log('切换到Tab', index, ':', diagnosisGroupFillState.templates[index].name);
        }

        // 保存当前诊断
        async function saveCurrentDiagnosisInGroup() {
            const index = diagnosisGroupFillState.currentIndex;
            const template = diagnosisGroupFillState.templates[index];

            console.log('💾 保存诊断组中的诊断', index, ':', template.name);

            try {
                // 验证必填字段
                const diagnoseDate = document.getElementById(`diagnosisGroupDate_${index}`).value;
                const diagnosedBy = document.getElementById(`diagnosisGroupDiagnosedBy_${index}`).value;

                if (!diagnoseDate || !diagnosedBy) {
                    UIUtils.notify('请填写诊断日期和诊断人', 'error');
                    return;
                }

                // 收集表单数据
                const diagnoseData = {};
                const formElement = document.getElementById(`diagnosisGroupFormElement_${index}`);

                // 处理所有输入字段
                const allFields = formElement.querySelectorAll('[data-field-key]');
                allFields.forEach(field => {
                    const fieldKey = field.dataset.fieldKey;

                    if (field.type === 'checkbox') {
                        // 复选框：收集所有选中的值
                        const checkedValues = Array.from(
                            formElement.querySelectorAll(`[name*="${fieldKey}"]:checked`)
                        ).map(cb => cb.value);
                        if (checkedValues.length > 0) {
                            diagnoseData[fieldKey] = checkedValues;
                        }
                    } else if (field.type === 'radio') {
                        // 单选框：只收集选中的值
                        const checkedRadio = formElement.querySelector(`[name*="${fieldKey}"]:checked`);
                        if (checkedRadio) {
                            diagnoseData[fieldKey] = checkedRadio.value;
                        }
                    } else {
                        // 其他类型：直接获取值
                        if (field.value) {
                            diagnoseData[fieldKey] = field.value;
                        }
                    }
                });

                const suggestions = document.getElementById(`diagnosisGroupSuggestions_${index}`).value;

                console.log('📋 收集的诊断数据:', diagnoseData);

                // 调用API保存诊断
                const response = await window.apiClient.post('/api/customer-diagnoses', {
                    customer_id: parseInt(currentCustomer.id),
                    org_id: currentCustomer.org_id || 1,
                    diagnosis_group_id: diagnosisGroupFillState.group_id,
                    diagnosis_template_id: template.id,
                    diagnose_date: diagnoseDate,
                    diagnosed_by: parseInt(diagnosedBy),
                    diagnose_data: diagnoseData,
                    suggestions: suggestions || null,
                    created_by: 1
                });

                console.log('✅ 诊断保存成功:', response);

                if (!response.success) {
                    throw new Error(response.message || '保存诊断失败');
                }

                // 标记为已完成
                if (!diagnosisGroupFillState.completedIndexes.includes(index)) {
                    diagnosisGroupFillState.completedIndexes.push(index);
                }

                // 更新Tab显示
                renderDiagnosisGroupTabs();
                updateDiagnosisGroupProgress();

                UIUtils.notify(`✅ ${template.name} 诊断已保存`, 'success');

                // 自动切换到下一个未完成的Tab
                const nextIndex = findNextIncompleteDiagnosisInGroup();
                if (nextIndex !== -1) {
                    switchDiagnosisGroupTab(nextIndex);
                }

            } catch (error) {
                console.error('❌ 保存诊断失败:', error);
                UIUtils.notify('保存失败: ' + error.message, 'error');
            }
        }

        // 跳过当前诊断
        function skipCurrentDiagnosisInGroup() {
            const nextIndex = findNextIncompleteDiagnosisInGroup();
            if (nextIndex !== -1) {
                switchDiagnosisGroupTab(nextIndex);
            } else {
                UIUtils.notify('没有更多未完成的诊断', 'info');
            }
        }

        // 查找下一个未完成的诊断索引
        function findNextIncompleteDiagnosisInGroup() {
            const total = diagnosisGroupFillState.templates.length;

            // 从当前位置之后查找
            for (let i = diagnosisGroupFillState.currentIndex + 1; i < total; i++) {
                if (!diagnosisGroupFillState.completedIndexes.includes(i)) {
                    return i;
                }
            }

            // 如果没找到，从头开始查找
            for (let i = 0; i < diagnosisGroupFillState.currentIndex; i++) {
                if (!diagnosisGroupFillState.completedIndexes.includes(i)) {
                    return i;
                }
            }

            return -1;
        }

        // 完成所有诊断
        async function completeAllDiagnoses() {
            const total = diagnosisGroupFillState.templates.length;
            const completed = diagnosisGroupFillState.completedIndexes.length;

            if (completed < total) {
                const userConfirm = confirm(
                    `还有 ${total - completed} 个诊断未填写，确定要结束吗？`
                );
                if (!userConfirm) return;
            }

            console.log('✅ 诊断组填写完成');

            // 关闭模态框
            closeDiagnosisGroupFillModal();

            // 重新加载诊断历史
            await loadDiagnosisHistory();

            UIUtils.notify('诊断组填写完成！', 'success');
        }

        // 更新诊断组进度
        function updateDiagnosisGroupProgress() {
            const total = diagnosisGroupFillState.templates.length;
            const completed = diagnosisGroupFillState.completedIndexes.length;
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('diagnosisGroupProgressCount').textContent = `${completed} / ${total}`;
            document.getElementById('diagnosisGroupProgressBar').style.width = `${percent}%`;
        }

        // 关闭诊断组填写模态框
        function closeDiagnosisGroupFillModal() {
            console.log('关闭诊断组填写模态框');
            document.getElementById('diagnosisGroupFillModal').classList.add('hidden');
            document.body.classList.remove('no-scroll');

            // 重置状态
            diagnosisGroupFillState = {
                group_id: null,
                templates: [],
                currentIndex: 0,
                completedIndexes: [],
                formData: {}
            };

            currentDiagnosisGroupData = null;
        }

        // 点击模态框外部关闭诊断组选择模态框
        document.getElementById('diagnosisGroupModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeDiagnosisGroupModal();
            }
        });

        // ========================================
        // 生成订单功能
        // ========================================

        // 存储当前方案组数据
        let currentSolutionGroup = null;

        // 显示生成订单模态框
        async function showGenerateOrderModal(planGroupId) {
            try {
                console.log('📡 加载方案组数据:', planGroupId);

                // 获取方案组数据
                const response = await window.apiClient.get('/api/customer-solutions', {
                    customer_id: currentCustomer.id
                });

                if (!response.success) {
                    throw new Error(response.message || '获取方案组失败');
                }

                // 找到对应的方案组
                const groups = response.data || [];
                currentSolutionGroup = groups.find(g => g.plan_group_id === planGroupId);

                if (!currentSolutionGroup || !currentSolutionGroup.solutions) {
                    throw new Error('未找到方案组数据');
                }

                console.log('✅ 方案组数据:', currentSolutionGroup);

                // 渲染方案列表
                renderOrderSolutions(currentSolutionGroup.solutions);

                // 显示模态框
                document.getElementById('generateOrderModal').classList.remove('hidden');

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载方案组失败:', error);
                UIUtils.notify('加载方案组失败: ' + error.message, 'error');
            }
        }

        // 渲染订单方案列表
        function renderOrderSolutions(solutions) {
            const container = document.getElementById('orderSolutionsContainer');

            container.innerHTML = solutions.map((solution, index) => {
                // 设置默认值
                const courseDuration = solution.course_duration || '8-12周';
                const treatmentTimes = 10; // 默认10次
                const unitPrice = solution.estimated_price_min || 0;
                const totalAmount = unitPrice * treatmentTimes;

                return `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-solution-index="${index}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900">${solution.template_name}</h4>
                                <p class="text-sm text-gray-600 mt-1">${solution.expected_effects || ''}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- 周期 -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">疗程周期</label>
                                <input type="text"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       value="${courseDuration}"
                                       data-field="course_duration"
                                       onchange="updateSolutionField(${index}, 'course_duration', this.value)">
                            </div>

                            <!-- 次数 -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">疗程次数</label>
                                <input type="number"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       value="${treatmentTimes}"
                                       min="1"
                                       data-field="treatment_times"
                                       onchange="updateSolutionField(${index}, 'treatment_times', this.value)">
                            </div>

                            <!-- 单价 -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">单价（元）</label>
                                <input type="number"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       value="${unitPrice}"
                                       min="0"
                                       step="0.01"
                                       data-field="unit_price"
                                       onchange="updateSolutionField(${index}, 'unit_price', this.value)">
                            </div>

                            <!-- 总金额 -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">总金额（元）</label>
                                <input type="number"
                                       class="w-full px-3 py-2 bg-green-50 border border-green-300 rounded-lg text-sm font-semibold text-green-700"
                                       value="${totalAmount.toFixed(2)}"
                                       min="0"
                                       step="0.01"
                                       data-field="total_amount"
                                       readonly>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // 更新订单数量和总金额
            updateOrderSummary();
        }

        // 更新方案字段
        function updateSolutionField(index, field, value) {
            const container = document.querySelector(`[data-solution-index="${index}"]`);

            if (field === 'treatment_times' || field === 'unit_price') {
                // 重新计算总金额
                const times = parseFloat(container.querySelector('[data-field="treatment_times"]').value) || 0;
                const price = parseFloat(container.querySelector('[data-field="unit_price"]').value) || 0;
                const total = times * price;

                container.querySelector('[data-field="total_amount"]').value = total.toFixed(2);
            }

            // 更新订单总金额
            updateOrderSummary();
        }

        // 更新订单摘要
        function updateOrderSummary() {
            const containers = document.querySelectorAll('[data-solution-index]');
            let totalAmount = 0;

            containers.forEach(container => {
                const amount = parseFloat(container.querySelector('[data-field="total_amount"]').value) || 0;
                totalAmount += amount;
            });

            document.getElementById('totalAmount').textContent = `¥${totalAmount.toFixed(2)}`;
            document.getElementById('orderCount').textContent = containers.length;
        }

        // 关闭生成订单模态框
        function closeGenerateOrderModal() {
            document.getElementById('generateOrderModal').classList.add('hidden');
            currentSolutionGroup = null;
        }

        // 确认生成订单
        async function confirmGenerateOrders() {
            try {
                if (!currentSolutionGroup) {
                    throw new Error('方案组数据不存在');
                }

                console.log('📡 开始生成订单...');

                // 收集所有方案的数据
                const containers = document.querySelectorAll('[data-solution-index]');
                const solutions = [];

                containers.forEach((container, index) => {
                    const solution = currentSolutionGroup.solutions[index];

                    solutions.push({
                        solution_id: solution.solution_template_id,
                        solution_name: solution.template_name,
                        category: solution.category,
                        course_duration: container.querySelector('[data-field="course_duration"]').value,
                        treatment_times: parseInt(container.querySelector('[data-field="treatment_times"]').value) || 1,
                        unit_price: parseFloat(container.querySelector('[data-field="unit_price"]').value) || 0,
                        total_amount: parseFloat(container.querySelector('[data-field="total_amount"]').value) || 0,
                        remark: ''
                    });
                });

                console.log('📋 订单数据:', solutions);

                // 调用批量创建订单API
                const response = await window.apiClient.post('/api/orders/batch-from-solutions', {
                    customer_id: currentCustomer.id,
                    customer_name: currentCustomer.name,
                    customer_phone: currentCustomer.phone,
                    org_id: currentCustomer.org_id || 7,
                    store_id: currentCustomer.org_id || 7,
                    created_by: 1, // TODO: 获取当前登录用户ID
                    plan_group_id: currentSolutionGroup.plan_group_id,  // 添加方案组ID
                    solutions: solutions
                });

                console.log('✅ 订单创建响应:', response);

                if (!response.success) {
                    throw new Error(response.message || '创建订单失败');
                }

                UIUtils.notify(`✅ 成功创建 ${response.data.count} 个订单`, 'success');

                // 关闭模态框
                closeGenerateOrderModal();

                // 重新加载方案组列表（更新按钮状态）
                await loadCustomerSolutionGroups();

                // 重新加载订单列表
                await loadOrders();

                // 切换到订单标签页
                switchTab('orders');

            } catch (error) {
                console.error('❌ 创建订单失败:', error);
                UIUtils.notify('创建订单失败: ' + error.message, 'error');
            }
        }

        // 点击模态框外部关闭生成订单模态框
        document.getElementById('generateOrderModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeGenerateOrderModal();
            }
        });

        // ========================================
        // 修改订单和确认订单功能
        // ========================================

        // 存储当前编辑的订单数据
        let currentEditingOrder = null;

        // 显示修改订单模态框
        async function showEditOrderModal(orderId) {
            try {
                console.log('📡 加载订单数据:', orderId);

                // 获取订单详情
                const response = await window.apiClient.get(`/api/orders/${orderId}`);

                if (!response.success || !response.data) {
                    throw new Error(response.message || '获取订单详情失败');
                }

                currentEditingOrder = response.data;
                console.log('✅ 订单数据:', currentEditingOrder);

                // 填充表单
                document.getElementById('editOrderId').value = currentEditingOrder.id;
                document.getElementById('editServiceDate').value = currentEditingOrder.service_date || '';
                document.getElementById('editServiceStartTime').value = currentEditingOrder.service_start_time || '';
                document.getElementById('editServiceEndTime').value = currentEditingOrder.service_end_time || '';
                document.getElementById('editOriginalAmount').value = currentEditingOrder.original_amount || 0;
                document.getElementById('editDiscountAmount').value = currentEditingOrder.discount_amount || 0;
                document.getElementById('editFinalAmount').value = currentEditingOrder.final_amount || 0;
                document.getElementById('editRemark').value = currentEditingOrder.remark || '';

                // 显示模态框
                document.getElementById('editOrderModal').classList.remove('hidden');

                lucide.createIcons();

            } catch (error) {
                console.error('❌ 加载订单数据失败:', error);
                UIUtils.notify('加载订单数据失败: ' + error.message, 'error');
            }
        }

        // 关闭修改订单模态框
        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.add('hidden');
            document.getElementById('editOrderForm').reset();
            currentEditingOrder = null;
        }

        // 计算最终金额
        function calculateFinalAmount() {
            const originalAmount = parseFloat(document.getElementById('editOriginalAmount').value) || 0;
            const discountAmount = parseFloat(document.getElementById('editDiscountAmount').value) || 0;
            const finalAmount = Math.max(0, originalAmount - discountAmount);
            document.getElementById('editFinalAmount').value = finalAmount.toFixed(2);
        }

        // 保存订单修改
        async function saveOrderEdit() {
            try {
                const orderId = document.getElementById('editOrderId').value;

                if (!orderId) {
                    throw new Error('订单ID不存在');
                }

                // 收集表单数据
                const updateData = {
                    customer_id: currentEditingOrder.customer_id,
                    customer_name: currentEditingOrder.customer_name,
                    customer_phone: currentEditingOrder.customer_phone,
                    service_date: document.getElementById('editServiceDate').value || null,
                    service_start_time: document.getElementById('editServiceStartTime').value || null,
                    service_end_time: document.getElementById('editServiceEndTime').value || null,
                    original_amount: parseFloat(document.getElementById('editOriginalAmount').value) || 0,
                    discount_amount: parseFloat(document.getElementById('editDiscountAmount').value) || 0,
                    final_amount: parseFloat(document.getElementById('editFinalAmount').value) || 0,
                    remark: document.getElementById('editRemark').value || null,
                    updated_by: 1  // TODO: 获取当前登录用户ID
                };

                console.log('📡 提交订单修改:', updateData);

                // 调用更新订单API
                const response = await window.apiClient.put(`/api/orders/${orderId}`, updateData);

                if (!response.success) {
                    throw new Error(response.message || '保存订单失败');
                }

                console.log('✅ 订单修改成功:', response.data);
                UIUtils.notify('✅ 订单修改成功', 'success');

                // 关闭模态框
                closeEditOrderModal();

                // 重新加载订单列表
                await loadOrders();

            } catch (error) {
                console.error('❌ 保存订单失败:', error);
                UIUtils.notify('保存订单失败: ' + error.message, 'error');
            }
        }

        // 确认订单
        async function confirmOrder(orderId) {
            if (!confirm('确认此订单？确认后将无法修改。')) {
                return;
            }

            try {
                console.log('📡 确认订单:', orderId);

                // 调用更新订单状态API
                const response = await window.apiClient.patch(`/api/orders/${orderId}/status`, {
                    order_status: 'confirmed',
                    updated_by: 1  // TODO: 获取当前登录用户ID
                });

                if (!response.success) {
                    throw new Error(response.message || '确认订单失败');
                }

                console.log('✅ 订单确认成功:', response.data);
                UIUtils.notify('✅ 订单已确认', 'success');

                // 重新加载订单列表
                await loadOrders();

            } catch (error) {
                console.error('❌ 确认订单失败:', error);
                UIUtils.notify('确认订单失败: ' + error.message, 'error');
            }
        }

        // ========================================
        // 生成任务相关功能
        // ========================================

        // 任务模板分类映射
        const CATEGORY_MAP = {
            'customer_follow_up': '客户跟进',
            'service_process': '服务流程',
            'quality_check': '质量检查',
            'inventory': '库存管理',
            'training': '培训',
            'nutrition_intervention': '营养干预',
            'care_service': '护理服务',
            'service_execution': '服务执行',
            'other': '其他'
        };

        // 服务类型关键词映射（用于智能推荐）
        const SERVICE_KEYWORDS_MAP = {
            '减重': ['SERVICE_WEIGHT_LOSS', 'PHLEGM_DAMP', 'SPLEEN_DEFICIENCY', 'LIVER_QI', 'SPLEEN_KIDNEY_YANG'],
            '减肥': ['SERVICE_WEIGHT_LOSS', 'PHLEGM_DAMP', 'SPLEEN_DEFICIENCY', 'LIVER_QI', 'SPLEEN_KIDNEY_YANG'],
            '瘦身': ['SERVICE_WEIGHT_LOSS', 'PRE_WEDDING_RAPID_SLIM'],
            '婚前': ['PRE_WEDDING_RAPID_SLIM'],
            '塑形': ['LOCAL_SHAPING'],
            '产后': ['POSTPARTUM_RECOVERY'],
            '修复': ['POSTPARTUM_RECOVERY'],
            '营养': ['NUTRITION_PLAN', 'NUTRITION_FOLLOWUP'],
            '护理': ['DAILY_CARE_GUIDANCE', 'CARE_EFFECT_ASSESSMENT']
        };

        // 显示生成任务模态框
        async function showGenerateTaskModal(orderId) {
            try {
                console.log('📋 显示生成任务模态框，订单ID:', orderId);

                // 获取订单信息
                const order = await getOrderById(orderId);
                if (!order) {
                    UIUtils.notify('订单不存在', 'error');
                    return;
                }

                currentGeneratingOrder = order;

                // 显示模态框
                document.getElementById('generateTaskModal').classList.remove('hidden');
                document.body.classList.add('no-scroll');

                // 显示订单信息
                const serviceName = order.service_name || order.solution_name || '未知服务';
                const serviceDate = order.service_date ? new Date(order.service_date).toLocaleDateString('zh-CN') : '未设置';
                document.getElementById('orderServiceName').textContent = serviceName;
                document.getElementById('orderServiceDate').textContent = serviceDate;

                // 加载任务模板
                await loadTaskTemplatesForOrder(order);

                lucide.createIcons();
            } catch (error) {
                console.error('❌ 显示生成任务模态框失败:', error);
                UIUtils.notify('加载失败: ' + error.message, 'error');
            }
        }

        // 为订单加载任务模板
        async function loadTaskTemplatesForOrder(order) {
            try {
                console.log('🔄 开始加载任务模板...');

                // 显示加载状态
                document.getElementById('taskTemplatesLoading').classList.remove('hidden');
                document.getElementById('recommendedTemplates').classList.add('hidden');
                document.getElementById('otherTemplates').classList.add('hidden');
                document.getElementById('noTemplatesMessage').classList.add('hidden');

                // 获取所有可用的任务模板
                const orgId = parseInt(localStorage.getItem('currentOrgId')) || currentCustomer.org_id || 1;
                const apiUrl = `/api/task-templates?org_id=${orgId}&status=active`;
                console.log('📡 API请求:', apiUrl);

                const response = await window.apiClient.get(apiUrl);
                console.log('📦 API响应:', response);

                if (!response.success || !response.data || response.data.length === 0) {
                    console.warn('⚠️ 没有可用的任务模板');
                    // 显示空状态
                    document.getElementById('taskTemplatesLoading').classList.add('hidden');
                    document.getElementById('noTemplatesMessage').classList.remove('hidden');
                    return;
                }

                const templates = response.data;
                console.log('✅ 成功加载任务模板:', templates.length, '个');
                console.log('📋 模板列表:', templates.map(t => t.template_name));

                // 根据订单服务内容智能推荐模板
                const { recommended, others } = categorizeTemplates(templates, order);
                console.log('⭐ 推荐模板数量:', recommended.length);
                console.log('📚 其他模板数量:', others.length);

                // 隐藏加载状态
                document.getElementById('taskTemplatesLoading').classList.add('hidden');

                // 渲染推荐模板
                if (recommended.length > 0) {
                    console.log('🎨 渲染推荐模板...');
                    renderTemplateList('recommendedTemplatesList', recommended, true);
                    document.getElementById('recommendedTemplates').classList.remove('hidden');
                }

                // 渲染其他模板
                if (others.length > 0) {
                    console.log('🎨 渲染其他模板...');
                    renderTemplateList('otherTemplatesList', others, false);
                    document.getElementById('otherTemplates').classList.remove('hidden');
                }

                // 如果没有任何模板，显示空状态
                if (recommended.length === 0 && others.length === 0) {
                    document.getElementById('noTemplatesMessage').classList.remove('hidden');
                }

                // 更新选中计数
                updateSelectedTemplateCount();

                lucide.createIcons();
                console.log('✨ 任务模板加载完成');
            } catch (error) {
                console.error('❌ 加载任务模板失败:', error);
                document.getElementById('taskTemplatesLoading').classList.add('hidden');
                document.getElementById('noTemplatesMessage').classList.remove('hidden');
            }
        }

        // 根据订单内容分类模板（智能推荐）
        function categorizeTemplates(templates, order) {
            const serviceName = (order.service_name || order.solution_name || '').toLowerCase();
            const recommended = [];
            const others = [];

            // 总是推荐的通用模板
            const alwaysRecommended = ['SERVICE_REMINDER', 'SERVICE_FOLLOWUP', 'NEXT_APPOINTMENT_REMINDER'];

            templates.forEach(template => {
                let isRecommended = false;

                // 1. 检查是否是通用推荐模板
                if (alwaysRecommended.includes(template.template_code)) {
                    isRecommended = true;
                }

                // 2. 根据服务名称关键词推荐
                if (!isRecommended) {
                    for (const [keyword, codes] of Object.entries(SERVICE_KEYWORDS_MAP)) {
                        if (serviceName.includes(keyword)) {
                            for (const code of codes) {
                                if (template.template_code.includes(code)) {
                                    isRecommended = true;
                                    break;
                                }
                            }
                            if (isRecommended) break;
                        }
                    }
                }

                if (isRecommended) {
                    recommended.push(template);
                } else {
                    others.push(template);
                }
            });

            return { recommended, others };
        }

        // 渲染模板列表
        function renderTemplateList(containerId, templates, defaultChecked = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            templates.forEach(template => {
                const categoryName = CATEGORY_MAP[template.category] || template.category;
                const estimatedTime = template.estimated_duration ? `约${template.estimated_duration}分钟` : '';

                const templateCard = document.createElement('label');
                templateCard.className = 'flex items-start gap-3 p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 hover:border-purple-300 transition-all';
                templateCard.innerHTML = `
                    <input type="checkbox"
                           class="task-template-checkbox mt-1 w-5 h-5 text-purple-600 rounded"
                           value="${template.template_code}"
                           data-template-id="${template.id}"
                           ${defaultChecked ? 'checked' : ''}
                           onchange="updateSelectedTemplateCount()">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="font-medium text-gray-900">${template.template_name}</div>
                            <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded">${categoryName}</span>
                            ${estimatedTime ? `<span class="text-xs text-gray-500">${estimatedTime}</span>` : ''}
                        </div>
                        <div class="text-sm text-gray-600">${template.description || '无描述'}</div>
                    </div>
                `;

                container.appendChild(templateCard);
            });
        }

        // 更新选中的模板计数
        function updateSelectedTemplateCount() {
            const checkboxes = document.querySelectorAll('.task-template-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedTemplateCount').textContent = count;
        }

        // 根据订单ID获取订单信息
        async function getOrderById(orderId) {
            try {
                const response = await window.apiClient.get(`/api/orders/${orderId}`);
                if (response.success && response.data) {
                    return response.data;
                }
                return null;
            } catch (error) {
                console.error('❌ 获取订单失败:', error);
                return null;
            }
        }

        // 关闭生成任务模态框
        function closeGenerateTaskModal() {
            document.getElementById('generateTaskModal').classList.add('hidden');
            document.body.classList.remove('no-scroll');
            currentGeneratingOrder = null;
        }

        // 确认生成任务
        async function confirmGenerateTasks() {
            try {
                if (!currentGeneratingOrder) {
                    UIUtils.notify('订单信息丢失', 'error');
                    return;
                }

                // 收集选中的任务模板
                const checkboxes = document.querySelectorAll('.task-template-checkbox:checked');
                const selectedTemplates = Array.from(checkboxes).map(cb => cb.value);

                if (selectedTemplates.length === 0) {
                    UIUtils.notify('请至少选择一个任务模板', 'warning');
                    return;
                }

                console.log('📡 生成任务，订单ID:', currentGeneratingOrder.id);
                console.log('📋 选中的任务模板:', selectedTemplates);

                // 获取当前机构ID
                const currentOrgId = parseInt(localStorage.getItem('currentOrgId')) || currentCustomer.org_id || 1;

                // 调用API生成任务
                const response = await window.apiClient.post('/api/tasks/generate-from-order', {
                    order_id: currentGeneratingOrder.id,
                    customer_id: currentCustomer.id,
                    org_id: currentOrgId,
                    template_codes: selectedTemplates,
                    created_by: 1  // TODO: 获取当前登录用户ID
                });

                console.log('✅ 任务生成响应:', response);

                if (!response.success) {
                    throw new Error(response.message || '生成任务失败');
                }

                UIUtils.notify(`✅ 成功生成 ${selectedTemplates.length} 个任务`, 'success');

                // 关闭模态框
                closeGenerateTaskModal();

                // 重新加载任务列表
                await loadTasks();

            } catch (error) {
                console.error('❌ 生成任务失败:', error);
                UIUtils.notify('生成任务失败: ' + error.message, 'error');
            }
        }

        // 点击模态框外部关闭生成任务模态框
        document.getElementById('generateTaskModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeGenerateTaskModal();
            }
        });

        // 点击模态框外部关闭修改订单模态框
        document.getElementById('editOrderModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeEditOrderModal();
            }
        });
    </script>

    <!-- 移动端底部导航 -->
    <div class="mobile-bottom-nav">
        <div class="flex justify-around items-center">
            <button class="mobile-nav-btn active" onclick="switchTab('profile')" data-tab="profile">
                <i data-lucide="user" class="w-5 h-5"></i>
                <span>资料</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('diagnosis')" data-tab="diagnosis">
                <i data-lucide="activity" class="w-5 h-5"></i>
                <span>诊断</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('plans')" data-tab="plans">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span>方案</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('orders')" data-tab="orders">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span>订单</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('tasks')" data-tab="tasks">
                <i data-lucide="check-square" class="w-5 h-5"></i>
                <span>任务</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('chat')" data-tab="chat">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span>对话</span>
            </button>
        </div>
    </div>

    <script>
        // 页面版本标识 - 用于调试缓存问题
        console.log('📦 客户详情页面版本: v2.0-任务模板选择器');
        console.log('🕐 加载时间:', new Date().toLocaleString('zh-CN'));
    </script>
</body>
</html>
