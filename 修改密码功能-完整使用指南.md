# 修改密码功能 - 完整使用指南

## 功能概述

本系统已完整实现用户修改密码功能，包括：
- 完整的前端UI界面（模态框形式）
- 密码强度检测
- 实时密码匹配验证
- 安全的后端API（bcrypt加密）
- 用户友好的提示信息

---

## 功能位置

### 1. 设置页面中使用
文件：`settings.html`

**访问路径：**
1. 打开浏览器访问：`http://localhost:3000/settings.html`
2. 点击顶部导航 "用户信息" 标签
3. 在 "安全设置" 卡片中点击 "修改密码"

### 2. 独立测试页面
文件：`test-change-password.html`

**访问路径：**
- 浏览器访问：`http://localhost:3000/test-change-password.html`

---

## 使用前准备

### 1. 启动后端服务器

```bash
# 方式一：使用npm
cd D:\work6\美业客户后台
npm start

# 方式二：直接运行
node api/server.js

# 方式三：使用PM2（生产环境）
pm2 start ecosystem.config.js
```

**验证服务器运行：**
```bash
# 浏览器访问
http://localhost:3000

# 或使用curl测试
curl http://localhost:3000/api/users/1
```

### 2. 确认数据库连接

确保MySQL数据库服务正在运行，并且配置正确：

**数据库配置文件：** `api/config/database.js`

```javascript
const config = {
    host: 'localhost',
    port: 3306,
    user: 'root',
    password: 'your_password',
    database: 'beauty_crm'
};
```

### 3. 准备测试用户

系统需要至少一个测试用户。如果数据库中没有用户，运行以下脚本：

```bash
node database/create-test-users.js
```

这将创建默认测试用户：
- **用户名**: `admin`
- **密码**: `123456`
- **用户ID**: `1`

---

## 功能使用步骤

### 方式一：在设置页面中使用

1. **打开设置页面**
   ```
   http://localhost:3000/settings.html
   ```

2. **切换到"用户信息"标签**
   - 点击页面顶部的 "用户信息" 标签

3. **点击"修改密码"按钮**
   - 在右侧"安全设置"卡片中
   - 点击"修改密码"选项

4. **填写密码信息**
   - 当前密码：输入现有密码（如：123456）
   - 新密码：输入新密码（至少6位）
   - 确认新密码：再次输入新密码

5. **查看密码强度提示**
   - 系统会自动显示密码强度（很弱/弱/中等/强/很强）
   - 绿色表示强密码

6. **提交修改**
   - 点击"确认修改"按钮
   - 等待处理完成
   - 查看成功/失败提示

### 方式二：使用测试页面

1. **打开测试页面**
   ```
   http://localhost:3000/test-change-password.html
   ```

2. **方法A - 手动填写**
   - 依次填写三个密码框
   - 观察密码强度和匹配提示
   - 点击"提交修改"

3. **方法B - 快速测试**
   - 点击"填充默认值"按钮
   - 系统自动填入测试数据
   - 点击"提交修改"

4. **查看测试结果**
   - 成功：绿色背景提示
   - 失败：红色背景显示错误原因

---

## 前端实现细节

### UI组件位置（settings.html）

1. **修改密码模态框** (457-550行)
   - 当前密码输入框
   - 新密码输入框（带强度检测）
   - 确认密码输入框（带匹配验证）
   - 密码安全建议
   - 提交/取消按钮

2. **JavaScript功能** (1559-1751行)
   - `changePassword()` - 打开模态框
   - `closePasswordModal()` - 关闭模态框
   - `togglePasswordVisibility()` - 切换密码可见性
   - `calculatePasswordStrength()` - 计算密码强度
   - `updatePasswordStrength()` - 更新强度显示
   - `checkPasswordMatch()` - 检查密码匹配
   - 表单提交处理

### 前端验证规则

```javascript
// 1. 必填验证
if (!currentPassword || !newPassword || !confirmPassword) {
    UIUtils.notify('请填写所有必填字段', 'error');
    return;
}

// 2. 密码长度验证
if (newPassword.length < 6) {
    UIUtils.notify('新密码长度至少为6位', 'error');
    return;
}

// 3. 密码一致性验证
if (newPassword !== confirmPassword) {
    UIUtils.notify('两次输入的密码不一致', 'error');
    return;
}

// 4. 新旧密码不能相同
if (currentPassword === newPassword) {
    UIUtils.notify('新密码不能与当前密码相同', 'error');
    return;
}
```

### 密码强度计算算法

```javascript
function calculatePasswordStrength(password) {
    let strength = 0;

    if (password.length >= 6) strength += 1;  // 基础长度
    if (password.length >= 8) strength += 1;  // 推荐长度
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;  // 大小写
    if (/\d/.test(password)) strength += 1;   // 数字
    if (/[^a-zA-Z\d]/.test(password)) strength += 1;  // 特殊字符

    return strength; // 0-5级
}
```

强度等级：
- **0-1**: 很弱（红色）
- **2**: 弱（橙色）
- **3**: 中等（黄色）
- **4**: 强（蓝色）
- **5**: 很强（绿色）

---

## 后端实现细节

### API路由（api/routes/users.js）

**端点：** `PATCH /api/users/:id/password`

**请求参数：**
```json
{
    "old_password": "当前密码（明文）",
    "new_password": "新密码（明文）"
}
```

**响应格式：**

成功：
```json
{
    "success": true,
    "message": "密码更新成功"
}
```

失败：
```json
{
    "success": false,
    "error": {
        "code": "错误码",
        "message": "错误描述"
    }
}
```

### 错误码说明

| 错误码 | 说明 | 原因 |
|--------|------|------|
| `INVALID_PARAMS` | 缺少必填字段 | 未提供旧密码或新密码 |
| `USER_NOT_FOUND` | 用户不存在 | 数据库中找不到该用户ID |
| `INVALID_PASSWORD` | 原密码错误 | 当前密码验证失败 |
| `UPDATE_FAILED` | 密码更新失败 | 数据库更新操作失败 |
| `INTERNAL_ERROR` | 服务器内部错误 | 未知错误 |

### 安全措施

1. **密码加密存储**
   ```javascript
   const bcrypt = require('bcrypt');
   const password_hash = await bcrypt.hash(new_password, 10);
   ```

2. **旧密码验证**
   ```javascript
   const isValidPassword = await bcrypt.compare(old_password, user.password_hash);
   ```

3. **敏感信息过滤**
   ```javascript
   delete user.password_hash; // 返回用户信息时移除密码哈希
   ```

4. **SQL注入防护**
   - 使用参数化查询
   - 输入验证

---

## 数据库模型（api/models/User.js）

### 相关方法

1. **findByIdWithPassword(id)**
   - 获取包含密码哈希的用户信息
   - 用于密码验证

2. **updatePassword(id, password_hash)**
   - 更新用户密码哈希
   - 自动更新updated_at字段

### SQL查询示例

```sql
-- 验证旧密码（获取用户信息）
SELECT id, username, password_hash, real_name, org_id, status
FROM users
WHERE id = ? AND is_deleted = 0

-- 更新密码
UPDATE users
SET password_hash = ?, updated_at = NOW()
WHERE id = ? AND is_deleted = 0
```

---

## API调用方法（js/api.js）

### 前端调用示例

```javascript
// 方法定义（已实现）
const userAPI = {
    async updatePassword(id, oldPassword, newPassword) {
        return await api.patch(`/api/users/${id}/password`, {
            old_password: oldPassword,
            new_password: newPassword
        });
    }
};

// 使用示例
const result = await userAPI.updatePassword(1, '123456', 'newpass123');

if (result.success) {
    console.log('密码修改成功');
} else {
    console.error('修改失败:', result.error.message);
}
```

---

## 测试流程

### 完整测试步骤

1. **准备环境**
   ```bash
   # 启动数据库
   # 启动后端服务
   npm start
   ```

2. **打开测试页面**
   ```
   http://localhost:3000/test-change-password.html
   ```

3. **测试场景一：成功修改**
   - 当前密码：`123456`
   - 新密码：`newpass123`
   - 确认密码：`newpass123`
   - 预期结果：✓ 密码修改成功

4. **测试场景二：旧密码错误**
   - 当前密码：`wrongpass`
   - 新密码：`newpass123`
   - 确认密码：`newpass123`
   - 预期结果：✗ 原密码错误

5. **测试场景三：密码不一致**
   - 当前密码：`123456`
   - 新密码：`newpass123`
   - 确认密码：`newpass456`
   - 预期结果：✗ 两次输入的密码不一致（前端拦截）

6. **测试场景四：密码太短**
   - 当前密码：`123456`
   - 新密码：`123`
   - 确认密码：`123`
   - 预期结果：✗ 新密码长度至少为6位（前端拦截）

7. **测试场景五：新旧密码相同**
   - 当前密码：`123456`
   - 新密码：`123456`
   - 确认密码：`123456`
   - 预期结果：✗ 新密码不能与当前密码相同（前端拦截）

### 使用curl测试API

```bash
# 成功案例
curl -X PATCH http://localhost:3000/api/users/1/password \
  -H "Content-Type: application/json" \
  -d '{"old_password":"123456","new_password":"newpass123"}'

# 预期响应
{"success":true,"message":"密码更新成功"}

# 失败案例（旧密码错误）
curl -X PATCH http://localhost:3000/api/users/1/password \
  -H "Content-Type: application/json" \
  -d '{"old_password":"wrongpass","new_password":"newpass123"}'

# 预期响应
{"success":false,"error":{"code":"INVALID_PASSWORD","message":"原密码错误"}}
```

### 使用Postman测试

1. **创建新请求**
   - Method: `PATCH`
   - URL: `http://localhost:3000/api/users/1/password`

2. **设置Headers**
   ```
   Content-Type: application/json
   ```

3. **设置Body（raw JSON）**
   ```json
   {
       "old_password": "123456",
       "new_password": "newpass123"
   }
   ```

4. **发送请求并查看响应**

---

## 常见问题排查

### 1. 服务器连接失败

**症状：** 提示"网络错误"或"API连接失败"

**解决方法：**
```bash
# 检查服务器是否运行
npm start

# 检查端口是否被占用
netstat -ano | findstr :3000

# 查看服务器日志
tail -f logs/app.log
```

### 2. 数据库连接失败

**症状：** 提示"INTERNAL_ERROR"或服务器日志显示数据库错误

**解决方法：**
```bash
# 测试数据库连接
node database/test-connection.js

# 检查数据库配置
# 编辑 api/config/database.js

# 验证数据库表是否存在
node database/verify-tables.js
```

### 3. 用户不存在

**症状：** 提示"USER_NOT_FOUND"

**解决方法：**
```bash
# 创建测试用户
node database/create-test-users.js

# 或直接在MySQL中创建
mysql -u root -p
USE beauty_crm;
SELECT * FROM users WHERE id = 1;
```

### 4. 前端显示问题

**症状：** 模态框不显示、样式错误

**解决方法：**
1. 检查浏览器控制台错误
2. 确认CSS文件已加载
3. 确认Lucide图标库已加载
4. 清除浏览器缓存

### 5. Toast通知不显示

**症状：** 没有弹出通知提示

**解决方法：**
1. 确认`js/utils.js`已正确加载
2. 确认`css/styles.css`包含通知样式
3. 检查浏览器控制台是否有JavaScript错误

---

## 扩展功能建议

### 1. 密码历史记录
防止用户重复使用最近的密码：

```sql
CREATE TABLE password_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 2. 密码过期策略
强制用户定期更换密码：

```javascript
// 检查密码是否过期（90天）
const passwordAge = daysBetween(user.password_updated_at, new Date());
if (passwordAge > 90) {
    // 强制要求修改密码
}
```

### 3. 登录失败锁定
多次输入错误密码后锁定账户：

```javascript
// 记录失败次数
await User.incrementFailedLoginAttempts(userId);

if (user.failed_login_attempts >= 5) {
    await User.lockAccount(userId);
}
```

### 4. 密码找回功能
通过邮箱/手机重置密码：

```javascript
// 发送重置邮件
await sendPasswordResetEmail(user.email, resetToken);
```

### 5. 双因素认证（2FA）
增强账户安全性：

```javascript
// 生成TOTP密钥
const secret = generateTOTPSecret();
await User.enable2FA(userId, secret);
```

---

## 文件清单

### 前端文件
- `settings.html` - 设置页面（含修改密码UI）
- `test-change-password.html` - 独立测试页面
- `js/api.js` - API调用封装（含userAPI.updatePassword）
- `js/utils.js` - 工具函数（含UIUtils.notify）
- `css/styles.css` - 样式文件（含通知样式）

### 后端文件
- `api/routes/users.js` - 用户路由（含修改密码API）
- `api/models/User.js` - 用户模型（含数据库操作）
- `api/config/database.js` - 数据库配置
- `api/server.js` - 服务器入口

### 数据库脚本
- `database/init-db.js` - 初始化数据库
- `database/create-test-users.js` - 创建测试用户
- `database/test-connection.js` - 测试数据库连接
- `database/verify-tables.js` - 验证表结构

---

## 联系支持

如有问题，请检查：
1. 服务器日志：`logs/app.log`
2. 浏览器控制台错误
3. 数据库连接状态
4. 网络连接

**测试成功标准：**
- ✓ 服务器正常运行（端口3000）
- ✓ 数据库连接正常
- ✓ 可以成功修改密码
- ✓ 错误情况正确提示
- ✓ UI交互流畅无卡顿

---

**文档版本：** 1.0
**最后更新：** 2025-12-02
**适用版本：** 美业客户洞察CRM v1.0.0
