# 修改密码功能演示脚本

## 场景：用户需要修改登录密码

### 步骤1: 访问系统设置页面

**操作**: 用户登录后，点击右上角用户菜单中的"系统设置"

**页面**: http://localhost:3000/settings.html

**当前位置**: 默认显示"组织信息"标签页

---

### 步骤2: 切换到用户信息标签页

**操作**: 点击"用户信息"标签

**界面变化**:
- 左侧显示"个人资料"卡片
  - 头像、姓名、职位、邮箱、手机号
- 右侧显示"安全设置"卡片
  - 密码强度显示: "您的密码安全等级: 强"
  - 三个安全选项按钮:
    1. ✨ **修改密码** ← 我们的目标
    2. 双因素认证（未启用）
    3. 登录历史

---

### 步骤3: 打开修改密码对话框

**操作**: 点击"修改密码"按钮

**界面变化**: 弹出模态对话框

**对话框标题**: 🔑 修改密码

**对话框内容**:
```
┌────────────────────────────────────────┐
│ 🔑 修改密码                      [X]   │
├────────────────────────────────────────┤
│                                        │
│ 当前密码 *                             │
│ [••••••••••••]                    👁   │
│                                        │
│ 新密码 *                               │
│ [••••••••••••]                    👁   │
│ [密码强度指示器]                      │
│                                        │
│ 确认新密码 *                           │
│ [••••••••••••]                    👁   │
│ [密码匹配提示]                        │
│                                        │
│ ℹ️ 密码安全建议                        │
│ • 密码长度至少6位，建议8位以上        │
│ • 包含大小写字母、数字和特殊字符      │
│ • 不要使用生日、电话等易猜测信息      │
│                                        │
│        [取消]    [✓ 确认修改]         │
└────────────────────────────────────────┘
```

---

### 步骤4: 输入当前密码

**操作**: 在"当前密码"输入框输入: `password123`

**界面**: 密码以圆点显示: `••••••••••••`

**可选操作**: 点击👁图标查看明文密码

**切换后**: 图标变为👁‍🗨，密码显示为明文: `password123`

---

### 步骤5: 输入新密码（观察密码强度）

**测试不同强度的密码**:

#### 5.1 输入弱密码
**输入**: `123456`

**密码强度显示**:
```
[████░░░░░░] 很弱
  红色
```

#### 5.2 输入中等密码
**输入**: `Abc123`

**密码强度显示**:
```
[████████░░] 中等
  黄色
```

#### 5.3 输入强密码
**输入**: `NewPass@123`

**密码强度显示**:
```
[██████████] 很强
  绿色
```

---

### 步骤6: 确认新密码（观察匹配提示）

#### 6.1 输入不匹配的密码
**新密码**: `NewPass@123`
**确认密码**: `NewPass@456`

**提示显示**:
```
❌ 两次输入的密码不一致
   (红色文字)
```

#### 6.2 输入匹配的密码
**新密码**: `NewPass@123`
**确认密码**: `NewPass@123`

**提示显示**:
```
✓ 密码匹配
  (绿色文字)
```

---

### 步骤7: 提交修改

**完整填写示例**:
- 当前密码: `password123`
- 新密码: `NewPass@123`
- 确认新密码: `NewPass@123`

**操作**: 点击"确认修改"按钮

**按钮状态变化**:
```
[✓ 确认修改] → [⏳ 修改中...] → 恢复原状态
```

---

### 步骤8: 查看结果

#### 成功情况

**提示消息**:
```
┌─────────────────────────────────────┐
│ ✓ 密码修改成功，请使用新密码登录    │
└─────────────────────────────────────┘
```

**界面变化**:
- 模态对话框自动关闭
- 表单内容已清空
- 可以继续其他操作

#### 失败情况

**场景1: 当前密码错误**

**输入**: 当前密码填写为 `wrongpassword`

**提示消息**:
```
┌─────────────────────────────────────┐
│ ✗ 原密码错误                        │
└─────────────────────────────────────┘
```

**场景2: 网络错误**

**提示消息**:
```
┌─────────────────────────────────────┐
│ ✗ 网络错误，请稍后重试              │
└─────────────────────────────────────┘
```

---

## 完整交互流程图

```
用户点击"修改密码"
        ↓
  打开模态对话框
        ↓
  填写当前密码
        ↓
  填写新密码 ─→ [实时显示密码强度]
        ↓
  确认新密码 ─→ [实时验证是否匹配]
        ↓
  点击"确认修改"
        ↓
  前端验证 ────→ 验证失败 ─→ 显示错误提示
        ↓                        ↑
  验证通过                       │
        ↓                        │
  调用后端API                    │
        ↓                        │
  后端验证当前密码 ──验证失败 ────┘
        ↓
  验证通过
        ↓
  加密新密码(bcrypt)
        ↓
  更新数据库
        ↓
  返回成功响应
        ↓
  关闭对话框
        ↓
  显示成功提示
```

---

## 实际操作演示

### 1. 打开浏览器
```
http://localhost:3000/settings.html
```

### 2. 切换到"用户信息"标签

### 3. 点击"修改密码"

### 4. 填写表单
- 当前密码: `password123`
- 新密码: `NewPass@123`
- 确认新密码: `NewPass@123`

### 5. 观察密码强度
应该显示"很强"（绿色）

### 6. 观察密码匹配
应该显示"密码匹配"（绿色）

### 7. 点击"确认修改"

### 8. 查看提示
应该显示"密码修改成功，请使用新密码登录"

### 9. 验证修改结果
再次点击"修改密码"，使用新密码`NewPass@123`作为当前密码

---

## 常见问题

### Q1: 点击"修改密码"没反应？
**A**: 检查浏览器控制台是否有JavaScript错误

### Q2: 提交后一直显示"修改中..."？
**A**: 检查后端服务是否正常运行（端口3000）

### Q3: 显示"原密码错误"？
**A**: 确认当前密码是否正确，测试用户默认密码可能是`password123`

### Q4: 密码强度一直是"很弱"？
**A**: 尝试输入包含大小写字母、数字和特殊字符的密码

### Q5: 修改成功后能用新密码登录吗？
**A**: 如果系统有登录功能，应该可以。当前演示系统可能没有完整的登录页面。

---

## 技术细节

### 前端实现
- **文件**: settings.html (第457-550行: 模态对话框HTML)
- **文件**: settings.html (第1559-1751行: JavaScript逻辑)
- **密码强度算法**: 基于长度、大小写、数字、特殊字符的5级评分
- **实时验证**: 使用input事件监听器

### 后端实现
- **路由**: PATCH /api/users/:id/password
- **文件**: api/routes/users.js (第300-367行)
- **验证**: bcrypt.compare(旧密码, 数据库密码哈希)
- **加密**: bcrypt.hash(新密码, 10轮加盐)

### 数据流
```
前端输入 → 前端验证 → API请求 → 后端验证 → 密码加密 → 数据库更新 → 响应返回 → 前端提示
```
