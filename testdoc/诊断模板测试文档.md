# 诊断模板功能测试文档

## 文档信息
- **模块名称**: 诊断模板管理
- **页面路径**: /diagnosis-templates.html
- **API路由**: /api/diagnosis-templates
- **测试目的**: 验证皮肤诊断模板的创建、字段配置、诊断项管理等功能的数据库操作正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

诊断模板管理模块负责定义皮肤诊断的评估项目和标准，支持不同组织创建个性化的皮肤诊断表单模板。

### 核心功能
1. 模板信息管理（CRUD）
2. 诊断字段配置（动态字段定义）
3. 诊断项分组管理
4. 模板共享范围控制（global/org）
5. 适用场景设置
6. 模板统计分析

---

## 二、数据库表结构

### 2.1 主表：diagnosis_templates

```sql
CREATE TABLE `diagnosis_templates` (
  `id` int NOT NULL AUTO_INCREMENT,
  `template_code` varchar(50) NOT NULL COMMENT '模板编码',
  `template_name` varchar(200) NOT NULL COMMENT '模板名称',
  `description` text COMMENT '模板描述',
  `org_id` bigint unsigned DEFAULT NULL COMMENT '组织ID（NULL表示全局模板）',
  `scope` enum('global','org') DEFAULT 'org' COMMENT '作用域：global-全局，org-组织',
  `apply_scene` varchar(100) DEFAULT NULL COMMENT '适用场景',
  `fields` json NOT NULL COMMENT '模板字段定义（JSON格式）',
  `version` varchar(20) DEFAULT '1.0' COMMENT '模板版本',
  `status` enum('active','inactive') DEFAULT 'active' COMMENT '状态',
  `sort_order` int DEFAULT '0' COMMENT '排序顺序',
  `created_by` int DEFAULT NULL COMMENT '创建人ID',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `template_code` (`template_code`),
  KEY `idx_org_id` (`org_id`),
  KEY `idx_status` (`status`),
  KEY `idx_apply_scene` (`apply_scene`),
  CONSTRAINT `diagnosis_templates_ibfk_1` FOREIGN KEY (`org_id`) REFERENCES `organizations` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB COMMENT='诊断模板表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | int | 是 | 主键 | 自增 |
| template_code | varchar(50) | 是 | 模板编码 | 全局唯一，不可修改 |
| template_name | varchar(200) | 是 | 模板名称 | 用于显示 |
| description | text | 否 | 模板描述 | 说明模板用途 |
| org_id | bigint | 否 | 组织ID | NULL表示全局模板 |
| scope | enum | 否 | 作用域 | global/org，默认org |
| apply_scene | varchar(100) | 否 | 适用场景 | 如：新客诊断、定期复诊等 |
| fields | json | 是 | 字段定义 | JSON数组，存储诊断项配置 |
| version | varchar(20) | 否 | 版本号 | 默认1.0 |
| status | enum | 否 | 状态 | active/inactive，默认active |
| sort_order | int | 否 | 排序 | 默认0 |
| created_by | int | 否 | 创建人 | 用户ID |

**scope字段说明**:

| 值 | 含义 | 可见范围 | 典型应用 |
|----|------|---------|---------|
| global | 全局模板 | 所有组织可见可用 | 系统标准诊断模板 |
| org | 组织模板 | 仅本组织可见可用 | 组织特色诊断项 |

### 2.2 fields字段JSON结构

```json
[
  {
    "field_key": "skin_moisture",
    "field_name": "皮肤含水量",
    "field_type": "select",
    "group": "水分检测",
    "required": true,
    "options": ["严重缺水", "轻度缺水", "正常", "水分充足"],
    "scoring": {
      "严重缺水": 1,
      "轻度缺水": 2,
      "正常": 3,
      "水分充足": 4
    },
    "unit": "%",
    "normal_range": "30-50%",
    "display_order": 1
  }
]
```

**字段属性说明**:

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| field_key | string | 是 | 字段键（英文） |
| field_name | string | 是 | 字段名称（中文） |
| field_type | string | 是 | 字段类型（select/number/text等） |
| group | string | 是 | 所属分组（如：水分检测、油脂检测） |
| required | boolean | 否 | 是否必填 |
| options | array | 否 | 选项列表 |
| scoring | object | 否 | 评分规则（选项→分数映射） |
| unit | string | 否 | 单位（%、mg/L等） |
| normal_range | string | 否 | 正常范围 |
| display_order | number | 是 | 显示顺序 |

---

## 三、业务流程

### 3.1 创建诊断模板流程

```
开始
  ↓
前端：填写模板基本信息
  ↓
API: POST /api/diagnosis-templates
  ↓
验证：模板编码唯一性（全局唯一）
  ↓
插入：diagnosis_templates 表
  ↓
获取：新模板ID
  ↓
配置诊断项字段
  ↓
更新：fields 字段（JSON）
  ↓
返回：成功
  ↓
结束
```

### 3.2 使用模板进行诊断流程

```
开始
  ↓
选择：诊断模板
  ↓
API: GET /api/diagnosis-templates/:id
  ↓
渲染：动态诊断表单（基于fields配置）
  ↓
美容师：填写诊断结果
  ↓
API: POST /api/diagnoses
Body: { template_id, customer_id, diagnosis_data: {...}, scores: {...} }
  ↓
创建：诊断记录
  ↓
计算：综合评分
  ↓
返回：诊断报告
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建模板测试

#### 测试场景1：创建全局标准诊断模板

**前置条件**:
- 已登录系统
- 有模板管理权限

**操作步骤**:
1. 访问 http://8.210.246.101:5002/diagnosis-templates.html
2. 点击"创建模板"按钮
3. 填写信息：
   - 模板编码：`SKIN_DIAGNOSIS_STD_V1`
   - 模板名称：`标准皮肤诊断模板V1.0`
   - 描述：`包含水分、油脂、弹性等基础诊断项`
   - 作用域：`全局模板(global)`
   - 适用场景：`新客诊断`
   - 状态：`启用(active)`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证模板创建
SELECT
    id, template_code, template_name, description,
    scope, apply_scene, org_id, status
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期结果：
-- template_code: SKIN_DIAGNOSIS_STD_V1
-- template_name: 标准皮肤诊断模板V1.0
-- scope: global
-- org_id: NULL (全局模板)
-- status: active

-- 2. 验证字段JSON结构
SELECT
    template_code,
    JSON_LENGTH(fields) as field_count,
    JSON_VALID(fields) as is_valid_json
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期结果：
-- field_count: 0 (新建模板暂无字段)
-- is_valid_json: 1
```

**预期结果**:
- ✅ diagnosis_templates表新增1条记录
- ✅ template_code全局唯一
- ✅ scope为'global'，org_id为NULL
- ✅ status默认为'active'
- ✅ created_at和updated_at自动设置

#### 测试场景2：模板编码重复校验

**操作步骤**:
1. 创建模板：`SKIN_DIAGNOSIS_STD_V1`（与已存在模板代码重复）
2. 保存

**数据库验证SQL**:

```sql
-- 验证唯一约束
SELECT COUNT(*) as count
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期结果：
-- count: 1 (只有一个，创建失败)
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"模板编码已存在"
- ✅ 数据库无新增记录

### 4.2 诊断项配置测试

#### 测试场景3：添加基础诊断项

**前置条件**: 模板SKIN_DIAGNOSIS_STD_V1已存在

**操作步骤**:
1. 编辑模板SKIN_DIAGNOSIS_STD_V1
2. 添加诊断项：
   - 字段键: `skin_moisture`
   - 字段名称: `皮肤含水量`
   - 字段类型: `单选下拉(select)`
   - 分组: `水分检测`
   - 选项: `严重缺水(1分),轻度缺水(2分),正常(3分),水分充足(4分)`
   - 单位: `%`
   - 正常范围: `30-50%`
   - 必填: ✓
   - 显示顺序: 1
3. 保存

**数据库验证SQL**:

```sql
-- 验证诊断项添加
SELECT
    template_code,
    JSON_LENGTH(fields) as field_count,
    JSON_EXTRACT(fields, '$[0].field_name') as first_field_name,
    JSON_EXTRACT(fields, '$[0].field_type') as first_field_type
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期结果：
-- field_count: 1
-- first_field_name: "皮肤含水量"
-- first_field_type: "select"

-- 验证评分规则
SELECT
    JSON_PRETTY(JSON_EXTRACT(fields, '$[0].scoring')) as scoring_rules
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期包含：
-- {"严重缺水": 1, "轻度缺水": 2, "正常": 3, "水分充足": 4}
```

**预期结果**:
- ✅ fields JSON数组新增1个元素
- ✅ 诊断项属性完整（field_key, scoring, unit, normal_range等）
- ✅ 评分规则正确配置

#### 测试场景4：配置完整诊断项组

**操作步骤**:
1. 编辑模板
2. 批量添加诊断项组：

   **水分检测组**:
   - 皮肤含水量 (select, 1-4分)
   - T区水分值 (number, 单位%)

   **油脂检测组**:
   - 皮肤出油量 (select, 1-4分)
   - T区油脂值 (number, 单位mg/L)

   **弹性检测组**:
   - 皮肤弹性 (select, 差/一般/良好/优秀)
   - 胶原蛋白密度 (select, 低/中/高)

3. 保存

**数据库验证SQL**:

```sql
-- 验证诊断项分组
SELECT
    jt.group_name,
    COUNT(*) as item_count
FROM diagnosis_templates t,
     JSON_TABLE(
         t.fields,
         '$[*]' COLUMNS (
             group_name VARCHAR(50) PATH '$.group'
         )
     ) AS jt
WHERE t.template_code = 'SKIN_DIAGNOSIS_STD_V1'
GROUP BY jt.group_name
ORDER BY MIN(JSON_EXTRACT(t.fields, CONCAT('$[', jt.ordinality - 1, '].display_order')));

-- 预期结果：
-- 水分检测: 2项
-- 油脂检测: 2项
-- 弹性检测: 2项
```

**预期结果**:
- ✅ 成功添加6个诊断项
- ✅ 分组正确（3个组）
- ✅ 每个诊断项属性完整

### 4.3 模板状态管理测试

#### 测试场景5：停用模板

**操作步骤**:
1. 点击模板的停用按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT template_code, status, updated_at
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期结果：
-- status: inactive
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status从'active'变为'inactive'
- ✅ updated_at自动更新
- ✅ 模板不再出现在可选列表中

### 4.4 删除模板测试

#### 测试场景6：删除模板

**操作步骤**:
1. 点击模板的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证物理删除
SELECT COUNT(*) as count
FROM diagnosis_templates
WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';

-- 预期结果：
-- count: 0 (物理删除，记录不存在)

-- 注意：诊断模板不使用软删除，是物理删除
```

**预期结果**:
- ✅ 记录从数据库中删除
- ⚠️ 注意：确保没有诊断记录关联此模板

---

## 五、统计功能测试

### 测试场景7：模板统计

**API**: `GET /api/diagnosis-templates/stats`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(CASE WHEN scope = 'global' THEN 1 ELSE 0 END) as global_count,
    SUM(CASE WHEN scope = 'org' THEN 1 ELSE 0 END) as org_count
FROM diagnosis_templates;

-- 统计各场景的模板数
SELECT
    apply_scene,
    COUNT(*) as count
FROM diagnosis_templates
GROUP BY apply_scene
ORDER BY count DESC;
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试模板编码最大长度（50字符）
INSERT INTO diagnosis_templates (template_code, template_name, fields)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试模板',
    '[]'
);

-- 预期：成功
```

### 6.2 必填字段测试

```sql
-- 测试缺少必填字段
INSERT INTO diagnosis_templates (template_code) -- 缺少template_name和fields
VALUES ('test');

-- 预期：失败，NOT NULL约束
```

### 6.3 JSON字段有效性测试

```sql
-- 测试无效JSON
UPDATE diagnosis_templates
SET fields = 'invalid json'
WHERE id = 1;

-- 预期：失败，JSON格式错误

-- 测试空JSON数组
UPDATE diagnosis_templates
SET fields = '[]'
WHERE id = 1;

-- 预期：成功，空数组是有效的
```

### 6.4 外键约束测试

```sql
-- 测试无效org_id
INSERT INTO diagnosis_templates (template_code, template_name, org_id, fields)
VALUES ('TEST', '测试', 99999, '[]');

-- 预期：失败，外键约束
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试template_code唯一索引
EXPLAIN SELECT * FROM diagnosis_templates WHERE template_code = 'SKIN_DIAGNOSIS_STD_V1';
-- 预期：type=const, key=template_code

-- 测试org_id索引
EXPLAIN SELECT * FROM diagnosis_templates WHERE org_id = 7;
-- 预期：type=ref, key=idx_org_id

-- 测试JSON字段查询
EXPLAIN SELECT * FROM diagnosis_templates
WHERE JSON_CONTAINS(fields, '{"field_type": "select"}');
-- 验证JSON查询性能
```

---

## 八、数据完整性检查

### 8.1 孤儿记录检查

```sql
-- 检查无效的org_id
SELECT id, template_code, org_id
FROM diagnosis_templates
WHERE org_id IS NOT NULL
  AND org_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0);

-- 预期结果：0条记录
```

### 8.2 数据一致性检查

```sql
-- 检查唯一约束完整性
SELECT template_code, COUNT(*) as count
FROM diagnosis_templates
GROUP BY template_code
HAVING count > 1;

-- 预期结果：0条记录

-- 检查JSON字段完整性
SELECT
    id,
    template_code,
    CASE
        WHEN JSON_VALID(fields) THEN '✅ 有效'
        ELSE '❌ 无效'
    END as fields_valid
FROM diagnosis_templates;

-- 预期：所有记录的JSON都应该有效
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 删除测试模板
DELETE FROM diagnosis_templates
WHERE template_code LIKE 'TEST_%' OR template_code LIKE 'SKIN_DIAGNOSIS_STD_%';

-- 验证清理结果
SELECT COUNT(*) as remaining_test_templates
FROM diagnosis_templates
WHERE template_code LIKE 'TEST_%' OR template_code LIKE 'SKIN_DIAGNOSIS_STD_%';

-- 预期结果：0
```

---

## 十、常见问题排查

### 问题1：创建模板失败

**排查SQL**:
```sql
-- 检查模板编码是否已存在
SELECT id, template_code, scope, org_id
FROM diagnosis_templates
WHERE template_code = 'xxx';

-- 检查外键关系
SELECT id, org_name
FROM organizations
WHERE id = xxx;
```

### 问题2：诊断项配置保存失败

**排查SQL**:
```sql
-- 检查JSON格式
SELECT
    id,
    template_code,
    JSON_VALID(fields) as is_valid_json,
    fields
FROM diagnosis_templates
WHERE id = xxx;

-- 检查诊断项结构
SELECT
    JSON_EXTRACT(fields, '$[0].field_key') as field_key,
    JSON_EXTRACT(fields, '$[0].field_name') as field_name,
    JSON_EXTRACT(fields, '$[0].scoring') as scoring_rules
FROM diagnosis_templates
WHERE id = xxx;
```

---

## 十一、测试检查清单

### 功能测试
- [ ] 创建全局模板
- [ ] 创建组织模板
- [ ] 模板编码重复校验
- [ ] 添加基础诊断项
- [ ] 配置完整诊断项组
- [ ] 配置评分规则
- [ ] 停用模板
- [ ] 删除模板
- [ ] 模板统计准确性

### 数据库测试
- [ ] diagnosis_templates表记录正确插入
- [ ] 唯一约束生效（template_code）
- [ ] 外键约束生效（org_id）
- [ ] 索引使用正确
- [ ] JSON字段格式正确
- [ ] fields数组结构正确
- [ ] 时间戳自动更新

### 诊断项配置测试
- [ ] 选择字段配置
- [ ] 数值字段配置
- [ ] 评分规则配置
- [ ] 单位和正常范围配置
- [ ] 字段分组配置
- [ ] 字段排序

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验
- [ ] JSON格式校验
- [ ] 外键约束

### 性能测试
- [ ] 索引效率
- [ ] JSON查询性能

---

## 十二、快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试模板
INSERT INTO diagnosis_templates (
    template_code, template_name, description,
    scope, apply_scene, fields, created_by
)
VALUES (
    'AUTO_TEST_DIAG_001',
    '自动测试诊断模板',
    '用于自动化测试',
    'global',
    '新客诊断',
    '[]',
    1
);

SET @test_template_id = LAST_INSERT_ID();

-- 2. 添加诊断项配置
UPDATE diagnosis_templates
SET fields = JSON_ARRAY(
    JSON_OBJECT(
        'field_key', 'test_moisture',
        'field_name', '测试-皮肤含水量',
        'field_type', 'select',
        'group', '水分检测',
        'required', true,
        'options', JSON_ARRAY('严重缺水', '轻度缺水', '正常', '水分充足'),
        'scoring', JSON_OBJECT('严重缺水', 1, '轻度缺水', 2, '正常', 3, '水分充足', 4),
        'unit', '%',
        'normal_range', '30-50%',
        'display_order', 1
    ),
    JSON_OBJECT(
        'field_key', 'test_oil',
        'field_name', '测试-皮肤出油量',
        'field_type', 'select',
        'group', '油脂检测',
        'required', true,
        'options', JSON_ARRAY('严重缺油', '轻度缺油', '正常', '出油过多'),
        'scoring', JSON_OBJECT('严重缺油', 1, '轻度缺油', 2, '正常', 3, '出油过多', 4),
        'unit', 'mg/L',
        'display_order', 2
    )
)
WHERE id = @test_template_id;

-- 3. 验证创建
SELECT
    id,
    template_code,
    template_name,
    JSON_LENGTH(fields) as field_count
FROM diagnosis_templates
WHERE id = @test_template_id;

-- 4. 更新模板
UPDATE diagnosis_templates
SET template_name = '自动测试诊断模板-已修改',
    status = 'inactive'
WHERE id = @test_template_id;

-- 5. 验证更新
SELECT id, template_name, status
FROM diagnosis_templates
WHERE id = @test_template_id;

-- 6. 清理测试数据
DELETE FROM diagnosis_templates WHERE id = @test_template_id;
```

---

## 十三、监控查询

```sql
-- 实时监控模板变化
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_templates
FROM diagnosis_templates
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计模板使用情况
SELECT
    t.template_code,
    t.template_name,
    t.scope,
    t.apply_scene,
    JSON_LENGTH(t.fields) as field_count,
    t.status
FROM diagnosis_templates t
ORDER BY t.id DESC;

-- 统计诊断项类型分布
SELECT
    jt.field_type,
    COUNT(*) as count
FROM diagnosis_templates t,
     JSON_TABLE(
         t.fields,
         '$[*]' COLUMNS (
             field_type VARCHAR(50) PATH '$.field_type'
         )
     ) AS jt
GROUP BY jt.field_type
ORDER BY count DESC;
```

---

## 附录A：诊断项类型支持清单

| 字段类型 | field_type值 | 说明 | 示例 |
|---------|-------------|------|------|
| 单选下拉 | select | 下拉选择（带评分） | 肤质类型、出油程度 |
| 数值输入 | number | 数字（可设单位） | 水分值、油脂值 |
| 文本输入 | text | 文本备注 | 特殊情况说明 |

---

## 附录B：预置模板示例

### 标准皮肤诊断模板

```json
{
  "template_code": "STANDARD_SKIN_DIAGNOSIS",
  "template_name": "标准皮肤诊断模板",
  "scope": "global",
  "apply_scene": "新客诊断",
  "fields": [
    {
      "field_key": "skin_moisture",
      "field_name": "皮肤含水量",
      "field_type": "select",
      "group": "水分检测",
      "required": true,
      "options": ["严重缺水", "轻度缺水", "正常", "水分充足"],
      "scoring": {"严重缺水": 1, "轻度缺水": 2, "正常": 3, "水分充足": 4},
      "unit": "%",
      "normal_range": "30-50%",
      "display_order": 1
    },
    {
      "field_key": "skin_oil",
      "field_name": "皮肤出油量",
      "field_type": "select",
      "group": "油脂检测",
      "required": true,
      "options": ["严重缺油", "轻度缺油", "正常", "出油过多"],
      "scoring": {"严重缺油": 1, "轻度缺油": 2, "正常": 3, "出油过多": 4},
      "unit": "mg/L",
      "display_order": 2
    },
    {
      "field_key": "skin_elasticity",
      "field_name": "皮肤弹性",
      "field_type": "select",
      "group": "弹性检测",
      "required": true,
      "options": ["差", "一般", "良好", "优秀"],
      "scoring": {"差": 1, "一般": 2, "良好": 3, "优秀": 4},
      "display_order": 3
    }
  ]
}
```

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
