# æ•°æ®åº“è¿æ¥è¯´æ˜ - http://localhost:3000/users.html

## ğŸ“Š æ•°æ®åº“è¿æ¥ä¿¡æ¯

### åŸºæœ¬ä¿¡æ¯
| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| **æ•°æ®åº“ç±»å‹** | MySQL 5.7+ |
| **æ•°æ®åº“æœåŠ¡å•†** | é˜¿é‡Œäº‘ RDS (Relational Database Service) |
| **æ•°æ®åº“åç§°** | `beautydb` |
| **å­—ç¬¦é›†** | `utf8mb4` |
| **æ—¶åŒº** | `+08:00` (ä¸œå…«åŒº/åŒ—äº¬æ—¶é—´) |

### è¿æ¥é…ç½® (.env æ–‡ä»¶)
```env
# æ•°æ®åº“é…ç½® (é˜¿é‡Œäº‘RDS MySQL)
DB_HOST=rm-m5ej7x6xf3yb5876hao.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_USER=beautydba
DB_PASSWORD=Shujuku1979
DB_NAME=beautydb
DB_CHARSET=utf8mb4
DB_TIMEZONE=+08:00
```

### è¿æ¥æ± é…ç½®
```javascript
{
    host: 'rm-m5ej7x6xf3yb5876hao.mysql.rds.aliyuncs.com',
    port: 3306,
    user: 'beautydba',
    password: 'Shujuku1979',
    database: 'beautydb',
    charset: 'utf8mb4',
    timezone: '+08:00',
    waitForConnections: true,
    connectionLimit: 10,        // æœ€å¤§è¿æ¥æ•°: 10
    queueLimit: 0,              // æ— é™åˆ¶æ’é˜Ÿ
    enableKeepAlive: true,
    keepAliveInitialDelay: 0
}
```

---

## ğŸ”— è¿æ¥æµç¨‹

### 1. é…ç½®æ–‡ä»¶å±‚çº§
```
.env (ç¯å¢ƒå˜é‡é…ç½®)
    â†“
database/db.config.js (è¯»å– .env é…ç½®)
    â†“
api/config/db.js (å¼•ç”¨ database/db.config.js)
    â†“
api/models/User.js (ä½¿ç”¨ db.query() æ‰§è¡ŒSQL)
    â†“
MySQL RDS (é˜¿é‡Œäº‘æ•°æ®åº“)
```

### 2. å¯åŠ¨æ—¶è¿æ¥æ—¥å¿—
```
[dotenv@17.2.3] injecting env (17) from .env
ğŸ“ é™æ€æ–‡ä»¶ç›®å½•: D:\work6\ç¾ä¸šå®¢æˆ·åå°
ğŸ”Œ æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...
âœ… æ•°æ®åº“è¿æ¥æ± å·²åˆ›å»º
ğŸ”Œ æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼
   è®¡ç®—ç»“æœ: 2
   æœåŠ¡å™¨æ—¶é—´: 2025-12-02T07:16:47.000Z
   å½“å‰æ•°æ®åº“: beautydb
```

### 3. ç”¨æˆ·è®¿é—®æµç¨‹
```
ç”¨æˆ·è®¿é—® http://localhost:3000/users.html
    â†“
å‰ç«¯ JavaScript è°ƒç”¨ userAPI.getList({ org_id: 7 })
    â†“
å‘é€ HTTP è¯·æ±‚: GET /api/users?org_id=7
    â†“
Node.js æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ (api/routes/users.js)
    â†“
è°ƒç”¨ User.getList({ org_id: 7 })
    â†“
æ‰§è¡Œ SQL æŸ¥è¯¢ (é€šè¿‡ mysql2 è¿æ¥æ± )
    â†“
é˜¿é‡Œäº‘ RDS MySQL æ•°æ®åº“ (beautydb)
    â†“
è¿”å›æ•°æ® â†’ åç«¯ â†’ å‰ç«¯ â†’ ç”¨æˆ·çœ‹åˆ°æ•°æ®
```

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶

### é…ç½®æ–‡ä»¶
| æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|---------|------|
| `.env` | ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼‰ |
| `database/db.config.js` | æ•°æ®åº“è¿æ¥é…ç½®å’Œè¿æ¥æ± ç®¡ç† |
| `api/config/db.js` | APIå±‚æ•°æ®åº“é…ç½®å¼•ç”¨ |

### ä¸šåŠ¡ä»£ç 
| æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|---------|------|
| `api/server.js` | æœåŠ¡å™¨å¯åŠ¨ï¼Œæµ‹è¯•æ•°æ®åº“è¿æ¥ |
| `api/models/User.js` | ç”¨æˆ·æ•°æ®æ¨¡å‹ï¼Œæ‰§è¡ŒSQLæŸ¥è¯¢ |
| `api/routes/users.js` | ç”¨æˆ·APIè·¯ç”± |
| `users.html` | å‰ç«¯é¡µé¢ |
| `js/api.js` | å‰ç«¯APIå°è£… |

---

## ğŸ›¢ï¸ æ•°æ®åº“ç»“æ„

### users è¡¨ç»“æ„
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    real_name VARCHAR(50),
    org_id INT,                          -- å…³è”ç»„ç»‡ID
    phone VARCHAR(20),
    email VARCHAR(100),
    gender ENUM('male', 'female', 'other'),
    avatar_url VARCHAR(255),
    position VARCHAR(50),
    status ENUM('active', 'inactive', 'locked') DEFAULT 'active',
    last_login_at DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT(1) DEFAULT 0,

    FOREIGN KEY (org_id) REFERENCES organizations(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### organizations è¡¨ç»“æ„
```sql
CREATE TABLE organizations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    org_name VARCHAR(100) NOT NULL,
    org_code VARCHAR(50) UNIQUE,
    org_type ENUM('headquarters', 'franchisee', 'branch', 'other'),
    level INT DEFAULT 1,
    parent_id INT,
    status ENUM('active', 'inactive') DEFAULT 'active',
    contact_person VARCHAR(50),
    contact_phone VARCHAR(20),
    contact_email VARCHAR(100),
    address VARCHAR(255),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT(1) DEFAULT 0,

    FOREIGN KEY (parent_id) REFERENCES organizations(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## ğŸ“Š å®é™…æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢ç»„ç»‡ID=7çš„ç”¨æˆ·
```sql
SELECT
    u.id, u.username, u.real_name, u.org_id,
    u.phone, u.email, u.gender, u.avatar_url,
    u.position, u.status, u.last_login_at, u.created_at,
    o.org_name, o.org_type
FROM users u
LEFT JOIN organizations o ON u.org_id = o.id
WHERE u.is_deleted = 0 AND u.org_id = 7
ORDER BY u.created_at DESC
LIMIT 10 OFFSET 0;
```

### æŸ¥è¯¢ç»“æœç¤ºä¾‹
```
id  | username          | real_name | org_id | org_name        | position
----|-------------------|-----------|--------|-----------------|-------------
14  | beautician_chen   | é™ˆé™      | 7      | æµ‹è¯•Â·è™¹æ¡¥æ——èˆ°åº— | ç¾å®¹å¸ˆ
15  | receptionist_zhao | èµµå©·      | 7      | æµ‹è¯•Â·è™¹æ¡¥æ——èˆ°åº— | å‰å°æ¥å¾…
16  | beautician_sun    | å­™ä¸½      | 7      | æµ‹è¯•Â·è™¹æ¡¥æ——èˆ°åº— | èµ„æ·±ç¾å®¹å¸ˆ
...
```

### ç»Ÿè®¡æŸ¥è¯¢
```sql
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(CASE WHEN status = 'locked' THEN 1 ELSE 0 END) as locked_count,
    SUM(CASE WHEN DATE(last_login_at) = CURDATE() THEN 1 ELSE 0 END) as today_login_count
FROM users
WHERE is_deleted = 0 AND org_id = 7;
```

### ç»Ÿè®¡ç»“æœç¤ºä¾‹
```json
{
  "total": 9,
  "active_count": 8,
  "inactive_count": 1,
  "locked_count": 0,
  "today_login_count": 0
}
```

---

## ğŸ”’ æ•°æ®åº“å®‰å…¨

### è¿æ¥å®‰å…¨
- âœ… ä½¿ç”¨é˜¿é‡Œäº‘ RDSï¼Œè‡ªåŠ¨å¤‡ä»½å’Œå®¹ç¾
- âœ… ä¸“ç”¨æ•°æ®åº“ç”¨æˆ· `beautydba`
- âœ… è¿æ¥æ± é™åˆ¶ï¼šæœ€å¤š10ä¸ªå¹¶å‘è¿æ¥
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯

### æŸ¥è¯¢å®‰å…¨
- âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
- âœ… ä½¿ç”¨ `mysql2/promise` çš„ `execute()` æ–¹æ³•
- âœ… æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡å‚æ•°ç»‘å®š

```javascript
// âœ… å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢
const sql = 'SELECT * FROM users WHERE org_id = ? AND is_deleted = 0';
const rows = await db.query(sql, [org_id]);

// âŒ ä¸å®‰å…¨çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå·²é¿å…ï¼‰
// const sql = `SELECT * FROM users WHERE org_id = ${org_id}`;
```

### å¯†ç å®‰å…¨
- âœ… ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨å¯†ç 
- âœ… å¯†ç å“ˆå¸ŒåŠ ç›ï¼ˆ10è½®saltï¼‰
- âœ… APIè¿”å›æ—¶è¿‡æ»¤ `password_hash` å­—æ®µ

---

## ğŸ“ˆ æ•°æ®åº“æ€§èƒ½

### è¿æ¥æ± ä¼˜åŠ¿
- å¤ç”¨è¿æ¥ï¼Œå‡å°‘è¿æ¥å¼€é”€
- è‡ªåŠ¨ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- æ”¯æŒé«˜å¹¶å‘ï¼ˆæœ€å¤š10ä¸ªè¿æ¥ï¼‰
- è‡ªåŠ¨é‡è¿æœºåˆ¶

### æŸ¥è¯¢ä¼˜åŒ–
- âœ… ä½¿ç”¨ç´¢å¼•ï¼ˆä¸»é”®ã€å¤–é”®ã€å”¯ä¸€ç´¢å¼•ï¼‰
- âœ… LEFT JOIN æŸ¥è¯¢ç»„ç»‡ä¿¡æ¯
- âœ… LIMIT/OFFSET åˆ†é¡µæŸ¥è¯¢
- âœ… æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ‰ç´¢å¼•ï¼‰

### å®é™…æ€§èƒ½ï¼ˆä»æ—¥å¿—ï¼‰
```
GET /api/users?org_id=7        200  119.473 ms
GET /api/users/stats?org_id=7  200   57.015 ms
```
å¹³å‡å“åº”æ—¶é—´ï¼š**< 200ms** âš¡

---

## ğŸŒ é˜¿é‡Œäº‘ RDS ä¿¡æ¯

### è¿æ¥åœ°å€
```
rm-m5ej7x6xf3yb5876hao.mysql.rds.aliyuncs.com:3306
```

### ç‰¹æ€§
- âœ… é«˜å¯ç”¨æ¶æ„ï¼ˆä¸»ä»å¤åˆ¶ï¼‰
- âœ… è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯æ—¥å¤‡ä»½ï¼‰
- âœ… æ€§èƒ½ç›‘æ§
- âœ… æ…¢æŸ¥è¯¢æ—¥å¿—
- âœ… è‡ªåŠ¨å®¹ç¾åˆ‡æ¢

### è®¿é—®æ§åˆ¶
- å†…ç½‘è®¿é—®ï¼šé˜¿é‡Œäº‘VPCå†…éƒ¨
- å¤–ç½‘è®¿é—®ï¼šéœ€è¦ç™½åå•IP
- å½“å‰è¿æ¥ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒ

---

## ğŸ”§ å¼€å‘è°ƒè¯•

### æŸ¥çœ‹æ•°æ®åº“è¿æ¥
```bash
# æœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šæ˜¾ç¤º
npm start

# è¾“å‡º:
# âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼
#    å½“å‰æ•°æ®åº“: beautydb
```

### æ‰‹åŠ¨æµ‹è¯•è¿æ¥
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
node database/test-connection.js

# è¾“å‡ºè¿æ¥çŠ¶æ€å’Œæ•°æ®åº“ä¿¡æ¯
```

### APIæµ‹è¯•
```bash
# æµ‹è¯•ç”¨æˆ·åˆ—è¡¨API
curl "http://localhost:3000/api/users?org_id=7"

# æµ‹è¯•ç»Ÿè®¡API
curl "http://localhost:3000/api/users/stats?org_id=7"

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl "http://localhost:3000/health"
```

---

## ğŸ“ æ€»ç»“

**http://localhost:3000/users.html è¿æ¥çš„æ•°æ®åº“ä¿¡æ¯:**

| é¡¹ç›® | å€¼ |
|------|-----|
| **æ•°æ®åº“åœ°å€** | rm-m5ej7x6xf3yb5876hao.mysql.rds.aliyuncs.com |
| **ç«¯å£** | 3306 |
| **æ•°æ®åº“å** | beautydb |
| **ç”¨æˆ·å** | beautydba |
| **æœåŠ¡å•†** | é˜¿é‡Œäº‘ RDS MySQL |
| **è¿æ¥æ–¹å¼** | mysql2 è¿æ¥æ±  |
| **æœ€å¤§è¿æ¥æ•°** | 10 |
| **å­—ç¬¦é›†** | utf8mb4 |
| **æ—¶åŒº** | +08:00 |

**æ•°æ®æµå‘**:
```
ç”¨æˆ·æµè§ˆå™¨ â†’ users.html â†’ Node.js API â†’ MySQLè¿æ¥æ±  â†’ é˜¿é‡Œäº‘RDS (beautydb)
```

**å½“å‰çŠ¶æ€**: âœ… è¿æ¥æ­£å¸¸ï¼Œè¿è¡Œç¨³å®š

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-12-02
**æ•°æ®åº“ç‰ˆæœ¬**: MySQL 5.7+
**Node.jsç‰ˆæœ¬**: v18+
**è¿æ¥åº“**: mysql2@3.11.5
