# 客户案例模块快速测试指南

## 前置准备

### 1. 启动后端服务器
```bash
cd D:\work6\美业客户后台
node api/server.js
```

等待看到以下输出：
```
✅ 服务器运行中...
   环境: development
   端口: 3000
   地址: http://localhost:3000
```

### 2. 确认测试数据已创建
数据库中应该已经存在：
- 1个测试客户（customer_id: 1）
- 3个测试案例（案例ID: 2, 3, 4）

---

## 一、使用 curl 测试 API

### 1. 获取案例列表
```bash
curl http://localhost:3000/api/cases?org_id=1
```

**预期结果**: 返回 3 个案例

### 2. 获取统计信息
```bash
curl http://localhost:3000/api/cases/stats?org_id=1
```

**预期结果**:
```json
{
  "success": true,
  "data": {
    "total": 3,
    "featured_count": "1",
    "public_count": "0",
    "today_count": "3"
  }
}
```

### 3. 获取案例详情
```bash
curl http://localhost:3000/api/cases/2
```

### 4. 创建新案例
```bash
curl -X POST http://localhost:3000/api/cases \
  -H "Content-Type: application/json" \
  -d "{\"customer_id\":1,\"org_id\":1,\"case_title\":\"测试案例\",\"case_type\":\"skin_care\",\"initial_problems\":\"测试问题\",\"results\":\"测试效果\"}"
```

### 5. 更新案例
```bash
curl -X PUT http://localhost:3000/api/cases/2 \
  -H "Content-Type: application/json" \
  -d "{\"case_title\":\"更新后的标题\"}"
```

### 6. 删除案例
```bash
curl -X DELETE http://localhost:3000/api/cases/2
```

---

## 二、使用浏览器测试前端页面

### 1. 打开案例页面
在浏览器中访问:
```
http://localhost:3000/cases.html
```

### 2. 测试功能清单

#### 2.1 列表展示
- [ ] 页面加载后自动显示案例列表
- [ ] 显示3个测试案例
- [ ] 每个案例卡片显示标题、客户名称、内容预览
- [ ] 精选案例显示"已润色"标记

#### 2.2 搜索筛选
- [ ] 在搜索框输入关键词（如"敏感肌"）
- [ ] 点击标签筛选按钮（如"面部护理"）
- [ ] 验证筛选结果正确

#### 2.3 新建案例
1. 点击"新建案例"按钮
2. 填写表单：
   - 案例标题: "测试新建案例"
   - 关联客户: "测试客户"
   - 详细内容: "这是一个测试案例内容"
3. 点击"保存案例"
4. 验证：
   - [ ] 显示"案例保存成功"提示
   - [ ] 列表中出现新案例
   - [ ] 刷新页面后数据仍然存在

#### 2.4 编辑案例
1. 在列表中找到任意案例
2. 点击编辑按钮（笔图标）
3. 修改标题或内容
4. 点击"保存案例"
5. 验证：
   - [ ] 显示"案例更新成功"提示
   - [ ] 列表中显示更新后的内容

#### 2.5 删除案例
1. 在列表中找到任意案例
2. 点击删除按钮（垃圾桶图标）
3. 确认删除
4. 验证：
   - [ ] 显示"案例已删除"提示
   - [ ] 案例从列表中消失

#### 2.6 查看详情
1. 点击任意案例卡片
2. 验证：
   - [ ] 打开详情弹窗
   - [ ] 显示完整的案例信息
   - [ ] 可以从详情页编辑

#### 2.7 AI 润色功能（前端模拟）
1. 新建或编辑案例
2. 填写内容后点击"一键润色"
3. 验证：
   - [ ] 右侧生成营销文案
   - [ ] 可以复制文案
   - [ ] （模拟功能，未连接真实AI）

---

## 三、数据库验证

### 1. 查看所有案例
```sql
SELECT id, case_title, customer_id, org_id, is_deleted, created_at
FROM customer_cases
WHERE org_id = 1
ORDER BY created_at DESC;
```

### 2. 验证软删除
删除一个案例后，查询：
```sql
SELECT id, case_title, is_deleted
FROM customer_cases
WHERE id = [删除的案例ID];
```
**预期**: `is_deleted` 字段值为 1

### 3. 验证多租户隔离
```sql
-- 统计组织1的案例数
SELECT COUNT(*) FROM customer_cases WHERE org_id = 1 AND is_deleted = 0;

-- 统计组织2的案例数（应该为0）
SELECT COUNT(*) FROM customer_cases WHERE org_id = 2 AND is_deleted = 0;
```

---

## 四、常见问题排查

### 问题1: API 返回 "缺少组织ID参数"
**原因**: 请求中没有传递 `org_id` 参数
**解决**:
- 检查 localStorage 中是否设置了 `currentOrgId`
- 在浏览器控制台执行: `localStorage.setItem('currentOrgId', '1')`

### 问题2: 创建案例失败
**原因**: customer_id 不存在
**解决**: 确保数据库中存在对应的客户记录

### 问题3: 页面显示空白
**原因**: 后端服务未启动或前端 API 调用失败
**解决**:
1. 检查后端服务是否运行
2. 打开浏览器开发者工具查看 Console 错误
3. 检查 Network 标签查看 API 请求状态

### 问题4: 字符显示乱码
**原因**: 数据库字符集配置问题
**解决**: 确保数据库和表使用 `utf8mb4` 字符集

---

## 五、性能测试

### 1. 批量创建测试数据
```bash
# 使用循环创建100个测试案例
for i in {1..100}; do
  curl -X POST http://localhost:3000/api/cases \
    -H "Content-Type: application/json" \
    -d "{\"customer_id\":1,\"org_id\":1,\"case_title\":\"批量测试案例$i\",\"case_type\":\"skin_care\",\"initial_problems\":\"测试\",\"results\":\"测试\"}" \
    > /dev/null 2>&1
done
```

### 2. 测试分页性能
```bash
# 请求大数据量的分页
curl "http://localhost:3000/api/cases?org_id=1&page=1&pageSize=100"
```

### 3. 测试搜索性能
```bash
# 关键词搜索
curl "http://localhost:3000/api/cases?org_id=1&keyword=测试"
```

---

## 六、集成测试检查清单

### 数据完整性
- [ ] 创建的案例能正确保存到数据库
- [ ] 更新操作不会丢失未修改的字段
- [ ] 删除操作是软删除（is_deleted=1）
- [ ] JSON 字段正确序列化和反序列化

### 多租户隔离
- [ ] 不同 org_id 的数据完全隔离
- [ ] 切换组织后只显示对应组织的案例
- [ ] API 强制验证 org_id 参数

### 前后端协作
- [ ] 前端表单提交的数据格式正确
- [ ] API 返回的数据格式前端能正确解析
- [ ] 错误信息能正确显示给用户

### 边界条件
- [ ] 空列表时显示"暂无案例"提示
- [ ] 搜索无结果时正确提示
- [ ] 必填字段验证正常工作
- [ ] 超长文本正确截断显示

---

## 七、停止测试

### 停止后端服务器
按 `Ctrl + C` 或关闭命令行窗口

### 清理测试数据（可选）
```sql
-- 删除所有测试案例
DELETE FROM customer_cases WHERE org_id = 1;

-- 删除测试客户
DELETE FROM customers WHERE id = 1;
```

---

**测试完成后，请填写测试报告并提交相关截图**

**文档版本**: v1.0
**创建日期**: 2025-12-02
