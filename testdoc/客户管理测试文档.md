# 客户管理功能测试文档

## 文档信息
- **模块名称**: 客户管理
- **页面路径**: /customers.html
- **API路由**: /api/customers
- **测试目的**: 验证客户信息的创建、查询、更新、删除等基础数据操作的正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

客户管理模块是美业CRM系统的核心模块，负责管理客户的基本信息、会员等级、消费记录等核心数据。

### 核心功能
1. 客户信息管理（CRUD）
2. 客户搜索与筛选
3. 会员等级管理
4. 客户标签管理
5. 来源渠道追踪
6. 客户统计分析

### 不包含功能
- 客户详情页面操作（单独测试文档）
- 订单管理（单独模块）
- 任务管理（单独模块）

---

## 二、数据库表结构

### 2.1 主表：customers

```sql
CREATE TABLE `customers` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '客户ID',
  `customer_no` varchar(50) NOT NULL COMMENT '客户编号',
  `name` varchar(50) NOT NULL COMMENT '姓名',
  `gender` enum('male','female') DEFAULT NULL COMMENT '性别',
  `birth_date` date DEFAULT NULL COMMENT '出生日期',
  `phone` varchar(20) NOT NULL COMMENT '手机号',
  `id_card` varchar(255) DEFAULT NULL COMMENT '身份证号（加密）',
  `province` varchar(50) DEFAULT NULL COMMENT '省',
  `city` varchar(50) DEFAULT NULL COMMENT '市',
  `district` varchar(50) DEFAULT NULL COMMENT '区',
  `address` varchar(200) DEFAULT NULL COMMENT '详细地址',
  `org_id` bigint unsigned NOT NULL COMMENT '所属机构ID',
  `store_id` bigint unsigned NOT NULL COMMENT '所属门店ID',
  `counselor_id` bigint unsigned DEFAULT NULL COMMENT '专属顾问ID',
  `profile_template_id` bigint unsigned DEFAULT NULL COMMENT '使用的资料模板ID',
  `source_channel` enum('walk_in','referral','online','event','other') DEFAULT 'walk_in' COMMENT '来源渠道',
  `referrer_id` bigint unsigned DEFAULT NULL COMMENT '推荐人ID',
  `member_level` enum('normal','silver','gold','platinum','diamond') NOT NULL DEFAULT 'normal' COMMENT '会员等级',
  `member_points` int unsigned NOT NULL DEFAULT '0' COMMENT '会员积分',
  `tags` json DEFAULT NULL COMMENT '客户标签',
  `profile_data` json DEFAULT NULL COMMENT '自定义字段数据',
  `total_consumption` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '累计消费金额',
  `total_orders` int unsigned NOT NULL DEFAULT '0' COMMENT '累计订单数',
  `last_visit_at` timestamp NULL DEFAULT NULL COMMENT '最后到店时间',
  `remark` text COMMENT '备注',
  `status` enum('active','inactive','blacklist') NOT NULL DEFAULT 'active' COMMENT '状态',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` bigint unsigned DEFAULT NULL,
  `updated_by` bigint unsigned DEFAULT NULL,
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `customer_no` (`customer_no`),
  KEY `idx_phone` (`phone`),
  KEY `idx_org_id` (`org_id`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_counselor_id` (`counselor_id`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `customers_ibfk_1` FOREIGN KEY (`org_id`) REFERENCES `organizations` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `customers_ibfk_2` FOREIGN KEY (`store_id`) REFERENCES `organizations` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `customers_ibfk_3` FOREIGN KEY (`counselor_id`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB COMMENT='客户表';
```

**核心字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| customer_no | varchar(50) | 是 | 客户编号 | 唯一，格式：CUST+时间戳+随机数 |
| name | varchar(50) | 是 | 姓名 | 客户姓名 |
| gender | enum | 否 | 性别 | male/female |
| birth_date | date | 否 | 出生日期 | 用于计算年龄 |
| phone | varchar(20) | 是 | 手机号 | 唯一索引，用于客户识别 |
| org_id | bigint | 是 | 机构ID | 外键，数据权限隔离 |
| store_id | bigint | 是 | 门店ID | 外键，客户归属门店 |
| source_channel | enum | 否 | 来源渠道 | walk_in/referral/online/event/other |
| member_level | enum | 是 | 会员等级 | normal/silver/gold/platinum/diamond |
| member_points | int unsigned | 是 | 会员积分 | 默认0 |
| tags | json | 否 | 客户标签 | JSON数组，如["护肤","美白"] |
| total_consumption | decimal(10,2) | 是 | 累计消费 | 默认0.00 |
| total_orders | int unsigned | 是 | 累计订单 | 默认0 |
| status | enum | 是 | 状态 | active/inactive/blacklist |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

**source_channel字段说明**:

| 值 | 含义 | 典型场景 |
|----|------|---------|
| walk_in | 到店 | 客户直接到店咨询 |
| referral | 推荐 | 老客户推荐新客户 |
| online | 线上 | 官网、公众号等线上渠道 |
| event | 活动 | 营销活动、展会等 |
| other | 其他 | 其他来源 |

**member_level字段说明**:

| 值 | 含义 | 权益说明 |
|----|------|---------|
| normal | 普通会员 | 基础权益 |
| silver | 银卡会员 | 9.5折优惠 |
| gold | 金卡会员 | 9折优惠 |
| platinum | 铂金会员 | 8.5折优惠 |
| diamond | 钻石会员 | 8折优惠+专属服务 |

**status字段说明**:

| 值 | 含义 | 业务规则 |
|----|------|---------|
| active | 活跃 | 正常状态，可进行交易 |
| inactive | 非活跃 | 暂停服务，不可交易 |
| blacklist | 黑名单 | 禁止服务 |

---

## 三、业务流程

### 3.1 新增客户流程

```
开始
  ↓
前端：填写客户基本信息
  ├─ 必填：姓名、手机号、机构ID、门店ID
  └─ 可选：性别、生日、来源渠道、标签、备注
  ↓
API: POST /api/customers
  ↓
验证：手机号唯一性检查
  ├─ 重复 → 返回错误
  └─ 不重复 → 继续
  ↓
生成：客户编号 (CUST + 时间戳 + 随机数)
  ↓
插入：customers 表
  ↓
返回：新客户信息
  ↓
前端：刷新客户列表
  ↓
结束
```

### 3.2 查询客户流程

```
开始
  ↓
API: GET /api/customers?page=1&pageSize=10&org_id=6
  ↓
查询：customers 表
  ├─ 过滤：is_deleted = 0
  ├─ 过滤：org_id (数据权限)
  ├─ 可选：status、keyword搜索
  └─ 排序：created_at DESC
  ↓
分页：LIMIT pageSize OFFSET (page-1)*pageSize
  ↓
返回：客户列表 + 总数
  ↓
结束
```

### 3.3 更新客户流程

```
开始
  ↓
API: PUT /api/customers/:id
  ↓
验证：客户是否存在
  ├─ 不存在 → 返回404
  └─ 存在 → 继续
  ↓
（可选）验证：手机号唯一性
  ├─ 被占用 → 返回错误
  └─ 可用 → 继续
  ↓
更新：customers 表
  ├─ updated_at 自动更新
  └─ updated_by 记录操作人
  ↓
返回：更新后的客户信息
  ↓
结束
```

### 3.4 搜索客户流程

```
开始
  ↓
API: GET /api/customers?keyword=张&org_id=6
  ↓
查询：WHERE (name LIKE '%张%' OR phone LIKE '%张%' OR customer_no LIKE '%张%')
  ├─ AND org_id = 6
  ├─ AND is_deleted = 0
  └─ LIMIT 50
  ↓
返回：搜索结果列表
  ↓
结束
```

### 3.5 删除客户流程（软删除）

```
开始
  ↓
API: DELETE /api/customers/:id
  ↓
验证：客户是否存在
  ├─ 不存在 → 返回404
  └─ 存在 → 继续
  ↓
更新：is_deleted = 1
  ├─ updated_at 自动更新
  └─ 保留所有历史数据
  ↓
返回：成功
  ↓
结束
```

---

## 四、测试场景

### 4.1 新增客户测试

#### 测试场景1：创建基础客户（必填字段）

**前置条件**:
- 已登录系统
- 有客户管理权限
- 当前机构ID: 6 (虹桥店)

**操作步骤**:
1. 访问 http://8.210.246.101:5002/customers.html
2. 点击"新增客户"按钮
3. 填写信息：
   - 姓名：`张小姐`
   - 手机号：`13900001001`
   - 性别：`女`
   - 来源渠道：`到店`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证客户创建
SELECT
    id, customer_no, name, phone, gender,
    org_id, store_id, source_channel,
    member_level, status, is_deleted
FROM customers
WHERE phone = '13900001001';

-- 预期结果：
-- name: 张小姐
-- phone: 13900001001
-- gender: female
-- org_id: 6
-- store_id: 6
-- source_channel: walk_in
-- member_level: normal (默认)
-- status: active (默认)
-- is_deleted: 0

-- 2. 验证客户编号生成
SELECT customer_no
FROM customers
WHERE phone = '13900001001';

-- 预期结果：
-- customer_no: CUST开头，共13位字符
-- 格式: CUST + 时间戳6位 + 随机数3位
-- 示例: CUST893194339

-- 3. 验证自动字段
SELECT
    created_at, updated_at, created_by
FROM customers
WHERE phone = '13900001001';

-- 预期结果：
-- created_at: 插入时间
-- updated_at: 等于created_at
-- created_by: NULL (可选)
```

**预期结果**:
- ✅ customers表新增1条记录
- ✅ customer_no自动生成，格式正确
- ✅ phone唯一
- ✅ 默认字段正确设置：member_level='normal', status='active'
- ✅ created_at和updated_at自动设置

#### 测试场景2：创建完整信息客户

**操作步骤**:
1. 新增客户：`李女士`
2. 填写完整信息：
   - 姓名：`李女士`
   - 手机号：`13900001002`
   - 性别：`女`
   - 生日：`1990-05-15`
   - 来源渠道：`推荐`
   - 标签：`护肤`, `美白`
   - 备注：`朋友推荐，对美白项目感兴趣`

**数据库验证SQL**:

```sql
-- 验证完整信息保存
SELECT
    name, phone, gender, birth_date,
    source_channel, tags, remark
FROM customers
WHERE phone = '13900001002';

-- 预期结果：
-- name: 李女士
-- birth_date: 1990-05-15
-- source_channel: referral
-- tags: ["护肤", "美白"] (JSON数组)
-- remark: 朋友推荐，对美白项目感兴趣

-- 验证tags JSON格式
SELECT
    phone,
    JSON_LENGTH(tags) as tag_count,
    JSON_EXTRACT(tags, '$[0]') as tag1,
    JSON_EXTRACT(tags, '$[1]') as tag2
FROM customers
WHERE phone = '13900001002';

-- 预期结果：
-- tag_count: 2
-- tag1: "护肤"
-- tag2: "美白"
```

**预期结果**:
- ✅ 所有字段正确保存
- ✅ tags以JSON数组格式存储
- ✅ 日期格式正确

#### 测试场景3：手机号重复校验

**前置条件**: 已存在手机号 `13900001001` 的客户

**操作步骤**:
1. 新增客户
2. 填写手机号：`13900001001` (已存在)
3. 点击保存

**数据库验证SQL**:

```sql
-- 验证手机号唯一性
SELECT COUNT(*) as count
FROM customers
WHERE phone = '13900001001'
  AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)

-- 验证唯一索引
SHOW INDEX FROM customers WHERE Key_name = 'idx_phone';

-- 预期：idx_phone索引存在
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"该手机号已存在"
- ✅ 数据库无新增记录

#### 测试场景4：必填字段校验

**操作步骤**:
1. 新增客户
2. 缺少必填字段：
   - 姓名：空
   - 手机号：`13900001003`
3. 点击保存

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"客户名称不能为空"
- ✅ 数据库无新增记录

**测试场景5**: 缺少org_id

**操作步骤**:
1. 新增客户，不传org_id

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"机构ID不能为空"

### 4.2 查询客户测试

#### 测试场景6：分页查询

**API**: `GET /api/customers?page=1&pageSize=10&org_id=6`

**数据库验证SQL**:

```sql
-- 手动计算分页结果
SELECT
    id, customer_no, name, phone, gender,
    member_level, status, created_at
FROM customers
WHERE org_id = 6 AND is_deleted = 0
ORDER BY created_at DESC
LIMIT 10 OFFSET 0;

-- 获取总数
SELECT COUNT(*) as total
FROM customers
WHERE org_id = 6 AND is_deleted = 0;

-- 预期：API返回的data和total与SQL结果一致
```

**预期结果**:
- ✅ API返回10条记录（如果总数>=10）
- ✅ 按创建时间倒序排列
- ✅ total字段正确反映总数
- ✅ 只返回is_deleted=0的记录

#### 测试场景7：关键词搜索

**API**: `GET /api/customers?keyword=张&org_id=6`

**数据库验证SQL**:

```sql
-- 验证搜索逻辑
SELECT
    id, customer_no, name, phone
FROM customers
WHERE (
    name LIKE '%张%'
    OR phone LIKE '%张%'
    OR customer_no LIKE '%张%'
)
AND org_id = 6
AND is_deleted = 0
LIMIT 50;

-- 预期：返回所有包含"张"的客户
```

**预期结果**:
- ✅ 返回姓名、手机号、客户编号中包含关键词的客户
- ✅ 最多返回50条
- ✅ 结果按创建时间倒序

#### 测试场景8：状态筛选

**API**: `GET /api/customers?status=active&org_id=6`

**数据库验证SQL**:

```sql
-- 验证状态筛选
SELECT COUNT(*) as count, status
FROM customers
WHERE org_id = 6 AND is_deleted = 0
GROUP BY status;

-- 对比API返回的status=active的数量
SELECT COUNT(*) as active_count
FROM customers
WHERE status = 'active' AND org_id = 6 AND is_deleted = 0;
```

**预期结果**:
- ✅ 只返回status='active'的客户
- ✅ 数量与SQL查询一致

### 4.3 更新客户测试

#### 测试场景9：更新客户基本信息

**前置条件**: 客户ID 1 已存在

**操作步骤**:
1. 编辑客户
2. 修改信息：
   - 姓名：`张小姐-VIP`
   - 会员等级：`gold` (金卡)
   - 备注：`已升级为金卡会员`
3. 保存

**数据库验证SQL**:

```sql
-- 验证更新
SELECT
    name, member_level, remark, updated_at
FROM customers
WHERE id = 1;

-- 预期结果：
-- name: 张小姐-VIP
-- member_level: gold
-- remark: 已升级为金卡会员
-- updated_at: (更新时间)

-- 验证updated_at自动更新
SELECT
    created_at,
    updated_at,
    TIMESTAMPDIFF(SECOND, created_at, updated_at) as time_diff
FROM customers
WHERE id = 1;

-- 预期：time_diff > 0 (updated_at比created_at晚)
```

**预期结果**:
- ✅ 字段成功更新
- ✅ updated_at自动更新
- ✅ 其他字段保持不变

#### 测试场景10：更新手机号（唯一性校验）

**前置条件**:
- 客户A (ID 1): phone = '13900001001'
- 客户B (ID 2): phone = '13900001002'

**操作步骤**:
1. 编辑客户A
2. 修改手机号为：`13900001002` (客户B的手机号)
3. 保存

**数据库验证SQL**:

```sql
-- 验证手机号未改变
SELECT id, phone
FROM customers
WHERE id = 1;

-- 预期结果：
-- phone: 13900001001 (未改变)

-- 验证客户B的手机号未被占用
SELECT COUNT(*) as count
FROM customers
WHERE phone = '13900001002' AND is_deleted = 0;

-- 预期结果：
-- count: 1 (仍然只有客户B)
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"该手机号已被其他客户使用"
- ✅ 数据库未改变

### 4.4 删除客户测试

#### 测试场景11：软删除客户

**前置条件**: 客户ID 1 已存在

**操作步骤**:
1. 选择客户
2. 点击删除按钮
3. 确认删除

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    id, name, phone, is_deleted, updated_at
FROM customers
WHERE id = 1;

-- 预期结果：
-- is_deleted: 1
-- 其他字段保持不变

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM customers
WHERE id = 1 AND is_deleted = 0;

-- 预期结果：
-- count: 0

-- 验证历史数据保留
SELECT
    customer_no, name, phone, tags, total_consumption
FROM customers
WHERE id = 1;

-- 预期：所有数据保留，仅is_deleted=1
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ 列表查询不再显示该客户
- ✅ 历史数据完整保留

---

## 五、统计功能测试

### 测试场景12：客户统计

**API**: `GET /api/customers/stats/:orgId`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total_customers,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_customers,
    AVG(total_consumption) as avg_consumption,
    MAX(total_consumption) as max_consumption,
    MIN(total_consumption) as min_consumption
FROM customers
WHERE org_id = 6 AND is_deleted = 0;

-- 按会员等级统计
SELECT
    member_level,
    COUNT(*) as count,
    SUM(total_consumption) as total_consumption
FROM customers
WHERE org_id = 6 AND is_deleted = 0
GROUP BY member_level
ORDER BY
    FIELD(member_level, 'diamond', 'platinum', 'gold', 'silver', 'normal');

-- 按来源渠道统计
SELECT
    source_channel,
    COUNT(*) as count
FROM customers
WHERE org_id = 6 AND is_deleted = 0
GROUP BY source_channel
ORDER BY count DESC;
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致
- ✅ 各维度统计准确

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试客户编号最大长度（50字符）
INSERT INTO customers (customer_no, name, phone, org_id, store_id)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试客户',
    '13900009001',
    6, 6
);

-- 预期：成功

-- 测试超长客户编号（51字符）
INSERT INTO customers (customer_no, name, phone, org_id, store_id)
VALUES (
    '123456789012345678901234567890123456789012345678901', -- 51字符
    '测试客户2',
    '13900009002',
    6, 6
);

-- 预期：失败，超出长度限制
```

### 6.2 必填字段测试

```sql
-- 测试缺少name
INSERT INTO customers (customer_no, phone, org_id, store_id)
VALUES ('CUST000001', '13900009003', 6, 6);

-- 预期：失败，NOT NULL约束

-- 测试缺少phone
INSERT INTO customers (customer_no, name, org_id, store_id)
VALUES ('CUST000002', '测试客户', 6, 6);

-- 预期：失败，NOT NULL约束

-- 测试缺少org_id
INSERT INTO customers (customer_no, name, phone, store_id)
VALUES ('CUST000003', '测试客户', '13900009004', 6);

-- 预期：失败，NOT NULL约束
```

### 6.3 枚举值测试

```sql
-- 测试非法gender值
UPDATE customers
SET gender = 'unknown'
WHERE id = 1;

-- 预期：失败，枚举值约束

-- 测试非法source_channel值
UPDATE customers
SET source_channel = 'invalid_channel'
WHERE id = 1;

-- 预期：失败，枚举值约束

-- 测试非法member_level值
UPDATE customers
SET member_level = 'vvip'
WHERE id = 1;

-- 预期：失败，枚举值约束
```

### 6.4 JSON字段测试

```sql
-- 测试无效JSON
UPDATE customers
SET tags = 'invalid json'
WHERE id = 1;

-- 预期：失败，JSON格式错误

-- 测试空JSON数组
UPDATE customers
SET tags = '[]'
WHERE id = 1;

-- 预期：成功，空数组是有效的

-- 测试NULL值
UPDATE customers
SET tags = NULL
WHERE id = 1;

-- 预期：成功，tags允许NULL
```

### 6.5 外键约束测试

```sql
-- 测试无效的org_id
INSERT INTO customers (customer_no, name, phone, org_id, store_id)
VALUES ('CUST000004', '测试客户', '13900009005', 9999, 6);

-- 预期：失败，外键约束 (organizations表中不存在id=9999)

-- 测试无效的counselor_id
UPDATE customers
SET counselor_id = 9999
WHERE id = 1;

-- 预期：失败，外键约束 (users表中不存在id=9999)
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试phone索引
EXPLAIN SELECT * FROM customers WHERE phone = '13900001001';
-- 预期：type=const 或 ref, key=idx_phone

-- 测试org_id索引
EXPLAIN SELECT * FROM customers WHERE org_id = 6;
-- 预期：type=ref, key=idx_org_id

-- 测试customer_no唯一索引
EXPLAIN SELECT * FROM customers WHERE customer_no = 'CUST000001';
-- 预期：type=const, key=customer_no

-- 测试组合查询
EXPLAIN SELECT * FROM customers
WHERE org_id = 6 AND status = 'active' AND is_deleted = 0;
-- 验证索引使用情况
```

### 7.2 分页查询性能

```sql
-- 测试大数据量分页
SELECT SQL_NO_CACHE
    id, customer_no, name, phone, member_level
FROM customers
WHERE org_id = 6 AND is_deleted = 0
ORDER BY created_at DESC
LIMIT 100 OFFSET 1000;

-- 使用 EXPLAIN ANALYZE 验证执行计划
EXPLAIN ANALYZE
SELECT id, name, phone
FROM customers
WHERE org_id = 6 AND is_deleted = 0
ORDER BY created_at DESC
LIMIT 10;
```

### 7.3 搜索性能

```sql
-- 测试LIKE查询性能
EXPLAIN SELECT * FROM customers
WHERE (name LIKE '%张%' OR phone LIKE '%张%')
AND org_id = 6 AND is_deleted = 0
LIMIT 50;

-- 注意：LIKE '%keyword%' 无法使用索引，但加了LIMIT控制返回量
```

---

## 八、数据完整性检查

### 8.1 孤儿记录检查

```sql
-- 检查无效的org_id
SELECT id, customer_no, name, org_id
FROM customers
WHERE org_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0)
  AND is_deleted = 0;

-- 预期结果：0条记录

-- 检查无效的store_id
SELECT id, customer_no, name, store_id
FROM customers
WHERE store_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0)
  AND is_deleted = 0;

-- 预期结果：0条记录

-- 检查无效的counselor_id
SELECT id, customer_no, name, counselor_id
FROM customers
WHERE counselor_id IS NOT NULL
  AND counselor_id NOT IN (SELECT id FROM users WHERE is_deleted = 0)
  AND is_deleted = 0;

-- 预期结果：0条记录
```

### 8.2 数据一致性检查

```sql
-- 检查phone唯一性
SELECT phone, COUNT(*) as count
FROM customers
WHERE is_deleted = 0
GROUP BY phone
HAVING count > 1;

-- 预期结果：0条记录

-- 检查customer_no唯一性
SELECT customer_no, COUNT(*) as count
FROM customers
GROUP BY customer_no
HAVING count > 1;

-- 预期结果：0条记录

-- 检查JSON字段有效性
SELECT
    id,
    customer_no,
    CASE
        WHEN tags IS NULL OR JSON_VALID(tags) THEN '✅ 有效'
        ELSE '❌ 无效'
    END as tags_valid,
    CASE
        WHEN profile_data IS NULL OR JSON_VALID(profile_data) THEN '✅ 有效'
        ELSE '❌ 无效'
    END as profile_valid
FROM customers
WHERE is_deleted = 0;

-- 预期：所有记录的JSON都应该有效
```

### 8.3 业务逻辑一致性

```sql
-- 检查累计消费与订单数的一致性
SELECT
    c.id,
    c.customer_no,
    c.name,
    c.total_consumption as customer_total,
    c.total_orders as customer_orders,
    COALESCE(SUM(o.final_amount), 0) as orders_total,
    COUNT(o.id) as orders_count
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id AND o.is_deleted = 0
WHERE c.is_deleted = 0
GROUP BY c.id, c.customer_no, c.name, c.total_consumption, c.total_orders
HAVING ABS(customer_total - orders_total) > 0.01
    OR customer_orders != orders_count;

-- 预期：如果订单模块已对接，数据应该一致
-- 如果存在差异，需要排查是否有数据同步问题
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 删除测试客户
DELETE FROM customers
WHERE phone LIKE '139000%'
   OR customer_no LIKE 'TEST_%'
   OR name LIKE '测试%';

-- 验证清理结果
SELECT COUNT(*) as remaining_test_customers
FROM customers
WHERE phone LIKE '139000%'
   OR customer_no LIKE 'TEST_%'
   OR name LIKE '测试%';

-- 预期结果：0

-- 重置自增ID（可选，测试环境使用）
-- ALTER TABLE customers AUTO_INCREMENT = 1;
```

---

## 十、常见问题排查

### 问题1：创建客户失败

**排查SQL**:
```sql
-- 检查手机号是否已存在
SELECT id, name, phone, is_deleted
FROM customers
WHERE phone = 'xxx';

-- 检查org_id和store_id是否有效
SELECT id, org_name
FROM organizations
WHERE id IN (6, 7) AND is_deleted = 0;

-- 检查字段值是否合法
SELECT
    'CUST000001' as customer_no,
    '张小姐' as name,
    '13900001001' as phone,
    'female' as gender,
    'walk_in' as source_channel,
    'normal' as member_level;
```

### 问题2：客户列表为空

**排查SQL**:
```sql
-- 检查org_id筛选
SELECT COUNT(*) as total
FROM customers
WHERE org_id = 6;

-- 检查is_deleted状态
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN is_deleted = 0 THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN is_deleted = 1 THEN 1 ELSE 0 END) as deleted_count
FROM customers
WHERE org_id = 6;

-- 检查status状态
SELECT status, COUNT(*) as count
FROM customers
WHERE org_id = 6 AND is_deleted = 0
GROUP BY status;
```

### 问题3：搜索功能不准确

**排查SQL**:
```sql
-- 测试搜索逻辑
SET @keyword = '张';

SELECT
    id, customer_no, name, phone,
    CASE
        WHEN name LIKE CONCAT('%', @keyword, '%') THEN '✅ 姓名匹配'
        WHEN phone LIKE CONCAT('%', @keyword, '%') THEN '✅ 手机号匹配'
        WHEN customer_no LIKE CONCAT('%', @keyword, '%') THEN '✅ 客户编号匹配'
        ELSE '❌ 不匹配'
    END as match_type
FROM customers
WHERE (
    name LIKE CONCAT('%', @keyword, '%')
    OR phone LIKE CONCAT('%', @keyword, '%')
    OR customer_no LIKE CONCAT('%', @keyword, '%')
)
AND org_id = 6
AND is_deleted = 0
LIMIT 50;
```

### 问题4：客户编号重复

**排查SQL**:
```sql
-- 检查重复的客户编号
SELECT customer_no, COUNT(*) as count
FROM customers
GROUP BY customer_no
HAVING count > 1;

-- 如果存在重复，查看详情
SELECT id, customer_no, name, phone, created_at
FROM customers
WHERE customer_no IN (
    SELECT customer_no
    FROM customers
    GROUP BY customer_no
    HAVING COUNT(*) > 1
)
ORDER BY customer_no, created_at;
```

---

## 十一、测试检查清单

### 功能测试
- [ ] 创建基础客户（必填字段）
- [ ] 创建完整信息客户
- [ ] 手机号重复校验
- [ ] 必填字段校验
- [ ] 分页查询
- [ ] 关键词搜索
- [ ] 状态筛选
- [ ] 更新客户基本信息
- [ ] 更新手机号（唯一性校验）
- [ ] 软删除客户
- [ ] 客户统计准确性

### 数据库测试
- [ ] customers表记录正确插入
- [ ] customer_no自动生成正确
- [ ] 手机号唯一约束生效
- [ ] 索引使用正确
- [ ] JSON字段格式正确
- [ ] 外键约束生效
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新

### 会员等级测试
- [ ] 默认等级为normal
- [ ] 可升级为silver
- [ ] 可升级为gold
- [ ] 可升级为platinum
- [ ] 可升级为diamond

### 来源渠道测试
- [ ] walk_in (到店)
- [ ] referral (推荐)
- [ ] online (线上)
- [ ] event (活动)
- [ ] other (其他)

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验
- [ ] JSON格式校验
- [ ] 外键约束校验

### 性能测试
- [ ] 索引效率
- [ ] 分页查询性能
- [ ] 搜索性能
- [ ] 批量操作性能

---

## 十二、快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试客户
INSERT INTO customers (
    customer_no, name, phone,
    gender, birth_date, org_id, store_id,
    source_channel, tags, remark, created_by
)
VALUES (
    'AUTO_TEST_001',
    '自动测试客户',
    '13900009999',
    'female',
    '1990-01-01',
    6,
    6,
    'walk_in',
    JSON_ARRAY('测试标签1', '测试标签2'),
    '自动化测试用',
    1
);

SET @test_customer_id = LAST_INSERT_ID();

-- 2. 验证创建
SELECT
    id, customer_no, name, phone,
    JSON_LENGTH(tags) as tag_count,
    status, member_level
FROM customers
WHERE id = @test_customer_id;

-- 预期：tag_count = 2, status = 'active', member_level = 'normal'

-- 3. 更新客户
UPDATE customers
SET
    name = '自动测试客户-已修改',
    member_level = 'gold',
    member_points = 1000,
    remark = '测试更新功能'
WHERE id = @test_customer_id;

-- 4. 验证更新
SELECT
    id, name, member_level, member_points, remark,
    updated_at > created_at as is_updated
FROM customers
WHERE id = @test_customer_id;

-- 预期：is_updated = 1

-- 5. 软删除
UPDATE customers
SET is_deleted = 1
WHERE id = @test_customer_id;

-- 6. 验证软删除
SELECT
    id, name, is_deleted,
    (SELECT COUNT(*) FROM customers WHERE id = @test_customer_id AND is_deleted = 0) as visible_in_list
FROM customers
WHERE id = @test_customer_id;

-- 预期：is_deleted = 1, visible_in_list = 0

-- 7. 清理测试数据
DELETE FROM customers WHERE id = @test_customer_id;

-- 8. 验证清理
SELECT COUNT(*) as remaining FROM customers WHERE id = @test_customer_id;

-- 预期：remaining = 0
```

---

## 十三、监控查询

```sql
-- 实时监控客户增长
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_customers
FROM customers
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND is_deleted = 0
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计各机构客户数
SELECT
    o.org_name,
    COUNT(c.id) as customer_count,
    SUM(c.total_consumption) as total_consumption
FROM customers c
INNER JOIN organizations o ON c.org_id = o.id
WHERE c.is_deleted = 0 AND o.is_deleted = 0
GROUP BY o.id, o.org_name
ORDER BY customer_count DESC;

-- 统计会员等级分布
SELECT
    member_level,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM customers WHERE is_deleted = 0), 2) as percentage
FROM customers
WHERE is_deleted = 0
GROUP BY member_level
ORDER BY FIELD(member_level, 'diamond', 'platinum', 'gold', 'silver', 'normal');

-- 统计来源渠道分布
SELECT
    source_channel,
    COUNT(*) as count,
    ROUND(AVG(total_consumption), 2) as avg_consumption
FROM customers
WHERE is_deleted = 0
GROUP BY source_channel
ORDER BY count DESC;

-- 客户活跃度分析
SELECT
    CASE
        WHEN last_visit_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN '本周活跃'
        WHEN last_visit_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN '本月活跃'
        WHEN last_visit_at >= DATE_SUB(NOW(), INTERVAL 90 DAY) THEN '近三月活跃'
        ELSE '沉睡客户'
    END as activity_level,
    COUNT(*) as count
FROM customers
WHERE is_deleted = 0
GROUP BY activity_level
ORDER BY FIELD(activity_level, '本周活跃', '本月活跃', '近三月活跃', '沉睡客户');
```

---

## 附录A：客户编号生成规则

### 生成算法

```javascript
// 格式：CUST + 时间戳后6位 + 随机3位数
const timestamp = Date.now().toString().slice(-6);
const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
const customer_no = `CUST${timestamp}${random}`;
```

### 示例

```
CUST893194339
│   │      │
│   │      └─ 随机3位数 (000-999)
│   └────────── 时间戳后6位
└──────────────── 固定前缀
```

### 特点

- ✅ 唯一性高 (时间戳 + 随机数)
- ✅ 可读性好 (固定前缀CUST)
- ✅ 长度固定 (13位)
- ✅ 包含时间信息 (可推断创建时间范围)

---

## 附录B：会员等级权益对照表

| 等级 | 英文值 | 消费折扣 | 升级门槛 | 专属权益 |
|------|--------|---------|---------|---------|
| 普通会员 | normal | 无折扣 | 注册即可 | 基础服务 |
| 银卡会员 | silver | 9.5折 | 累计消费≥2000元 | 生日礼品 |
| 金卡会员 | gold | 9折 | 累计消费≥5000元 | 优先预约 |
| 铂金会员 | platinum | 8.5折 | 累计消费≥10000元 | 专属顾问 |
| 钻石会员 | diamond | 8折 | 累计消费≥30000元 | VIP专区+免费项目 |

---

## 附录C：来源渠道说明

| 渠道值 | 中文名称 | 典型场景 | 统计价值 |
|--------|---------|---------|---------|
| walk_in | 到店 | 客户直接到店咨询 | 门店地理位置、装修效果 |
| referral | 推荐 | 老客户推荐新客户 | 客户满意度、口碑传播 |
| online | 线上 | 官网、公众号、小程序 | 线上营销效果 |
| event | 活动 | 营销活动、展会、路演 | 活动ROI分析 |
| other | 其他 | 其他来源 | 未分类渠道 |

---

## 附录D：API接口清单

| 方法 | 路径 | 说明 | 必需参数 |
|------|------|------|---------|
| GET | /api/customers | 获取客户列表（分页） | org_id, page, pageSize |
| GET | /api/customers/:id | 获取单个客户 | id |
| GET | /api/customers/phone/:phone | 根据手机号获取客户 | phone |
| POST | /api/customers | 创建客户 | name, phone, org_id, store_id |
| PUT | /api/customers/:id | 更新客户 | id |
| PATCH | /api/customers/:id/status | 更新客户状态 | id, status |
| DELETE | /api/customers/:id | 删除客户（软删除） | id |
| GET | /api/customers/stats/:orgId | 获取客户统计 | orgId |
| POST | /api/customers/search | 搜索客户 | keyword |
| POST | /api/customers/new | 获取新增客户 | startDate, endDate |

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
