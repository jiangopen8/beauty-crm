# 工作日志 - 用户管理模块开发与问题修复

**日期**: 2025-12-01
**项目**: 美业客户洞察CRM系统
**模块**: 用户管理（内部员工）

---

## 一、工作概述

本次工作主要完成了以下内容：
1. 创建用户管理页面（users.html）
2. 添加演示数据到数据库（10个测试用户）
3. 修复API路由顺序问题
4. 修复数据库查询结果处理问题
5. 修复SQL参数类型不匹配问题
6. 部署所有修复到生产环境

---

## 二、需求说明

### 原始需求
在 `franchisees.html` 页面的"加盟管理"菜单下添加二级菜单"用户管理（内部员工）"，用于维护员工信息。

### 核心要求
- 只显示当前组织（org_id）相关的员工
- 当前组织ID来自 `settings.html` 中的"组织切换"功能
- 支持完整的CRUD操作（创建、查看、编辑、删除）
- 支持员工状态管理（启用/禁用）
- 支持密码重置功能

---

## 三、技术架构

### 后端技术栈
- **框架**: Node.js + Express.js
- **数据库**: MySQL (阿里云RDS)
- **数据库客户端**: mysql2 (支持prepared statements)
- **密码加密**: bcrypt
- **进程管理**: PM2
- **反向代理**: Nginx

### 前端技术栈
- **基础**: HTML5 + CSS3 + Vanilla JavaScript
- **UI框架**: Tailwind CSS (CDN)
- **图标库**: Lucide Icons
- **架构**: 静态页面 + REST API

### 服务器信息
- **生产服务器**: 8.210.246.101
- **后端端口**: 5002
- **项目路径**: /var/www/beauty-crm/
- **PM2应用名**: beauty-crm-backend

---

## 四、文件清单

### 新建文件
```
users.html                              # 用户管理主页面（1082行）
```

### 修改文件
```
franchisees.html                        # 添加用户管理菜单项（第213-217行）
js/api.js                              # 添加userAPI定义（第173-239行）
api/models/User.js                     # 修复数据库查询处理（多处修改）
api/routes/users.js                    # 修复路由顺序（第79-102行）
database/create-test-users.js         # 添加6个新测试用户（第73-127行）
```

---

## 五、核心功能实现

### 5.1 用户管理页面 (users.html)

#### 主要功能模块

**1. 用户列表展示**
- 卡片式布局，响应式设计
- 显示用户基本信息：姓名、职位、联系方式
- 渐变色头像（根据姓名生成）
- 状态标签（active/inactive/locked）

**2. 搜索与筛选**
```javascript
// 关键代码位置：第540-554行
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;

    const filtered = allUsers.filter(u => {
        const matchesStatus = statusFilter === 'all' || u.status === statusFilter;
        const matchesSearch = !searchTerm ||
            u.username.toLowerCase().includes(searchTerm) ||
            u.real_name.toLowerCase().includes(searchTerm) ||
            u.phone.toLowerCase().includes(searchTerm);
        return matchesStatus && matchesSearch;
    });

    renderUsers(filtered);
}
```

**3. 统计面板**
- 总用户数
- 活跃用户数
- 禁用用户数
- 锁定用户数

**4. CRUD操作**
- **创建用户**: 表单验证（必填项、手机号格式、邮箱格式、密码确认）
- **编辑用户**: 预填充数据，禁用机构编码修改
- **删除用户**: 软删除（设置is_deleted标志）
- **状态切换**: 启用/禁用用户
- **密码重置**: 验证旧密码，确认新密码

**5. 组织过滤**
```javascript
// 关键代码位置：第36-48行
let currentOrgId = 7; // 默认组织ID

function loadCurrentOrg() {
    const orgId = localStorage.getItem('currentOrgId');
    const orgName = localStorage.getItem('currentOrgName');

    if (orgId) {
        currentOrgId = parseInt(orgId);
        document.getElementById('currentOrgName').textContent = orgName || '未知组织';
    } else {
        currentOrgId = 7; // 上海加盟商 (默认)
        document.getElementById('currentOrgName').textContent = '上海静安旗舰店';
    }
}

// 加载用户时带上组织ID
async function loadUsers() {
    const result = await userAPI.getList({ org_id: currentOrgId });
    // ...
}
```

### 5.2 前端API封装 (js/api.js)

```javascript
// 完整的userAPI定义（第173-239行）
const userAPI = {
    // 获取用户列表（支持分页和过滤）
    async getList(params) {
        return await api.get('/api/users', params);
    },

    // 获取单个用户详情
    async getById(id) {
        return await api.get(`/api/users/${id}`);
    },

    // 获取当前登录用户信息
    async getCurrentUser() {
        return await api.get('/api/users/current');
    },

    // 创建新用户
    async create(data) {
        return await api.post('/api/users', data);
    },

    // 更新用户信息
    async update(id, data) {
        return await api.put(`/api/users/${id}`, data);
    },

    // 更新用户状态
    async updateStatus(id, status) {
        return await api.patch(`/api/users/${id}/status`, { status });
    },

    // 更新密码
    async updatePassword(id, oldPassword, newPassword) {
        return await api.patch(`/api/users/${id}/password`, {
            old_password: oldPassword,
            new_password: newPassword
        });
    },

    // 删除用户
    async delete(id) {
        return await api.delete(`/api/users/${id}`);
    },

    // 获取统计信息
    async getStats(orgId = null) {
        return await api.get('/api/users/stats', orgId ? { org_id: orgId } : {});
    }
};
```

### 5.3 导航菜单集成 (franchisees.html)

```html
<!-- 第213-217行 -->
<a href="users.html" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg transition-colors ml-4">
    <i data-lucide="user-cog" class="w-4 h-4"></i>
    <span>用户管理</span>
    <span class="ml-auto text-xs text-gray-500">(内部员工)</span>
</a>
```

---

## 六、数据库测试数据

### 6.1 测试用户列表

通过 `database/create-test-users.js` 创建的10个测试用户：

| ID | 用户名 | 姓名 | 组织ID | 职位 | 状态 | 密码 |
|----|--------|------|--------|------|------|------|
| 1 | admin | 系统管理员 | 1 | 系统管理员 | active | 123456 |
| 2 | manager_sh | 李美丽 | 7 | 加盟商经理 | active | 123456 |
| 3 | consultant_wang | 王美容 | 7 | 美容顾问 | active | 123456 |
| 4 | beautician_zhang | 张美师 | 7 | 美容师 | active | 123456 |
| 13 | consultant_liu | 刘悦 | 7 | 高级美容顾问 | active | 123456 |
| 14 | beautician_chen | 陈静 | 7 | 美容师 | active | 123456 |
| 15 | receptionist_zhao | 赵婷 | 7 | 前台接待 | active | 123456 |
| 16 | beautician_sun | 孙丽 | 7 | 资深美容师 | active | 123456 |
| 17 | assistant_zhou | 周芳 | 7 | 美容助理 | inactive | 123456 |
| 18 | consultant_wu | 吴雪 | 7 | 美容顾问 | active | 123456 |

**注意**: 所有密码均使用bcrypt加密，盐轮次为10

### 6.2 创建测试数据

```bash
# 在本地执行
node database/create-test-users.js

# 输出示例
✅ 用户创建成功: admin (系统管理员)
✅ 用户创建成功: manager_sh (李美丽)
✅ 用户创建成功: consultant_wang (王美容)
...
✅ 所有测试用户创建完成！
```

---

## 七、问题修复详解

### 7.1 问题1：API路由顺序错误

#### 问题描述
访问 `/api/users/stats` 返回"用户不存在"错误

#### 根本原因
```javascript
// 错误的路由顺序（api/routes/users.js）
router.get('/', ...);           // 列表
router.get('/:id', ...);        // 详情 - 会匹配 "stats"
router.get('/stats', ...);      // 统计 - 永远无法到达
```

Express会按顺序匹配路由，`/:id` 会将 "stats" 当作用户ID处理。

#### 解决方案
```javascript
// 正确的路由顺序
router.get('/', ...);           // 列表
router.get('/stats', ...);      // 统计 - 必须在 :id 之前
router.get('/:id', ...);        // 详情
```

#### 修改位置
- **文件**: `api/routes/users.js`
- **行号**: 第79-102行（将stats路由移到:id路由之前）
- **额外修改**: 删除了文件末尾的重复stats路由定义

#### 验证命令
```bash
curl http://localhost:3000/api/users/stats?org_id=7
# 输出: {"success":true,"data":{"total":9,"active_count":"8",...}}
```

---

### 7.2 问题2：数据库查询结果双重解构

#### 问题描述
```
TypeError: Cannot read properties of undefined (reading 'total')
TypeError: Cannot read properties of undefined (reading '0')
```

#### 根本原因
`database/db.config.js` 中的query函数已经解构了结果：

```javascript
// db.config.js 中的实现
async function query(sql, params = []) {
    const [rows] = await getPool().execute(sql, params);  // 第一次解构
    return rows;  // 返回的已经是rows数组
}
```

但 `api/models/User.js` 中所有方法又进行了二次解构：

```javascript
// 错误的用法（双重解构）
const [rows] = await db.query(sql, params);  // 第二次解构
// rows现在是undefined或第一个元素
```

#### 解决方案
移除所有User模型方法中的解构操作：

```javascript
// 正确的用法
const rows = await db.query(sql, params);
const result = await db.query(sql, params);
```

#### 修改清单（api/models/User.js）

1. **findById** (第54行)
```javascript
// 修改前
const [rows] = await db.query(sql, [id]);
// 修改后
const rows = await db.query(sql, [id]);
```

2. **findByUsername** (第73行)
```javascript
// 修改前
const [rows] = await db.query(sql, [username]);
// 修改后
const rows = await db.query(sql, [username]);
```

3. **getList** (第110, 137行)
```javascript
// 修改前
const [countResult] = await db.query(countSql, params);
const [rows] = await db.query(sql, params);
// 修改后
const countResult = await db.query(countSql, params);
const rows = await db.query(sql, params);
```

4. **create** (第182行)
```javascript
// 修改前
const [result] = await db.query(sql, params);
// 修改后
const result = await db.query(sql, params);
```

5. **update, updateStatus, updatePassword, updateLoginInfo, delete**
   (第213, 227, 241, 258, 272行)
```javascript
// 修改前
const [result] = await db.query(sql, params);
// 修改后
const result = await db.query(sql, params);
```

6. **getStats** (第299行)
```javascript
// 修改前
const [rows] = await db.query(sql, params);
// 修改后
const rows = await db.query(sql, params);
```

---

### 7.3 问题3：SQL参数类型不匹配

#### 问题描述
```
Error: Incorrect arguments to mysqld_stmt_execute
```

#### 根本原因
MySQL的prepared statements要求LIMIT和OFFSET必须是整数类型，但使用占位符`?`时，params数组中混合了字符串和数字：

```javascript
// 错误的实现
const sql = `
    SELECT ...
    LIMIT ? OFFSET ?
`;
const params = [...params, pageSize, offset];  // 可能包含字符串
const rows = await db.query(sql, params);
```

从URL查询参数获取的值默认是字符串，即使转换也可能不被mysql2正确识别。

#### 解决方案
使用字符串插值代替占位符，并显式转换为整数：

```javascript
// 正确的实现（api/models/User.js 第134-137行）
const sql = `
    SELECT
        u.id,
        u.username,
        u.real_name,
        u.org_id,
        u.phone,
        u.email,
        u.gender,
        u.avatar_url,
        u.position,
        u.status,
        u.last_login_at,
        u.created_at,
        o.org_name,
        o.org_type
    FROM users u
    LEFT JOIN organizations o ON u.org_id = o.id
    WHERE ${whereClause}
    ORDER BY u.created_at DESC
    LIMIT ${parseInt(pageSize)} OFFSET ${parseInt(offset)}
`;

const rows = await db.query(sql, params);  // params不包含pageSize和offset
```

**重要**: 同时确保org_id参数也转换为整数：

```javascript
// 第86-89行
if (org_id) {
    whereClauses.push('u.org_id = ?');
    params.push(parseInt(org_id));  // 显式转换
}
```

#### 为什么这样做是安全的？
- `parseInt()` 确保值是纯整数，防止SQL注入
- LIMIT和OFFSET是数值，不能包含SQL语句
- 其他参数仍使用占位符`?`，保持安全性

---

## 八、API测试结果

### 8.1 本地环境测试

**用户列表API**
```bash
curl "http://localhost:3000/api/users?org_id=7&page=1&pageSize=10"

# 响应
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 14,
        "username": "beautician_chen",
        "real_name": "陈静",
        "org_id": 7,
        "phone": "13800138004",
        "position": "美容师",
        "status": "active",
        "org_name": "测试·虹桥旗舰店"
      },
      // ... 其他8个用户
    ],
    "total": 9,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

**用户统计API**
```bash
curl "http://localhost:3000/api/users/stats?org_id=7"

# 响应
{
  "success": true,
  "data": {
    "total": 9,
    "active_count": "8",
    "inactive_count": "1",
    "locked_count": "0",
    "today_login_count": "0"
  }
}
```

### 8.2 生产环境测试

**用户列表API**
```bash
curl "http://8.210.246.101:5002/api/users?org_id=7&page=1&pageSize=10"
# 响应正常，返回9个用户 ✅
```

**用户统计API**
```bash
curl "http://8.210.246.101:5002/api/users/stats?org_id=7"
# 响应正常，返回统计数据 ✅
```

---

## 九、部署流程

### 9.1 部署命令

```bash
# 1. 上传用户管理页面
scp users.html root@8.210.246.101:/var/www/beauty-crm/

# 2. 上传修改的导航页面
scp franchisees.html root@8.210.246.101:/var/www/beauty-crm/

# 3. 上传修改的settings页面
scp settings.html root@8.210.246.101:/var/www/beauty-crm/

# 4. 上传API配置文件
scp js/api.js root@8.210.246.101:/var/www/beauty-crm/js/

# 5. 上传修复的User模型
scp api/models/User.js root@8.210.246.101:/var/www/beauty-crm/api/models/

# 6. 上传修复的路由文件
scp api/routes/users.js root@8.210.246.101:/var/www/beauty-crm/api/routes/

# 7. 重启后端服务
ssh root@8.210.246.101 "pm2 restart beauty-crm-backend"
```

### 9.2 使用Git Bash部署（Windows）

```bash
# 使用Git Bash的完整路径
"C:\Program Files\Git\usr\bin\bash.exe" -c "cd '/d/work6/美业客户后台' && scp users.html root@8.210.246.101:/var/www/beauty-crm/"

"C:\Program Files\Git\usr\bin\bash.exe" -c "cd '/d/work6/美业客户后台' && scp franchisees.html root@8.210.246.101:/var/www/beauty-crm/"

"C:\Program Files\Git\usr\bin\bash.exe" -c "cd '/d/work6/美业客户后台' && scp settings.html root@8.210.246.101:/var/www/beauty-crm/"

"C:\Program Files\Git\usr\bin\bash.exe" -c "cd '/d/work6/美业客户后台/js' && scp api.js root@8.210.246.101:/var/www/beauty-crm/js/"

"C:\Program Files\Git\usr\bin\bash.exe" -c "cd '/d/work6/美业客户后台' && scp api/models/User.js root@8.210.246.101:/var/www/beauty-crm/api/models/"

"C:\Program Files\Git\usr\bin\bash.exe" -c "cd '/d/work6/美业客户后台' && scp api/routes/users.js root@8.210.246.101:/var/www/beauty-crm/api/routes/"
```

---

## 十、页面访问地址

### 开发环境
```
http://localhost:8080/users.html
```

### 生产环境
```
http://8.210.246.101:5002/users.html
```

---

## 十一、遗留问题

### 1. Tailwind CSS生产环境警告

**问题描述**:
```
cdn.tailwindcss.com should not be used in production.
To use Tailwind CSS in production, install it as a PostCSS plugin
or use the Tailwind CLI: https://tailwindcss.com/docs/installation
```

**影响**: 性能问题，CDN版本不适合生产环境

**建议解决方案**:
1. 安装Tailwind CSS作为项目依赖
2. 配置PostCSS构建流程
3. 生成优化的CSS文件
4. 移除CDN链接

**优先级**: 中（不影响功能，但影响性能）

### 2. 用户认证和权限控制

**当前状态**:
- `/api/users/current` 使用硬编码的用户ID（userId = 1）
- 没有实现session或JWT token认证
- 没有权限验证

**影响**: 安全风险

**建议解决方案**:
1. 实现JWT token认证
2. 添加登录/登出功能
3. 实现基于角色的权限控制（RBAC）
4. 添加认证中间件

**优先级**: 高（安全问题）

### 3. 组织切换功能未完善

**当前状态**:
- settings.html中有组织切换UI，但未实现完整逻辑
- 依赖localStorage存储组织ID
- 没有与后端session同步

**建议解决方案**:
1. 完善settings.html中的组织切换逻辑
2. 实现后端session管理
3. 添加组织权限验证

**优先级**: 中

---

## 十二、下一步工作建议

### 短期任务（1-2天）
1. ✅ 完成用户管理页面开发
2. ✅ 修复所有API错误
3. ✅ 部署到生产环境
4. ⏳ 添加用户头像上传功能
5. ⏳ 完善settings.html的组织切换功能

### 中期任务（1周）
1. ⏳ 实现JWT认证系统
2. ⏳ 添加权限控制中间件
3. ⏳ 迁移Tailwind CSS到本地构建
4. ⏳ 完善错误处理和日志记录
5. ⏳ 添加API请求限流

### 长期任务（2-4周）
1. ⏳ 实现完整的RBAC权限系统
2. ⏳ 添加操作日志和审计功能
3. ⏳ 实现数据导出功能
4. ⏳ 添加批量操作功能
5. ⏳ 优化前端性能（代码分割、懒加载）

---

## 十三、关键代码片段

### 13.1 数据库连接配置 (database/db.config.js)

```javascript
const mysql = require('mysql2/promise');

let pool = null;

function createPool() {
    return mysql.createPool({
        host: process.env.DB_HOST || 'rm-uf6n6109o1lz3s13lso.mysql.rds.aliyuncs.com',
        user: process.env.DB_USER || 'daymade',
        password: process.env.DB_PASSWORD,
        database: process.env.DB_NAME || 'beauty_crm',
        port: process.env.DB_PORT || 3306,
        waitForConnections: true,
        connectionLimit: 10,
        queueLimit: 0,
        enableKeepAlive: true,
        keepAliveInitialDelay: 0
    });
}

async function query(sql, params = []) {
    if (!pool) {
        pool = createPool();
    }
    const [rows] = await pool.execute(sql, params);
    return rows;  // 已经解构，直接返回rows
}
```

### 13.2 用户模型关键方法 (api/models/User.js)

```javascript
/**
 * 获取用户列表（分页）- 修复后的版本
 */
static async getList({ page = 1, pageSize = 10, org_id, status, keyword }) {
    const offset = (page - 1) * pageSize;

    let whereClauses = ['u.is_deleted = 0'];
    const params = [];

    // 组织过滤
    if (org_id) {
        whereClauses.push('u.org_id = ?');
        params.push(parseInt(org_id));  // 显式转换为整数
    }

    // 状态过滤
    if (status) {
        whereClauses.push('u.status = ?');
        params.push(status);
    }

    // 关键词搜索
    if (keyword) {
        whereClauses.push('(u.username LIKE ? OR u.real_name LIKE ? OR u.phone LIKE ?)');
        const likeKeyword = `%${keyword}%`;
        params.push(likeKeyword, likeKeyword, likeKeyword);
    }

    const whereClause = whereClauses.join(' AND ');

    // 获取总数
    const countSql = `
        SELECT COUNT(*) as total
        FROM users u
        WHERE ${whereClause}
    `;
    const countResult = await db.query(countSql, params);  // 不解构
    const total = countResult[0]?.total || 0;

    // 获取列表 - 使用字符串拼接LIMIT和OFFSET
    const sql = `
        SELECT
            u.id,
            u.username,
            u.real_name,
            u.org_id,
            u.phone,
            u.email,
            u.gender,
            u.avatar_url,
            u.position,
            u.status,
            u.last_login_at,
            u.created_at,
            o.org_name,
            o.org_type
        FROM users u
        LEFT JOIN organizations o ON u.org_id = o.id
        WHERE ${whereClause}
        ORDER BY u.created_at DESC
        LIMIT ${parseInt(pageSize)} OFFSET ${parseInt(offset)}
    `;

    const rows = await db.query(sql, params);  // 不解构

    return {
        items: rows,
        total,
        page,
        pageSize,
        totalPages: Math.ceil(total / pageSize)
    };
}
```

### 13.3 路由配置 (api/routes/users.js)

```javascript
const express = require('express');
const router = express.Router();
const { User, USER_STATUS } = require('../models/User');
const bcrypt = require('bcrypt');

/**
 * 获取用户列表
 * GET /api/users?page=1&pageSize=10&org_id=1&status=active&keyword=xxx
 */
router.get('/', async (req, res) => {
    try {
        const { page, pageSize, org_id, status, keyword } = req.query;

        const result = await User.getList({
            page: parseInt(page) || 1,
            pageSize: parseInt(pageSize) || 10,
            org_id: org_id ? parseInt(org_id) : null,
            status,
            keyword
        });

        res.json({
            success: true,
            data: result
        });
    } catch (error) {
        console.error('获取用户列表失败:', error);
        res.status(500).json({
            success: false,
            error: {
                code: 'INTERNAL_ERROR',
                message: '获取用户列表失败'
            }
        });
    }
});

/**
 * 获取用户统计信息
 * GET /api/users/stats
 * 注意：必须在 /:id 路由之前定义
 */
router.get('/stats', async (req, res) => {
    try {
        const { org_id } = req.query;
        const stats = await User.getStats(org_id ? parseInt(org_id) : null);

        res.json({
            success: true,
            data: stats
        });
    } catch (error) {
        console.error('获取用户统计失败:', error);
        res.status(500).json({
            success: false,
            error: {
                code: 'INTERNAL_ERROR',
                message: '获取统计信息失败'
            }
        });
    }
});

/**
 * 根据ID获取用户详情
 * GET /api/users/:id
 */
router.get('/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const user = await User.findById(parseInt(id));

        if (!user) {
            return res.json({
                success: false,
                error: {
                    code: 'USER_NOT_FOUND',
                    message: '用户不存在'
                }
            });
        }

        // 移除敏感信息
        delete user.password_hash;

        res.json({
            success: true,
            data: user
        });
    } catch (error) {
        console.error('获取用户详情失败:', error);
        res.status(500).json({
            success: false,
            error: {
                code: 'INTERNAL_ERROR',
                message: '获取用户详情失败'
            }
        });
    }
});

module.exports = router;
```

### 13.4 前端加载和过滤逻辑 (users.html)

```javascript
// 全局变量
let allUsers = [];
let currentOrgId = 7; // 默认组织ID

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentOrg();
    loadUsers();
    lucide.createIcons();
});

// 加载当前组织信息
function loadCurrentOrg() {
    const orgId = localStorage.getItem('currentOrgId');
    const orgName = localStorage.getItem('currentOrgName');

    if (orgId) {
        currentOrgId = parseInt(orgId);
        document.getElementById('currentOrgName').textContent = orgName || '未知组织';
    } else {
        currentOrgId = 7; // 上海加盟商 (默认)
        document.getElementById('currentOrgName').textContent = '上海静安旗舰店';
    }
}

// 加载用户数据
async function loadUsers() {
    try {
        showLoading();
        const result = await userAPI.getList({ org_id: currentOrgId });

        if (result.success) {
            allUsers = result.data.items;
            updateStats();
            filterUsers();
        } else {
            showNotification('加载用户数据失败', 'error');
        }
    } catch (error) {
        console.error('加载失败:', error);
        showNotification('加载用户数据失败: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// 更新统计数据
async function updateStats() {
    try {
        const result = await userAPI.getStats(currentOrgId);
        if (result.success) {
            const stats = result.data;
            document.getElementById('statTotal').textContent = stats.total || 0;
            document.getElementById('statActive').textContent = stats.active_count || 0;
            document.getElementById('statInactive').textContent = stats.inactive_count || 0;
            document.getElementById('statLocked').textContent = stats.locked_count || 0;
        }
    } catch (error) {
        console.error('更新统计失败:', error);
    }
}

// 筛选用户
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;

    const filtered = allUsers.filter(u => {
        const matchesStatus = statusFilter === 'all' || u.status === statusFilter;
        const matchesSearch = !searchTerm ||
            u.username.toLowerCase().includes(searchTerm) ||
            u.real_name.toLowerCase().includes(searchTerm) ||
            u.phone.toLowerCase().includes(searchTerm) ||
            u.position.toLowerCase().includes(searchTerm);
        return matchesStatus && matchesSearch;
    });

    renderUsers(filtered);
}

// 渲染用户列表
function renderUsers(users) {
    const container = document.getElementById('userList');
    const emptyState = document.getElementById('emptyState');

    if (users.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }

    emptyState.classList.add('hidden');
    container.innerHTML = users.map(u => createUserCard(u)).join('');
    lucide.createIcons();
}

// 创建用户卡片
function createUserCard(user) {
    const statusInfo = getStatusInfo(user.status);
    const avatarColor = getAvatarColor(user.real_name);
    const initial = user.real_name.charAt(0);

    return `
        <div class="user-card bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow">
            <!-- 头像和基本信息 -->
            <div class="flex items-start gap-3 mb-4">
                <div class="avatar" style="background: ${avatarColor}">
                    ${initial}
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900">${user.real_name}</h3>
                    <p class="text-sm text-gray-500">${user.position}</p>
                    <p class="text-xs text-gray-400">@${user.username}</p>
                </div>
                <span class="status-badge ${statusInfo.colorClass}">
                    <i data-lucide="${statusInfo.icon}" class="w-3 h-3"></i>
                    ${statusInfo.label}
                </span>
            </div>

            <!-- 联系信息 -->
            <div class="space-y-2 mb-4">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i data-lucide="phone" class="w-4 h-4"></i>
                    ${user.phone}
                </div>
                ${user.email ? `
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    ${user.email}
                </div>
                ` : ''}
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i data-lucide="building" class="w-4 h-4"></i>
                    ${user.org_name}
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="flex gap-2">
                <button onclick="showEditModal(${user.id})"
                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                    <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                    编辑
                </button>
                <button onclick="toggleUserStatus(${user.id}, '${user.status}')"
                    class="px-3 py-2 ${user.status === 'active' ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white rounded-lg transition-colors">
                    <i data-lucide="${user.status === 'active' ? 'user-x' : 'user-check'}" class="w-4 h-4"></i>
                </button>
                <button onclick="showResetPasswordModal(${user.id}, '${user.real_name}')"
                    class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <i data-lucide="key" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    `;
}

// 生成头像颜色
function getAvatarColor(name) {
    const colors = [
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)'
    ];

    const index = name.charCodeAt(0) % colors.length;
    return colors[index];
}
```

---

## 十四、数据库表结构

### users表结构

```sql
CREATE TABLE `users` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希',
  `real_name` varchar(50) NOT NULL COMMENT '真实姓名',
  `org_id` int NOT NULL COMMENT '所属组织ID',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `gender` enum('male','female','other') DEFAULT NULL COMMENT '性别',
  `avatar_url` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `position` varchar(50) DEFAULT NULL COMMENT '职位',
  `status` enum('active','inactive','locked') DEFAULT 'active' COMMENT '状态',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(45) DEFAULT NULL COMMENT '最后登录IP',
  `login_count` int DEFAULT '0' COMMENT '登录次数',
  `created_by` int DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_deleted` tinyint(1) DEFAULT '0' COMMENT '是否删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  KEY `org_id` (`org_id`),
  KEY `status` (`status`),
  KEY `is_deleted` (`is_deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

---

## 十五、学到的经验教训

### 1. Express路由顺序很重要
- 具体路由（如 `/stats`）必须在参数化路由（如 `/:id`）之前定义
- Express按照定义顺序匹配路由，第一个匹配的路由会处理请求
- 参数化路由会匹配任何字符串，包括看起来像具体路径的字符串

### 2. 理解第三方库的返回值格式
- 不要假设库的行为，要查看源代码或文档
- mysql2的`execute()`返回`[rows, fields]`
- 如果已经在wrapper函数中解构，调用代码不应该再次解构
- 保持返回值格式的一致性

### 3. SQL prepared statements的类型限制
- MySQL的LIMIT和OFFSET必须是整数类型
- 使用占位符`?`时，某些数据库驱动对类型要求严格
- 对于LIMIT/OFFSET，使用字符串插值+parseInt比占位符更可靠
- 其他参数仍应使用占位符防止SQL注入

### 4. 前后端参数类型一致性
- URL查询参数默认是字符串类型
- 后端接收参数时应显式转换类型（parseInt、parseFloat）
- 数据库查询前要验证和转换参数类型

### 5. 错误调试流程
1. 查看完整错误堆栈
2. 定位出错的代码行
3. 理解错误消息的含义
4. 检查相关代码的上下文
5. 查看第三方库的文档和源码
6. 逐步缩小问题范围
7. 使用console.log或调试器验证假设

### 6. 部署前的检查清单
- [ ] 本地测试所有API端点
- [ ] 检查所有修改的文件
- [ ] 验证数据库查询性能
- [ ] 测试边界条件和错误情况
- [ ] 检查日志输出
- [ ] 备份生产数据
- [ ] 准备回滚方案

---

## 十六、性能优化建议

### 1. 数据库查询优化
- 为常用查询字段添加索引（org_id, status, is_deleted）
- 使用EXPLAIN分析查询计划
- 考虑添加复合索引：`(org_id, status, is_deleted)`
- 分页查询避免使用大的OFFSET值

### 2. 前端性能优化
- 实现虚拟滚动（当用户数量超过100时）
- 使用防抖（debounce）优化搜索输入
- 延迟加载图片和头像
- 缓存API响应结果
- 使用Web Workers处理大量数据

### 3. API性能优化
- 添加Redis缓存层
- 实现API响应压缩（gzip）
- 使用连接池管理数据库连接
- 添加请求限流和防护
- 实现分布式缓存

---

## 十七、安全加固建议

### 1. 认证和授权
```javascript
// 实现JWT中间件
const jwt = require('jsonwebtoken');

const authMiddleware = (req, res, next) => {
    const token = req.headers.authorization?.split(' ')[1];

    if (!token) {
        return res.status(401).json({
            success: false,
            error: { code: 'UNAUTHORIZED', message: '未授权' }
        });
    }

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.user = decoded;
        next();
    } catch (error) {
        return res.status(401).json({
            success: false,
            error: { code: 'INVALID_TOKEN', message: 'Token无效' }
        });
    }
};

// 在路由中使用
router.get('/users', authMiddleware, async (req, res) => {
    // 只返回当前用户有权限查看的数据
    const orgId = req.user.org_id;
    // ...
});
```

### 2. 输入验证
```javascript
// 使用joi进行请求验证
const Joi = require('joi');

const userCreateSchema = Joi.object({
    username: Joi.string().alphanum().min(3).max(30).required(),
    password: Joi.string().min(8).required(),
    real_name: Joi.string().min(2).max(50).required(),
    org_id: Joi.number().integer().positive().required(),
    phone: Joi.string().pattern(/^1[3-9]\d{9}$/),
    email: Joi.string().email()
});

router.post('/users', async (req, res) => {
    const { error, value } = userCreateSchema.validate(req.body);
    if (error) {
        return res.status(400).json({
            success: false,
            error: { code: 'VALIDATION_ERROR', message: error.details[0].message }
        });
    }
    // ...
});
```

### 3. SQL注入防护
- ✅ 已使用prepared statements（占位符`?`）
- ✅ 对字符串插值的参数使用parseInt()
- ⏳ 添加输入验证和清理
- ⏳ 使用ORM（如Sequelize）替代原生SQL

### 4. XSS防护
```javascript
// 安装helmet
const helmet = require('helmet');
app.use(helmet());

// 转义用户输入
const escapeHtml = (text) => {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
};
```

### 5. CSRF防护
```javascript
const csrf = require('csurf');
const csrfProtection = csrf({ cookie: true });

app.use(csrfProtection);
```

---

## 十八、监控和日志

### 1. 应用日志
```javascript
// 使用winston记录日志
const winston = require('winston');

const logger = winston.createLogger({
    level: 'info',
    format: winston.format.json(),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' })
    ]
});

// 在代码中使用
logger.info('User logged in', { userId: user.id, ip: req.ip });
logger.error('Database query failed', { error: error.message, sql });
```

### 2. PM2监控
```bash
# 查看应用状态
pm2 status beauty-crm-backend

# 查看日志
pm2 logs beauty-crm-backend

# 查看详细监控
pm2 monit

# 查看内存使用
pm2 show beauty-crm-backend
```

### 3. 数据库监控
```bash
# 查看慢查询
mysql> SHOW PROCESSLIST;
mysql> SHOW FULL PROCESSLIST;

# 查看慢查询日志
mysql> SHOW VARIABLES LIKE 'slow_query%';
mysql> SET GLOBAL slow_query_log = 'ON';
mysql> SET GLOBAL long_query_time = 2;
```

---

## 十九、备份和恢复

### 1. 数据库备份
```bash
# 备份单个表
mysqldump -h rm-uf6n6109o1lz3s13lso.mysql.rds.aliyuncs.com \
  -u daymade -p \
  beauty_crm users > users_backup_2025-12-01.sql

# 备份整个数据库
mysqldump -h rm-uf6n6109o1lz3s13lso.mysql.rds.aliyuncs.com \
  -u daymade -p \
  beauty_crm > beauty_crm_backup_2025-12-01.sql
```

### 2. 数据库恢复
```bash
# 恢复数据
mysql -h rm-uf6n6109o1lz3s13lso.mysql.rds.aliyuncs.com \
  -u daymade -p \
  beauty_crm < beauty_crm_backup_2025-12-01.sql
```

### 3. 代码备份
```bash
# 创建Git标签
git tag -a v1.2.0-user-management -m "用户管理模块上线"
git push origin v1.2.0-user-management

# 备份到远程仓库
git push origin master
```

---

## 二十、联系和支持

### 项目信息
- **项目名称**: 美业客户洞察CRM系统
- **版本**: v1.2.0
- **模块**: 用户管理（内部员工）

### 服务器信息
- **生产服务器**: 8.210.246.101
- **数据库**: 阿里云RDS MySQL
- **域名**: （待配置）

### 技术支持
- **开发团队**: 内部开发团队
- **文档位置**: /docs/工作日志-2025-12-01-用户管理模块.md

---

## 附录A：完整API文档

### A.1 获取用户列表

**接口**: `GET /api/users`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | number | 否 | 页码，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |
| org_id | number | 否 | 组织ID过滤 |
| status | string | 否 | 状态过滤：active/inactive/locked |
| keyword | string | 否 | 关键词搜索（用户名/姓名/手机） |

**响应示例**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 2,
        "username": "manager_sh",
        "real_name": "李美丽",
        "org_id": 7,
        "phone": "13900139000",
        "email": "limei@example.com",
        "gender": "female",
        "position": "加盟商经理",
        "status": "active",
        "org_name": "测试·虹桥旗舰店",
        "org_type": "franchisee"
      }
    ],
    "total": 9,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

### A.2 获取用户详情

**接口**: `GET /api/users/:id`

**响应示例**:
```json
{
  "success": true,
  "data": {
    "id": 2,
    "username": "manager_sh",
    "real_name": "李美丽",
    "org_id": 7,
    "phone": "13900139000",
    "email": "limei@example.com",
    "gender": "female",
    "position": "加盟商经理",
    "status": "active",
    "org_name": "测试·虹桥旗舰店",
    "org_level": 2
  }
}
```

### A.3 创建用户

**接口**: `POST /api/users`

**请求体**:
```json
{
  "username": "test_user",
  "password": "password123",
  "real_name": "测试用户",
  "org_id": 7,
  "phone": "13800138888",
  "email": "test@example.com",
  "gender": "female",
  "position": "美容师"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "id": 19,
    "message": "用户创建成功"
  }
}
```

### A.4 更新用户

**接口**: `PUT /api/users/:id`

**请求体**:
```json
{
  "real_name": "李美丽（更新）",
  "phone": "13900139001",
  "position": "高级经理"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "id": 2,
    "username": "manager_sh",
    "real_name": "李美丽（更新）",
    "phone": "13900139001",
    "position": "高级经理"
  },
  "message": "用户信息更新成功"
}
```

### A.5 更新用户状态

**接口**: `PATCH /api/users/:id/status`

**请求体**:
```json
{
  "status": "inactive"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "状态更新成功"
}
```

### A.6 更新密码

**接口**: `PATCH /api/users/:id/password`

**请求体**:
```json
{
  "old_password": "123456",
  "new_password": "newpassword123"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "密码更新成功"
}
```

### A.7 删除用户

**接口**: `DELETE /api/users/:id`

**响应示例**:
```json
{
  "success": true,
  "message": "用户删除成功"
}
```

### A.8 获取用户统计

**接口**: `GET /api/users/stats`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| org_id | number | 否 | 组织ID过滤 |

**响应示例**:
```json
{
  "success": true,
  "data": {
    "total": 9,
    "active_count": "8",
    "inactive_count": "1",
    "locked_count": "0",
    "today_login_count": "0"
  }
}
```

---

## 附录B：错误代码表

| 错误代码 | HTTP状态码 | 说明 |
|---------|-----------|------|
| INTERNAL_ERROR | 500 | 服务器内部错误 |
| USER_NOT_FOUND | 200 | 用户不存在 |
| INVALID_PARAMS | 200 | 参数错误 |
| USERNAME_EXISTS | 200 | 用户名已存在 |
| UPDATE_FAILED | 200 | 更新失败 |
| DELETE_FAILED | 200 | 删除失败 |
| INVALID_STATUS | 200 | 无效的状态值 |
| INVALID_PASSWORD | 200 | 密码错误 |

---

**文档版本**: 1.0
**最后更新**: 2025-12-01
**作者**: Claude (AI Assistant)
