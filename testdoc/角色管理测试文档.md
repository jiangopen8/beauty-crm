# 角色管理功能测试文档

## 文档信息
- **模块名称**: 角色管理
- **页面路径**: /roles.html
- **API路由**: /api/roles
- **测试目的**: 验证角色创建、权限分配、用户关联等功能的数据库操作正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

角色管理模块负责系统角色的定义、权限配置和用户关联管理，是实现基于角色的访问控制（RBAC）的核心模块。

### 核心功能
1. 角色信息管理（CRUD）
2. 角色权限配置（多对多关系）
3. 用户角色分配
4. 数据权限范围控制
5. 角色统计分析

---

## 二、数据库表结构

### 2.1 主表：roles

```sql
CREATE TABLE `roles` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `role_code` varchar(50) NOT NULL COMMENT '角色代码',
  `role_name` varchar(50) NOT NULL COMMENT '角色名称',
  `description` varchar(200) DEFAULT NULL COMMENT '角色描述',
  `data_scope` enum('all','org','store','self') NOT NULL DEFAULT 'self' COMMENT '数据权限范围',
  `status` enum('active','inactive') NOT NULL DEFAULT 'active' COMMENT '状态',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` bigint unsigned DEFAULT NULL COMMENT '创建人ID',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '软删除标记',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_code` (`role_code`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| role_code | varchar(50) | 是 | 角色代码 | 唯一，英文标识，不可修改 |
| role_name | varchar(50) | 是 | 角色名称 | 中文显示名 |
| description | varchar(200) | 否 | 角色描述 | 说明角色职责 |
| data_scope | enum | 是 | 数据权限 | all/org/store/self |
| status | enum | 是 | 状态 | active/inactive |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

**data_scope说明**:

| 值 | 含义 | 数据范围 | 典型角色 |
|----|------|---------|---------|
| all | 全部数据 | 可查看所有组织数据 | 系统管理员、数据分析师 |
| org | 组织数据 | 仅本组织数据 | 门店经理 |
| store | 门店数据 | 仅本门店数据 | 店长 |
| self | 个人数据 | 仅个人创建/负责的数据 | 美容顾问、销售专员 |

### 2.2 关联表：user_roles

```sql
CREATE TABLE `user_roles` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `role_id` bigint unsigned NOT NULL COMMENT '角色ID',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `created_by` bigint unsigned DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_role` (`user_id`,`role_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

### 2.3 权限表：role_permissions

```sql
CREATE TABLE `role_permissions` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `role_id` bigint unsigned NOT NULL COMMENT '角色ID',
  `permission_code` varchar(100) NOT NULL COMMENT '权限代码',
  `resource_type` varchar(50) DEFAULT NULL COMMENT '资源类型',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `created_by` bigint unsigned DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_permission` (`role_id`,`permission_code`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| id | bigint | 是 | 主键 | 自增 |
| role_id | bigint | 是 | 角色ID | 外键 |
| permission_code | varchar(100) | 是 | 权限代码 | customer:view, order:create |
| resource_type | varchar(50) | 否 | 资源类型 | customer, order, user |

---

## 三、业务流程

### 3.1 创建角色流程

```
开始
  ↓
前端：填写角色信息
  ↓
API: POST /api/roles
  ↓
验证：角色代码唯一性
  ↓
插入：roles 表
  ↓
获取：新角色ID
  ↓
（可选）配置权限
  ↓
批量插入：role_permissions 表
  ↓
返回：成功
  ↓
结束
```

### 3.2 分配角色给用户流程

```
开始
  ↓
API: POST /api/roles/assign-user
Body: { user_id, role_ids: [1,2,3] }
  ↓
删除：该用户的旧角色关联
DELETE FROM user_roles WHERE user_id = ?
  ↓
批量插入：新角色关联
INSERT INTO user_roles (user_id, role_id)
  ↓
返回：成功
  ↓
结束
```

### 3.3 获取用户角色流程

```
开始
  ↓
API: GET /api/roles/user/:userId
  ↓
查询：user_roles + roles 表关联
  ↓
返回：角色列表
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建角色测试

#### 测试场景1：创建基础角色

**前置条件**:
- 已登录系统
- 有角色管理权限

**操作步骤**:
1. 访问 http://8.210.246.101:5002/roles.html
2. 点击"新建角色"按钮
3. 填写信息：
   - 角色代码：`test_role_001`
   - 角色名称：`测试角色001`
   - 角色描述：`用于测试的角色`
   - 数据权限范围：`组织数据(org)`
   - 状态：`活跃`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证角色创建
SELECT
    id, role_code, role_name, description,
    data_scope, status, is_deleted
FROM roles
WHERE role_code = 'test_role_001';

-- 预期结果：
-- role_code: test_role_001
-- role_name: 测试角色001
-- description: 用于测试的角色
-- data_scope: org
-- status: active
-- is_deleted: 0

-- 2. 验证创建时间
SELECT
    role_code,
    created_at,
    updated_at,
    created_by
FROM roles
WHERE role_code = 'test_role_001';

-- 预期结果：
-- created_at: (当前时间)
-- updated_at: (当前时间)
-- created_by: (操作人ID)
```

**预期结果**:
- ✅ roles表新增1条记录
- ✅ role_code唯一
- ✅ status默认为'active'
- ✅ is_deleted默认为0
- ✅ created_at和updated_at自动设置

#### 测试场景2：角色代码重复校验

**操作步骤**:
1. 创建角色：`test_role_001`（与已存在角色代码重复）
2. 保存

**数据库验证SQL**:

```sql
-- 验证唯一约束
SELECT COUNT(*) as count
FROM roles
WHERE role_code = 'test_role_001' AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)
```

**预期结果**:
- ❌ API返回409错误
- ❌ 提示"角色代码已存在"
- ✅ 数据库无新增记录

#### 测试场景3：创建带权限的角色

**操作步骤**:
1. 创建角色：`test_role_002`
2. 配置权限：
   - customer:view (查看客户)
   - customer:create (创建客户)
   - order:view (查看订单)
3. 保存

**数据库验证SQL**:

```sql
-- 验证角色和权限
SELECT
    r.role_code,
    r.role_name,
    COUNT(rp.id) as permission_count,
    GROUP_CONCAT(rp.permission_code ORDER BY rp.permission_code) as permissions
FROM roles r
LEFT JOIN role_permissions rp ON r.id = rp.role_id
WHERE r.role_code = 'test_role_002'
GROUP BY r.id;

-- 预期结果：
-- permission_count: 3
-- permissions: customer:create,customer:view,order:view
```

**预期结果**:
- ✅ roles表新增1条记录
- ✅ role_permissions表新增3条记录
- ✅ 每个权限记录的role_id相同

### 4.2 编辑角色测试

#### 测试场景4：修改角色基本信息

**前置条件**: 角色test_role_001已存在

**操作步骤**:
1. 点击test_role_001的"编辑"按钮
2. 修改：
   - 角色名称：`测试角色001-已修改`
   - 描述：`已更新的描述信息`
   - 数据权限：`全部数据(all)`
3. 保存

**数据库验证SQL**:

```sql
-- 验证信息更新
SELECT
    role_code, role_name, description,
    data_scope, updated_at
FROM roles
WHERE role_code = 'test_role_001';

-- 预期结果：
-- role_name: 测试角色001-已修改
-- description: 已更新的描述信息
-- data_scope: all
-- updated_at: (更新为当前时间)
```

**预期结果**:
- ✅ 对应字段已更新
- ✅ updated_at自动更新
- ✅ role_code未改变（不可修改）

#### 测试场景5：修改角色权限

**前置条件**: test_role_002有3个权限

**操作步骤**:
1. 编辑test_role_002
2. 移除权限：`order:view`
3. 新增权限：`order:create`, `order:update`
4. 保存

**数据库验证SQL**:

```sql
-- 验证权限变更
SELECT
    r.role_code,
    GROUP_CONCAT(rp.permission_code ORDER BY rp.permission_code) as permissions
FROM roles r
LEFT JOIN role_permissions rp ON r.id = rp.role_id
WHERE r.role_code = 'test_role_002'
GROUP BY r.id;

-- 预期结果：
-- permissions: customer:create,customer:view,order:create,order:update
```

**预期结果**:
- ✅ 旧权限记录被删除
- ✅ 新权限记录被插入
- ✅ 最终权限数量正确（4个）

### 4.3 角色分配测试

#### 测试场景6：为用户分配单个角色

**前置条件**:
- 用户test_user_001已存在
- 角色test_role_001已存在

**API调用**:
```bash
POST /api/roles/assign-user
Body: {
  "user_id": 14,
  "role_ids": [角色ID]
}
```

**数据库验证SQL**:

```sql
-- 验证角色分配
SELECT
    u.username,
    u.real_name,
    r.role_code,
    r.role_name,
    ur.created_at
FROM user_roles ur
JOIN users u ON ur.user_id = u.id
JOIN roles r ON ur.role_id = r.id
WHERE u.username = 'test_user_001';

-- 预期结果：
-- 1条记录，role_code为test_role_001
```

**预期结果**:
- ✅ user_roles表新增1条记录
- ✅ user_id和role_id正确关联

#### 测试场景7：为用户分配多个角色

**API调用**:
```bash
POST /api/roles/assign-user
Body: {
  "user_id": 14,
  "role_ids": [1, 3, 6]
}
```

**数据库验证SQL**:

```sql
-- 验证多角色分配
SELECT
    u.username,
    COUNT(ur.role_id) as role_count,
    GROUP_CONCAT(r.role_name ORDER BY r.role_name) as roles
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.id = 14
GROUP BY u.id;

-- 预期结果：
-- role_count: 3
-- roles: (3个角色名称)
```

**预期结果**:
- ✅ 旧的user_roles记录被删除
- ✅ 新增3条user_roles记录

#### 测试场景8：移除用户的所有角色

**API调用**:
```bash
POST /api/roles/assign-user
Body: {
  "user_id": 14,
  "role_ids": []
}
```

**数据库验证SQL**:

```sql
-- 验证角色移除
SELECT COUNT(*) as role_count
FROM user_roles
WHERE user_id = 14;

-- 预期结果：
-- role_count: 0
```

**预期结果**:
- ✅ 该用户的所有user_roles记录被删除

### 4.4 角色状态管理

#### 测试场景9：停用角色

**操作步骤**:
1. 点击test_role_001的停用按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT role_code, status, updated_at
FROM roles
WHERE role_code = 'test_role_001';

-- 预期结果：
-- status: inactive
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status从'active'变为'inactive'
- ✅ updated_at自动更新
- ✅ 已分配该角色的用户不受影响（关联保留）

### 4.5 删除角色测试

#### 测试场景10：删除无用户关联的角色

**前置条件**: 角色test_role_001无用户关联

**操作步骤**:
1. 点击test_role_001的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    role_code, status, is_deleted, updated_at
FROM roles
WHERE role_code = 'test_role_001';

-- 预期结果：
-- is_deleted: 1

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM roles
WHERE role_code = 'test_role_001' AND is_deleted = 0;

-- 预期结果：
-- count: 0

-- 验证权限保留
SELECT COUNT(*) as permission_count
FROM role_permissions rp
JOIN roles r ON rp.role_id = r.id
WHERE r.role_code = 'test_role_001';

-- 预期结果：
-- permission_count > 0 (权限关联保留，用于审计)
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ role_permissions关联记录保留

#### 测试场景11：删除有用户关联的角色

**前置条件**: 角色test_role_002有用户关联

**操作步骤**:
1. 点击test_role_002的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 检查用户关联
SELECT COUNT(*) as user_count
FROM user_roles
WHERE role_id = (SELECT id FROM roles WHERE role_code = 'test_role_002');

-- 如果user_count > 0，删除应该失败
```

**预期结果**:
- ❌ API返回409错误
- ❌ 提示"该角色已分配给用户，不能删除"
- ✅ 数据库记录未改变

---

## 五、统计功能测试

### 测试场景12：角色统计

**API**: `GET /api/roles/stats`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count
FROM roles
WHERE is_deleted = 0;

-- 统计各角色的用户数
SELECT
    r.role_code,
    r.role_name,
    COUNT(DISTINCT ur.user_id) as user_count
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
WHERE r.is_deleted = 0
GROUP BY r.id
ORDER BY user_count DESC;
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致

---

## 六、数据权限范围测试

### 测试场景13：验证数据权限控制

**前置条件**: 创建不同data_scope的角色

**测试数据准备**:

```sql
-- 创建测试角色
INSERT INTO roles (role_code, role_name, description, data_scope, status)
VALUES
    ('test_all', '全局管理员', '可查看所有数据', 'all', 'active'),
    ('test_org', '组织管理员', '可查看组织数据', 'org', 'active'),
    ('test_store', '门店管理员', '可查看门店数据', 'store', 'active'),
    ('test_self', '普通员工', '只能查看个人数据', 'self', 'active');

-- 分配给不同用户
INSERT INTO user_roles (user_id, role_id)
SELECT 1, id FROM roles WHERE role_code = 'test_all' UNION
SELECT 2, id FROM roles WHERE role_code = 'test_org' UNION
SELECT 3, id FROM roles WHERE role_code = 'test_store' UNION
SELECT 4, id FROM roles WHERE role_code = 'test_self';
```

**验证SQL**:

```sql
-- 验证用户的数据权限范围
SELECT
    u.username,
    u.real_name,
    r.role_name,
    r.data_scope,
    CASE r.data_scope
        WHEN 'all' THEN '可查看所有组织数据'
        WHEN 'org' THEN '可查看本组织数据'
        WHEN 'store' THEN '可查看本门店数据'
        WHEN 'self' THEN '只能查看个人数据'
    END as permission_desc
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE u.id IN (1,2,3,4)
ORDER BY u.id;
```

**预期结果**:
- ✅ 每个用户的data_scope正确设置
- ✅ 可用于后续业务权限控制

---

## 七、边界条件测试

### 7.1 字段长度测试

```sql
-- 测试角色代码最大长度（50字符）
INSERT INTO roles (role_code, role_name, data_scope)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试角色',
    'self'
);

-- 预期：成功

-- 测试超长角色代码（51字符）
-- 预期：失败，超出长度限制
```

### 7.2 必填字段测试

```sql
-- 测试缺少必填字段
INSERT INTO roles (role_code) -- 缺少role_name
VALUES ('test');

-- 预期：失败，NOT NULL约束
```

### 7.3 枚举值测试

```sql
-- 测试非法data_scope值
INSERT INTO roles (role_code, role_name, data_scope)
VALUES ('test', '测试', 'invalid_scope');

-- 预期：失败，枚举值约束

-- 测试非法status值
UPDATE roles
SET status = 'invalid_status'
WHERE id = 1;

-- 预期：失败，枚举值约束
```

### 7.4 超级管理员保护测试

```sql
-- 尝试修改超级管理员角色
UPDATE roles
SET role_name = '修改后的名称'
WHERE role_code = 'super_admin';

-- 预期：API层面阻止（403错误）

-- 尝试删除超级管理员角色
UPDATE roles
SET is_deleted = 1
WHERE role_code = 'super_admin';

-- 预期：API层面阻止（403错误）
```

---

## 八、性能测试SQL

### 8.1 索引效率测试

```sql
-- 测试role_code唯一索引
EXPLAIN SELECT * FROM roles WHERE role_code = 'test_role_001';
-- 预期：type=const, key=uk_role_code

-- 测试status索引
EXPLAIN SELECT * FROM roles WHERE status = 'active';
-- 预期：type=ref, key=idx_status

-- 测试角色用户关联查询
EXPLAIN
SELECT r.*, COUNT(ur.user_id) as user_count
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
WHERE r.is_deleted = 0
GROUP BY r.id;
-- 验证索引使用情况
```

### 8.2 批量操作性能

```sql
-- 批量分配角色
START TRANSACTION;

DELETE FROM user_roles WHERE user_id = 1;

INSERT INTO user_roles (user_id, role_id, created_by)
SELECT 1, id, 1
FROM roles
WHERE id IN (1,2,3,4,5);

COMMIT;

-- 验证执行时间和影响行数
```

---

## 九、数据完整性检查

### 9.1 孤儿记录检查

```sql
-- 检查role_permissions中是否有孤儿记录
SELECT rp.id, rp.role_id, rp.permission_code
FROM role_permissions rp
LEFT JOIN roles r ON rp.role_id = r.id
WHERE r.id IS NULL;

-- 预期结果：0条记录

-- 检查user_roles中的角色是否有效
SELECT ur.id, ur.role_id, ur.user_id
FROM user_roles ur
LEFT JOIN roles r ON ur.role_id = r.id
WHERE r.id IS NULL OR r.is_deleted = 1;

-- 预期结果：0条记录（或已删除角色的关联需要清理）
```

### 9.2 数据一致性检查

```sql
-- 检查角色用户数统计
SELECT
    r.role_code,
    r.role_name,
    (SELECT COUNT(*) FROM user_roles WHERE role_id = r.id) as actual_user_count,
    -- 与业务统计对比
    r.user_count_cache -- 如果有缓存字段
FROM roles r
WHERE r.is_deleted = 0;

-- 检查唯一约束完整性
SELECT role_code, COUNT(*) as count
FROM roles
WHERE is_deleted = 0
GROUP BY role_code
HAVING count > 1;

-- 预期结果：0条记录
```

---

## 十、角色权限配置测试

### 10.1 权限代码规范测试

**推荐权限命名规范**: `资源:操作`

```sql
-- 检查权限代码格式
SELECT
    rp.permission_code,
    CASE
        WHEN rp.permission_code REGEXP '^[a-z_]+:[a-z_]+$' THEN '✅ 格式正确'
        ELSE '❌ 格式错误'
    END as format_check
FROM role_permissions rp
GROUP BY rp.permission_code;
```

**常用权限示例**:

| 权限代码 | 说明 | 资源类型 |
|----------|------|---------|
| customer:view | 查看客户 | customer |
| customer:create | 创建客户 | customer |
| customer:update | 更新客户 | customer |
| customer:delete | 删除客户 | customer |
| order:view | 查看订单 | order |
| order:create | 创建订单 | order |
| user:manage | 管理用户 | user |
| role:manage | 管理角色 | role |

### 10.2 权限完整性测试

```sql
-- 检查各角色的权限配置
SELECT
    r.role_code,
    r.role_name,
    COUNT(rp.id) as permission_count,
    GROUP_CONCAT(rp.permission_code ORDER BY rp.permission_code SEPARATOR ', ') as permissions
FROM roles r
LEFT JOIN role_permissions rp ON r.id = rp.role_id
WHERE r.is_deleted = 0
GROUP BY r.id
ORDER BY permission_count DESC;
```

---

## 十一、系统预置角色验证

### 11.1 预置角色列表

```sql
-- 验证系统预置角色
SELECT
    id, role_code, role_name, description,
    data_scope, status, created_at
FROM roles
WHERE role_code IN (
    'admin',
    'store_manager',
    'beautician',
    'sales',
    'receptionist',
    'data_analyst'
)
ORDER BY id;
```

**预期结果**:

| role_code | role_name | data_scope | 说明 |
|-----------|-----------|------------|------|
| admin | 系统管理员 | all | 拥有所有权限 |
| store_manager | 门店经理 | org | 管理门店运营 |
| beautician | 美容顾问 | self | 客户接待服务 |
| sales | 销售专员 | self | 产品销售 |
| receptionist | 前台接待 | org | 预约接待 |
| data_analyst | 数据分析师 | all | 数据分析 |

### 11.2 预置角色用户分配验证

```sql
-- 统计各预置角色的用户数
SELECT
    r.role_code,
    r.role_name,
    COUNT(DISTINCT ur.user_id) as user_count,
    GROUP_CONCAT(DISTINCT u.real_name ORDER BY u.real_name) as users
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
LEFT JOIN users u ON ur.user_id = u.id AND u.is_deleted = 0
WHERE r.role_code IN (
    'admin', 'store_manager', 'beautician',
    'sales', 'receptionist', 'data_analyst'
)
GROUP BY r.id
ORDER BY user_count DESC;
```

---

## 十二、测试数据清理

### 测试完成后的清理脚本

```sql
-- 1. 删除测试角色的权限
DELETE FROM role_permissions
WHERE role_id IN (
    SELECT id FROM roles
    WHERE role_code LIKE 'test_%'
);

-- 2. 删除测试角色的用户关联
DELETE FROM user_roles
WHERE role_id IN (
    SELECT id FROM roles
    WHERE role_code LIKE 'test_%'
);

-- 3. 删除测试角色
DELETE FROM roles
WHERE role_code LIKE 'test_%';

-- 4. 验证清理结果
SELECT COUNT(*) as remaining_test_roles
FROM roles
WHERE role_code LIKE 'test_%';

-- 预期结果：0
```

---

## 十三、常见问题排查

### 问题1：创建角色失败

**排查SQL**:
```sql
-- 检查角色代码是否已存在
SELECT id, role_code, is_deleted
FROM roles
WHERE role_code = 'xxx';

-- 检查字段值是否合法
SELECT
    'test_code' as role_code,
    'test' as role_name,
    'self' as data_scope,
    'active' as status;
```

### 问题2：角色分配失败

**排查SQL**:
```sql
-- 检查用户是否存在
SELECT id, username, is_deleted
FROM users
WHERE id = xxx;

-- 检查角色是否存在
SELECT id, role_code, status, is_deleted
FROM roles
WHERE id IN (1,2,3);

-- 检查是否已有重复关联
SELECT * FROM user_roles
WHERE user_id = xxx AND role_id = xxx;
```

### 问题3：角色删除失败

**排查SQL**:
```sql
-- 检查角色是否有用户关联
SELECT
    r.role_code,
    r.role_name,
    COUNT(ur.user_id) as user_count,
    GROUP_CONCAT(u.real_name) as users
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
LEFT JOIN users u ON ur.user_id = u.id
WHERE r.id = xxx
GROUP BY r.id;

-- 如果user_count > 0，则不能删除
```

---

## 十四、测试检查清单

### 功能测试
- [ ] 创建基础角色
- [ ] 角色代码重复校验
- [ ] 创建带权限的角色
- [ ] 修改角色基本信息
- [ ] 修改角色权限
- [ ] 为用户分配单个角色
- [ ] 为用户分配多个角色
- [ ] 移除用户的所有角色
- [ ] 停用角色
- [ ] 删除无用户关联的角色
- [ ] 删除有用户关联的角色（应失败）
- [ ] 角色统计准确性

### 数据库测试
- [ ] roles表记录正确插入
- [ ] role_permissions表记录正确插入
- [ ] user_roles表记录正确插入/删除
- [ ] 唯一约束生效
- [ ] 外键约束生效
- [ ] 索引使用正确
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新

### 权限测试
- [ ] data_scope正确设置
- [ ] 权限代码格式规范
- [ ] 权限配置完整性
- [ ] 超级管理员保护

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验

### 性能测试
- [ ] 索引效率
- [ ] 批量操作性能

---

## 附录A：快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试角色
INSERT INTO roles (role_code, role_name, description, data_scope, status, created_by)
VALUES ('test_auto_role', '自动测试角色', '用于自动化测试', 'org', 'active', 1);

SET @test_role_id = LAST_INSERT_ID();

-- 2. 配置权限
INSERT INTO role_permissions (role_id, permission_code, resource_type, created_by)
VALUES
    (@test_role_id, 'customer:view', 'customer', 1),
    (@test_role_id, 'customer:create', 'customer', 1),
    (@test_role_id, 'order:view', 'order', 1);

-- 3. 分配给用户
INSERT INTO user_roles (user_id, role_id, created_by)
VALUES (1, @test_role_id, 1);

-- 4. 验证创建
SELECT
    r.id, r.role_code, r.role_name,
    COUNT(rp.id) as permission_count,
    COUNT(DISTINCT ur.user_id) as user_count
FROM roles r
LEFT JOIN role_permissions rp ON r.id = rp.role_id
LEFT JOIN user_roles ur ON r.id = ur.role_id
WHERE r.id = @test_role_id
GROUP BY r.id;

-- 5. 更新角色
UPDATE roles
SET role_name = '自动测试角色-已修改', data_scope = 'all'
WHERE id = @test_role_id;

-- 6. 停用角色
UPDATE roles SET status = 'inactive' WHERE id = @test_role_id;

-- 7. 验证更新
SELECT id, role_code, role_name, data_scope, status
FROM roles
WHERE id = @test_role_id;

-- 8. 清理测试数据
DELETE FROM user_roles WHERE role_id = @test_role_id;
DELETE FROM role_permissions WHERE role_id = @test_role_id;
DELETE FROM roles WHERE id = @test_role_id;
```

---

## 附录B：监控查询

```sql
-- 实时监控角色变化
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_roles
FROM roles
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND is_deleted = 0
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计角色使用情况
SELECT
    r.role_code,
    r.role_name,
    COUNT(DISTINCT ur.user_id) as user_count,
    COUNT(rp.id) as permission_count,
    r.data_scope,
    r.status
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
LEFT JOIN role_permissions rp ON r.id = rp.role_id
WHERE r.is_deleted = 0
GROUP BY r.id
ORDER BY user_count DESC;

-- 权限分布统计
SELECT
    rp.permission_code,
    COUNT(DISTINCT rp.role_id) as role_count,
    GROUP_CONCAT(DISTINCT r.role_name) as roles
FROM role_permissions rp
JOIN roles r ON rp.role_id = r.id
WHERE r.is_deleted = 0
GROUP BY rp.permission_code
ORDER BY role_count DESC;
```

---

## 附录C：角色权限矩阵示例

| 功能模块 | 系统管理员 | 门店经理 | 美容顾问 | 销售专员 | 前台接待 | 数据分析师 |
|---------|----------|---------|---------|---------|---------|-----------|
| 查看客户 | ✅ all | ✅ org | ✅ self | ✅ self | ✅ org | ✅ all |
| 创建客户 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 编辑客户 | ✅ | ✅ | ✅ self | ✅ self | ✅ | ❌ |
| 删除客户 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 查看订单 | ✅ all | ✅ org | ✅ self | ✅ self | ✅ org | ✅ all |
| 创建订单 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 管理用户 | ✅ | ✅ org | ❌ | ❌ | ❌ | ❌ |
| 管理角色 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 数据分析 | ✅ | ✅ org | ❌ | ❌ | ❌ | ✅ all |

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
