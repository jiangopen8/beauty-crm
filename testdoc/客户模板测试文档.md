# 客户模板功能测试文档

## 文档信息
- **模块名称**: 客户模板管理
- **页面路径**: /customer-profile-templates.html
- **API路由**: /api/customer-profile-templates
- **测试目的**: 验证客户资料模板的创建、字段配置、分组管理等功能的数据库操作正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

客户模板管理模块负责定义客户资料的字段结构，支持不同组织和场景创建个性化的客户信息采集模板。

### 核心功能
1. 模板信息管理（CRUD）
2. 字段配置（动态字段定义）
3. 字段分组管理
4. 模板共享范围控制（global/org/private）
5. 适用场景设置
6. 模板统计分析

---

## 二、数据库表结构

### 2.1 主表：customer_profile_templates

```sql
CREATE TABLE `customer_profile_templates` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `template_code` varchar(50) NOT NULL COMMENT '模板编码',
  `template_name` varchar(100) NOT NULL COMMENT '模板名称',
  `description` text COMMENT '模板描述',
  `org_id` bigint unsigned DEFAULT NULL COMMENT '所属机构ID（NULL表示全局模板）',
  `scope` enum('global','org','private') NOT NULL DEFAULT 'org' COMMENT '共享范围',
  `apply_scene` enum('all','new_customer','vip_customer','online_register','other') NOT NULL DEFAULT 'all' COMMENT '适用场景',
  `fields` json NOT NULL COMMENT '字段定义（JSON数组）',
  `field_groups` json DEFAULT NULL COMMENT '字段分组配置',
  `version` varchar(20) DEFAULT '1.0' COMMENT '模板版本号',
  `is_default` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否默认模板',
  `usage_count` int unsigned NOT NULL DEFAULT '0' COMMENT '使用次数',
  `status` enum('active','inactive','draft') NOT NULL DEFAULT 'active' COMMENT '状态',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` bigint unsigned DEFAULT NULL,
  `updated_by` bigint unsigned DEFAULT NULL,
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_org_code` (`org_id`,`template_code`),
  KEY `idx_org_id` (`org_id`),
  KEY `idx_scope` (`scope`),
  KEY `idx_status` (`status`),
  KEY `idx_apply_scene` (`apply_scene`)
) ENGINE=InnoDB COMMENT='客户资料模板表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| template_code | varchar(50) | 是 | 模板编码 | 唯一（同org_id内），不可修改 |
| template_name | varchar(100) | 是 | 模板名称 | 用于显示 |
| description | text | 否 | 模板描述 | 说明模板用途 |
| org_id | bigint | 否 | 组织ID | NULL表示全局模板 |
| scope | enum | 是 | 共享范围 | global/org/private |
| apply_scene | enum | 是 | 适用场景 | all/new_customer/vip_customer等 |
| fields | json | 是 | 字段定义 | JSON数组，存储字段配置 |
| field_groups | json | 否 | 字段分组 | JSON数组，分组配置 |
| version | varchar(20) | 否 | 版本号 | 默认1.0 |
| is_default | tinyint(1) | 是 | 是否默认 | 0=否，1=是 |
| usage_count | int unsigned | 是 | 使用次数 | 默认0，统计用 |
| status | enum | 是 | 状态 | active/inactive/draft |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

**scope字段说明**:

| 值 | 含义 | 可见范围 | 典型应用 |
|----|------|---------|---------|
| global | 全局模板 | 所有组织可见可用 | 系统预置标准模板 |
| org | 组织模板 | 仅本组织可见可用 | 组织自定义模板 |
| private | 私有模板 | 仅创建人可见可用 | 个人专用模板 |

**apply_scene字段说明**:

| 值 | 含义 | 使用场景 |
|----|------|---------|
| all | 全部客户 | 通用客户信息采集 |
| new_customer | 新客户 | 新客首次建档 |
| vip_customer | VIP客户 | VIP客户详细信息 |
| online_register | 线上注册 | 线上渠道客户 |
| other | 其他 | 特殊场景 |

### 2.2 fields字段JSON结构

```json
[
  {
    "field_key": "skin_type",
    "field_name": "肤质",
    "field_type": "select",
    "group": "皮肤信息",
    "required": true,
    "options": ["干性", "油性", "混合性", "敏感性"],
    "placeholder": "请选择肤质类型",
    "display_order": 1,
    "validation": {
      "required": true
    }
  }
]
```

**字段属性说明**:

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| field_key | string | 是 | 字段键（英文，存储用） |
| field_name | string | 是 | 字段名称（中文，显示用） |
| field_type | string | 是 | 字段类型（text/select/checkbox等） |
| group | string | 是 | 所属分组 |
| required | boolean | 否 | 是否必填 |
| options | array | 否 | 选项列表（select/checkbox用） |
| placeholder | string | 否 | 提示文本 |
| display_order | number | 是 | 显示顺序 |

---

## 三、业务流程

### 3.1 创建客户模板流程

```
开始
  ↓
前端：填写模板基本信息
  ↓
API: POST /api/customer-profile-templates
  ↓
验证：模板编码唯一性（同org_id内）
  ↓
插入：customer_profile_templates 表
  ↓
获取：新模板ID
  ↓
（可选）配置字段
  ↓
更新：fields 字段（JSON）
  ↓
返回：成功
  ↓
结束
```

### 3.2 配置模板字段流程

```
开始
  ↓
API: GET /api/customer-profile-templates/:id
  ↓
获取：当前模板和字段配置
  ↓
前端：添加/编辑/删除字段
  ↓
API: PUT /api/customer-profile-templates/:id
Body: { fields: [...] }
  ↓
更新：fields JSON字段
  ↓
返回：成功
  ↓
结束
```

### 3.3 应用模板创建客户流程

```
开始
  ↓
选择：客户模板
  ↓
API: GET /api/customer-profile-templates/:id
  ↓
渲染：动态表单（基于fields配置）
  ↓
用户：填写客户信息
  ↓
API: POST /api/customers
Body: { template_id, profile_data: {...} }
  ↓
创建：客户记录
  ↓
更新：模板usage_count + 1
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建模板测试

#### 测试场景1：创建全局基础模板

**前置条件**:
- 已登录系统
- 有模板管理权限

**操作步骤**:
1. 访问 http://8.210.246.101:5002/customer-profile-templates.html
2. 点击"创建模板"按钮
3. 填写信息：
   - 模板编码：`GLOBAL_BASIC_001`
   - 模板名称：`全局基础客户模板`
   - 描述：`适用于所有组织的标准客户资料`
   - 共享范围：`全局模板(global)`
   - 适用场景：`全部客户(all)`
   - 状态：`启用`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证模板创建
SELECT
    id, template_code, template_name, description,
    scope, apply_scene, org_id, status, is_deleted
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期结果：
-- template_code: GLOBAL_BASIC_001
-- template_name: 全局基础客户模板
-- scope: global
-- apply_scene: all
-- org_id: NULL (全局模板)
-- status: active
-- is_deleted: 0

-- 2. 验证字段JSON结构
SELECT
    template_code,
    JSON_LENGTH(fields) as field_count,
    JSON_LENGTH(field_groups) as group_count
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期结果：
-- field_count: 0 (新建模板暂无字段)
-- group_count: NULL or 0
```

**预期结果**:
- ✅ customer_profile_templates表新增1条记录
- ✅ template_code唯一
- ✅ scope为'global'，org_id为NULL
- ✅ status默认为'active'
- ✅ is_deleted默认为0
- ✅ created_at和updated_at自动设置

#### 测试场景2：模板编码重复校验

**操作步骤**:
1. 创建模板：`GLOBAL_BASIC_001`（与已存在模板代码重复，且同org_id）
2. 保存

**数据库验证SQL**:

```sql
-- 验证唯一约束
SELECT COUNT(*) as count
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001'
  AND org_id IS NULL
  AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"模板编码已存在"
- ✅ 数据库无新增记录

#### 测试场景3：创建组织专用模板

**操作步骤**:
1. 创建模板：`ORG_VIP_001`
2. 共享范围：`组织模板(org)`
3. 适用场景：`VIP客户(vip_customer)`
4. 指定org_id: 7（虹桥店）

**数据库验证SQL**:

```sql
-- 验证组织模板
SELECT
    template_code,
    template_name,
    scope,
    org_id,
    apply_scene
FROM customer_profile_templates
WHERE template_code = 'ORG_VIP_001';

-- 预期结果：
-- scope: org
-- org_id: 7
-- apply_scene: vip_customer
```

**预期结果**:
- ✅ 模板创建成功
- ✅ 仅虹桥店可见可用
- ✅ 其他组织不可见

### 4.2 字段配置测试

#### 测试场景4：添加基础字段

**前置条件**: 模板GLOBAL_BASIC_001已存在

**操作步骤**:
1. 编辑模板GLOBAL_BASIC_001
2. 添加字段：
   - 字段键: `skin_type`
   - 字段名称: `肤质`
   - 字段类型: `单选下拉(select)`
   - 分组: `皮肤信息`
   - 选项: `干性,油性,混合性,敏感性`
   - 必填: ✓
   - 显示顺序: 1
3. 保存

**数据库验证SQL**:

```sql
-- 验证字段添加
SELECT
    template_code,
    JSON_LENGTH(fields) as field_count,
    JSON_EXTRACT(fields, '$[0].field_name') as first_field_name,
    JSON_EXTRACT(fields, '$[0].field_type') as first_field_type
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期结果：
-- field_count: 1
-- first_field_name: "肤质"
-- first_field_type: "select"

-- 验证字段完整结构
SELECT
    JSON_PRETTY(fields) as fields_detail
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期包含：
-- field_key: skin_type
-- options: ["干性", "油性", "混合性", "敏感性"]
-- required: true
```

**预期结果**:
- ✅ fields JSON数组新增1个元素
- ✅ 字段属性完整（field_key, field_name, field_type, options等）
- ✅ display_order正确设置

#### 测试场景5：批量配置多个字段

**操作步骤**:
1. 编辑模板
2. 批量添加字段：
   - `skin_concern` (皮肤问题, checkbox, 皮肤信息)
   - `allergies` (过敏史, textarea, 健康信息)
   - `preferred_contact` (首选联系方式, radio, 联系信息)
3. 保存

**数据库验证SQL**:

```sql
-- 验证字段数量
SELECT
    template_code,
    JSON_LENGTH(fields) as field_count,
    GROUP_CONCAT(DISTINCT JSON_EXTRACT(fields, CONCAT('$[', idx, '].group')) SEPARATOR ', ') as groups
FROM customer_profile_templates,
     JSON_TABLE(
         fields,
         '$[*]' COLUMNS (
             idx FOR ORDINALITY,
             group_name VARCHAR(50) PATH '$.group'
         )
     ) AS jt
WHERE template_code = 'GLOBAL_BASIC_001'
GROUP BY template_code;

-- 预期结果：
-- field_count: 4 (包括之前的skin_type)
-- groups包含: "皮肤信息", "健康信息", "联系信息"
```

**预期结果**:
- ✅ 成功添加3个新字段
- ✅ 不同分组字段正确保存
- ✅ 字段类型多样化（checkbox, textarea, radio）

#### 测试场景6：字段排序调整

**操作步骤**:
1. 拖拽字段调整顺序
2. 保存

**数据库验证SQL**:

```sql
-- 验证display_order
SELECT
    JSON_EXTRACT(fields, CONCAT('$[', idx - 1, '].field_name')) as field_name,
    JSON_EXTRACT(fields, CONCAT('$[', idx - 1, '].display_order')) as display_order
FROM customer_profile_templates,
     JSON_TABLE(
         JSON_ARRAY(0, 1, 2, 3),
         '$[*]' COLUMNS (idx INT PATH '$')
     ) AS nums
WHERE template_code = 'GLOBAL_BASIC_001'
  AND idx <= JSON_LENGTH(fields)
ORDER BY display_order;

-- 预期：display_order按拖拽后的顺序排列
```

**预期结果**:
- ✅ display_order值已更新
- ✅ 字段顺序符合拖拽结果

### 4.3 字段分组测试

#### 测试场景7：配置字段分组

**操作步骤**:
1. 编辑模板
2. 配置分组：
   - 分组名: `皮肤信息`，顺序: 1
   - 分组名: `健康信息`，顺序: 2
   - 分组名: `联系信息`，顺序: 3
3. 保存

**数据库验证SQL**:

```sql
-- 验证field_groups配置
SELECT
    template_code,
    JSON_PRETTY(field_groups) as groups_config
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期结果示例：
-- [
--   {"group_name": "皮肤信息", "display_order": 1},
--   {"group_name": "健康信息", "display_order": 2},
--   {"group_name": "联系信息", "display_order": 3}
-- ]
```

**预期结果**:
- ✅ field_groups JSON正确保存
- ✅ 分组顺序正确

### 4.4 模板状态管理测试

#### 测试场景8：停用模板

**操作步骤**:
1. 点击模板的停用按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT template_code, status, updated_at
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期结果：
-- status: inactive
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status从'active'变为'inactive'
- ✅ updated_at自动更新
- ✅ 模板不再出现在可选列表中

### 4.5 删除模板测试

#### 测试场景9：软删除模板

**前置条件**: 模板未被使用（usage_count = 0）

**操作步骤**:
1. 点击模板的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    template_code, status, is_deleted, updated_at
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001';

-- 预期结果：
-- is_deleted: 1

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM customer_profile_templates
WHERE template_code = 'GLOBAL_BASIC_001' AND is_deleted = 0;

-- 预期结果：
-- count: 0
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ 字段配置保留（用于审计）

#### 测试场景10：删除已使用的模板

**前置条件**: 模板已被使用（usage_count > 0）

**操作步骤**:
1. 点击模板的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 检查使用次数
SELECT template_code, usage_count
FROM customer_profile_templates
WHERE template_code = 'XXX';

-- 如果usage_count > 0，删除应该失败或给出警告
```

**预期结果**:
- ❌ API返回409错误或警告
- ❌ 提示"该模板已被使用，不能删除"
- ✅ 数据库记录未改变

---

## 五、统计功能测试

### 测试场景11：模板统计

**API**: `GET /api/customer-profile-templates/stats`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(CASE WHEN scope = 'global' THEN 1 ELSE 0 END) as global_count,
    SUM(CASE WHEN scope = 'org' THEN 1 ELSE 0 END) as org_count,
    SUM(usage_count) as total_usage
FROM customer_profile_templates
WHERE is_deleted = 0;

-- 统计各场景的模板数
SELECT
    apply_scene,
    COUNT(*) as count,
    SUM(usage_count) as total_usage
FROM customer_profile_templates
WHERE is_deleted = 0
GROUP BY apply_scene
ORDER BY count DESC;
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试模板编码最大长度（50字符）
INSERT INTO customer_profile_templates (template_code, template_name, fields)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试模板',
    '[]'
);

-- 预期：成功

-- 测试超长模板编码（51字符）
-- 预期：失败，超出长度限制
```

### 6.2 必填字段测试

```sql
-- 测试缺少必填字段
INSERT INTO customer_profile_templates (template_code) -- 缺少template_name和fields
VALUES ('test');

-- 预期：失败，NOT NULL约束
```

### 6.3 JSON字段有效性测试

```sql
-- 测试无效JSON
UPDATE customer_profile_templates
SET fields = 'invalid json'
WHERE id = 1;

-- 预期：失败，JSON格式错误

-- 测试空JSON数组
UPDATE customer_profile_templates
SET fields = '[]'
WHERE id = 1;

-- 预期：成功，空数组是有效的
```

### 6.4 枚举值测试

```sql
-- 测试非法scope值
UPDATE customer_profile_templates
SET scope = 'invalid_scope'
WHERE id = 1;

-- 预期：失败，枚举值约束

-- 测试非法apply_scene值
UPDATE customer_profile_templates
SET apply_scene = 'invalid_scene'
WHERE id = 1;

-- 预期：失败，枚举值约束
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试org_id索引
EXPLAIN SELECT * FROM customer_profile_templates WHERE org_id = 7;
-- 预期：type=ref, key=idx_org_id

-- 测试scope索引
EXPLAIN SELECT * FROM customer_profile_templates WHERE scope = 'global';
-- 预期：type=ref, key=idx_scope

-- 测试唯一索引
EXPLAIN SELECT * FROM customer_profile_templates
WHERE org_id = 7 AND template_code = 'TEST_001';
-- 预期：type=const, key=uk_org_code

-- 测试JSON字段查询
EXPLAIN SELECT * FROM customer_profile_templates
WHERE JSON_CONTAINS(fields, '{"field_type": "select"}');
-- 验证JSON查询性能
```

### 7.2 批量操作性能

```sql
-- 批量查询模板
SELECT
    t.id,
    t.template_name,
    JSON_LENGTH(t.fields) as field_count,
    o.org_name
FROM customer_profile_templates t
LEFT JOIN organizations o ON t.org_id = o.id
WHERE t.is_deleted = 0
  AND t.status = 'active'
ORDER BY t.usage_count DESC
LIMIT 100;

-- 验证执行时间
```

---

## 八、数据完整性检查

### 8.1 孤儿记录检查

```sql
-- 检查无效的org_id
SELECT id, template_code, org_id
FROM customer_profile_templates
WHERE org_id IS NOT NULL
  AND org_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0)
  AND is_deleted = 0;

-- 预期结果：0条记录
```

### 8.2 数据一致性检查

```sql
-- 检查唯一约束完整性
SELECT org_id, template_code, COUNT(*) as count
FROM customer_profile_templates
WHERE is_deleted = 0
GROUP BY org_id, template_code
HAVING count > 1;

-- 预期结果：0条记录

-- 检查JSON字段完整性
SELECT
    id,
    template_code,
    CASE
        WHEN JSON_VALID(fields) THEN '✅ 有效'
        ELSE '❌ 无效'
    END as fields_valid,
    CASE
        WHEN field_groups IS NULL OR JSON_VALID(field_groups) THEN '✅ 有效'
        ELSE '❌ 无效'
    END as groups_valid
FROM customer_profile_templates
WHERE is_deleted = 0;

-- 预期：所有记录的JSON都应该有效
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 删除测试模板
DELETE FROM customer_profile_templates
WHERE template_code LIKE 'TEST_%' OR template_code LIKE 'GLOBAL_BASIC_%';

-- 验证清理结果
SELECT COUNT(*) as remaining_test_templates
FROM customer_profile_templates
WHERE template_code LIKE 'TEST_%' OR template_code LIKE 'GLOBAL_BASIC_%';

-- 预期结果：0
```

---

## 十、常见问题排查

### 问题1：创建模板失败

**排查SQL**:
```sql
-- 检查模板编码是否已存在
SELECT id, template_code, org_id, is_deleted
FROM customer_profile_templates
WHERE template_code = 'xxx';

-- 检查字段值是否合法
SELECT
    'TEST_CODE' as template_code,
    '测试模板' as template_name,
    '[]' as fields,
    'org' as scope,
    'all' as apply_scene;
```

### 问题2：字段配置保存失败

**排查SQL**:
```sql
-- 检查JSON格式
SELECT
    id,
    template_code,
    JSON_VALID(fields) as is_valid_json,
    fields
FROM customer_profile_templates
WHERE id = xxx;

-- 检查字段结构
SELECT
    JSON_EXTRACT(fields, '$[0].field_key') as field_key,
    JSON_EXTRACT(fields, '$[0].field_name') as field_name,
    JSON_EXTRACT(fields, '$[0].field_type') as field_type
FROM customer_profile_templates
WHERE id = xxx;
```

### 问题3：模板不显示

**排查SQL**:
```sql
-- 检查模板状态
SELECT
    template_code,
    status,
    is_deleted,
    scope,
    org_id
FROM customer_profile_templates
WHERE id = xxx;

-- 如果status='inactive'或is_deleted=1，则不显示
-- 如果scope='org'，检查org_id是否匹配当前用户组织
```

---

## 十一、测试检查清单

### 功能测试
- [ ] 创建全局模板
- [ ] 创建组织模板
- [ ] 模板编码重复校验
- [ ] 添加基础字段
- [ ] 批量配置字段
- [ ] 字段排序调整
- [ ] 配置字段分组
- [ ] 停用模板
- [ ] 软删除模板
- [ ] 删除已使用模板（应失败）
- [ ] 模板统计准确性

### 数据库测试
- [ ] customer_profile_templates表记录正确插入
- [ ] 唯一约束生效（org_id + template_code）
- [ ] 索引使用正确
- [ ] JSON字段格式正确
- [ ] fields数组结构正确
- [ ] field_groups配置正确
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新

### 字段配置测试
- [ ] 文本字段配置
- [ ] 下拉选择字段配置
- [ ] 多选框字段配置
- [ ] 日期字段配置
- [ ] 数字字段配置
- [ ] 字段必填校验
- [ ] 字段选项配置

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验
- [ ] JSON格式校验

### 性能测试
- [ ] 索引效率
- [ ] JSON查询性能
- [ ] 批量操作性能

---

## 十二、快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试模板
INSERT INTO customer_profile_templates (
    template_code, template_name, description,
    scope, apply_scene, fields, created_by
)
VALUES (
    'AUTO_TEST_001',
    '自动测试模板',
    '用于自动化测试',
    'org',
    'all',
    '[]',
    1
);

SET @test_template_id = LAST_INSERT_ID();

-- 2. 添加字段配置
UPDATE customer_profile_templates
SET fields = JSON_ARRAY(
    JSON_OBJECT(
        'field_key', 'test_field_1',
        'field_name', '测试字段1',
        'field_type', 'text',
        'group', '测试分组',
        'required', true,
        'display_order', 1
    ),
    JSON_OBJECT(
        'field_key', 'test_field_2',
        'field_name', '测试字段2',
        'field_type', 'select',
        'group', '测试分组',
        'options', JSON_ARRAY('选项1', '选项2', '选项3'),
        'required', false,
        'display_order', 2
    )
)
WHERE id = @test_template_id;

-- 3. 验证创建
SELECT
    id,
    template_code,
    template_name,
    JSON_LENGTH(fields) as field_count
FROM customer_profile_templates
WHERE id = @test_template_id;

-- 4. 更新模板
UPDATE customer_profile_templates
SET template_name = '自动测试模板-已修改',
    status = 'inactive'
WHERE id = @test_template_id;

-- 5. 验证更新
SELECT id, template_name, status
FROM customer_profile_templates
WHERE id = @test_template_id;

-- 6. 清理测试数据
DELETE FROM customer_profile_templates WHERE id = @test_template_id;
```

---

## 十三、监控查询

```sql
-- 实时监控模板变化
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_templates
FROM customer_profile_templates
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND is_deleted = 0
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计模板使用情况
SELECT
    t.template_code,
    t.template_name,
    t.scope,
    t.apply_scene,
    t.usage_count,
    JSON_LENGTH(t.fields) as field_count,
    t.status
FROM customer_profile_templates t
WHERE t.is_deleted = 0
ORDER BY t.usage_count DESC
LIMIT 20;

-- 统计各场景模板分布
SELECT
    apply_scene,
    COUNT(*) as template_count,
    SUM(usage_count) as total_usage
FROM customer_profile_templates
WHERE is_deleted = 0
GROUP BY apply_scene
ORDER BY template_count DESC;

-- 统计字段类型分布
SELECT
    jt.field_type,
    COUNT(*) as count
FROM customer_profile_templates t,
     JSON_TABLE(
         t.fields,
         '$[*]' COLUMNS (
             field_type VARCHAR(50) PATH '$.field_type'
         )
     ) AS jt
WHERE t.is_deleted = 0
GROUP BY jt.field_type
ORDER BY count DESC;
```

---

## 附录A：字段类型支持清单

| 字段类型 | field_type值 | 说明 | 示例 |
|---------|-------------|------|------|
| 文本输入 | text | 单行文本 | 姓名、地址 |
| 多行文本 | textarea | 多行文本 | 备注、说明 |
| 数字输入 | number | 数字 | 年龄、身高 |
| 日期选择 | date | 日期 | 生日、首次到店 |
| 单选下拉 | select | 下拉选择 | 肤质、性别 |
| 单选按钮 | radio | 单选组 | 是否VIP |
| 多选框 | checkbox | 多选 | 兴趣爱好、皮肤问题 |
| 邮箱 | email | 邮箱格式 | 联系邮箱 |
| 电话 | tel | 电话号码 | 联系电话 |

---

## 附录B：预置模板示例

### 基础客户模板

```json
{
  "template_code": "BASIC_CUSTOMER",
  "template_name": "基础客户资料模板",
  "scope": "global",
  "apply_scene": "all",
  "fields": [
    {
      "field_key": "name",
      "field_name": "姓名",
      "field_type": "text",
      "group": "基本信息",
      "required": true,
      "display_order": 1
    },
    {
      "field_key": "phone",
      "field_name": "手机号",
      "field_type": "tel",
      "group": "基本信息",
      "required": true,
      "display_order": 2
    },
    {
      "field_key": "gender",
      "field_name": "性别",
      "field_type": "radio",
      "group": "基本信息",
      "options": ["女", "男"],
      "required": false,
      "display_order": 3
    },
    {
      "field_key": "birth_date",
      "field_name": "生日",
      "field_type": "date",
      "group": "基本信息",
      "required": false,
      "display_order": 4
    }
  ]
}
```

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
