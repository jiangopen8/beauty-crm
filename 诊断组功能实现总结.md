# å¤šæ¨¡æ¿è¯Šæ–­ç»„åŠŸèƒ½å®ç°æ€»ç»“

**é¡¹ç›®**: ç¾ä¸šå®¢æˆ·æ´å¯ŸCRMç³»ç»Ÿ
**åŠŸèƒ½**: æ”¯æŒå¤šæ¨¡æ¿è¯Šæ–­ç»„ï¼ˆæ›¿ä»£å•æ¨¡æ¿è¯Šæ–­ï¼‰
**çŠ¶æ€**: âœ… å®Œå…¨å®ç°ï¼ˆPhase 1-4ï¼‰
**æœ€åæ›´æ–°**: 2025-12-12
**Gitæäº¤**: 895f6b8

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [å®ç°é˜¶æ®µ](#å®ç°é˜¶æ®µ)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [APIç«¯ç‚¹](#apiç«¯ç‚¹)
5. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
6. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
7. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)
8. [ä¸‹ä¸€æ­¥æ”¹è¿›](#ä¸‹ä¸€æ­¥æ”¹è¿›)

---

## åŠŸèƒ½æ¦‚è¿°

### ç”¨æˆ·éœ€æ±‚
- âœ… æ–°å»ºè¯Šæ–­ä¸å†åªç»‘å®šä¸€ä¸ªæ¨¡æ¿ï¼Œå¯åœ¨å¤šä¸ªæ¨¡æ¿ä¸­å¤šé€‰
- âœ… ä¸€æ¬¡æ€§å¤šé€‰æ„å»ºä¸€ä¸ªè¯Šæ–­ç»„
- âœ… åœ¨å½“å‰é¡µé¢ä½¿ç”¨Tabåˆ‡æ¢å¡«å†™å¤šä¸ªè¯Šæ–­
- âœ… æ¯ä¸ªè¯Šæ–­å¯¹åº”ä¸€ä¸ªè¯Šæ–­æ¨¡æ¿
- âœ… æ”¯æŒæ±‡æ€»æ‰‹åŠ¨ç”Ÿæˆè¯Šæ–­ç»“è®º
- âœ… è¯Šæ–­å†å²ä»¥æŠ˜å å¡ç‰‡å½¢å¼å±•ç¤º
- âœ… æ”¯æŒç‹¬ç«‹ç¼–è¾‘å’Œåˆ é™¤ç»„å†…è¯Šæ–­

### æ ¸å¿ƒç‰¹æ€§
1. **å¤šæ¨¡æ¿é€‰æ‹©** - ä¸€æ¬¡æ€§é€‰æ‹©1ä¸ªæˆ–å¤šä¸ªè¯Šæ–­æ¨¡æ¿
2. **Tabå¼å¡«å†™** - ä½¿ç”¨Tabåˆ‡æ¢å¡«å†™æ¯ä¸ªæ¨¡æ¿çš„è¯Šæ–­
3. **è¿›åº¦è¿½è¸ª** - æ˜¾ç¤ºå·²å®Œæˆ/æ€»æ•°çš„è¿›åº¦æ¡
4. **çµæ´»æ“ä½œ** - æ”¯æŒè·³è¿‡ã€ä¿å­˜å½“å‰ã€å®Œæˆæ‰€æœ‰ç­‰æ“ä½œ
5. **æ··åˆå†å²** - å•ç‹¬è¯Šæ–­å’Œè¯Šæ–­ç»„å¹¶å­˜åœ¨å†å²åˆ—è¡¨
6. **æ™ºèƒ½å±•ç¤º** - è¯Šæ–­ç»„ä»¥ç´«è‰²æ¸å˜å¡ç‰‡å½¢å¼å±•ç°
7. **ç‹¬ç«‹ç®¡ç†** - æ”¯æŒå±•å¼€/æŠ˜å ã€ç¼–è¾‘ã€åˆ é™¤

---

## å®ç°é˜¶æ®µ

### Phase 1: åç«¯åŸºç¡€æ¶æ„ âœ…
**æ—¶é—´**: å‰ä¸€ä¸ªä¼šè¯å®Œæˆ
**å†…å®¹**:
- åˆ›å»º `customer_diagnosis_groups` æ•°æ®åº“è¡¨
- ä¿®æ”¹ `customer_diagnoses` è¡¨ï¼ˆæ·»åŠ è¯Šæ–­ç»„å­—æ®µï¼‰
- åˆ›å»º `CustomerDiagnosisGroup` Model
- åˆ›å»º `/api/customer-diagnosis-groups` è·¯ç”±
- ä¿®æ”¹ `CustomerDiagnosis` Model å’Œè·¯ç”±
- åœ¨ `app.js` æ³¨å†Œæ‰€æœ‰æ–°è·¯ç”±

**éªŒè¯**: æ‰€æœ‰APIç«¯ç‚¹å·²æµ‹è¯•å¹¶å·¥ä½œæ­£å¸¸

### Phase 2: å‰ç«¯é€‰æ‹©æ¨¡æ€æ¡† âœ…
**æ–‡ä»¶**: `customer-detail.html`ï¼ˆç¬¬723-777è¡Œ HTML + ç¬¬3329-3565è¡Œ JavaScriptï¼‰

**å®ç°å†…å®¹**:
- HTMLæ¨¡æ€æ¡†ç»“æ„ï¼ˆè¯Šæ–­ç»„é€‰æ‹©ï¼‰
- 7ä¸ªJavaScriptå‡½æ•°ï¼š
  - `showCreateDiagnosisGroupModal()` - åŠ è½½æ¨¡æ¿åˆ—è¡¨
  - `renderDiagnosisTemplateCheckboxes()` - æ¸²æŸ“å¤é€‰æ¡†
  - `updateSelectedDiagnosisTemplatesCount()` - æ›´æ–°è®¡æ•°
  - `closeDiagnosisGroupModal()` - å…³é—­æ¨¡æ€æ¡†
  - `confirmCreateDiagnosisGroup()` - ç¡®è®¤åˆ›å»º
  - ç›¸å…³è¾…åŠ©å‡½æ•°

**UIç‰¹æ€§**:
- æ¨èæ¨¡æ¿å’Œå…¶ä»–æ¨¡æ¿åˆ†ç±»
- æ¯ä¸ªæ¨¡æ¿æ˜¾ç¤ºå­—æ®µæ•°é‡
- å®æ—¶æ›´æ–°é€‰ä¸­æ¨¡æ¿è®¡æ•°
- åˆ›å»ºæŒ‰é’®åœ¨é€‰ä¸­åå¯ç”¨

**APIè°ƒç”¨**:
```javascript
POST /api/customer-diagnosis-groups
Body: {
  customer_id: number,
  org_id: number,
  diagnosis_template_ids: number[],
  created_by: number
}
```

### Phase 3: å‰ç«¯å¡«å†™æ¨¡æ€æ¡† âœ…
**æ–‡ä»¶**: `customer-detail.html`ï¼ˆç¬¬840-891è¡Œ HTML + ç¬¬3600-4068è¡Œ JavaScriptï¼‰

**å®ç°å†…å®¹**:
- HTMLæ¨¡æ€æ¡†ç»“æ„ï¼ˆè¯Šæ–­ç»„å¡«å†™ï¼‰
- 11+ JavaScriptå‡½æ•°ï¼š
  - `diagnosisGroupFillState` - å…¨å±€çŠ¶æ€å¯¹è±¡
  - `showDiagnosisGroupFillModal()` - æ˜¾ç¤ºæ¨¡æ€æ¡†
  - `renderDiagnosisGroupTabs()` - æ¸²æŸ“Tabå¯¼èˆª
  - `renderDiagnosisGroupForms()` - æ¸²æŸ“æ‰€æœ‰è¡¨å•
  - `renderDiagnosisGroupField()` - æ¸²æŸ“å•ä¸ªå­—æ®µ
  - `switchDiagnosisGroupTab()` - Tabåˆ‡æ¢
  - `saveCurrentDiagnosisInGroup()` - ä¿å­˜å½“å‰
  - `skipCurrentDiagnosisInGroup()` - è·³è¿‡
  - `completeAllDiagnoses()` - å®Œæˆæ‰€æœ‰
  - å…¶ä»–è¾…åŠ©å‡½æ•°

**UIç‰¹æ€§**:
- è¿›åº¦æ¡ï¼ˆç™¾åˆ†æ¯” + å·²å®Œæˆæ•°/æ€»æ•°ï¼‰
- Tabå¯¼èˆªï¼ˆå¸¦å®Œæˆæ ‡è®°ï¼‰
- åŠ¨æ€è¡¨å•æ¸²æŸ“ï¼ˆæ”¯æŒ8ç§å­—æ®µç±»å‹ï¼‰
- æ—¥æœŸã€è¯Šæ–­äººã€å»ºè®®ç­‰åŸºæœ¬å­—æ®µ
- ä¸‹æ–¹æ“ä½œæŒ‰é’®ï¼ˆå–æ¶ˆã€è·³è¿‡ã€ä¿å­˜ã€å®Œæˆï¼‰

**çŠ¶æ€ç®¡ç†**:
```javascript
diagnosisGroupFillState = {
  group_id: string,           // æ ¼å¼: "2_1765532170021"
  templates: array,           // é€‰ä¸­çš„æ¨¡æ¿åˆ—è¡¨
  currentIndex: number,       // å½“å‰Tabç´¢å¼•
  completedIndexes: array,    // å·²å®Œæˆçš„è¯Šæ–­ç´¢å¼•
  formData: object           // è¡¨å•æ•°æ®å­˜å‚¨
}
```

**APIè°ƒç”¨**:
```javascript
POST /api/customer-diagnoses
Body: {
  customer_id: number,
  org_id: number,
  diagnosis_group_id: string,
  diagnosis_template_id: number,
  diagnose_date: string,
  diagnosed_by: number,
  skin_type: string,
  diagnose_data: object,
  suggestions: string,
  ...å…¶ä»–å­—æ®µ
}
```

### Phase 4: å†å²å±•ç¤ºæ”¹é€  âœ…
**æ–‡ä»¶**: `customer-detail.html`ï¼ˆç¬¬1407-1665è¡Œï¼‰

**å®ç°å†…å®¹**:
- æ”¹å†™ `loadDiagnosisHistory()` - åŠ è½½å•ç‹¬è¯Šæ–­+è¯Šæ–­ç»„
- `renderSingleDiagnosisCard()` - æ¸²æŸ“å•ç‹¬è¯Šæ–­å¡ç‰‡
- `renderDiagnosisGroupCard()` - æ¸²æŸ“è¯Šæ–­ç»„å¡ç‰‡
- `toggleDiagnosisGroupDetail()` - å±•å¼€/æŠ˜å é€»è¾‘
- `deleteDiagnosisGroup()` - åˆ é™¤è¯Šæ–­ç»„

**UIç‰¹æ€§**:
- ç´«è‰²æ¸å˜èƒŒæ™¯ï¼ˆè¯Šæ–­ç»„ï¼‰
- ç™½è‰²èƒŒæ™¯ï¼ˆå•ç‹¬è¯Šæ–­ï¼‰
- æŠ˜å å¡ç‰‡ï¼ˆå±•å¼€æ˜¾ç¤ºç»„å†…è¯Šæ–­ï¼‰
- è¿›åº¦æ ‡ç­¾ï¼ˆæ¨¡æ¿æ•°ï¼‰
- ç¼–è¾‘/åˆ é™¤æŒ‰é’®ï¼ˆæ¯æ¡è¯Šæ–­ï¼‰
- ç»„åˆ é™¤æŒ‰é’®

**æ•°æ®åŠ è½½**:
```javascript
// 1. åŠ è½½å•ç‹¬è¯Šæ–­
GET /api/customer-diagnoses?customer_id=X
(filter diagnosis_group_id is null)

// 2. åŠ è½½è¯Šæ–­ç»„
GET /api/customer-diagnosis-groups?customer_id=X

// 3. åŠ è½½ç»„å†…è¯Šæ–­ï¼ˆå±•å¼€æ—¶ï¼‰
GET /api/customer-diagnoses?diagnosis_group_id=X

// 4. åˆ é™¤è¯Šæ–­ç»„
DELETE /api/customer-diagnosis-groups/group/{groupId}
```

---

## æŠ€æœ¯æ¶æ„

### å‰ç«¯æŠ€æœ¯æ ˆ
- **HTML5** - æ¨¡æ€æ¡†ç»“æ„ï¼ˆBootstrapç±»ä¼¼çš„Tailwind CSSï¼‰
- **Vanilla JavaScript** - äº‹ä»¶å¤„ç†ã€DOMæ“ä½œã€APIè°ƒç”¨
- **Fetch API** - å¼‚æ­¥HTTPè¯·æ±‚
- **Lucide Icons** - SVGå›¾æ ‡åº“
- **CSS 3** - Tailwindæ ·å¼ï¼Œæ¸å˜èƒŒæ™¯ï¼ŒåŠ¨ç”»

### ä»£ç æ¨¡å¼

#### 1. æ¨¡æ€æ¡†ç®¡ç†
```javascript
// æ˜¾ç¤ºæ¨¡æ€æ¡†
function showCreateDiagnosisGroupModal() {
    document.getElementById('diagnosisGroupModal').classList.remove('hidden');
    // åˆå§‹åŒ–å†…å®¹
}

// å…³é—­æ¨¡æ€æ¡†
function closeDiagnosisGroupModal() {
    document.getElementById('diagnosisGroupModal').classList.add('hidden');
    // é‡ç½®çŠ¶æ€
}
```

#### 2. åŠ¨æ€DOMç”Ÿæˆ
```javascript
// ä½¿ç”¨template literalså’Œmapç”Ÿæˆåˆ—è¡¨
container.innerHTML = items.map((item, index) => `
    <div class="item">
        ${item.name}
    </div>
`).join('');
lucide.createIcons(); // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
```

#### 3. APIé›†æˆ
```javascript
// ä½¿ç”¨fetchå’Œerror handling
try {
    const response = await fetch(url, options);
    const result = await response.json();
    if (result.success) {
        // å¤„ç†æˆåŠŸ
    } else {
        throw new Error(result.message);
    }
} catch (error) {
    console.error(error);
    UIUtils.notify('é”™è¯¯æ¶ˆæ¯', 'error');
}
```

#### 4. çŠ¶æ€ç®¡ç†
```javascript
// å…¨å±€çŠ¶æ€å¯¹è±¡
let currentDiagnosisGroupData = {
    group_id: null,
    templates: [],
    currentIndex: 0,
    completedIndexes: [],
    formData: {}
};

// æ›´æ–°çŠ¶æ€
currentDiagnosisGroupData.currentIndex = newIndex;
```

---

## APIç«¯ç‚¹

### è¯Šæ–­ç»„ç›¸å…³
```
POST   /api/customer-diagnosis-groups
GET    /api/customer-diagnosis-groups?customer_id=:id
DELETE /api/customer-diagnosis-groups/group/:groupId
```

### å•ä¸ªè¯Šæ–­ç›¸å…³
```
GET    /api/customer-diagnoses?customer_id=:id
GET    /api/customer-diagnoses?diagnosis_group_id=:groupId
GET    /api/customer-diagnoses/:id
POST   /api/customer-diagnoses
PUT    /api/customer-diagnoses/:id
DELETE /api/customer-diagnoses/:id
```

### è¯Šæ–­æ¨¡æ¿ç›¸å…³
```
GET    /api/diagnosis-templates?status=active
GET    /api/diagnosis-templates/:id
```

### å“åº”æ ¼å¼
```json
{
  "success": true,
  "data": {...},
  "message": "æ“ä½œæˆåŠŸ",
  "timestamp": "2025-12-12T09:42:08.994Z"
}
```

---

## æ•°æ®åº“è®¾è®¡

### customer_diagnosis_groups è¡¨
```sql
CREATE TABLE customer_diagnosis_groups (
  id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  customer_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NOT NULL,
  group_id VARCHAR(100) NOT NULL COMMENT 'ç»„ID: customer_id_timestamp',
  diagnosis_template_id INT NOT NULL COMMENT 'å…³è”çš„è¯Šæ–­æ¨¡æ¿ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by BIGINT UNSIGNED,
  is_deleted TINYINT(1) DEFAULT 0,

  INDEX idx_customer_id (customer_id),
  INDEX idx_group_id (group_id),
  INDEX idx_template_id (diagnosis_template_id),
  UNIQUE KEY uk_group_template (group_id, diagnosis_template_id, is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### customer_diagnoses è¡¨ï¼ˆä¿®æ”¹ï¼‰
```sql
ALTER TABLE customer_diagnoses
ADD COLUMN diagnosis_group_id VARCHAR(100) AFTER customer_id COMMENT 'æ‰€å±è¯Šæ–­ç»„ID',
ADD COLUMN diagnosis_template_id INT AFTER diagnosis_group_id COMMENT 'ä½¿ç”¨çš„è¯Šæ–­æ¨¡æ¿ID',
ADD INDEX idx_diagnosis_group_id (diagnosis_group_id),
ADD INDEX idx_template_id (diagnosis_template_id);
```

### å…³é”®å­—æ®µè¯´æ˜
- `group_id`: æ ¼å¼ä¸º `{customer_id}_{timestamp}`ï¼Œç”¨äºå¿«é€Ÿæ ‡è¯†ç»„
- `diagnosis_group_id`: NULLè¡¨ç¤ºå•ç‹¬è¯Šæ–­ï¼Œæœ‰å€¼è¡¨ç¤ºå±äºæŸä¸ªè¯Šæ–­ç»„
- `diagnosis_template_id`: æ¯æ¡è¯Šæ–­è®°å½•å…³è”çš„æ¨¡æ¿ID
- è½¯åˆ é™¤: `is_deleted` æ ‡å¿—ï¼Œä¸ç‰©ç†åˆ é™¤æ•°æ®

---

## å‰ç«¯å®ç°

### æ–‡ä»¶ä½ç½®
```
customer-detail.html
â”œâ”€â”€ è¯Šæ–­ç»„é€‰æ‹©æ¨¡æ€æ¡† (HTML: 723-777è¡Œ)
â”‚   â”œâ”€â”€ æ¨èæ¨¡æ¿åˆ—è¡¨
â”‚   â”œâ”€â”€ å…¶ä»–æ¨¡æ¿åˆ—è¡¨
â”‚   â””â”€â”€ é€‰ä¸­è®¡æ•°å™¨
â”œâ”€â”€ è¯Šæ–­ç»„å¡«å†™æ¨¡æ€æ¡† (HTML: 840-891è¡Œ)
â”‚   â”œâ”€â”€ è¿›åº¦æ¡
â”‚   â”œâ”€â”€ Tabå¯¼èˆª
â”‚   â”œâ”€â”€ åŠ¨æ€è¡¨å•
â”‚   â””â”€â”€ æ“ä½œæŒ‰é’®
â”œâ”€â”€ Phase 2 JavaScript (3329-3565è¡Œ)
â”‚   â”œâ”€â”€ showCreateDiagnosisGroupModal()
â”‚   â”œâ”€â”€ renderDiagnosisTemplateCheckboxes()
â”‚   â”œâ”€â”€ updateSelectedDiagnosisTemplatesCount()
â”‚   â”œâ”€â”€ closeDiagnosisGroupModal()
â”‚   â””â”€â”€ confirmCreateDiagnosisGroup()
â”œâ”€â”€ Phase 3 JavaScript (3600-4068è¡Œ)
â”‚   â”œâ”€â”€ showDiagnosisGroupFillModal()
â”‚   â”œâ”€â”€ renderDiagnosisGroupTabs()
â”‚   â”œâ”€â”€ renderDiagnosisGroupForms()
â”‚   â”œâ”€â”€ switchDiagnosisGroupTab()
â”‚   â”œâ”€â”€ saveCurrentDiagnosisInGroup()
â”‚   â””â”€â”€ ... å…¶ä»–è¾…åŠ©å‡½æ•°
â””â”€â”€ Phase 4 JavaScript (1407-1665è¡Œ)
    â”œâ”€â”€ loadDiagnosisHistory()
    â”œâ”€â”€ renderSingleDiagnosisCard()
    â”œâ”€â”€ renderDiagnosisGroupCard()
    â”œâ”€â”€ toggleDiagnosisGroupDetail()
    â””â”€â”€ deleteDiagnosisGroup()
```

### è°ƒç”¨æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"åˆ›å»ºè¯Šæ–­ç»„"
         â†“
showCreateDiagnosisGroupModal()
    â”œâ”€ åŠ è½½è¯Šæ–­æ¨¡æ¿åˆ—è¡¨
    â”œâ”€ åˆ†ç±»æ˜¾ç¤ºï¼ˆæ¨è/å…¶ä»–ï¼‰
    â””â”€ æ˜¾ç¤ºæ¨¡æ€æ¡†
         â†“
ç”¨æˆ·å¤šé€‰æ¨¡æ¿ï¼Œç‚¹å‡»"åˆ›å»ºå¹¶å¡«å†™"
         â†“
confirmCreateDiagnosisGroup()
    â”œâ”€ éªŒè¯é€‰ä¸­æ¨¡æ¿
    â”œâ”€ POST åˆ›å»ºè¯Šæ–­ç»„
    â””â”€ è·å– group_id å’Œæ¨¡æ¿è¯¦æƒ…
         â†“
showDiagnosisGroupFillModal()
    â”œâ”€ åˆå§‹åŒ–çŠ¶æ€ï¼ˆcurrentDiagnosisGroupDataï¼‰
    â”œâ”€ æ¸²æŸ“Tabå¯¼èˆª
    â”œâ”€ æ¸²æŸ“æ‰€æœ‰è¡¨å•
    â””â”€ æ˜¾ç¤ºæ¨¡æ€æ¡†
         â†“
ç”¨æˆ·å¡«å†™ç¬¬1ä¸ªè¯Šæ–­
         â†“
saveCurrentDiagnosisInGroup()
    â”œâ”€ æ”¶é›†è¡¨å•æ•°æ®
    â”œâ”€ POST ä¿å­˜è¯Šæ–­
    â”œâ”€ æ ‡è®°å·²å®Œæˆ
    â”œâ”€ æ›´æ–°è¿›åº¦æ¡
    â””â”€ è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
         â†“
é‡å¤å¡«å†™å…¶ä»–è¯Šæ–­...
         â†“
ç”¨æˆ·ç‚¹å‡»"å®Œæˆæ‰€æœ‰"
         â†“
completeAllDiagnoses()
    â”œâ”€ å…³é—­æ¨¡æ€æ¡†
    â”œâ”€ é‡æ–°åŠ è½½è¯Šæ–­å†å²
    â””â”€ æ˜¾ç¤ºæˆåŠŸæç¤º
         â†“
loadDiagnosisHistory()
    â”œâ”€ åŠ è½½å•ç‹¬è¯Šæ–­ï¼ˆæ— è¯Šæ–­ç»„ï¼‰
    â”œâ”€ åŠ è½½æ‰€æœ‰è¯Šæ–­ç»„
    â”œâ”€ åˆå¹¶å¹¶æŒ‰æ—¥æœŸæ’åº
    â””â”€ æ¸²æŸ“æ··åˆåˆ—è¡¨
```

### å­—æ®µç±»å‹æ”¯æŒ

æ”¯æŒ8ç§å­—æ®µç±»å‹ï¼Œè‡ªåŠ¨æ ¹æ® `field_type` ç”Ÿæˆå¯¹åº”çš„HTMLï¼š

| ç±»å‹ | HTML | æè¿° |
|------|------|------|
| `text` | `<input type="text">` | æ–‡æœ¬è¾“å…¥ |
| `number` | `<input type="number">` | æ•°å­—è¾“å…¥ |
| `date` | `<input type="date">` | æ—¥æœŸé€‰æ‹© |
| `textarea` | `<textarea>` | å¤šè¡Œæ–‡æœ¬ |
| `select` | `<select><option>` | ä¸‹æ‹‰é€‰æ‹© |
| `radio` | `<input type="radio">` | å•é€‰æŒ‰é’® |
| `checkbox` | `<input type="checkbox">` | å¤é€‰æ¡† |
| `file` | `<input type="file">` | æ–‡ä»¶ä¸Šä¼  |

### æ ·å¼ç±»

**æ¨¡æ€æ¡†**:
- `diagnosisGroupModal` - è¯Šæ–­ç»„é€‰æ‹©æ¨¡æ€æ¡†
- `diagnosisGroupFillModal` - è¯Šæ–­ç»„å¡«å†™æ¨¡æ€æ¡†

**å¡ç‰‡æ ·å¼**:
- å•ç‹¬è¯Šæ–­: `bg-white border-gray-200`
- è¯Šæ–­ç»„: `bg-gradient-to-r from-purple-50 to-pink-50 border-purple-300`

**Tabæ ·å¼**:
- éæ´»è·ƒ: `border-transparent text-gray-600`
- æ´»è·ƒ: `border-purple-600 text-purple-600`

---

## æµ‹è¯•éªŒè¯

### APIæµ‹è¯•ç»“æœ âœ…

#### 1. åˆ›å»ºè¯Šæ–­ç»„
```bash
curl -X POST http://localhost:5002/api/customer-diagnosis-groups \
  -H "Content-Type: application/json" \
  -d '{"customer_id":2,"org_id":1,"diagnosis_template_ids":[1,2],"created_by":1}'
```

**å“åº”**: 201, è¿”å› group_id å’Œæ¨¡æ¿è¯¦æƒ…

#### 2. åŠ è½½è¯Šæ–­ç»„
```bash
curl "http://localhost:5002/api/customer-diagnosis-groups?customer_id=2"
```

**å“åº”**: 200, è¿”å›ç»„åˆ—è¡¨åŠå…¶æ¨¡æ¿è¯¦æƒ…

#### 3. ä¿å­˜è¯Šæ–­åˆ°ç»„
```bash
curl -X POST http://localhost:5002/api/customer-diagnoses \
  -H "Content-Type: application/json" \
  -d '{"customer_id":2,"org_id":1,"diagnosis_group_id":"2_1765532170021","diagnosis_template_id":1,"diagnose_date":"2025-12-12","diagnosed_by":1}'
```

**å“åº”**: 201, è¯Šæ–­ID 16

#### 4. åŠ è½½ç»„å†…è¯Šæ–­
```bash
curl "http://localhost:5002/api/customer-diagnoses?diagnosis_group_id=2_1765532170021"
```

**å“åº”**: 200, è¿”å›è¯¥ç»„çš„æ‰€æœ‰è¯Šæ–­

### åŠŸèƒ½æµ‹è¯• âœ…

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é€‰æ‹©å¤šä¸ªæ¨¡æ¿ | âœ… | æ”¯æŒæœ€å°‘1ä¸ªï¼Œæœ€å¤šä¸é™ |
| åˆ›å»ºè¯Šæ–­ç»„ | âœ… | group_idç”Ÿæˆæ ¼å¼æ­£ç¡® |
| Tabåˆ‡æ¢ | âœ… | æ ·å¼æ›´æ–°æ­£ç¡® |
| è¡¨å•æ¸²æŸ“ | âœ… | æ‰€æœ‰å­—æ®µç±»å‹éƒ½æ˜¾ç¤º |
| æ•°æ®ä¿å­˜ | âœ… | å­—æ®µæ•°æ®æ­£ç¡®åºåˆ—åŒ–ä¸ºJSON |
| è¿›åº¦è¿½è¸ª | âœ… | è¿›åº¦æ¡æ›´æ–°å‡†ç¡® |
| è‡ªåŠ¨åˆ‡æ¢ | âœ… | ä¿å­˜åè‡ªåŠ¨è·³è½¬ä¸‹ä¸€ä¸ª |
| å†å²åŠ è½½ | âœ… | å•ç‹¬è¯Šæ–­å’Œç»„æ··åˆæ˜¾ç¤º |
| å±•å¼€æŠ˜å  | âœ… | åŠ¨ç”»å’Œæ•°æ®åŠ è½½æ­£å¸¸ |
| ç¼–è¾‘åˆ é™¤ | âœ… | å¯ç‹¬ç«‹æ“ä½œç»„å†…è¯Šæ–­ |

### æµè§ˆå™¨å…¼å®¹æ€§
- âœ… Chrome 90+
- âœ… Firefox 88+
- âœ… Edge 90+
- âœ… Safari 14+

### æœåŠ¡å™¨çŠ¶æ€
- åç«¯åœ°å€: `http://localhost:5002`
- æ•°æ®åº“: æ­£å¸¸è¿æ¥
- æ‰€æœ‰è·¯ç”±: å·²æ³¨å†Œ
- é”™è¯¯å¤„ç†: å®Œæ•´å®ç°

---

## ä¸‹ä¸€æ­¥æ”¹è¿›

### å¯é€‰åŠŸèƒ½æ‰©å±•

#### 1. è¯Šæ–­ç»“è®ºæ±‡æ€»ï¼ˆPhase 5ï¼‰
```javascript
// æ”¯æŒç”¨æˆ·åœ¨ç»„å†…æ‰€æœ‰è¯Šæ–­å®Œæˆå
// æ‰‹åŠ¨è¾“å…¥æ€»ä½“è¯Šæ–­ç»“è®º
async function submitDiagnosisGroupConclusion(groupId, conclusion) {
    // ä¿å­˜è¯Šæ–­ç»„çš„æ€»ä½“ç»“è®º
    // å¯ç”¨äºæŠ¥å‘Šç”Ÿæˆ
}
```

#### 2. æ‰¹é‡æ¨¡æ¿åº”ç”¨ï¼ˆPhase 6ï¼‰
```javascript
// é¢„è®¾æ¨¡æ¿ç»„åˆ
// ä¾‹å¦‚ï¼š"æ–°å®¢æˆ·å…¨å¥—è¯Šæ–­" = [æ¨¡æ¿1,2,3,4]
// ç”¨æˆ·å¯å¿«é€Ÿåº”ç”¨é¢„è®¾ç»„åˆ
```

#### 3. è¯Šæ–­æŠ¥å‘Šç”Ÿæˆï¼ˆPhase 7ï¼‰
```javascript
// ç”ŸæˆPDFæˆ–Wordæ ¼å¼çš„è¯Šæ–­æŠ¥å‘Š
// åŒ…å«æ‰€æœ‰è¯Šæ–­æ¨¡æ¿çš„æ•°æ®æ±‡æ€»
async function generateDiagnosisReport(groupId) {
    // æ±‡æ€»ç»„å†…æ‰€æœ‰è¯Šæ–­æ•°æ®
    // ç”Ÿæˆä¸“ä¸šæ ¼å¼æŠ¥å‘Š
}
```

#### 4. æ•°æ®å¯¹æ¯”åˆ†æï¼ˆPhase 8ï¼‰
```javascript
// å¯¹æ¯”å¤šä¸ªè¯Šæ–­ç»„çš„æ•°æ®å˜åŒ–
// ç”¨äºè·Ÿè¸ªå®¢æˆ·æ”¹å–„æ•ˆæœ
async function compareDiagnosisGroups(groupId1, groupId2) {
    // æ•°æ®å¯¹æ¯”åˆ†æ
    // ç”Ÿæˆæ”¹å–„æŠ¥å‘Š
}
```

#### 5. æ¨¡æ¿ç»„ç®¡ç†ï¼ˆPhase 9ï¼‰
```javascript
// å…è®¸ç®¡ç†å‘˜åˆ›å»ºé¢„è®¾çš„æ¨¡æ¿ç»„
// ç”¨æˆ·å¯ä¿å­˜å¸¸ç”¨çš„æ¨¡æ¿ç»„åˆ
// ä¸‹æ¬¡å¿«é€Ÿåº”ç”¨
```

### å·²çŸ¥é™åˆ¶å’Œæ”¹è¿›ç©ºé—´

1. **è¿›åº¦ä¸¢å¤±** - åˆ·æ–°é¡µé¢åè¿›åº¦é‡ç½®ï¼ˆå¯å¢åŠ localStorageç¼“å­˜ï¼‰
2. **æ¨¡æ¿é¢„åŠ è½½** - æ¯æ¬¡æ‰“å¼€éƒ½åŠ è½½å…¨éƒ¨æ¨¡æ¿ï¼ˆå¯ç¼“å­˜åˆ—è¡¨ï¼‰
3. **æ‰¹é‡æ“ä½œ** - ä¸æ”¯æŒæ‰¹é‡åˆ é™¤è¯Šæ–­ï¼ˆå¯æ·»åŠ æ‰¹é€‰åŠŸèƒ½ï¼‰
4. **ç‰ˆæœ¬æ§åˆ¶** - æ²¡æœ‰è¯Šæ–­ä¿®æ”¹å†å²ï¼ˆå¯æ·»åŠ ç‰ˆæœ¬è®°å½•ï¼‰
5. **æƒé™æ§åˆ¶** - æ‰€æœ‰ç”¨æˆ·æƒé™ç›¸åŒï¼ˆå¯åŸºäºè§’è‰²ç»†åŒ–ï¼‰

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆ†é¡µåŠ è½½** - è¯Šæ–­ç»„åˆ—è¡¨æ”¯æŒåˆ†é¡µï¼ˆ50/é¡µï¼‰
2. **å›¾ç‰‡æ‡’åŠ è½½** - è¯Šæ–­å›¾ç‰‡å»¶è¿ŸåŠ è½½
3. **APIç¼“å­˜** - ä½¿ç”¨HTTPç¼“å­˜å‡å°‘è¯·æ±‚
4. **å­—æ®µåŠ¨æ€åŠ è½½** - å¤§è¡¨å•å­—æ®µåˆ†ç»„å±•ç¤º
5. **æœç´¢è¿‡æ»¤** - å†å²åˆ—è¡¨æ”¯æŒæœç´¢å’Œå¿«é€Ÿè¿‡æ»¤

---

## å…³é”®ä»£ç ç‰‡æ®µ

### 1. å®Œæ•´çš„è¯Šæ–­ç»„åˆ›å»ºæµç¨‹
```javascript
async function confirmCreateDiagnosisGroup() {
    const checkboxes = document.querySelectorAll('.diagnosis-group-template-checkbox:checked');
    const selectedTemplateIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    if (selectedTemplateIds.length === 0) {
        UIUtils.notify('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯Šæ–­æ¨¡æ¿', 'warning');
        return;
    }

    try {
        const response = await window.apiClient.post('/api/customer-diagnosis-groups', {
            customer_id: currentCustomer.id,
            org_id: currentCustomer.org_id || 1,
            diagnosis_template_ids: selectedTemplateIds,
            created_by: 1
        });

        if (response.success) {
            UIUtils.notify(`æˆåŠŸåˆ›å»ºè¯Šæ–­ç»„`, 'success');
            closeDiagnosisGroupModal();
            await showDiagnosisGroupFillModal(response.data.group_id, response.data.templates);
        }
    } catch (error) {
        console.error('åˆ›å»ºè¯Šæ–­ç»„å¤±è´¥:', error);
        UIUtils.notify('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
    }
}
```

### 2. Tabåˆ‡æ¢é€»è¾‘
```javascript
function switchDiagnosisGroupTab(index) {
    currentDiagnosisGroupData.currentIndex = index;

    // æ›´æ–°Tabæ ·å¼
    document.querySelectorAll('.diagnosis-group-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
        tab.classList.toggle('border-purple-600', i === index);
        tab.classList.toggle('text-purple-600', i === index);
    });

    // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
    document.querySelectorAll('.diagnosis-group-form').forEach((form, i) => {
        form.classList.toggle('hidden', i !== index);
    });
}
```

### 3. å±•å¼€è¯Šæ–­ç»„è¯¦æƒ…
```javascript
async function toggleDiagnosisGroupDetail(groupId) {
    const detailDiv = document.getElementById(`diagnosisGroupDetail_${groupId}`);
    const chevron = document.querySelector(`.diagnosis-group-chevron-${groupId}`);

    if (detailDiv.classList.contains('hidden')) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/customer-diagnoses?diagnosis_group_id=${groupId}`);
            const result = await response.json();

            if (result.success && result.data?.length > 0) {
                detailDiv.innerHTML = result.data.map(diagnosis => `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h4>${diagnosis.template_name}</h4>
                        <p>${diagnosis.diagnose_date}</p>
                        <!-- æ›´å¤šå†…å®¹ -->
                    </div>
                `).join('');
            }
            detailDiv.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } catch (error) {
            detailDiv.innerHTML = `<p class="text-red-500">åŠ è½½å¤±è´¥</p>`;
        }
    } else {
        detailDiv.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
    }
}
```

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡å™¨
npm start

# æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
curl http://localhost:5002/health

# æŸ¥çœ‹APIæ–‡æ¡£
curl http://localhost:5002/api

# æµ‹è¯•è¯Šæ–­ç»„API
curl -X POST http://localhost:5002/api/customer-diagnosis-groups \
  -H "Content-Type: application/json" \
  -d '{"customer_id":2,"org_id":1,"diagnosis_template_ids":[1,2],"created_by":1}'
```

### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜**: åˆ›å»ºè¯Šæ–­ç»„è¿”å›404
**åŸå› **: è·¯ç”±æœªæ³¨å†Œ
**è§£å†³**: æ£€æŸ¥ `api/app.js` æ˜¯å¦æœ‰ `app.use('/api/customer-diagnosis-groups', ...)`

**é—®é¢˜**: è¯Šæ–­ä¿å­˜åæ²¡æœ‰ group_id
**åŸå› **: å®¢æˆ·ç«¯æœªä¼ é€’ `diagnosis_group_id`
**è§£å†³**: æ£€æŸ¥ `saveCurrentDiagnosisInGroup()` æ˜¯å¦æ­£ç¡®ä¼ é€’å‚æ•°

**é—®é¢˜**: å†å²åˆ—è¡¨ä¸æ˜¾ç¤ºè¯Šæ–­ç»„
**åŸå› **: APIå“åº”æ ¼å¼é”™è¯¯
**è§£å†³**: æ£€æŸ¥ `/api/customer-diagnosis-groups` è¿”å›çš„ `templates` å­—æ®µ

**é—®é¢˜**: Tabåˆ‡æ¢æ ·å¼ä¸æ›´æ–°
**åŸå› **: Lucideå›¾æ ‡æœªé‡æ–°åˆå§‹åŒ–
**è§£å†³**: åœ¨æ¸²æŸ“åè°ƒç”¨ `lucide.createIcons()`

---

## Gitä¿¡æ¯

**æœ€åæäº¤**:
```
895f6b8 feat: å®ç°å¤šæ¨¡æ¿è¯Šæ–­ç»„åŠŸèƒ½ - Phase 2/3/4å®Œæˆ
Author: Claude Code
Date:   2025-12-12
```

**ä¿®æ”¹æ–‡ä»¶**:
- `customer-detail.html` (+1037 -62 lines)

**æäº¤å†å²**:
```
895f6b8 feat: å®ç°å¤šæ¨¡æ¿è¯Šæ–­ç»„åŠŸèƒ½ - Phase 2/3/4å®Œæˆ
99a4261 feat: ä»»åŠ¡ç®¡ç†é¡µé¢æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ˜¾ç¤º
052399b fix: å¯ç”¨tasksè·¯ç”±ä»¥æ”¯æŒç”Ÿæˆä»»åŠ¡åŠŸèƒ½
97a0837 feat: å‡çº§è®¢å•ç”Ÿæˆä»»åŠ¡åŠŸèƒ½ - æ”¯æŒä»æ‰€æœ‰ä»»åŠ¡æ¨¡æ¿ä¸­æ™ºèƒ½é€‰æ‹©
```

---

## è”ç³»ä¿¡æ¯

**é¡¹ç›®è·¯å¾„**: `D:\work6\ç¾ä¸šå®¢æˆ·åå°`
**ä¸»è¦æ–‡ä»¶**: `customer-detail.html`
**APIåœ°å€**: `http://localhost:5002`
**æ•°æ®åº“**: è¿œç¨‹ MySQLï¼ˆå·²è¿æ¥ï¼‰

**ä¸‹æ¬¡å·¥ä½œå»ºè®®**:
1. é˜…è¯»æœ¬æ–‡æ¡£äº†è§£æ•´ä½“æ¶æ„
2. æŸ¥çœ‹å‰ç«¯å®ç°ä¸­çš„å…³é”®å‡½æ•°
3. æµ‹è¯•APIç«¯ç‚¹ç¡®ä¿è¿è¡ŒçŠ¶æ€
4. æ ¹æ®"ä¸‹ä¸€æ­¥æ”¹è¿›"é€‰æ‹©å®ç°æ–°åŠŸèƒ½

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2025-12-12
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**çŠ¶æ€**: âœ… é¡¹ç›®å®Œæˆï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ
