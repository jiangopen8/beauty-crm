# 客户资料板块完善说明

## 概述

本次更新改进了 `customer-detail.html` 中的**客户资料板块**，使其能够：
- ✅ 从数据库加载真实的客户资料数据
- ✅ 根据客户资料模板动态渲染表单
- ✅ 支持多个字段类型（文本、下拉、复选框、日期等）
- ✅ 实时保存客户资料到数据库
- ✅ 显示资料最后更新时间

## 技术架构

### 核心组件

#### 1. **CustomerProfileModule** (`js/modules/customer-profile.js`)
这是一个独立的客户资料管理模块，提供以下功能：

```javascript
// 初始化模块
const module = new CustomerProfileModule({
    customerId: '客户ID'
});

// 挂载到容器
module.mount(document.getElementById('container'));

// 保存资料
module.saveProfile();
```

**主要功能：**
- 自动加载客户资料模板
- 动态生成表单UI
- 支持多种字段类型
- 表单数据验证和收集
- 与后端API通信

#### 2. **后端API接口**

**获取模板列表**
```
GET /api/customer-profile-templates
```
返回所有可用的客户资料模板。

**获取客户资料**
```
GET /api/customer-profiles/customer/:customerId/template/:templateId
```
获取特定客户使用特定模板的资料。

**创建客户资料**
```
POST /api/customer-profiles
请求体：{
    customer_id: number,
    template_id: number,
    org_id: number,
    profile_data: object,
    template_version: string,
    created_by: number
}
```

**更新客户资料**
```
PUT /api/customer-profiles/customer/:customerId/template/:templateId
请求体：{
    profile_data: object,
    updated_by: number
}
```

### 数据库表结构

#### customer_profile_templates（模板表）
存储客户资料模板定义：
- `id`: 模板ID
- `template_code`: 模板编码
- `template_name`: 模板名称
- `fields`: JSON格式的字段定义
- `field_groups`: 字段分组信息
- `status`: 模板状态（active/inactive）
- `is_default`: 是否为默认模板

#### customer_profiles（资料表）
存储客户的详细资料：
- `id`: 资料ID
- `customer_id`: 客户ID
- `template_id`: 使用的模板ID
- `profile_data`: JSON格式的资料数据
- `template_version`: 模板版本号
- `created_at/updated_at`: 创建/更新时间

## 可用的模板类型

### 1. 客户基础资料模板（标准版）
**模板代码**: `DEFAULT_BASIC`

包含以下字段分组：
- **基础信息**：职业
- **皮肤信息**：肤质类型、主要皮肤问题
- **健康信息**：过敏史、既往病史
- **偏好设置**：偏好服务时间

### 2. 客户资料模板（专业版）
**模板代码**: `PREMIUM_PROFESSIONAL`

更详细的皮肤分析，包含：
- **皮肤诊断**：肤质、皮肤问题、pH值、含水量、含油量
- **生活方式**：生活习惯
- **护肤习惯**：当前使用的护肤品牌

### 3. 线上注册快速模板
**模板代码**: `ONLINE_SIMPLE`

简化版本，适合快速注册：
- **基础信息**：肤质类型、年龄段
- **需求分析**：最关注的问题
- **消费意向**：护理预算

### 4. 新客到店详细登记模板
**模板代码**: `NEW_CUSTOMER_DETAILED`

全面采集新客户信息：
- **来源信息**：了解渠道、推荐人
- **皮肤分析**：肤质、主要护理需求
- **健康档案**：过敏史、正在服用的药物
- **服务偏好**：服务偏好、偏好到店时间

### 5. 身体护理客户模板
**模板代码**: `BODY_CARE_TEMPLATE`

适用于身体护理、SPA项目：
- **身体信息**：体型、身体皮肤敏感度
- **护理需求**：身体护理需求
- **健康信息**：慢性疾病、孕产状态
- **服务偏好**：按摩力度、精油香型

## 使用流程

### 前端使用

1. **在客户详情页初始化模块**
```javascript
function loadProfileForms() {
    const container = document.getElementById('profileFormsContainer');

    profileModule = new CustomerProfileModule({
        customerId: currentCustomer.id
    });

    profileModule.mount(container);
}
```

2. **保存客户资料**
```javascript
function saveCustomerData() {
    if (profileModule && profileModule.saveProfile) {
        return profileModule.saveProfile();
    }
}
```

3. **刷新客户资料**
```javascript
// 重新初始化模块（会重新加载数据）
profileModule.refresh();
```

### 表单字段类型支持

| 字段类型 | 说明 | 示例 |
|---------|------|------|
| `text` | 文本输入框 | 职业、姓名 |
| `textarea` | 多行文本 | 过敏史、备注 |
| `number` | 数字输入 | pH值、含水量 |
| `date` | 日期选择 | 出生日期 |
| `select` | 下拉选择 | 肤质类型 |
| `radio` | 单选按钮 | 性别 |
| `checkbox` | 多选框 | 皮肤问题、生活习惯 |

## 改进亮点

### 1. 动态表单生成
- 无需修改前端代码，直接通过模板定义来生成表单
- 支持字段分组显示
- 支持字段验证规则

### 2. 灵活的模板系统
- 支持多个模板，不同场景使用不同模板
- 支持全局模板和机构级模板
- 可扩展的字段类型系统

### 3. 完整的CRUD操作
- 自动检测是否存在资料（创建或更新）
- 版本管理（记录模板版本）
- 软删除机制

### 4. 智能API调用
- 自动检测服务器地址（支持localhost和远程服务器）
- 备用地址支持（无法连接时自动切换）
- 完整的错误处理和提示

### 5. 用户友好的界面
- 显示资料最后更新时间
- 未填写时显示提示
- 加载状态和错误提示
- 重置和保存按钮

## 调试技巧

### 1. 查看浏览器控制台
在客户详情页打开浏览器开发者工具，查看Console标签：
- ✅ 模板加载成功
- ✅ 客户资料加载成功
- ℹ️ 客户暂无资料
- ❌ 错误信息

### 2. 检查网络请求
在Network标签中查看API调用：
- `GET /api/customer-profile-templates` - 模板列表
- `GET /api/customer-profiles/customer/:id/template/:templateId` - 客户资料
- `POST /api/customer-profiles` - 创建资料
- `PUT /api/customer-profiles/...` - 更新资料

### 3. 常见问题

**Q: 表单无法加载**
- 检查浏览器console中的错误信息
- 确保服务器运行正常
- 检查API返回的数据格式

**Q: 保存失败**
- 查看浏览器console中的详细错误
- 检查服务器日志
- 确保必填字段已填写

**Q: 看不到更新的资料**
- 刷新页面或重新初始化模块
- 检查API返回的数据
- 确认数据库已更新

## 后续改进方向

1. **字段验证增强**
   - 自定义验证规则
   - 实时验证反馈
   - 表单级别的验证

2. **UI/UX优化**
   - 拖拽排序字段
   - 条件字段显示
   - 字段联动

3. **性能优化**
   - 字段级别的缓存
   - 批量保存支持
   - 离线模式

4. **功能扩展**
   - 历史版本查看
   - 字段对比
   - 批量导入/导出
   - 模板预设值

## 部署检查清单

- [ ] 确保数据库表已创建
- [ ] 确保模板数据已插入
- [ ] 测试API接口是否正常
- [ ] 在浏览器中测试客户详情页加载
- [ ] 验证表单可以正确显示
- [ ] 测试保存功能是否成功
- [ ] 查看数据库是否正确存储数据
- [ ] 测试刷新页面数据是否持久化

## 相关文件

- `customer-detail.html` - 客户详情页面
- `js/modules/customer-profile.js` - 客户资料模块
- `api/routes/customer-profiles.js` - 客户资料API
- `api/routes/customer-profile-templates.js` - 模板API
- `api/models/CustomerProfileTemplate.js` - 模板模型
- `database/create-customer-profiles-table.sql` - 数据库表定义
- `database/insert-customer-profile-templates.js` - 模板数据脚本
