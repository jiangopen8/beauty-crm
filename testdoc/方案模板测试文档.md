# 方案模板功能测试文档

## 文档信息
- **模块名称**: 方案模板管理
- **页面路径**: /templates.html
- **API路由**: /api/solution-templates
- **测试目的**: 验证美容方案模板的创建、配置、产品服务关联等功能的数据库操作正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

方案模板管理模块负责定义美容护理方案的标准配置，包括适用肤质、护理步骤、推荐产品、预期效果等完整的方案结构。

### 核心功能
1. 模板信息管理（CRUD）
2. 方案字段配置（动态字段定义）
3. 适用肤质和问题配置
4. 护理步骤定义
5. 产品和服务关联
6. 价格区间设置
7. 案例照片管理
8. 模板统计分析

---

## 二、数据库表结构

### 2.1 主表：solution_templates

```sql
CREATE TABLE `solution_templates` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `template_code` varchar(50) NOT NULL COMMENT '模板编码',
  `template_name` varchar(200) NOT NULL COMMENT '模板名称',
  `category` enum('hydration','whitening','anti_aging','repair','hair_care','other') NOT NULL COMMENT '方案类别',
  `org_id` bigint unsigned DEFAULT NULL COMMENT '所属机构ID',
  `scope` enum('global','org','private') NOT NULL DEFAULT 'org' COMMENT '共享范围',
  `apply_scene` varchar(100) DEFAULT NULL,
  `fields` json DEFAULT NULL,
  `version` varchar(20) DEFAULT '1.0',
  `sort_order` int DEFAULT '0',
  `suitable_skin_types` json DEFAULT NULL COMMENT '适用肤质（JSON数组）',
  `suitable_problems` json DEFAULT NULL COMMENT '适用问题（JSON数组）',
  `target_group` varchar(100) DEFAULT NULL COMMENT '目标人群',
  `course_duration` varchar(50) DEFAULT NULL COMMENT '疗程时长',
  `treatment_frequency` varchar(50) DEFAULT NULL COMMENT '治疗频次',
  `steps` json DEFAULT NULL COMMENT '步骤说明（JSON数组）',
  `products` json DEFAULT NULL COMMENT '推荐产品（JSON数组）',
  `services` json DEFAULT NULL COMMENT '包含服务（JSON数组）',
  `expected_effects` text COMMENT '预期效果',
  `precautions` text COMMENT '注意事项',
  `estimated_price_min` decimal(10,2) DEFAULT NULL COMMENT '预估价格下限',
  `estimated_price_max` decimal(10,2) DEFAULT NULL COMMENT '预估价格上限',
  `cover_image` varchar(255) DEFAULT NULL COMMENT '封面图',
  `case_photos` json DEFAULT NULL COMMENT '案例照片（JSON数组）',
  `usage_count` int unsigned NOT NULL DEFAULT '0' COMMENT '使用次数',
  `status` enum('active','inactive') NOT NULL DEFAULT 'active',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` bigint unsigned DEFAULT NULL,
  `updated_by` bigint unsigned DEFAULT NULL,
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_org_code` (`org_id`,`template_code`),
  KEY `idx_category` (`category`),
  KEY `idx_org_id` (`org_id`),
  KEY `idx_scope` (`scope`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB COMMENT='方案模板表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| template_code | varchar(50) | 是 | 模板编码 | 唯一（同org_id内），不可修改 |
| template_name | varchar(200) | 是 | 模板名称 | 用于显示 |
| category | enum | 是 | 方案类别 | 必选项 |
| org_id | bigint | 否 | 组织ID | NULL表示全局模板 |
| scope | enum | 是 | 共享范围 | global/org/private |
| suitable_skin_types | json | 否 | 适用肤质 | ["干性", "油性", "混合性"] |
| suitable_problems | json | 否 | 适用问题 | ["痘痘", "色斑", "皱纹"] |
| target_group | varchar(100) | 否 | 目标人群 | 如：25-35岁女性 |
| course_duration | varchar(50) | 否 | 疗程时长 | 如：4周、3个月 |
| treatment_frequency | varchar(50) | 否 | 治疗频次 | 如：每周2次 |
| steps | json | 否 | 步骤说明 | JSON数组 |
| products | json | 否 | 推荐产品 | JSON数组 |
| services | json | 否 | 包含服务 | JSON数组 |
| expected_effects | text | 否 | 预期效果 | 详细描述 |
| precautions | text | 否 | 注意事项 | 详细描述 |
| estimated_price_min | decimal(10,2) | 否 | 最低价格 | 金额 |
| estimated_price_max | decimal(10,2) | 否 | 最高价格 | 金额 |
| cover_image | varchar(255) | 否 | 封面图URL | 图片路径 |
| case_photos | json | 否 | 案例照片 | JSON数组，存储URL |
| usage_count | int unsigned | 是 | 使用次数 | 默认0 |
| status | enum | 是 | 状态 | active/inactive |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

**category字段说明**:

| 值 | 中文名称 | 适用场景 |
|----|---------|---------|
| hydration | 补水保湿 | 干燥缺水肌肤 |
| whitening | 美白提亮 | 暗沉色斑肌肤 |
| anti_aging | 抗衰老 | 皱纹松弛肌肤 |
| repair | 修复舒缓 | 敏感受损肌肤 |
| hair_care | 头发护理 | 头发头皮护理 |
| other | 其他 | 其他特殊方案 |

### 2.2 steps字段JSON结构

```json
[
  {
    "step": 1,
    "name": "深层清洁",
    "description": "使用温和洁面乳清洁面部，去除表面污垢",
    "duration": "5分钟",
    "products": ["温和洁面乳", "洁面海绵"],
    "techniques": "打圈按摩"
  }
]
```

### 2.3 products字段JSON结构

```json
[
  {
    "product_id": 101,
    "product_name": "玻尿酸精华液",
    "brand": "某品牌",
    "usage": "每日早晚使用",
    "quantity": "30ml/瓶"
  }
]
```

---

## 三、业务流程

### 3.1 创建方案模板流程

```
开始
  ↓
前端：填写方案基本信息（类别、名称等）
  ↓
API: POST /api/solution-templates
  ↓
验证：模板编码唯一性（同org_id内）
  ↓
插入：solution_templates 表
  ↓
获取：新模板ID
  ↓
配置：适用肤质、问题、步骤、产品
  ↓
更新：相关JSON字段
  ↓
返回：成功
  ↓
结束
```

### 3.2 应用模板创建方案流程

```
开始
  ↓
选择：方案模板
  ↓
API: GET /api/solution-templates/:id
  ↓
获取：模板配置（步骤、产品、服务等）
  ↓
为客户定制：调整产品、服务、价格
  ↓
API: POST /api/solutions
Body: { template_id, customer_id, customized_data: {...} }
  ↓
创建：客户方案记录
  ↓
更新：模板usage_count + 1
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建模板测试

#### 测试场景1：创建补水保湿方案模板

**前置条件**:
- 已登录系统
- 有模板管理权限

**操作步骤**:
1. 访问 http://8.210.246.101:5002/templates.html
2. 点击"创建模板"按钮
3. 填写信息：
   - 模板编码：`HYDRATION_BASIC_V1`
   - 模板名称：`基础补水保湿方案`
   - 方案类别：`补水保湿(hydration)`
   - 共享范围：`组织模板(org)`
   - 适用肤质：`干性,混合性`
   - 适用问题：`缺水,干燥,脱皮`
   - 目标人群：`25-40岁干性肌肤女性`
   - 疗程时长：`4周`
   - 治疗频次：`每周2次`
   - 预估价格：`1500-3000元`
   - 状态：`启用`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证模板创建
SELECT
    id, template_code, template_name, category,
    scope, org_id, status, is_deleted
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- template_code: HYDRATION_BASIC_V1
-- template_name: 基础补水保湿方案
-- category: hydration
-- scope: org
-- status: active
-- is_deleted: 0

-- 2. 验证适用条件
SELECT
    template_code,
    suitable_skin_types,
    suitable_problems,
    target_group,
    course_duration,
    treatment_frequency
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- suitable_skin_types: ["干性", "混合性"]
-- suitable_problems: ["缺水", "干燥", "脱皮"]
-- target_group: 25-40岁干性肌肤女性
-- course_duration: 4周
-- treatment_frequency: 每周2次

-- 3. 验证价格区间
SELECT
    template_code,
    estimated_price_min,
    estimated_price_max
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- estimated_price_min: 1500.00
-- estimated_price_max: 3000.00
```

**预期结果**:
- ✅ solution_templates表新增1条记录
- ✅ template_code唯一（同org_id内）
- ✅ category正确设置
- ✅ JSON字段正确保存
- ✅ 价格字段类型正确（decimal）

#### 测试场景2：模板编码重复校验

**操作步骤**:
1. 创建模板：`HYDRATION_BASIC_V1`（与已存在模板代码重复，且同org_id）
2. 保存

**数据库验证SQL**:

```sql
-- 验证唯一约束
SELECT COUNT(*) as count
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1'
  AND org_id = 7
  AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"模板编码已存在"
- ✅ 数据库无新增记录

### 4.2 步骤配置测试

#### 测试场景3：配置护理步骤

**前置条件**: 模板HYDRATION_BASIC_V1已存在

**操作步骤**:
1. 编辑模板HYDRATION_BASIC_V1
2. 配置步骤：

   **步骤1**:
   - 步骤序号: 1
   - 步骤名称: `深层清洁`
   - 步骤描述: `使用温和洁面乳清洁面部`
   - 时长: `5分钟`
   - 使用产品: `温和洁面乳`
   - 操作手法: `打圈按摩`

   **步骤2**:
   - 步骤序号: 2
   - 步骤名称: `补水精华`
   - 步骤描述: `涂抹玻尿酸精华液`
   - 时长: `10分钟`
   - 使用产品: `玻尿酸精华液`
   - 操作手法: `轻拍至吸收`

3. 保存

**数据库验证SQL**:

```sql
-- 验证步骤配置
SELECT
    template_code,
    JSON_LENGTH(steps) as step_count,
    JSON_EXTRACT(steps, '$[0].name') as first_step_name,
    JSON_EXTRACT(steps, '$[0].duration') as first_step_duration
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- step_count: 2
-- first_step_name: "深层清洁"
-- first_step_duration: "5分钟"

-- 验证完整步骤结构
SELECT
    JSON_PRETTY(steps) as steps_detail
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期包含：step, name, description, duration, products, techniques
```

**预期结果**:
- ✅ steps JSON数组包含2个元素
- ✅ 每个步骤属性完整
- ✅ 步骤顺序正确

### 4.3 产品关联测试

#### 测试场景4：配置推荐产品

**操作步骤**:
1. 编辑模板
2. 添加推荐产品：
   - 产品1: 玻尿酸精华液, 30ml, 每日早晚使用
   - 产品2: 补水面膜, 5片/盒, 每周2-3次
   - 产品3: 保湿乳液, 50ml, 每日早晚使用
3. 保存

**数据库验证SQL**:

```sql
-- 验证产品配置
SELECT
    template_code,
    JSON_LENGTH(products) as product_count,
    JSON_EXTRACT(products, '$[0].product_name') as first_product
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- product_count: 3
-- first_product: "玻尿酸精华液"

-- 验证产品完整结构
SELECT
    JSON_PRETTY(products) as products_detail
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期包含：product_name, quantity, usage等属性
```

**预期结果**:
- ✅ products JSON数组包含3个元素
- ✅ 每个产品属性完整
- ✅ 产品用法正确保存

### 4.4 服务关联测试

#### 测试场景5：配置包含服务

**操作步骤**:
1. 编辑模板
2. 添加包含服务：
   - 服务1: 深层补水护理, 60分钟, 800元
   - 服务2: 保湿面膜护理, 30分钟, 300元
3. 保存

**数据库验证SQL**:

```sql
-- 验证服务配置
SELECT
    template_code,
    JSON_LENGTH(services) as service_count
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- service_count: 2
```

**预期结果**:
- ✅ services JSON数组正确保存
- ✅ 服务属性完整

### 4.5 效果和注意事项测试

#### 测试场景6：配置预期效果和注意事项

**操作步骤**:
1. 编辑模板
2. 填写预期效果：
   ```
   - 1周后：肌肤水分含量明显提升，干燥脱皮现象减轻
   - 2周后：肌肤触感更加柔软细腻，细纹淡化
   - 4周后：肌肤水润饱满，持久保湿，肤色更加均匀透亮
   ```
3. 填写注意事项：
   ```
   - 护理期间保持充足睡眠，多饮水
   - 避免使用刺激性护肤品
   - 做好防晒工作
   - 如有不适及时反馈
   ```
4. 保存

**数据库验证SQL**:

```sql
-- 验证文本字段
SELECT
    template_code,
    LENGTH(expected_effects) as effects_length,
    LENGTH(precautions) as precautions_length
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- effects_length > 0
-- precautions_length > 0

-- 查看内容
SELECT
    expected_effects,
    precautions
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';
```

**预期结果**:
- ✅ expected_effects字段正确保存
- ✅ precautions字段正确保存
- ✅ 文本内容完整

### 4.6 案例照片管理测试

#### 测试场景7：上传案例照片

**操作步骤**:
1. 编辑模板
2. 上传封面图：`/images/solutions/hydration_cover.jpg`
3. 上传案例照片：
   - 前后对比1: `/images/cases/case1_before.jpg`, `/images/cases/case1_after.jpg`
   - 前后对比2: `/images/cases/case2_before.jpg`, `/images/cases/case2_after.jpg`
4. 保存

**数据库验证SQL**:

```sql
-- 验证图片配置
SELECT
    template_code,
    cover_image,
    JSON_LENGTH(case_photos) as photo_count
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- cover_image: /images/solutions/hydration_cover.jpg
-- photo_count: 4

-- 查看案例照片
SELECT
    JSON_PRETTY(case_photos) as photos
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';
```

**预期结果**:
- ✅ cover_image字段正确保存
- ✅ case_photos JSON数组包含4个URL
- ✅ 图片路径格式正确

### 4.7 模板状态管理测试

#### 测试场景8：停用模板

**操作步骤**:
1. 点击模板的停用按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT template_code, status, updated_at
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- status: inactive
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status从'active'变为'inactive'
- ✅ updated_at自动更新

### 4.8 删除模板测试

#### 测试场景9：软删除模板

**前置条件**: 模板未被使用（usage_count = 0）

**操作步骤**:
1. 点击模板的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    template_code, status, is_deleted, updated_at
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1';

-- 预期结果：
-- is_deleted: 1

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM solution_templates
WHERE template_code = 'HYDRATION_BASIC_V1' AND is_deleted = 0;

-- 预期结果：
-- count: 0
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ 配置数据保留（用于审计）

---

## 五、统计功能测试

### 测试场景10：模板统计

**API**: `GET /api/solution-templates/stats`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(usage_count) as total_usage,
    AVG(estimated_price_min) as avg_min_price,
    AVG(estimated_price_max) as avg_max_price
FROM solution_templates
WHERE is_deleted = 0;

-- 统计各类别的模板数
SELECT
    category,
    COUNT(*) as count,
    SUM(usage_count) as total_usage
FROM solution_templates
WHERE is_deleted = 0
GROUP BY category
ORDER BY count DESC;
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试模板编码最大长度（50字符）
INSERT INTO solution_templates (template_code, template_name, category)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试模板',
    'hydration'
);

-- 预期：成功
```

### 6.2 必填字段测试

```sql
-- 测试缺少必填字段
INSERT INTO solution_templates (template_code) -- 缺少template_name和category
VALUES ('test');

-- 预期：失败，NOT NULL约束
```

### 6.3 枚举值测试

```sql
-- 测试非法category值
UPDATE solution_templates
SET category = 'invalid_category'
WHERE id = 1;

-- 预期：失败，枚举值约束
```

### 6.4 价格字段测试

```sql
-- 测试价格精度
UPDATE solution_templates
SET estimated_price_min = 1234.567  -- 3位小数
WHERE id = 1;

-- 预期：成功，但会四舍五入到2位小数 (1234.57)

-- 验证
SELECT estimated_price_min FROM solution_templates WHERE id = 1;
-- 结果应为：1234.57
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试category索引
EXPLAIN SELECT * FROM solution_templates WHERE category = 'hydration';
-- 预期：type=ref, key=idx_category

-- 测试org_id索引
EXPLAIN SELECT * FROM solution_templates WHERE org_id = 7;
-- 预期：type=ref, key=idx_org_id

-- 测试唯一索引
EXPLAIN SELECT * FROM solution_templates
WHERE org_id = 7 AND template_code = 'TEST_001';
-- 预期：type=const, key=uk_org_code

-- 测试JSON字段查询
EXPLAIN SELECT * FROM solution_templates
WHERE JSON_CONTAINS(suitable_skin_types, '"干性"');
-- 验证JSON查询性能
```

---

## 八、数据完整性检查

### 8.1 孤儿记录检查

```sql
-- 检查无效的org_id
SELECT id, template_code, org_id
FROM solution_templates
WHERE org_id IS NOT NULL
  AND org_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0)
  AND is_deleted = 0;

-- 预期结果：0条记录
```

### 8.2 数据一致性检查

```sql
-- 检查唯一约束完整性
SELECT org_id, template_code, COUNT(*) as count
FROM solution_templates
WHERE is_deleted = 0
GROUP BY org_id, template_code
HAVING count > 1;

-- 预期结果：0条记录

-- 检查JSON字段完整性
SELECT
    id,
    template_code,
    CASE WHEN suitable_skin_types IS NULL OR JSON_VALID(suitable_skin_types) THEN '✅' ELSE '❌' END as skin_types_valid,
    CASE WHEN suitable_problems IS NULL OR JSON_VALID(suitable_problems) THEN '✅' ELSE '❌' END as problems_valid,
    CASE WHEN steps IS NULL OR JSON_VALID(steps) THEN '✅' ELSE '❌' END as steps_valid,
    CASE WHEN products IS NULL OR JSON_VALID(products) THEN '✅' ELSE '❌' END as products_valid,
    CASE WHEN services IS NULL OR JSON_VALID(services) THEN '✅' ELSE '❌' END as services_valid,
    CASE WHEN case_photos IS NULL OR JSON_VALID(case_photos) THEN '✅' ELSE '❌' END as photos_valid
FROM solution_templates
WHERE is_deleted = 0;

-- 预期：所有记录的JSON都应该有效

-- 检查价格逻辑
SELECT
    id,
    template_code,
    estimated_price_min,
    estimated_price_max,
    CASE
        WHEN estimated_price_min IS NOT NULL AND estimated_price_max IS NOT NULL
             AND estimated_price_min > estimated_price_max
        THEN '❌ 价格区间错误'
        ELSE '✅ 正常'
    END as price_check
FROM solution_templates
WHERE is_deleted = 0;

-- 预期：无价格区间错误
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 删除测试模板
DELETE FROM solution_templates
WHERE template_code LIKE 'TEST_%' OR template_code LIKE 'HYDRATION_BASIC_%';

-- 验证清理结果
SELECT COUNT(*) as remaining_test_templates
FROM solution_templates
WHERE template_code LIKE 'TEST_%' OR template_code LIKE 'HYDRATION_BASIC_%';

-- 预期结果：0
```

---

## 十、常见问题排查

### 问题1：创建模板失败

**排查SQL**:
```sql
-- 检查模板编码是否已存在
SELECT id, template_code, org_id, is_deleted
FROM solution_templates
WHERE template_code = 'xxx';

-- 检查category值是否合法
SELECT 'hydration' as category
UNION SELECT 'whitening'
UNION SELECT 'anti_aging'
UNION SELECT 'repair'
UNION SELECT 'hair_care'
UNION SELECT 'other';
```

### 问题2：JSON字段保存失败

**排查SQL**:
```sql
-- 检查JSON格式
SELECT
    id,
    template_code,
    JSON_VALID(steps) as steps_valid,
    steps
FROM solution_templates
WHERE id = xxx;

-- 检查JSON结构
SELECT
    JSON_EXTRACT(steps, '$[0].name') as step_name,
    JSON_EXTRACT(products, '$[0].product_name') as product_name
FROM solution_templates
WHERE id = xxx;
```

### 问题3：价格显示异常

**排查SQL**:
```sql
-- 检查价格字段
SELECT
    template_code,
    estimated_price_min,
    estimated_price_max,
    CAST(estimated_price_min AS DECIMAL(10,2)) as min_formatted,
    CAST(estimated_price_max AS DECIMAL(10,2)) as max_formatted
FROM solution_templates
WHERE id = xxx;
```

---

## 十一、测试检查清单

### 功能测试
- [ ] 创建各类别模板
- [ ] 模板编码重复校验
- [ ] 配置护理步骤
- [ ] 配置推荐产品
- [ ] 配置包含服务
- [ ] 配置适用肤质和问题
- [ ] 配置预期效果和注意事项
- [ ] 上传案例照片
- [ ] 停用模板
- [ ] 软删除模板
- [ ] 模板统计准确性

### 数据库测试
- [ ] solution_templates表记录正确插入
- [ ] 唯一约束生效（org_id + template_code）
- [ ] 索引使用正确
- [ ] JSON字段格式正确
- [ ] 价格字段类型正确（decimal(10,2)）
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新

### 业务逻辑测试
- [ ] 适用肤质配置
- [ ] 适用问题配置
- [ ] 护理步骤顺序
- [ ] 产品关联正确
- [ ] 服务关联正确
- [ ] 价格区间逻辑（min <= max）
- [ ] 图片URL保存

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验
- [ ] JSON格式校验
- [ ] 价格精度测试

### 性能测试
- [ ] 索引效率
- [ ] JSON查询性能
- [ ] 批量操作性能

---

## 十二、快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试模板
INSERT INTO solution_templates (
    template_code, template_name, category,
    scope, org_id, target_group,
    course_duration, treatment_frequency,
    estimated_price_min, estimated_price_max,
    created_by
)
VALUES (
    'AUTO_TEST_SOL_001',
    '自动测试方案模板',
    'hydration',
    'org',
    7,
    '25-40岁女性',
    '4周',
    '每周2次',
    1500.00,
    3000.00,
    1
);

SET @test_template_id = LAST_INSERT_ID();

-- 2. 配置适用条件
UPDATE solution_templates
SET suitable_skin_types = JSON_ARRAY('干性', '混合性'),
    suitable_problems = JSON_ARRAY('缺水', '干燥', '脱皮')
WHERE id = @test_template_id;

-- 3. 配置步骤
UPDATE solution_templates
SET steps = JSON_ARRAY(
    JSON_OBJECT(
        'step', 1,
        'name', '深层清洁',
        'description', '使用温和洁面乳清洁面部',
        'duration', '5分钟',
        'products', JSON_ARRAY('温和洁面乳'),
        'techniques', '打圈按摩'
    ),
    JSON_OBJECT(
        'step', 2,
        'name', '补水精华',
        'description', '涂抹玻尿酸精华液',
        'duration', '10分钟',
        'products', JSON_ARRAY('玻尿酸精华液'),
        'techniques', '轻拍至吸收'
    )
)
WHERE id = @test_template_id;

-- 4. 配置产品
UPDATE solution_templates
SET products = JSON_ARRAY(
    JSON_OBJECT(
        'product_name', '玻尿酸精华液',
        'quantity', '30ml',
        'usage', '每日早晚使用'
    ),
    JSON_OBJECT(
        'product_name', '补水面膜',
        'quantity', '5片/盒',
        'usage', '每周2-3次'
    )
)
WHERE id = @test_template_id;

-- 5. 验证创建
SELECT
    id,
    template_code,
    template_name,
    category,
    JSON_LENGTH(steps) as step_count,
    JSON_LENGTH(products) as product_count,
    estimated_price_min,
    estimated_price_max
FROM solution_templates
WHERE id = @test_template_id;

-- 6. 更新模板
UPDATE solution_templates
SET template_name = '自动测试方案模板-已修改',
    status = 'inactive'
WHERE id = @test_template_id;

-- 7. 验证更新
SELECT id, template_name, status
FROM solution_templates
WHERE id = @test_template_id;

-- 8. 清理测试数据
DELETE FROM solution_templates WHERE id = @test_template_id;
```

---

## 十三、监控查询

```sql
-- 实时监控模板变化
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_templates
FROM solution_templates
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND is_deleted = 0
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计模板使用情况
SELECT
    t.template_code,
    t.template_name,
    t.category,
    t.usage_count,
    t.estimated_price_min,
    t.estimated_price_max,
    JSON_LENGTH(t.steps) as step_count,
    JSON_LENGTH(t.products) as product_count,
    t.status
FROM solution_templates t
WHERE t.is_deleted = 0
ORDER BY t.usage_count DESC
LIMIT 20;

-- 统计各类别模板分布
SELECT
    category,
    COUNT(*) as template_count,
    SUM(usage_count) as total_usage,
    AVG(estimated_price_min) as avg_min_price,
    AVG(estimated_price_max) as avg_max_price
FROM solution_templates
WHERE is_deleted = 0
GROUP BY category
ORDER BY template_count DESC;

-- 统计肤质适用分布
SELECT
    jt.skin_type,
    COUNT(DISTINCT t.id) as template_count
FROM solution_templates t,
     JSON_TABLE(
         t.suitable_skin_types,
         '$[*]' COLUMNS (
             skin_type VARCHAR(50) PATH '$'
         )
     ) AS jt
WHERE t.is_deleted = 0
GROUP BY jt.skin_type
ORDER BY template_count DESC;
```

---

## 附录A：方案类别应用指南

| 类别 | 典型方案 | 适用人群 | 参考价格 |
|------|---------|---------|---------|
| 补水保湿 | 深层补水护理 | 干燥缺水肌肤 | 1500-3000元 |
| 美白提亮 | 美白淡斑方案 | 暗沉色斑肌肤 | 2000-5000元 |
| 抗衰老 | 紧致抗衰方案 | 皱纹松弛肌肤 | 3000-8000元 |
| 修复舒缓 | 敏感肌修复方案 | 敏感受损肌肤 | 1800-4000元 |
| 头发护理 | 头皮养护方案 | 脱发头屑问题 | 1000-3000元 |

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
