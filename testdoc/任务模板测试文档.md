# 任务模板功能测试文档

## 文档信息
- **模块名称**: 任务模板管理
- **页面路径**: /task-templates.html
- **API路由**: /api/task-templates
- **测试目的**: 验证任务模板的创建、字段配置、步骤定义等功能的数据库操作正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

任务模板管理模块负责定义标准化的工作任务流程，支持不同业务场景创建个性化的任务执行模板。

### 核心功能
1. 模板信息管理（CRUD）
2. 任务字段配置（动态字段定义）
3. 任务步骤定义（执行流程）
4. 模板共享范围控制（global/org/private）
5. 优先级和时长设置
6. 提醒配置管理
7. 模板统计分析

---

## 二、数据库表结构

### 2.1 主表：task_templates

```sql
CREATE TABLE `task_templates` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `template_code` varchar(50) NOT NULL COMMENT '模板编码',
  `template_name` varchar(100) NOT NULL COMMENT '模板名称',
  `description` text COMMENT '模板描述',
  `org_id` bigint unsigned DEFAULT NULL COMMENT '所属机构ID（NULL表示全局模板）',
  `scope` enum('global','org','private') NOT NULL DEFAULT 'org' COMMENT '共享范围',
  `apply_scene` varchar(100) DEFAULT NULL COMMENT '适用场景',
  `fields` json DEFAULT NULL COMMENT '任务字段定义（JSON数组）',
  `category` enum('customer_follow_up','service_process','quality_check','inventory','training','other') NOT NULL DEFAULT 'other' COMMENT '任务类别',
  `priority` enum('low','medium','high','urgent') NOT NULL DEFAULT 'medium' COMMENT '优先级',
  `estimated_duration` int DEFAULT NULL COMMENT '预计时长（分钟）',
  `assigned_role` varchar(50) DEFAULT NULL COMMENT '默认执行角色',
  `steps` json NOT NULL COMMENT '任务步骤定义（JSON数组）',
  `reminder_config` json DEFAULT NULL COMMENT '提醒配置（JSON对象）',
  `tags` json DEFAULT NULL COMMENT '标签（JSON数组）',
  `version` varchar(20) DEFAULT '1.0' COMMENT '模板版本号',
  `is_default` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否默认模板',
  `usage_count` int unsigned NOT NULL DEFAULT '0' COMMENT '使用次数',
  `status` enum('active','inactive','draft') NOT NULL DEFAULT 'active' COMMENT '状态',
  `sort_order` int DEFAULT '0' COMMENT '排序顺序',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` bigint unsigned DEFAULT NULL,
  `updated_by` bigint unsigned DEFAULT NULL,
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_org_code` (`org_id`,`template_code`),
  KEY `idx_org_id` (`org_id`),
  KEY `idx_category` (`category`),
  KEY `idx_scope` (`scope`),
  KEY `idx_status` (`status`),
  KEY `idx_priority` (`priority`)
) ENGINE=InnoDB COMMENT='任务模板表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| template_code | varchar(50) | 是 | 模板编码 | 唯一（同org_id内），不可修改 |
| template_name | varchar(100) | 是 | 模板名称 | 用于显示 |
| description | text | 否 | 模板描述 | 说明模板用途 |
| org_id | bigint | 否 | 组织ID | NULL表示全局模板 |
| scope | enum | 是 | 共享范围 | global/org/private，默认org |
| apply_scene | varchar(100) | 否 | 适用场景 | 如：新客接待、月度盘点等 |
| fields | json | 否 | 字段定义 | JSON数组，存储表单字段配置 |
| category | enum | 是 | 任务类别 | 必选项，默认other |
| priority | enum | 是 | 优先级 | low/medium/high/urgent，默认medium |
| estimated_duration | int | 否 | 预计时长 | 单位：分钟 |
| assigned_role | varchar(50) | 否 | 执行角色 | 默认分配的角色 |
| steps | json | 是 | 步骤定义 | JSON数组，NOT NULL |
| reminder_config | json | 否 | 提醒配置 | 提前提醒、逾期提醒等 |
| tags | json | 否 | 标签 | 便于分类和检索 |
| version | varchar(20) | 否 | 版本号 | 默认1.0 |
| is_default | tinyint(1) | 是 | 是否默认 | 0=否，1=是 |
| usage_count | int unsigned | 是 | 使用次数 | 默认0，统计用 |
| status | enum | 是 | 状态 | active/inactive/draft |
| sort_order | int | 否 | 排序 | 默认0 |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

**category字段说明**:

| 值 | 中文名称 | 适用场景 |
|----|---------|---------|
| customer_follow_up | 客户跟进 | 新客回访、VIP维护等 |
| service_process | 服务流程 | 护理服务、美容项目执行 |
| quality_check | 质量检查 | 服务质检、产品检查 |
| inventory | 库存管理 | 盘点、补货、清仓 |
| training | 培训任务 | 员工培训、技能考核 |
| other | 其他 | 其他类型任务 |

**priority字段说明**:

| 值 | 中文名称 | 处理时效 |
|----|---------|---------|
| low | 低优先级 | 可延后处理 |
| medium | 中优先级 | 正常处理 |
| high | 高优先级 | 优先处理 |
| urgent | 紧急 | 立即处理 |

**scope字段说明**:

| 值 | 含义 | 可见范围 | 典型应用 |
|----|------|---------|---------|
| global | 全局模板 | 所有组织可见可用 | 系统预置标准流程 |
| org | 组织模板 | 仅本组织可见可用 | 组织特色流程 |
| private | 私有模板 | 仅创建人可见可用 | 个人工作流程 |

### 2.2 fields字段JSON结构

```json
[
  {
    "field_key": "customer_feedback",
    "field_name": "客户反馈",
    "field_type": "textarea",
    "group": "服务记录",
    "required": true,
    "placeholder": "请记录客户的反馈意见",
    "display_order": 1
  },
  {
    "field_key": "service_rating",
    "field_name": "服务评分",
    "field_type": "select",
    "group": "服务记录",
    "required": true,
    "options": ["非常满意", "满意", "一般", "不满意"],
    "display_order": 2
  }
]
```

**字段属性说明**:

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| field_key | string | 是 | 字段键（英文） |
| field_name | string | 是 | 字段名称（中文） |
| field_type | string | 是 | 字段类型（text/select/textarea等） |
| group | string | 是 | 所属分组 |
| required | boolean | 否 | 是否必填 |
| options | array | 否 | 选项列表（select类型用） |
| placeholder | string | 否 | 提示文本 |
| display_order | number | 是 | 显示顺序 |

### 2.3 steps字段JSON结构

```json
[
  {
    "step": 1,
    "name": "准备工作",
    "description": "检查设备、准备工具、确认客户信息",
    "estimated_duration": 10,
    "required_fields": ["customer_id", "service_type"],
    "checklist": [
      "设备正常运行",
      "工具消毒完成",
      "客户档案已查看"
    ]
  },
  {
    "step": 2,
    "name": "执行服务",
    "description": "按照标准流程执行服务项目",
    "estimated_duration": 60,
    "required_fields": ["service_record"],
    "checklist": [
      "按标准操作流程执行",
      "注意客户反应",
      "记录服务过程"
    ]
  }
]
```

**步骤属性说明**:

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| step | number | 是 | 步骤序号 |
| name | string | 是 | 步骤名称 |
| description | string | 是 | 步骤描述 |
| estimated_duration | number | 否 | 预计时长（分钟） |
| required_fields | array | 否 | 必填字段列表 |
| checklist | array | 否 | 检查清单 |

### 2.4 reminder_config字段JSON结构

```json
{
  "before_start": {
    "enabled": true,
    "minutes": 30,
    "message": "任务将在30分钟后开始"
  },
  "after_deadline": {
    "enabled": true,
    "hours": 2,
    "message": "任务已逾期2小时"
  }
}
```

---

## 三、业务流程

### 3.1 创建任务模板流程

```
开始
  ↓
前端：填写模板基本信息
  ↓
API: POST /api/task-templates
  ↓
验证：模板编码唯一性（同org_id内）
  ↓
验证：必填字段（template_code, template_name, steps）
  ↓
插入：task_templates 表
  ↓
获取：新模板ID
  ↓
返回：成功
  ↓
结束
```

### 3.2 配置任务字段流程

```
开始
  ↓
API: GET /api/task-templates/:id
  ↓
获取：当前模板和字段配置
  ↓
前端：添加/编辑/删除字段
  ↓
API: PUT /api/task-templates/:id
Body: { fields: [...], steps: [...] }  -- ⚠️ 必须包含steps
  ↓
更新：fields 和 steps JSON字段
  ↓
返回：成功
  ↓
结束
```

### 3.3 应用模板创建任务流程

```
开始
  ↓
选择：任务模板
  ↓
API: GET /api/task-templates/:id
  ↓
渲染：动态表单（基于fields配置）
  ↓
渲染：步骤列表（基于steps配置）
  ↓
用户：填写任务信息
  ↓
API: POST /api/tasks
Body: { template_id, task_data: {...} }
  ↓
创建：任务记录
  ↓
更新：模板usage_count + 1
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建模板测试

#### 测试场景1：创建客户跟进任务模板

**前置条件**:
- 已登录系统
- 有模板管理权限

**操作步骤**:
1. 访问 http://8.210.246.101:5002/task-templates.html
2. 点击"创建模板"按钮
3. 填写信息：
   - 模板编码：`FOLLOW_UP_001`
   - 模板名称：`客户跟进标准流程`
   - 描述：`新客7天内跟进标准流程`
   - 任务类别：`客户跟进(customer_follow_up)`
   - 共享范围：`组织模板(org)`
   - 优先级：`高优先级(high)`
   - 预计时长：`30分钟`
   - 状态：`启用`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证模板创建
SELECT
    id, template_code, template_name, description,
    category, priority, estimated_duration,
    scope, org_id, status, is_deleted
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- template_code: FOLLOW_UP_001
-- template_name: 客户跟进标准流程
-- category: customer_follow_up
-- priority: high
-- estimated_duration: 30
-- scope: org
-- status: active
-- is_deleted: 0

-- 2. 验证steps字段（NOT NULL）
SELECT
    template_code,
    JSON_LENGTH(steps) as steps_count,
    JSON_VALID(steps) as steps_valid,
    steps
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- steps_count: 0 或更多（新建时为空数组[]）
-- steps_valid: 1 (有效JSON)
-- steps: [] 或具体步骤数组

-- 3. 验证category字段（NOT NULL，有默认值）
SELECT
    template_code,
    category,
    CASE
        WHEN category IN ('customer_follow_up', 'service_process', 'quality_check', 'inventory', 'training', 'other')
        THEN '✅ 有效枚举值'
        ELSE '❌ 无效枚举值'
    END as category_check
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- category: customer_follow_up
-- category_check: ✅ 有效枚举值
```

**预期结果**:
- ✅ task_templates表新增1条记录
- ✅ template_code唯一（同org_id内）
- ✅ category正确设置为'customer_follow_up'
- ✅ steps字段为空数组[]（NOT NULL约束满足）
- ✅ priority为'high'
- ✅ status默认为'active'
- ✅ is_deleted默认为0

#### 测试场景2：模板编码重复校验

**操作步骤**:
1. 创建模板：`FOLLOW_UP_001`（与已存在模板代码重复，且同org_id）
2. 保存

**数据库验证SQL**:

```sql
-- 验证唯一约束
SELECT COUNT(*) as count
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001'
  AND org_id = 7
  AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"模板编码已存在"
- ✅ 数据库无新增记录

### 4.2 字段配置测试

#### 测试场景3：添加任务字段

**前置条件**: 模板FOLLOW_UP_001已存在

**操作步骤**:
1. 编辑模板FOLLOW_UP_001
2. 点击"配置字段"
3. 添加字段：
   - 字段键: `contact_method`
   - 字段名称: `联系方式`
   - 字段类型: `单选下拉(select)`
   - 分组: `跟进信息`
   - 选项: `电话,微信,短信,上门`
   - 必填: ✓
   - 显示顺序: 1
4. 保存

**数据库验证SQL**:

```sql
-- 验证字段添加
SELECT
    template_code,
    JSON_LENGTH(fields) as field_count,
    JSON_EXTRACT(fields, '$[0].field_name') as first_field_name,
    JSON_EXTRACT(fields, '$[0].field_type') as first_field_type
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- field_count: 1
-- first_field_name: "联系方式"
-- first_field_type: "select"

-- 验证steps字段未被清空（重要！）
SELECT
    template_code,
    JSON_LENGTH(steps) as steps_count,
    CASE
        WHEN steps IS NULL THEN '❌ NULL值错误'
        WHEN JSON_VALID(steps) = 0 THEN '❌ 无效JSON'
        ELSE '✅ 正常'
    END as steps_check
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- steps_check: ✅ 正常
-- steps字段不应为NULL，应保持原值或为空数组[]
```

**预期结果**:
- ✅ fields JSON数组新增1个元素
- ✅ 字段属性完整（field_key, field_name, options等）
- ✅ steps字段未被清空（保持原值）
- ✅ category字段未被清空（保持原值）

### 4.3 步骤配置测试

#### 测试场景4：配置任务步骤

**前置条件**: 模板FOLLOW_UP_001已存在

**操作步骤**:
1. 编辑模板FOLLOW_UP_001
2. 点击"配置步骤"
3. 添加步骤：

   **步骤1**:
   - 步骤序号: 1
   - 步骤名称: `确认客户信息`
   - 步骤描述: `核对客户姓名、电话、上次服务时间`
   - 预计时长: `5分钟`
   - 检查清单: `客户档案已查看,联系方式有效`

   **步骤2**:
   - 步骤序号: 2
   - 步骤名称: `电话沟通`
   - 步骤描述: `询问客户满意度，了解需求`
   - 预计时长: `15分钟`
   - 检查清单: `记录客户反馈,预约下次服务`

   **步骤3**:
   - 步骤序号: 3
   - 步骤名称: `记录跟进结果`
   - 步骤描述: `在系统中记录本次跟进情况`
   - 预计时长: `10分钟`
   - 检查清单: `跟进结果已记录,下次跟进时间已设置`

4. 保存

**数据库验证SQL**:

```sql
-- 验证步骤配置
SELECT
    template_code,
    JSON_LENGTH(steps) as step_count,
    JSON_EXTRACT(steps, '$[0].name') as first_step_name,
    JSON_EXTRACT(steps, '$[0].estimated_duration') as first_step_duration
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- step_count: 3
-- first_step_name: "确认客户信息"
-- first_step_duration: 5

-- 验证完整步骤结构
SELECT
    JSON_PRETTY(steps) as steps_detail
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期包含：step, name, description, estimated_duration, checklist

-- 验证总预计时长
SELECT
    template_code,
    estimated_duration as template_duration,
    (
        SELECT SUM(CAST(JSON_EXTRACT(value, '$.estimated_duration') AS UNSIGNED))
        FROM JSON_TABLE(
            steps,
            '$[*]' COLUMNS (
                value JSON PATH '$'
            )
        ) AS jt
    ) as steps_total_duration
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- template_duration: 30
-- steps_total_duration: 30 (5+15+10)
```

**预期结果**:
- ✅ steps JSON数组包含3个元素
- ✅ 每个步骤属性完整
- ✅ 步骤顺序正确
- ✅ 总时长匹配

### 4.4 优先级和分类测试

#### 测试场景5：创建不同类别的模板

**操作步骤**:
创建以下6个模板，覆盖所有category值：

1. 服务流程模板：`SERVICE_PROC_001` (category: service_process)
2. 质量检查模板：`QC_CHECK_001` (category: quality_check)
3. 库存盘点模板：`INVENTORY_001` (category: inventory)
4. 培训任务模板：`TRAINING_001` (category: training)
5. 其他任务模板：`OTHER_TASK_001` (category: other)

**数据库验证SQL**:

```sql
-- 验证所有类别都有模板
SELECT
    category,
    COUNT(*) as template_count,
    GROUP_CONCAT(template_code SEPARATOR ', ') as templates
FROM task_templates
WHERE is_deleted = 0
GROUP BY category
ORDER BY category;

-- 预期结果：
-- customer_follow_up: 1 (FOLLOW_UP_001)
-- service_process: 1 (SERVICE_PROC_001)
-- quality_check: 1 (QC_CHECK_001)
-- inventory: 1 (INVENTORY_001)
-- training: 1 (TRAINING_001)
-- other: 1 (OTHER_TASK_001)
```

**预期结果**:
- ✅ 所有6种category都能正常创建模板
- ✅ category枚举值正确保存

#### 测试场景6：优先级设置

**操作步骤**:
为同一模板测试不同优先级：

1. 创建模板，优先级：低(low)
2. 更新为：中(medium)
3. 更新为：高(high)
4. 更新为：紧急(urgent)

**数据库验证SQL**:

```sql
-- 验证优先级变更
SELECT
    id,
    template_code,
    priority,
    updated_at
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001'
ORDER BY updated_at DESC;

-- 预期最终结果：
-- priority: urgent
```

**预期结果**:
- ✅ 所有4种priority都能正常保存
- ✅ updated_at自动更新

### 4.5 提醒配置测试

#### 测试场景7：配置任务提醒

**操作步骤**:
1. 编辑模板
2. 配置提醒：
   - 开始前提醒：启用，提前30分钟
   - 逾期提醒：启用，逾期2小时后
3. 保存

**数据库验证SQL**:

```sql
-- 验证提醒配置
SELECT
    template_code,
    JSON_PRETTY(reminder_config) as reminder_detail
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果示例：
-- {
--   "before_start": {
--     "enabled": true,
--     "minutes": 30,
--     "message": "任务将在30分钟后开始"
--   },
--   "after_deadline": {
--     "enabled": true,
--     "hours": 2,
--     "message": "任务已逾期2小时"
--   }
-- }
```

**预期结果**:
- ✅ reminder_config JSON正确保存
- ✅ 提醒时间参数正确

### 4.6 模板状态管理测试

#### 测试场景8：停用模板

**操作步骤**:
1. 点击模板的停用按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT template_code, status, updated_at
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- status: inactive
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status从'active'变为'inactive'
- ✅ updated_at自动更新
- ✅ 模板不再出现在可选列表中

### 4.7 删除模板测试

#### 测试场景9：软删除模板

**前置条件**: 模板未被使用（usage_count = 0）

**操作步骤**:
1. 点击模板的删除按钮
2. 确认操作

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    template_code, status, is_deleted, updated_at
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001';

-- 预期结果：
-- is_deleted: 1

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM task_templates
WHERE template_code = 'FOLLOW_UP_001' AND is_deleted = 0;

-- 预期结果：
-- count: 0
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ 字段和步骤配置保留（用于审计）

### 4.8 模板复制测试

#### 测试场景10：复制任务模板

**操作步骤**:
1. 选择模板FOLLOW_UP_001
2. 点击"复制"按钮
3. 输入新名称：`客户跟进流程-副本`
4. 输入新编码：`FOLLOW_UP_001_COPY`
5. 确认

**数据库验证SQL**:

```sql
-- 验证副本创建
SELECT
    id,
    template_code,
    template_name,
    category,
    JSON_LENGTH(steps) as steps_count,
    JSON_LENGTH(fields) as fields_count,
    is_default,
    status
FROM task_templates
WHERE template_code IN ('FOLLOW_UP_001', 'FOLLOW_UP_001_COPY')
ORDER BY id;

-- 预期结果：
-- FOLLOW_UP_001: steps_count和fields_count > 0, is_default可能为1, status=active
-- FOLLOW_UP_001_COPY: steps_count和fields_count相同, is_default=0, status=draft

-- 验证steps内容完全一致
SELECT
    t1.template_code as original,
    t2.template_code as copy,
    CASE
        WHEN t1.steps = t2.steps THEN '✅ 步骤一致'
        ELSE '❌ 步骤不一致'
    END as steps_check
FROM task_templates t1
JOIN task_templates t2 ON t1.template_code = 'FOLLOW_UP_001' AND t2.template_code = 'FOLLOW_UP_001_COPY';
```

**预期结果**:
- ✅ 创建新模板记录
- ✅ steps、fields等JSON字段内容完全复制
- ✅ 副本is_default=0（不是默认模板）
- ✅ 副本status='draft'（草稿状态）

---

## 五、统计功能测试

### 测试场景11：模板统计

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(CASE WHEN status = 'draft' THEN 1 ELSE 0 END) as draft_count,
    SUM(usage_count) as total_usage,
    AVG(estimated_duration) as avg_duration
FROM task_templates
WHERE is_deleted = 0;

-- 统计各类别的模板数
SELECT
    category,
    COUNT(*) as count,
    SUM(usage_count) as total_usage,
    AVG(estimated_duration) as avg_duration
FROM task_templates
WHERE is_deleted = 0
GROUP BY category
ORDER BY count DESC;

-- 统计各优先级的模板数
SELECT
    priority,
    COUNT(*) as count
FROM task_templates
WHERE is_deleted = 0
GROUP BY priority
ORDER BY FIELD(priority, 'urgent', 'high', 'medium', 'low');
```

**预期结果**:
- ✅ 统计数据准确
- ✅ 各维度分组正确

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试模板编码最大长度（50字符）
INSERT INTO task_templates (template_code, template_name, category, steps)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试模板',
    'other',
    '[]'
);

-- 预期：成功
```

### 6.2 必填字段测试

```sql
-- 测试缺少必填字段（steps）
INSERT INTO task_templates (template_code, template_name, category)
VALUES ('TEST_001', '测试模板', 'other');
-- 预期：失败，steps是NOT NULL

-- 测试steps为NULL
INSERT INTO task_templates (template_code, template_name, category, steps)
VALUES ('TEST_002', '测试模板', 'other', NULL);
-- 预期：失败，Column 'steps' cannot be null
```

### 6.3 枚举值测试

```sql
-- 测试非法category值
UPDATE task_templates
SET category = 'invalid_category'
WHERE id = 1;
-- 预期：失败，枚举值约束

-- 测试非法priority值
UPDATE task_templates
SET priority = 'super_urgent'
WHERE id = 1;
-- 预期：失败，枚举值约束

-- 测试非法status值
UPDATE task_templates
SET status = 'archived'
WHERE id = 1;
-- 预期：失败，枚举值约束
```

### 6.4 JSON字段有效性测试

```sql
-- 测试无效JSON
UPDATE task_templates
SET steps = 'invalid json'
WHERE id = 1;
-- 预期：失败，JSON格式错误

-- 测试空JSON数组
UPDATE task_templates
SET steps = '[]'
WHERE id = 1;
-- 预期：成功，空数组是有效的

-- 测试NULL值
UPDATE task_templates
SET steps = NULL
WHERE id = 1;
-- 预期：失败，NOT NULL约束
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试category索引
EXPLAIN SELECT * FROM task_templates WHERE category = 'customer_follow_up';
-- 预期：type=ref, key=idx_category

-- 测试org_id索引
EXPLAIN SELECT * FROM task_templates WHERE org_id = 7;
-- 预期：type=ref, key=idx_org_id

-- 测试唯一索引
EXPLAIN SELECT * FROM task_templates
WHERE org_id = 7 AND template_code = 'FOLLOW_UP_001';
-- 预期：type=const, key=uk_org_code

-- 测试priority索引
EXPLAIN SELECT * FROM task_templates WHERE priority = 'urgent';
-- 预期：type=ref, key=idx_priority

-- 测试JSON字段查询
EXPLAIN SELECT * FROM task_templates
WHERE JSON_CONTAINS(tags, '"紧急"');
-- 验证JSON查询性能
```

---

## 八、数据完整性检查

### 8.1 孤儿记录检查

```sql
-- 检查无效的org_id
SELECT id, template_code, org_id
FROM task_templates
WHERE org_id IS NOT NULL
  AND org_id NOT IN (SELECT id FROM organizations WHERE is_deleted = 0)
  AND is_deleted = 0;

-- 预期结果：0条记录
```

### 8.2 数据一致性检查

```sql
-- 检查唯一约束完整性
SELECT org_id, template_code, COUNT(*) as count
FROM task_templates
WHERE is_deleted = 0
GROUP BY org_id, template_code
HAVING count > 1;

-- 预期结果：0条记录

-- 检查JSON字段完整性
SELECT
    id,
    template_code,
    CASE WHEN steps IS NULL THEN '❌ NULL' WHEN JSON_VALID(steps) THEN '✅' ELSE '❌' END as steps_valid,
    CASE WHEN fields IS NULL OR JSON_VALID(fields) THEN '✅' ELSE '❌' END as fields_valid,
    CASE WHEN reminder_config IS NULL OR JSON_VALID(reminder_config) THEN '✅' ELSE '❌' END as reminder_valid,
    CASE WHEN tags IS NULL OR JSON_VALID(tags) THEN '✅' ELSE '❌' END as tags_valid
FROM task_templates
WHERE is_deleted = 0;

-- 预期：所有记录的JSON都应该有效，steps不应为NULL

-- 检查category和priority是否为有效枚举值
SELECT
    id,
    template_code,
    category,
    priority,
    CASE
        WHEN category IN ('customer_follow_up', 'service_process', 'quality_check', 'inventory', 'training', 'other')
        THEN '✅'
        ELSE '❌'
    END as category_valid,
    CASE
        WHEN priority IN ('low', 'medium', 'high', 'urgent')
        THEN '✅'
        ELSE '❌'
    END as priority_valid
FROM task_templates
WHERE is_deleted = 0;
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 删除测试模板
DELETE FROM task_templates
WHERE template_code LIKE 'TEST_%'
   OR template_code LIKE 'FOLLOW_UP_%'
   OR template_code LIKE '%_COPY';

-- 验证清理结果
SELECT COUNT(*) as remaining_test_templates
FROM task_templates
WHERE template_code LIKE 'TEST_%'
   OR template_code LIKE 'FOLLOW_UP_%'
   OR template_code LIKE '%_COPY';

-- 预期结果：0
```

---

## 十、常见问题排查

### 问题1：保存模板失败（500错误）

**现象**: 点击保存返回500错误

**可能原因1**: category字段为NULL
```sql
-- 检查category
SELECT id, template_code, category
FROM task_templates
WHERE id = xxx;

-- 如果category为NULL，说明是前端未传递或后端未设置默认值
```

**可能原因2**: steps字段为NULL
```sql
-- 检查steps
SELECT
    id,
    template_code,
    CASE
        WHEN steps IS NULL THEN '❌ NULL值'
        WHEN JSON_VALID(steps) = 0 THEN '❌ 无效JSON'
        WHEN steps = '[]' THEN '⚠️ 空数组'
        ELSE '✅ 正常'
    END as steps_status,
    steps
FROM task_templates
WHERE id = xxx;
```

**解决方案**:
1. 前端确保传递category和steps字段
2. 后端为category和steps提供默认值
3. 清除浏览器缓存后重试

### 问题2：JSON字段保存失败

**排查SQL**:
```sql
-- 检查JSON格式
SELECT
    id,
    template_code,
    JSON_VALID(steps) as steps_valid,
    JSON_VALID(fields) as fields_valid,
    steps,
    fields
FROM task_templates
WHERE id = xxx;

-- 检查JSON结构
SELECT
    JSON_EXTRACT(steps, '$[0].name') as step_name,
    JSON_EXTRACT(fields, '$[0].field_name') as field_name
FROM task_templates
WHERE id = xxx;
```

### 问题3：模板不显示

**排查SQL**:
```sql
-- 检查模板状态
SELECT
    template_code,
    status,
    is_deleted,
    scope,
    org_id
FROM task_templates
WHERE id = xxx;

-- 如果status='inactive'或is_deleted=1，则不显示
-- 如果scope='org'，检查org_id是否匹配当前用户组织
```

---

## 十一、已知BUG及修复记录

### BUG #1: category字段NULL错误（已修复）

**发现时间**: 2025-12-09 11:00

**错误信息**:
```
ER_BAD_NULL_ERROR, errno: 1048
sqlMessage: "Column 'category' cannot be null"
```

**根本原因**:
1. 数据库：category字段为NOT NULL enum
2. 前端：saveTemplate()未传递category字段
3. 后端：接收到undefined，尝试插入NULL

**修复方案**:
- 前端 task-templates.html line 1315: 添加 `category: currentTemplate && currentTemplate.category ? currentTemplate.category : 'other'`
- 后端 task-templates.js line 139 (POST): `category || 'other'`
- 后端 task-templates.js line 222 (PUT): `category || 'other'`

**部署时间**: 2025-12-09 11:05

### BUG #2: steps字段NULL错误（已修复）

**发现时间**: 2025-12-09 11:50

**错误信息**:
```
ER_BAD_NULL_ERROR, errno: 1048
sqlMessage: "Column 'steps' cannot be null"
```

**根本原因**:
1. 数据库：steps字段为NOT NULL json
2. 前端：配置字段界面保存时未传递steps字段
3. 后端：接收到undefined，尝试更新为NULL

**修复方案**:
- 前端 task-templates.html line 1319: 添加 `steps: currentTemplate && currentTemplate.steps ? currentTemplate.steps : []`
- 后端 task-templates.js line 143 (POST): `steps ? JSON.stringify(steps) : '[]'`
- 后端 task-templates.js line 226 (PUT): `steps ? JSON.stringify(steps) : '[]'`

**部署时间**: 2025-12-09 11:55

**重要提示**: 修复后需清除浏览器缓存

---

## 十二、测试检查清单

### 功能测试
- [ ] 创建各类别任务模板
- [ ] 模板编码重复校验
- [ ] 添加任务字段
- [ ] 配置任务步骤
- [ ] 设置优先级
- [ ] 配置提醒规则
- [ ] 停用模板
- [ ] 软删除模板
- [ ] 复制模板
- [ ] 模板统计准确性

### 数据库测试
- [ ] task_templates表记录正确插入
- [ ] 唯一约束生效（org_id + template_code）
- [ ] 索引使用正确
- [ ] JSON字段格式正确
- [ ] steps字段不为NULL（NOT NULL约束）
- [ ] category字段有效（NOT NULL，有默认值）
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新

### 业务逻辑测试
- [ ] 任务类别正确分类
- [ ] 优先级设置正确
- [ ] 步骤顺序正确
- [ ] 字段配置完整
- [ ] 提醒配置有效
- [ ] 使用次数正确累加

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验（steps必填）
- [ ] 枚举值校验（category, priority, status）
- [ ] JSON格式校验
- [ ] NULL值约束（steps不能为NULL）

### 性能测试
- [ ] 索引效率
- [ ] JSON查询性能
- [ ] 批量操作性能

---

## 十三、快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建测试模板
INSERT INTO task_templates (
    template_code, template_name, description,
    category, priority, scope, apply_scene,
    estimated_duration, assigned_role,
    steps, fields, created_by
)
VALUES (
    'AUTO_TEST_TASK_001',
    '自动测试任务模板',
    '用于自动化测试',
    'customer_follow_up',
    'high',
    'org',
    '新客跟进',
    30,
    'customer_service',
    '[]',  -- steps必须有值，不能为NULL
    NULL,  -- fields可以为NULL
    1
);

SET @test_template_id = LAST_INSERT_ID();

-- 2. 添加任务字段配置
UPDATE task_templates
SET fields = JSON_ARRAY(
    JSON_OBJECT(
        'field_key', 'test_field_1',
        'field_name', '测试字段1',
        'field_type', 'text',
        'group', '测试分组',
        'required', true,
        'display_order', 1
    )
)
WHERE id = @test_template_id;

-- 3. 添加任务步骤配置
UPDATE task_templates
SET steps = JSON_ARRAY(
    JSON_OBJECT(
        'step', 1,
        'name', '测试步骤1',
        'description', '测试步骤描述',
        'estimated_duration', 10,
        'checklist', JSON_ARRAY('检查项1', '检查项2')
    ),
    JSON_OBJECT(
        'step', 2,
        'name', '测试步骤2',
        'description', '测试步骤描述',
        'estimated_duration', 20,
        'checklist', JSON_ARRAY('检查项3', '检查项4')
    )
)
WHERE id = @test_template_id;

-- 4. 验证创建
SELECT
    id,
    template_code,
    template_name,
    category,
    priority,
    JSON_LENGTH(steps) as step_count,
    JSON_LENGTH(fields) as field_count,
    estimated_duration
FROM task_templates
WHERE id = @test_template_id;

-- 预期结果：
-- step_count: 2
-- field_count: 1
-- estimated_duration: 30

-- 5. 验证steps字段NOT NULL约束
SELECT
    id,
    CASE
        WHEN steps IS NULL THEN '❌ 错误：steps为NULL'
        WHEN JSON_VALID(steps) = 0 THEN '❌ 错误：steps不是有效JSON'
        WHEN JSON_LENGTH(steps) = 0 THEN '⚠️ 警告：steps为空数组'
        ELSE '✅ 正常'
    END as steps_check
FROM task_templates
WHERE id = @test_template_id;

-- 6. 更新模板（测试category和steps不被清空）
UPDATE task_templates
SET template_name = '自动测试任务模板-已修改',
    status = 'inactive'
WHERE id = @test_template_id;

-- 7. 验证更新后category和steps仍然存在
SELECT
    id,
    template_name,
    status,
    category,
    JSON_LENGTH(steps) as step_count
FROM task_templates
WHERE id = @test_template_id;

-- 预期结果：
-- status: inactive
-- category: customer_follow_up (未被清空)
-- step_count: 2 (未被清空)

-- 8. 清理测试数据
DELETE FROM task_templates WHERE id = @test_template_id;
```

---

## 十四、监控查询

```sql
-- 实时监控模板变化
SELECT
    DATE(created_at) as date,
    COUNT(*) as new_templates
FROM task_templates
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND is_deleted = 0
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 统计模板使用情况
SELECT
    t.template_code,
    t.template_name,
    t.category,
    t.priority,
    t.usage_count,
    t.estimated_duration,
    JSON_LENGTH(t.steps) as step_count,
    JSON_LENGTH(t.fields) as field_count,
    t.status
FROM task_templates t
WHERE t.is_deleted = 0
ORDER BY t.usage_count DESC
LIMIT 20;

-- 统计各类别模板分布
SELECT
    category,
    COUNT(*) as template_count,
    SUM(usage_count) as total_usage,
    AVG(estimated_duration) as avg_duration
FROM task_templates
WHERE is_deleted = 0
GROUP BY category
ORDER BY template_count DESC;

-- 统计优先级分布
SELECT
    priority,
    COUNT(*) as template_count,
    AVG(estimated_duration) as avg_duration
FROM task_templates
WHERE is_deleted = 0
GROUP BY priority
ORDER BY FIELD(priority, 'urgent', 'high', 'medium', 'low');

-- 检查steps字段完整性（监控NOT NULL约束）
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN steps IS NULL THEN 1 ELSE 0 END) as null_steps_count,
    SUM(CASE WHEN JSON_LENGTH(steps) = 0 THEN 1 ELSE 0 END) as empty_steps_count
FROM task_templates
WHERE is_deleted = 0;

-- 预期结果：
-- null_steps_count: 0 (不应该有NULL值)
-- empty_steps_count: 可以有（空数组是允许的）
```

---

## 附录A：任务类别应用指南

| 类别 | 典型任务 | 适用人员 | 参考时长 |
|------|---------|---------|---------|
| 客户跟进 | 新客回访、VIP维护 | 客服、顾问 | 15-30分钟 |
| 服务流程 | 护理服务、美容项目 | 美容师、技师 | 30-120分钟 |
| 质量检查 | 服务质检、产品检查 | 主管、质检员 | 15-45分钟 |
| 库存管理 | 盘点、补货、清仓 | 仓管、店长 | 30-120分钟 |
| 培训任务 | 员工培训、技能考核 | 培训师、主管 | 60-180分钟 |
| 其他 | 特殊任务 | 各岗位 | 不定 |

---

## 附录B：预置模板示例

### 客户跟进模板示例

```json
{
  "template_code": "STANDARD_FOLLOW_UP",
  "template_name": "标准客户跟进流程",
  "category": "customer_follow_up",
  "priority": "high",
  "estimated_duration": 30,
  "scope": "global",
  "steps": [
    {
      "step": 1,
      "name": "确认客户信息",
      "description": "核对客户姓名、电话、上次服务时间",
      "estimated_duration": 5,
      "checklist": ["客户档案已查看", "联系方式有效"]
    },
    {
      "step": 2,
      "name": "电话沟通",
      "description": "询问客户满意度，了解需求",
      "estimated_duration": 15,
      "checklist": ["记录客户反馈", "预约下次服务"]
    },
    {
      "step": 3,
      "name": "记录跟进结果",
      "description": "在系统中记录本次跟进情况",
      "estimated_duration": 10,
      "checklist": ["跟进结果已记录", "下次跟进时间已设置"]
    }
  ],
  "fields": [
    {
      "field_key": "contact_method",
      "field_name": "联系方式",
      "field_type": "select",
      "group": "跟进信息",
      "required": true,
      "options": ["电话", "微信", "短信", "上门"],
      "display_order": 1
    },
    {
      "field_key": "feedback",
      "field_name": "客户反馈",
      "field_type": "textarea",
      "group": "跟进信息",
      "required": true,
      "display_order": 2
    }
  ]
}
```

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
