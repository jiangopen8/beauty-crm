<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户详情 - 美业客户洞察 CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile-optimizations.css">
    <style>
        /* 移动端优化样式 */
        @media (max-width: 768px) {
            .mobile-hidden { display: none !important; }
            .mobile-full { width: 100% !important; }
            .mobile-p-2 { padding: 0.5rem !important; }
            .mobile-text-sm { font-size: 0.875rem !important; }
            .mobile-stack { flex-direction: column !important; }

            /* 确保表单卡片在移动端有适当的间距 */
            .form-card {
                padding: 1rem;
            }

            /* 订单卡片移动端优化 */
            .order-card {
                padding: 1rem;
            }

            /* 聊天气泡在移动端占更多宽度 */
            .chat-bubble {
                max-width: 85%;
            }

            /* AI画像模态框移动端优化 */
            #aiProfileModal > div {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }

            /* 任务筛选按钮移动端优化 */
            .task-filter-btn {
                white-space: nowrap;
                flex-shrink: 0;
            }
        }

        /* 标签页样式 */
        .tab-btn {
            position: relative;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .tab-btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }

            /* 隐藏桌面端的标签导航 */
            .tabs-container {
                display: none !important;
            }
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* 移动端底部导航 */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem 0;
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .mobile-bottom-nav {
                display: block;
            }

            /* 为底部导航留出空间 */
            main {
                padding-bottom: 80px !important;
            }
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            color: #9ca3af;
            transition: all 0.2s ease;
            text-decoration: none;
            cursor: pointer;
            border: none;
            background: none;
            flex: 1;
        }

        .mobile-nav-btn.active {
            color: #667eea;
        }

        .mobile-nav-btn i {
            margin-bottom: 0.25rem;
        }

        .mobile-nav-btn span {
            font-size: 0.65rem;
            font-weight: 500;
        }

        /* 表单卡片 */
        .form-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .form-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* AI分析卡片 */
        .ai-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* 方案卡片 */
        .plan-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .plan-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .plan-card.selected {
            border-color: #667eea;
            background: #f3f4f6;
        }

        @media (max-width: 768px) {
            .plan-card {
                padding: 0.875rem;
            }
        }

        /* 对话气泡 */
        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
        }

        .chat-bubble.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-bubble.ai {
            background: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
        }

        /* 侧边栏过渡 */
        .sidebar {
            transition: transform 0.3s ease;
        }

        .sidebar.closed {
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar.closed {
                transform: translateX(0);
            }
        }

        /* 标签页内容切换 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 加载动画 */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 分栏布局 */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
        }

        /* 诊断结果卡片 */
        .diagnosis-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            min-height: 200px;
        }

        /* 订单状态徽章 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #dbeafe; color: #1e40af; }
        .status-in-progress { background: #e0e7ff; color: #3730a3; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }

        /* 任务状态 */
        .task-pending { border-left: 4px solid #f59e0b; }
        .task-in_progress { border-left: 4px solid #3b82f6; }
        .task-completed { border-left: 4px solid #10b981; }
        .task-skipped { border-left: 4px solid #6b7280; }

        /* 标签页滚动 */
        .tabs-container {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .tabs-container::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 768px) {
            .tabs-container {
                padding-bottom: 0.25rem;
            }
        }

        /* 头像样式 */
        .customer-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }

        @media (max-width: 768px) {
            .customer-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        /* 诊断历史卡片 */
        .diagnosis-history-item {
            background: #f9fafb;
            border-left: 3px solid #667eea;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .diagnosis-history-item:hover {
            background: #f3f4f6;
            transform: translateX(4px);
        }

        @media (max-width: 768px) {
            .diagnosis-history-item {
                padding: 0.75rem;
            }
        }

        /* 订单卡片 */
        .order-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
        <div class="px-4 md:px-6 py-3 md:py-4">
            <div class="flex items-center justify-between">
                <!-- 左侧Logo和返回按钮 -->
                <div class="flex items-center space-x-3 md:space-x-4">
                    <button onclick="window.location.href='customers.html'" class="p-2 text-gray-600 hover:text-blue-600 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <i data-lucide="sparkles" class="w-6 h-6 md:w-8 md:h-8 text-purple-600"></i>
                        <h1 class="text-lg md:text-xl font-bold text-gray-900">美业洞察CRM</h1>
                    </div>
                </div>

                <!-- 右侧用户信息 -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <!-- 保存按钮 -->
                    <button onclick="saveCustomerData()" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>保存</span>
                    </button>

                    <!-- 通知铃铛 -->
                    <div class="relative">
                        <button class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- 用户菜单 -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition-colors">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-medium">李</span>
                            </div>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                                个人资料
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                系统设置
                            </a>
                            <hr class="my-2 border-gray-200">
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-14 md:pt-16">
        <!-- 主要内容区域 -->
        <main class="max-w-7xl mx-auto p-4 md:p-6">
            <!-- 客户基本信息头部 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 md:p-6 mb-6">
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6">
                    <!-- 头像 -->
                    <div class="customer-avatar" id="customerAvatar">陈</div>

                    <!-- 基本信息 -->
                    <div class="flex-1">
                        <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-2">
                            <h2 class="text-2xl font-bold text-gray-900" id="customerName">陈爱丽</h2>
                            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                <span class="badge badge-purple" id="customerVipLevel">金卡会员</span>
                                <span class="badge badge-green">活跃</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm text-gray-600">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                                <span id="customerPhone">13800138000</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>注册于 <span id="customerRegDate">2024-10-28</span></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                <span>最后联系 <span id="customerLastContact">2天前</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- 快速操作 -->
                    <div class="flex space-x-2 w-full md:w-auto">
                        <button onclick="generateAIProfile()" class="flex-1 md:flex-initial flex items-center justify-center space-x-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>AI画像</span>
                        </button>
                        <button onclick="saveCustomerData()" class="md:hidden flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i data-lucide="save" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 标签页导航 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="tabs-container flex border-b border-gray-200 px-4">
                    <button class="tab-btn active" onclick="switchTab('profile')">
                        <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                        客户资料
                    </button>
                    <button class="tab-btn" onclick="switchTab('diagnosis')">
                        <i data-lucide="activity" class="w-4 h-4 inline mr-1"></i>
                        诊断管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('plans')">
                        <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                        方案管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('orders')">
                        <i data-lucide="shopping-cart" class="w-4 h-4 inline mr-1"></i>
                        订单管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('tasks')">
                        <i data-lucide="check-square" class="w-4 h-4 inline mr-1"></i>
                        任务管理
                    </button>
                    <button class="tab-btn" onclick="switchTab('chat')">
                        <i data-lucide="message-circle" class="w-4 h-4 inline mr-1"></i>
                        AI对话
                    </button>
                </div>

                <!-- 标签页内容 -->
                <div class="p-4 md:p-6">
                    <!-- 客户资料标签页 -->
                    <div id="profileTab" class="tab-content active">
                        <div id="profileFormsContainer">
                            <!-- 使用 CustomerProfileModule 动态加载的表单 -->
                        </div>
                    </div>

                    <!-- 诊断管理标签页 -->
                    <div id="diagnosisTab" class="tab-content">
                        <div class="split-layout">
                            <!-- 左侧：身体组成分析数据录入 -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 mb-4">身体组成分析</h3>
                                <div class="form-card">
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">体重 (kg)</label>
                                                <input type="number" step="0.1" id="bodyWeight" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="65.0">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">体脂率 (%)</label>
                                                <input type="number" step="0.1" id="bodyFat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="28.5">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">肌肉量 (kg)</label>
                                                <input type="number" step="0.1" id="muscleMass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="45.0">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">BMI</label>
                                                <input type="number" step="0.1" id="bmi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="22.5">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">内脏脂肪等级</label>
                                                <input type="number" id="visceralFat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="8">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">基础代谢率</label>
                                                <input type="number" id="bmr" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="1350">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">测量备注</label>
                                            <textarea id="measurementNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="记录测量时的特殊情况..."></textarea>
                                        </div>
                                        <button onclick="submitBodyAnalysis()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                            提交并AI诊断
                                        </button>
                                    </div>
                                </div>

                                <!-- 诊断历史 -->
                                <div class="mt-6">
                                    <h3 class="text-lg font-bold text-gray-900 mb-4">诊断历史</h3>
                                    <div id="diagnosisHistoryContainer">
                                        <!-- 动态加载诊断历史 -->
                                    </div>
                                </div>
                            </div>

                            <!-- 右侧：AI诊断结果 -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 mb-4">AI诊断结果</h3>
                                <div class="diagnosis-card" id="diagnosisResultCard">
                                    <div class="flex items-center justify-center h-full text-gray-400">
                                        <div class="text-center">
                                            <i data-lucide="brain" class="w-16 h-16 mx-auto mb-3"></i>
                                            <p>提交数据后将显示AI诊断结果</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 方案管理标签页 -->
                    <div id="plansTab" class="tab-content">
                        <div class="split-layout">
                            <!-- 左侧：待选方案列表 -->
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">方案模板库</h3>
                                    <button onclick="refreshPlans()" class="text-sm text-purple-600 hover:text-purple-700">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i>
                                        刷新
                                    </button>
                                </div>
                                <div id="availablePlansContainer" class="space-y-3">
                                    <!-- 动态加载的方案列表 -->
                                </div>
                            </div>

                            <!-- 右侧：已分配方案 -->
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">已分配方案</h3>
                                    <button onclick="generateOrder()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm" id="generateOrderBtn" disabled>
                                        <i data-lucide="plus" class="w-4 h-4 inline"></i>
                                        生成订单
                                    </button>
                                </div>
                                <div id="assignedPlansContainer" class="space-y-3">
                                    <div class="text-center text-gray-400 py-8">
                                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                                        <p>暂无已分配方案</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 订单管理标签页 -->
                    <div id="ordersTab" class="tab-content">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">客户订单列表</h3>
                            <button onclick="createNewOrder()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                新建订单
                            </button>
                        </div>
                        <div id="ordersContainer">
                            <!-- 动态加载的订单列表 -->
                        </div>
                    </div>

                    <!-- 任务管理标签页 -->
                    <div id="tasksTab" class="tab-content">
                        <div class="mb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-3">客户任务列表</h3>
                            <div class="flex space-x-2 overflow-x-auto">
                                <button onclick="filterTasks('all')" class="task-filter-btn active px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium" data-status="all">
                                    全部
                                </button>
                                <button onclick="filterTasks('pending')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="pending">
                                    待执行
                                </button>
                                <button onclick="filterTasks('in_progress')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="in_progress">
                                    进行中
                                </button>
                                <button onclick="filterTasks('completed')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="completed">
                                    已完成
                                </button>
                                <button onclick="filterTasks('skipped')" class="task-filter-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm" data-status="skipped">
                                    已跳过
                                </button>
                            </div>
                        </div>
                        <div id="tasksContainer">
                            <!-- 动态加载的任务列表 -->
                        </div>
                    </div>

                    <!-- AI对话记录标签页 -->
                    <div id="chatTab" class="tab-content">
                        <div class="bg-white rounded-lg border border-gray-200 h-[600px] flex flex-col">
                            <!-- 对话头部 -->
                            <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">AI美容助手</h3>
                                        <p class="text-xs text-gray-500">24/7在线服务</p>
                                    </div>
                                </div>
                                <button onclick="clearChatHistory()" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <!-- 对话内容区 -->
                            <div id="chatMessagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                <!-- 动态加载的对话消息 -->
                            </div>

                            <!-- 输入区 -->
                            <div class="px-4 py-3 border-t border-gray-200">
                                <div class="flex space-x-2">
                                    <input type="text" id="chatInput" placeholder="输入消息..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onkeypress="handleChatKeyPress(event)">
                                    <button onclick="sendChatMessage()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI客户画像模态框 -->
    <div id="aiProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">AI客户画像分析</h3>
                    <button onclick="closeAIProfileModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="aiProfileContent" class="space-y-4">
                    <div class="flex items-center justify-center py-8">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script src="js/modules/customer-profile.js"></script>
    <script>
        // 全局变量
        let currentCustomer = null;
        let currentTab = 'profile';
        let selectedPlans = [];
        let allTasks = [];
        let currentTaskFilter = 'all';

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('===== 客户详情页面初始化 =====');
            console.log('URL:', window.location.href);
            console.log('URL参数:', window.location.search);

            lucide.createIcons();

            try {
                loadCustomerData();
            } catch (error) {
                console.error('加载客户数据时出错:', error);
                UIUtils.notify('加载失败: ' + error.message, 'error');
            }
        });

        // 加载客户数据
        function loadCustomerData() {
            const customerId = URLUtils.getParam('id');
            console.log('获取到的客户ID:', customerId);

            if (!customerId) {
                UIUtils.notify('未找到客户ID', 'error');
                setTimeout(() => window.location.href = 'customers.html', 1500);
                return;
            }

            // 直接从存储中获取所有客户（不经过 db.js 的过滤）
            const allCustomers = StorageManager.get('customers', []);
            console.log('所有客户列表:', allCustomers);
            console.log('客户数量:', allCustomers.length);

            // 直接查找客户
            currentCustomer = allCustomers.find(c => c.id === customerId);
            console.log('查找到的客户:', currentCustomer);

            if (!currentCustomer) {
                console.error('客户不存在,customerId:', customerId);
                console.error('可用的客户IDs:', allCustomers.map(c => c.id));
                UIUtils.notify('客户不存在', 'error');
                setTimeout(() => window.location.href = 'customers.html', 1500);
                return;
            }

            // 初始化客户数据结构
            if (!currentCustomer.data) {
                currentCustomer.data = {};
            }
            if (!currentCustomer.diagnosisHistory) {
                currentCustomer.diagnosisHistory = [];
            }
            if (!currentCustomer.chatHistory) {
                currentCustomer.chatHistory = [];
            }

            // 显示客户基本信息
            displayCustomerHeader();

            // 加载标签页内容
            loadProfileForms();
            loadDiagnosisHistory();
            loadAvailablePlans();
            loadOrders();
            loadTasks();
            loadChatHistory();
        }

        // 保存客户数据（替代 db.saveCustomer）
        function saveCurrentCustomer() {
            const allCustomers = StorageManager.get('customers', []);
            const index = allCustomers.findIndex(c => c.id === currentCustomer.id);
            if (index >= 0) {
                allCustomers[index] = currentCustomer;
                StorageManager.set('customers', allCustomers);
            }
        }

        // 显示客户头部信息
        function displayCustomerHeader() {
            document.getElementById('customerAvatar').textContent = currentCustomer.name.charAt(0);
            document.getElementById('customerName').textContent = currentCustomer.name;
            document.getElementById('customerPhone').textContent = currentCustomer.phone;
            document.getElementById('customerRegDate').textContent = DateUtils.format(new Date(currentCustomer.createdAt), 'YYYY-MM-DD');
            document.getElementById('customerLastContact').textContent = DateUtils.fromNow(currentCustomer.createdAt);

            // VIP等级
            const vipLevel = currentCustomer.data?.tpl_basic_info?.vip_level || '普通会员';
            document.getElementById('customerVipLevel').textContent = vipLevel;
        }

        // 初始化客户资料模块
        let profileModule = null;

        function loadProfileForms() {
            const container = document.getElementById('profileFormsContainer');

            // 创建并挂载 CustomerProfileModule
            profileModule = new CustomerProfileModule({
                customerId: currentCustomer.id
            });

            profileModule.mount(container);
        }

        // 保存客户数据（使用 CustomerProfileModule 的保存方法）
        function saveCustomerData() {
            if (profileModule && profileModule.saveProfile) {
                return profileModule.saveProfile();
            } else {
                UIUtils.notify('客户资料模块未初始化', 'error');
                return false;
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 更新桌面端标签按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target && event.target.closest('.tab-btn')) {
                event.target.closest('.tab-btn').classList.add('active');
            }

            // 更新移动端底部导航状态
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll(`.mobile-nav-btn[data-tab="${tabName}"]`).forEach(btn => {
                btn.classList.add('active');
            });

            // 更新标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            currentTab = tabName;
            lucide.createIcons();
        }

        // 提交身体分析数据并AI诊断
        function submitBodyAnalysis() {
            const data = {
                weight: parseFloat(document.getElementById('bodyWeight').value) || 0,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || 0,
                muscleMass: parseFloat(document.getElementById('muscleMass').value) || 0,
                bmi: parseFloat(document.getElementById('bmi').value) || 0,
                visceralFat: parseInt(document.getElementById('visceralFat').value) || 0,
                bmr: parseInt(document.getElementById('bmr').value) || 0,
                notes: document.getElementById('measurementNotes').value
            };

            // 验证必填字段
            if (!data.weight || !data.bodyFat) {
                UIUtils.notify('请填写体重和体脂率', 'warning');
                return;
            }

            // 显示加载状态
            const resultCard = document.getElementById('diagnosisResultCard');
            resultCard.innerHTML = '<div class="flex items-center justify-center h-full"><div class="loading-spinner"></div></div>';

            // 模拟AI诊断
            setTimeout(() => {
                const diagnosis = generateAIDiagnosis(data);

                // 保存诊断记录
                if (!currentCustomer.diagnosisHistory) {
                    currentCustomer.diagnosisHistory = [];
                }
                currentCustomer.diagnosisHistory.unshift({
                    ...data,
                    diagnosis: diagnosis,
                    timestamp: new Date().toISOString()
                });

                saveCurrentCustomer();

                displayDiagnosisResult(diagnosis);
                loadDiagnosisHistory();
                UIUtils.notify('AI诊断完成', 'success');
            }, 2000);
        }

        // 生成AI诊断结果(智能分析)
        function generateAIDiagnosis(data) {
            let overall = '';
            let bodyComposition = '';
            const recommendations = [];
            let riskLevel = 'low';

            // 分析体重和BMI
            if (data.bmi < 18.5) {
                overall = '体重偏轻';
                riskLevel = 'medium';
                recommendations.push('建议增加营养摄入,每日增加300-500卡路里');
                recommendations.push('进行适度力量训练,增加肌肉量');
            } else if (data.bmi >= 18.5 && data.bmi < 24) {
                overall = '体重正常';
                riskLevel = 'low';
            } else if (data.bmi >= 24 && data.bmi < 28) {
                overall = '体重偏高';
                riskLevel = 'medium';
                recommendations.push('建议控制每日热量摄入在1200-1500卡路里');
                recommendations.push('每周进行3-4次有氧运动,每次30-45分钟');
            } else {
                overall = '体重超标,需要重视';
                riskLevel = 'high';
                recommendations.push('强烈建议咨询专业营养师,制定减重计划');
                recommendations.push('每周进行4-5次有氧运动,每次45-60分钟');
            }

            // 分析体脂率
            const gender = currentCustomer.data?.tpl_basic_info?.gender || '女';
            const normalBodyFat = gender === '女' ? 25 : 20;

            if (data.bodyFat > normalBodyFat + 8) {
                overall += ',体脂率超标';
                riskLevel = riskLevel === 'low' ? 'medium' : 'high';
                bodyComposition = '体脂率明显偏高,需要通过有氧运动和饮食控制来降低体脂率';
                recommendations.push('增加有氧运动频率,如快走、游泳、骑行等');
                recommendations.push('减少高糖高脂食物摄入,增加蔬菜和优质蛋白');
            } else if (data.bodyFat > normalBodyFat + 3) {
                overall += ',体脂率偏高';
                bodyComposition = '体脂率略高于标准,建议通过运动和合理饮食来改善';
                recommendations.push('保持规律运动习惯,每周至少3次有氧运动');
            } else {
                bodyComposition = '体脂率在正常范围内,继续保持良好的生活习惯';
            }

            // 分析肌肉量
            if (data.muscleMass > 0) {
                const muscleMassRatio = (data.muscleMass / data.weight) * 100;
                if (muscleMassRatio < 30) {
                    bodyComposition += ',肌肉量偏低,建议增加力量训练';
                    recommendations.push('每周进行2-3次力量训练,提高肌肉量');
                    recommendations.push('增加蛋白质摄入,每日1.2-1.5克/公斤体重');
                }
            }

            // 分析内脏脂肪
            if (data.visceralFat >= 15) {
                riskLevel = 'high';
                recommendations.push('内脏脂肪等级偏高,存在健康风险,建议医学检查');
                recommendations.push('严格控制饮食,避免高油高糖食物');
            } else if (data.visceralFat >= 10) {
                riskLevel = riskLevel === 'low' ? 'medium' : riskLevel;
                recommendations.push('内脏脂肪需要注意,建议增加运动量');
            }

            // 分析基础代谢率
            if (data.bmr > 0) {
                bodyComposition += `。基础代谢率为${data.bmr}卡路里/天`;
            }

            // 通用建议
            recommendations.push('定期监测体重和体脂率变化,建议每周测量1-2次');
            recommendations.push('保证充足睡眠,每天7-8小时');
            recommendations.push('保持良好心态,避免压力过大影响代谢');

            return {
                overall,
                bodyComposition,
                recommendations: recommendations.slice(0, 6), // 最多6条建议
                riskLevel,
                timestamp: new Date().toISOString()
            };
        }

        // 显示诊断结果
        function displayDiagnosisResult(diagnosis) {
            const resultCard = document.getElementById('diagnosisResultCard');

            const riskColors = {
                low: { bg: 'green', text: '低风险' },
                medium: { bg: 'yellow', text: '中等风险' },
                high: { bg: 'red', text: '高风险' }
            };
            const risk = riskColors[diagnosis.riskLevel] || riskColors.low;

            resultCard.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-900">综合评估</h4>
                        <span class="px-3 py-1 bg-${risk.bg}-100 text-${risk.bg}-800 text-xs rounded-full">
                            ${risk.text}
                        </span>
                    </div>
                    <p class="text-gray-700 font-medium">${diagnosis.overall}</p>

                    <div>
                        <h5 class="font-semibold text-gray-900 mb-2">详细分析</h5>
                        <p class="text-sm text-gray-600">${diagnosis.bodyComposition}</p>
                    </div>

                    <div>
                        <h5 class="font-semibold text-gray-900 mb-2">改善建议</h5>
                        <ul class="space-y-2">
                            ${diagnosis.recommendations.map(rec => `
                                <li class="flex items-start space-x-2 text-sm text-gray-600">
                                    <i data-lucide="check" class="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"></i>
                                    <span>${rec}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <div class="text-xs text-gray-500 pt-3 border-t">
                        诊断时间: ${DateUtils.format(new Date(diagnosis.timestamp), 'YYYY-MM-DD HH:mm')}
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // 加载诊断历史
        function loadDiagnosisHistory() {
            const container = document.getElementById('diagnosisHistoryContainer');

            // 从客户数据中读取诊断信息
            const history = [];

            // 如果有 AI 诊断和身体组成数据,添加到历史记录
            if (currentCustomer.aiDiagnosis && currentCustomer.bodyComposition) {
                history.push({
                    timestamp: currentCustomer.aiDiagnosis.diagnosedAt,
                    weight: currentCustomer.bodyComposition.weight,
                    bodyFat: currentCustomer.bodyComposition.bodyFat,
                    bmi: currentCustomer.bodyComposition.bmi,
                    diagnosis: currentCustomer.aiDiagnosis
                });
            }

            // 如果有旧的诊断历史数据,也添加进来
            if (currentCustomer.diagnosisHistory && currentCustomer.diagnosisHistory.length > 0) {
                history.push(...currentCustomer.diagnosisHistory);
            }

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-4">
                        <p class="text-sm">暂无诊断历史</p>
                        <button onclick="runAIDiagnosis()" class="mt-2 text-purple-600 hover:text-purple-700 text-sm">
                            <i data-lucide="zap" class="w-4 h-4 inline mr-1"></i>
                            立即诊断
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = history.slice(0, 5).map((record, index) => `
                <div class="diagnosis-history-item" onclick="showDiagnosisRecord(${index})">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-900">
                            ${DateUtils.format(new Date(record.timestamp), 'YYYY-MM-DD HH:mm')}
                        </span>
                        <span class="text-xs px-2 py-0.5 rounded-full ${
                            record.diagnosis.riskLevel === 'low' ? 'bg-green-100 text-green-800' :
                            record.diagnosis.riskLevel === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${record.diagnosis.riskLevel === 'low' ? '低风险' :
                              record.diagnosis.riskLevel === 'medium' ? '中等' : '高风险'}
                        </span>
                    </div>
                    <div class="text-xs text-gray-600">
                        体重: ${record.weight}kg | 体脂率: ${record.bodyFat}% | BMI: ${record.bmi}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${record.diagnosis.healthStatus}
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // 显示历史诊断记录
        function showDiagnosisRecord(index) {
            const record = currentCustomer.diagnosisHistory[index];
            if (record) {
                // 填充表单数据
                document.getElementById('bodyWeight').value = record.weight;
                document.getElementById('bodyFat').value = record.bodyFat;
                document.getElementById('muscleMass').value = record.muscleMass;
                document.getElementById('bmi').value = record.bmi;
                document.getElementById('visceralFat').value = record.visceralFat;
                document.getElementById('bmr').value = record.bmr;
                document.getElementById('measurementNotes').value = record.notes || '';

                // 显示诊断结果
                displayDiagnosisResult(record.diagnosis);
            }
        }

        // 加载可用方案
        function loadAvailablePlans() {
            const container = document.getElementById('availablePlansContainer');
            const templates = db.getTemplatesByCategory(TemplateCategory.PLAN);

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无方案模板</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = templates.map(plan => `
                <div class="plan-card" onclick="togglePlanSelection('${plan.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${plan.name}</h4>
                            <p class="text-sm text-gray-600 mt-1">${plan.description}</p>
                        </div>
                        <div class="ml-4">
                            <input type="checkbox" id="plan_${plan.id}" class="w-5 h-5 text-purple-600 rounded pointer-events-none">
                        </div>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // 切换方案选择
        function togglePlanSelection(planId) {
            const checkbox = document.getElementById('plan_' + planId);
            checkbox.checked = !checkbox.checked;

            const card = checkbox.closest('.plan-card');
            if (checkbox.checked) {
                card.classList.add('selected');
                selectedPlans.push(planId);
            } else {
                card.classList.remove('selected');
                selectedPlans = selectedPlans.filter(id => id !== planId);
            }

            updateAssignedPlans();
        }

        // 更新已分配方案
        function updateAssignedPlans() {
            const container = document.getElementById('assignedPlansContainer');
            const generateBtn = document.getElementById('generateOrderBtn');

            if (selectedPlans.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无已分配方案</p>
                    </div>
                `;
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                container.innerHTML = selectedPlans.map(planId => {
                    const plan = db.getTemplateById(planId);
                    return `
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${plan.name}</h4>
                                    <p class="text-sm text-gray-600 mt-1">${plan.description}</p>
                                </div>
                                <button onclick="event.stopPropagation(); removePlan('${planId}')" class="text-red-600 hover:text-red-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            lucide.createIcons();
        }

        // 移除方案
        function removePlan(planId) {
            const checkbox = document.getElementById('plan_' + planId);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.plan-card').classList.remove('selected');
            }
            selectedPlans = selectedPlans.filter(id => id !== planId);
            updateAssignedPlans();
        }

        // 生成订单
        function generateOrder() {
            if (selectedPlans.length === 0) {
                UIUtils.notify('请先选择方案', 'warning');
                return;
            }

            // 创建订单项
            const items = selectedPlans.map(planId => {
                const plan = db.getTemplateById(planId);
                return {
                    planTemplateId: plan.id,
                    planTemplateName: plan.name,
                    quantity: 1,
                    unitPrice: 3500, // 默认价格
                    totalPrice: 3500
                };
            });

            const totalAmount = items.reduce((sum, item) => sum + item.totalPrice, 0);

            // 创建订单对象
            const order = {
                id: `order_${Date.now()}`,
                orgId: db.getCurrentOrgId(),
                customerId: currentCustomer.id,
                customerName: currentCustomer.name,
                orderNumber: `ORD${Date.now()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                items: items,
                totalAmount: totalAmount,
                discountAmount: 0,
                finalAmount: totalAmount,
                status: OrderStatus.PENDING,
                paymentMethod: '',
                paymentTime: null,
                notes: `从方案管理生成的订单`,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: 'admin'
            };

            // 保存订单
            db.saveOrder(order);

            UIUtils.notify('订单已创建', 'success');

            // 清空选择
            selectedPlans = [];
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('input[type="checkbox"]').checked = false;
            });
            updateAssignedPlans();

            // 切换到订单标签页
            switchTab('orders');
            loadOrders();
        }

        // 刷新方案
        function refreshPlans() {
            loadAvailablePlans();
            UIUtils.notify('方案列表已刷新', 'success');
        }

        // 加载订单
        function loadOrders() {
            const container = document.getElementById('ordersContainer');
            const orders = db.getOrdersByCustomerId(currentCustomer.id);

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                        <i data-lucide="shopping-cart" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无订单记录</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card" onclick="viewOrderDetail('${order.id}')">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <h4 class="font-semibold text-gray-900">订单 ${order.orderNumber}</h4>
                            <span class="status-badge status-${order.status}">${getOrderStatusText(order.status)}</span>
                        </div>
                        <span class="text-lg font-bold text-purple-600">${NumberUtils.formatMoney(order.finalAmount)}</span>
                    </div>
                    <div class="space-y-1 mb-3">
                        ${order.items.map(item => `
                            <div class="text-sm text-gray-600 flex items-center justify-between">
                                <span>${item.planTemplateName}</span>
                                <span class="text-xs">× ${item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="pt-3 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
                        <span>创建时间: ${DateUtils.format(new Date(order.createdAt), 'YYYY-MM-DD HH:mm')}</span>
                        <span class="text-purple-600 hover:text-purple-700 font-medium">
                            查看详情 →
                        </span>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // 获取订单状态文本
        function getOrderStatusText(status) {
            const statusMap = {
                pending: '待支付',
                paid: '已支付',
                in_progress: '进行中',
                completed: '已完成',
                cancelled: '已取消'
            };
            return statusMap[status] || status;
        }

        // 查看订单详情
        function viewOrderDetail(orderId) {
            UIUtils.notify('订单详情页面开发中...', 'info');
            // TODO: 跳转到订单详情页面
            // window.location.href = `order-detail.html?id=${orderId}`;
        }

        // 创建新订单
        function createNewOrder() {
            // 切换到方案管理标签页
            switchTab('plans');
            UIUtils.notify('请在方案管理中选择方案后生成订单', 'info');
        }

        // 加载任务
        function loadTasks() {
            allTasks = db.getTasksByCustomerId(currentCustomer.id);
            renderTasks();
        }

        // 渲染任务列表
        function renderTasks() {
            const container = document.getElementById('tasksContainer');

            // 根据筛选条件过滤任务
            let filteredTasks = allTasks;
            if (currentTaskFilter !== 'all') {
                filteredTasks = allTasks.filter(t => t.status === currentTaskFilter);
            }

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8 bg-white rounded-lg border border-gray-200">
                        <i data-lucide="check-square" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无任务记录</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // 按状态分组
            const groupedTasks = {};
            filteredTasks.forEach(task => {
                if (!groupedTasks[task.status]) {
                    groupedTasks[task.status] = [];
                }
                groupedTasks[task.status].push(task);
            });

            let html = '';
            Object.keys(groupedTasks).forEach(status => {
                html += `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">${getTaskStatusText(status)} (${groupedTasks[status].length})</h4>
                        <div class="space-y-2">
                            ${groupedTasks[status].map(task => `
                                <div class="bg-white border-l-4 task-${task.status} rounded-lg p-4 border border-gray-200">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h5 class="font-semibold text-gray-900">${task.title}</h5>
                                            <p class="text-sm text-gray-600 mt-1">${task.description}</p>
                                            <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                                <span><i data-lucide="calendar" class="w-3 h-3 inline"></i> ${task.scheduledDate}</span>
                                                <span><i data-lucide="clock" class="w-3 h-3 inline"></i> ${task.scheduledTime}</span>
                                                ${task.frequency ? `<span class="badge badge-gray">${task.frequency === 'daily' ? '每日' : task.frequency === 'weekly' ? '每周' : '一次性'}</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="ml-4 flex space-x-2">
                                            <button onclick="updateTaskStatus('${task.id}')" class="text-sm text-purple-600 hover:text-purple-700 px-3 py-1 border border-purple-600 rounded-lg hover:bg-purple-50 transition-colors">
                                                更新状态
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            lucide.createIcons();
        }

        // 获取任务状态文本
        function getTaskStatusText(status) {
            const statusMap = {
                pending: '待执行',
                in_progress: '进行中',
                completed: '已完成',
                skipped: '已跳过'
            };
            return statusMap[status] || status;
        }

        // 筛选任务
        function filterTasks(status) {
            currentTaskFilter = status;

            // 更新按钮状态
            document.querySelectorAll('.task-filter-btn').forEach(btn => {
                btn.classList.remove('bg-purple-100', 'text-purple-700', 'active');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });

            const activeBtn = document.querySelector(`.task-filter-btn[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                activeBtn.classList.add('bg-purple-100', 'text-purple-700', 'active');
            }

            renderTasks();
        }

        // 更新任务状态
        function updateTaskStatus(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            const statusFlow = {
                'pending': 'in_progress',
                'in_progress': 'completed',
                'completed': 'completed',
                'skipped': 'skipped'
            };

            // 简单的状态流转
            if (task.status === 'pending') {
                task.status = 'in_progress';
            } else if (task.status === 'in_progress') {
                task.status = 'completed';
            } else {
                UIUtils.notify('任务已完成', 'info');
                return;
            }

            task.updatedAt = new Date().toISOString();
            db.saveTask(task);

            loadTasks();
            UIUtils.notify(`任务状态已更新为${getTaskStatusText(task.status)}`, 'success');
        }

        // 加载对话历史
        function loadChatHistory() {
            const container = document.getElementById('chatMessagesContainer');
            const chatHistory = currentCustomer.chatHistory || [];

            if (chatHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>暂无对话记录</p>
                        <p class="text-sm mt-1">开始和AI美容助手对话吧</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = chatHistory.map(msg => `
                <div class="chat-bubble ${msg.role}" style="display: flex; flex-direction: column; ${msg.role === 'user' ? 'align-items: flex-end;' : 'align-items: flex-start;'}">
                    <p class="text-sm">${msg.content}</p>
                    <span class="text-xs opacity-75 mt-1">${DateUtils.format(new Date(msg.timestamp), 'HH:mm')}</span>
                </div>
            `).join('');

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        // 发送聊天消息
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // 添加用户消息
            if (!currentCustomer.chatHistory) {
                currentCustomer.chatHistory = [];
            }

            currentCustomer.chatHistory.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });

            input.value = '';
            loadChatHistory();

            // 模拟AI回复
            setTimeout(() => {
                const aiResponses = [
                    '感谢您的咨询,我们的专业美容顾问会尽快为您解答。',
                    '根据您的情况,我建议您可以尝试我们的深度清洁护理方案。',
                    '为了给您更准确的建议,请问您目前主要关注哪方面的美容需求?',
                    '您提到的问题很常见,通常我们会推荐结合内调和外养的方式来改善。',
                    '这是一个很好的问题!让我为您详细解答一下...'
                ];

                currentCustomer.chatHistory.push({
                    role: 'ai',
                    content: aiResponses[Math.floor(Math.random() * aiResponses.length)],
                    timestamp: new Date().toISOString()
                });

                saveCurrentCustomer();
                loadChatHistory();
            }, 1000);
        }

        // 处理回车发送
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // 清空对话历史
        function clearChatHistory() {
            if (confirm('确定要清空所有对话记录吗?')) {
                currentCustomer.chatHistory = [];
                saveCurrentCustomer();
                loadChatHistory();
                UIUtils.notify('对话记录已清空', 'success');
            }
        }

        // 生成AI客户画像
        function generateAIProfile() {
            document.getElementById('aiProfileModal').classList.remove('hidden');

            // 模拟AI分析
            setTimeout(() => {
                const basicInfo = currentCustomer.data?.tpl_basic_info || {};
                const skinInfo = currentCustomer.data?.tpl_basic_skin || {};

                const age = basicInfo.age || 30;
                const skinType = skinInfo.skin_type || '混合性';
                const concerns = skinInfo.concerns || '皮肤护理';

                const profile = {
                    personalityType: age < 25 ? '年轻活力型,追求时尚' : age < 35 ? '成熟知性型,注重品质' : '优雅精致型,追求高端',
                    beautyGoals: concerns ? [concerns, '皮肤改善', '提升气质'] : ['减重塑形', '皮肤改善', '抗衰老'],
                    purchasePower: basicInfo.vip_level === '钻石会员' ? '高端消费' :
                                   basicInfo.vip_level === '铂金会员' || basicInfo.vip_level === '金卡会员' ? '中高端消费' : '中端消费',
                    preferences: `对${skinType}皮肤护理有需求,关注专业度和效果`,
                    recommendedServices: [
                        { name: 'HIFU超声刀', reason: '适合抗衰老需求,效果显著' },
                        { name: '深层清洁护理', reason: `针对${skinType}肤质定制` },
                        { name: '光子嫩肤', reason: '改善肤色暗沉,提亮肤色' }
                    ],
                    engagementStrategy: age < 30 ? '建议每月1-2次基础护理,配合家居产品' : '建议每周1次专业护理,定制化服务方案',
                    riskLevel: '低流失风险',
                    lifetimeValue: basicInfo.vip_level === '钻石会员' ? '预估50000-80000元' :
                                   basicInfo.vip_level === '金卡会员' ? '预估30000-50000元' : '预估20000-30000元'
                };

                displayAIProfile(profile);
            }, 2000);
        }

        // 显示AI画像
        function displayAIProfile(profile) {
            const content = document.getElementById('aiProfileContent');
            content.innerHTML = `
                <div class="ai-card">
                    <h4 class="text-lg font-bold mb-2">AI智能分析结果</h4>
                    <p class="text-sm opacity-90">基于客户历史数据的深度分析</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">性格特征</h5>
                        <p class="text-gray-700">${profile.personalityType}</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">美容目标</h5>
                        <div class="flex flex-wrap gap-2">
                            ${profile.beautyGoals.map(goal => `
                                <span class="badge badge-purple">${goal}</span>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">消费能力</h5>
                        <p class="text-gray-700">${profile.purchasePower}</p>
                        <p class="text-sm text-gray-600 mt-1">预估终身价值: ${profile.lifetimeValue}</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">偏好分析</h5>
                        <p class="text-gray-700">${profile.preferences}</p>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">推荐服务</h5>
                        <div class="space-y-2">
                            ${profile.recommendedServices.map(service => `
                                <div class="flex items-start space-x-2">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
                                    <div>
                                        <div class="font-medium text-gray-900">${service.name}</div>
                                        <div class="text-sm text-gray-600">${service.reason}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 mb-2">维护策略</h5>
                        <p class="text-gray-700">${profile.engagementStrategy}</p>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="shield-check" class="w-5 h-5 text-green-600"></i>
                            <span class="font-semibold text-green-900">${profile.riskLevel}</span>
                        </div>
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // 关闭AI画像模态框
        function closeAIProfileModal() {
            document.getElementById('aiProfileModal').classList.add('hidden');
        }

        // 用户菜单切换
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }

        // 点击外部关闭用户菜单
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const userButton = event.target.closest('button[onclick="toggleUserMenu()"]');

            if (!userButton && !userMenu.contains(event.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // 点击模态框外部关闭
        document.getElementById('aiProfileModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeAIProfileModal();
            }
        });
    </script>

    <!-- 移动端底部导航 -->
    <div class="mobile-bottom-nav">
        <div class="flex justify-around items-center">
            <button class="mobile-nav-btn active" onclick="switchTab('profile')" data-tab="profile">
                <i data-lucide="user" class="w-5 h-5"></i>
                <span>资料</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('diagnosis')" data-tab="diagnosis">
                <i data-lucide="activity" class="w-5 h-5"></i>
                <span>诊断</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('plans')" data-tab="plans">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span>方案</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('orders')" data-tab="orders">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                <span>订单</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('tasks')" data-tab="tasks">
                <i data-lucide="check-square" class="w-5 h-5"></i>
                <span>任务</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('chat')" data-tab="chat">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span>对话</span>
            </button>
        </div>
    </div>
</body>
</html>
