# 客户资料功能快速测试指南

## 前置条件

1. ✅ 服务器已启动（`npm start`）
2. ✅ 数据库已连接
3. ✅ 客户资料模板已创建
4. ✅ 至少有一条客户记录

## 快速测试步骤

### 第1步：初始化模板数据

如果尚未插入模板，运行以下命令：

```bash
cd D:\work6\美业客户后台
node database/insert-customer-profile-templates.js
```

预期输出：
```
====================================
  客户模板测试数据插入
====================================

📝 正在连接数据库...
✅ 数据库连接成功

✓ 客户基础资料模板（标准版）
✓ 客户资料模板（专业版）
✓ 线上注册快速模板
✓ 新客到店详细登记模板
✓ 身体护理客户模板

✅ 所有测试数据插入成功！
```

### 第2步：访问客户详情页

打开浏览器访问：
```
http://8.210.246.101:5002/customer-detail.html?id=<客户ID>
```

例如：
```
http://8.210.246.101:5002/customer-detail.html?id=43743dea-7aa9-4b17-9e87-e809ed4e7e2a
```

### 第3步：打开开发者工具

按 `F12` 打开浏览器开发者工具，切换到 **Console** 标签。

观察以下日志：
```
✅ 模板加载成功: 客户基础资料模板（标准版）
✅ 客户资料加载成功
✅ CustomerProfileModule 模块已加载
```

### 第4步：查看客户资料表单

1. 在客户详情页中，点击 **"客户资料"** 标签（第一个标签）
2. 应该看到一个表单，包含以下分组：
   - **皮肤信息**：肤质类型、主要皮肤问题
   - **健康信息**：过敏史、既往病史
   - **偏好设置**：偏好服务时间
   - **基础信息**：职业

### 第5步：填写并保存表单

1. **填写字段**：
   - 肤质类型：选择 "干性"
   - 主要皮肤问题：勾选 "痘痘"、"斑点"
   - 过敏史：输入 "对花粉过敏"
   - 职业：输入 "工程师"

2. **保存资料**：
   - 点击表单底部的 **"保存资料"** 按钮
   - 等待保存完成（会显示加载动画）

3. **查看成功提示**：
   - 应该看到 `✅ 保存成功！` 的提示
   - 表单会重新加载，显示更新时间

### 第6步：验证数据持久化

1. **刷新页面**（Ctrl+F5）
2. **再次点击客户资料标签**
3. 验证：之前填写的数据应该仍然存在

## 调试检查清单

### API接口测试

在浏览器 Console 中执行以下测试：

```javascript
// 测试1：获取模板列表
fetch('http://localhost:3000/api/customer-profile-templates')
    .then(r => r.json())
    .then(d => console.log('✅ 模板列表:', d))
    .catch(e => console.error('❌ 错误:', e))

// 测试2：获取特定客户的资料
const customerId = '43743dea-7aa9-4b17-9e87-e809ed4e7e2a';
const templateId = 1; // 默认模板ID
fetch(`http://localhost:3000/api/customer-profiles/customer/${customerId}/template/${templateId}`)
    .then(r => r.json())
    .then(d => console.log('✅ 客户资料:', d))
    .catch(e => console.error('❌ 错误:', e))
```

### 数据库验证

```sql
-- 查看所有模板
SELECT id, template_code, template_name FROM customer_profile_templates;

-- 查看特定客户的资料
SELECT * FROM customer_profiles WHERE customer_id = 'customer_uuid';

-- 查看资料详情
SELECT cp.id, cp.customer_id, cpt.template_name, cp.profile_data, cp.updated_at
FROM customer_profiles cp
JOIN customer_profile_templates cpt ON cp.template_id = cpt.id
WHERE cp.customer_id = 'customer_uuid';
```

## 常见场景测试

### 场景1：新建客户资料
**预期行为**：
- 首次加载客户详情页时，表单为空
- 提示"尚未填写"
- 填写并保存后，数据持久化

**测试步骤**：
1. 选择一个新的客户ID（未有资料的客户）
2. 访问客户详情页
3. 验证表单为空
4. 填写字段并保存
5. 刷新页面，验证数据保存

### 场景2：编辑现有资料
**预期行为**：
- 加载现有数据到表单
- 显示最后更新时间
- 修改字段并保存
- 新数据覆盖旧数据

**测试步骤**：
1. 选择已有资料的客户
2. 验证表单预填充了旧数据
3. 修改某个字段
4. 保存并刷新
5. 验证新数据已保存

### 场景3：多个字段类型
**测试所有字段类型**：
- ✅ 文本输入：职业
- ✅ 下拉选择：肤质类型
- ✅ 多选框：皮肤问题
- ✅ 文本区域：过敏史

### 场景4：表单验证
**测试必填字段**：
1. 不填写肤质类型（必填）
2. 尝试保存
3. 应该看到浏览器原生的验证提示

## 性能检查

### 加载时间
- 页面加载时间：< 2秒
- 模板加载时间：< 1秒
- 客户资料加载时间：< 1秒
- 保存操作时间：< 2秒

### 浏览器Performance
在浏览器Performance标签中：
1. 点击 "Record" 开始记录
2. 切换到客户资料标签
3. 点击 "Stop" 停止记录
4. 查看性能指标

## 错误排查

### 问题1：表单无法加载

**症状**：客户资料标签打开时显示"正在加载..."，一直无法加载

**排查步骤**：
1. 打开 Console，检查错误信息
2. 检查网络标签中的API调用
3. 确认服务器地址是否正确

**解决方案**：
```javascript
// 检查当前使用的API地址
console.log('当前主机名:', window.location.hostname);
console.log('API基础地址:', window.location.hostname === 'localhost' ? 'http://localhost:3000' : `http://${window.location.hostname}:3000`);
```

### 问题2：保存失败

**症状**：点击保存后显示"❌ 保存失败"

**排查步骤**：
1. 查看 Console 中的详细错误信息
2. 检查表单数据是否正确
3. 检查必填字段是否填写

**常见原因**：
- API服务器未运行
- 必填字段为空
- 服务器返回验证错误

### 问题3：数据未持久化

**症状**：保存成功，但刷新页面后数据消失

**排查步骤**：
1. 打开数据库管理工具
2. 查询 `customer_profiles` 表
3. 检查是否有新记录

**常见原因**：
- 数据保存到了localStorage而非数据库
- 数据库连接断开
- 权限不足

## 性能优化建议

1. **减少API调用**
   - 已经缓存了模板数据
   - 建议在session中缓存模板信息

2. **字段级别的更新**
   - 可以实现只保存变化的字段
   - 减少网络传输

3. **批量操作**
   - 支持同时编辑多个模板
   - 批量保存

## 下一步行动

1. ✅ 测试所有场景
2. ✅ 验证数据完整性
3. ✅ 优化UI/UX
4. ✅ 添加更多模板
5. ✅ 实施权限控制
6. ✅ 添加审计日志

## 联系支持

如遇问题，请提供以下信息：
- 浏览器版本
- 错误截图
- Console错误日志
- 后端服务器日志
