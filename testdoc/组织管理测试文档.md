# 组织管理功能测试文档

## 文档信息
- **模块名称**: 组织管理
- **页面路径**: /organizations.html
- **API路由**: /api/organizations
- **测试目的**: 验证机构/门店的创建、查询、更新、删除等组织架构管理功能的正确性
- **文档版本**: 1.0
- **更新日期**: 2025-12-09

---

## 一、功能概述

组织管理模块负责管理美业CRM系统的组织架构，包括总部、加盟商和门店的层级关系管理。

### 核心功能
1. 组织信息管理（CRUD）
2. 组织层级关系管理
3. 加盟商等级管理
4. 合同信息管理
5. 分成比例配置
6. 组织状态管理
7. 组织统计分析

### 组织架构说明
```
总部 (platform, level=1)
  ├─ 加盟商A (franchisee, level=2)
  │   ├─ 门店A1 (store, level=3)
  │   └─ 门店A2 (store, level=3)
  └─ 加盟商B (franchisee, level=2)
      └─ 门店B1 (store, level=3)
```

---

## 二、数据库表结构

### 2.1 主表：organizations

```sql
CREATE TABLE `organizations` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '机构ID',
  `org_code` varchar(50) NOT NULL COMMENT '机构编码',
  `org_name` varchar(100) NOT NULL COMMENT '机构名称',
  `org_type` enum('platform','franchisee','store') NOT NULL COMMENT '机构类型',
  `parent_id` bigint unsigned DEFAULT NULL COMMENT '上级机构ID',
  `level` tinyint unsigned NOT NULL DEFAULT '1' COMMENT '层级：1-总部, 2-加盟商, 3-门店',
  `franchisee_level` enum('flagship','standard','community') DEFAULT NULL COMMENT '加盟商等级',
  `contract_no` varchar(50) DEFAULT NULL COMMENT '合同编号',
  `contract_start_date` date DEFAULT NULL COMMENT '合同开始日期',
  `contract_end_date` date DEFAULT NULL COMMENT '合同结束日期',
  `revenue_share_rate` decimal(5,2) DEFAULT '0.00' COMMENT '分成比例(%)',
  `contact_person` varchar(50) DEFAULT NULL COMMENT '联系人',
  `contact_phone` varchar(20) DEFAULT NULL COMMENT '联系电话',
  `contact_email` varchar(100) DEFAULT NULL COMMENT '联系邮箱',
  `province` varchar(50) DEFAULT NULL COMMENT '省',
  `city` varchar(50) DEFAULT NULL COMMENT '市',
  `district` varchar(50) DEFAULT NULL COMMENT '区',
  `address` varchar(200) DEFAULT NULL COMMENT '详细地址',
  `longitude` decimal(10,6) DEFAULT NULL COMMENT '经度',
  `latitude` decimal(10,6) DEFAULT NULL COMMENT '纬度',
  `status` enum('active','inactive','suspended') NOT NULL DEFAULT 'active' COMMENT '状态',
  `logo_url` varchar(255) DEFAULT NULL COMMENT 'Logo URL',
  `description` text COMMENT '机构描述',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` bigint unsigned DEFAULT NULL,
  `updated_by` bigint unsigned DEFAULT NULL,
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `org_code` (`org_code`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_org_type` (`org_type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB COMMENT='机构表';
```

**核心字段说明**:

| 字段名 | 类型 | 必填 | 说明 | 业务规则 |
|--------|------|------|------|----------|
| id | bigint | 是 | 主键 | 自增 |
| org_code | varchar(50) | 是 | 机构编码 | 唯一，建议格式：FC001 |
| org_name | varchar(100) | 是 | 机构名称 | 显示名称 |
| org_type | enum | 是 | 机构类型 | platform/franchisee/store |
| parent_id | bigint | 否 | 上级机构 | NULL表示总部 |
| level | tinyint | 是 | 层级 | 1=总部, 2=加盟商, 3=门店 |
| franchisee_level | enum | 否 | 加盟商等级 | flagship/standard/community |
| contract_no | varchar(50) | 否 | 合同编号 | 加盟商必填 |
| contract_start_date | date | 否 | 合同开始 | 加盟商必填 |
| contract_end_date | date | 否 | 合同结束 | 加盟商必填 |
| revenue_share_rate | decimal(5,2) | 否 | 分成比例 | 0-100，单位% |
| province/city/district | varchar | 否 | 省市区 | 门店位置 |
| longitude/latitude | decimal | 否 | 经纬度 | 地图定位 |
| status | enum | 是 | 状态 | active/inactive/suspended |
| is_deleted | tinyint(1) | 是 | 软删除 | 0=正常，1=已删除 |

**org_type字段说明**:

| 值 | 含义 | 层级 | 说明 |
|----|------|------|------|
| platform | 总部 | level=1 | 平台管理总部，parent_id为NULL |
| franchisee | 加盟商 | level=2 | 加盟商，parent_id指向总部 |
| store | 门店 | level=3 | 具体门店，parent_id指向加盟商 |

**franchisee_level字段说明** (仅加盟商使用):

| 值 | 含义 | 投资额 | 分成比例 | 权益说明 |
|----|------|--------|---------|---------|
| flagship | 旗舰店 | 100万+ | 30-40% | 地标商圈、豪华装修 |
| standard | 标准店 | 50-100万 | 40-50% | 主流商圈、标准装修 |
| community | 社区店 | 30-50万 | 50-60% | 社区周边、简约装修 |

**status字段说明**:

| 值 | 含义 | 业务规则 |
|----|------|---------|
| active | 正常 | 可正常开展业务 |
| inactive | 停用 | 暂停营业，不可开展业务 |
| suspended | 暂停 | 临时暂停，如装修、整改等 |

---

## 三、业务流程

### 3.1 创建加盟商流程

```
开始
  ↓
前端：填写加盟商信息
  ├─ 必填：机构编码、机构名称、机构类型
  ├─ 必填：加盟商等级、合同信息
  └─ 可选：联系人、地址、分成比例
  ↓
API: POST /api/organizations
  ↓
验证：机构编码唯一性
  ├─ 重复 → 返回错误
  └─ 不重复 → 继续
  ↓
验证：parent_id有效性（如果是加盟商或门店）
  ├─ 无效 → 返回错误
  └─ 有效 → 继续
  ↓
自动设置：level值
  ├─ org_type='platform' → level=1, parent_id=NULL
  ├─ org_type='franchisee' → level=2, parent_id=总部ID
  └─ org_type='store' → level=3, parent_id=加盟商ID
  ↓
插入：organizations 表
  ↓
返回：新机构信息
  ↓
结束
```

### 3.2 查询组织架构流程

```
开始
  ↓
API: GET /api/organizations?org_type=franchisee
  ↓
查询：organizations 表
  ├─ 过滤：is_deleted = 0
  ├─ 可选：org_type、status筛选
  └─ 排序：level ASC, created_at DESC
  ↓
（可选）递归查询：获取下级机构
  ↓
返回：组织列表（树形结构或扁平列表）
  ↓
结束
```

### 3.3 更新组织信息流程

```
开始
  ↓
API: PUT /api/organizations/:id
  ↓
验证：组织是否存在
  ├─ 不存在 → 返回404
  └─ 存在 → 继续
  ↓
验证：不允许修改的字段
  ├─ org_code (创建后不可修改)
  ├─ org_type (类型不可修改)
  └─ level (层级不可修改)
  ↓
更新：允许修改的字段
  ├─ org_name、status
  ├─ 联系信息、地址
  ├─ 合同信息、分成比例
  └─ updated_at 自动更新
  ↓
返回：更新后的组织信息
  ↓
结束
```

### 3.4 删除组织流程（软删除）

```
开始
  ↓
API: DELETE /api/organizations/:id
  ↓
验证：组织是否存在
  ├─ 不存在 → 返回404
  └─ 存在 → 继续
  ↓
检查：是否有下级机构
  ├─ 有下级 → 返回错误"请先删除下级机构"
  └─ 无下级 → 继续
  ↓
检查：是否有关联数据
  ├─ 有客户 → 返回错误"该机构还有客户，不能删除"
  ├─ 有用户 → 返回错误"该机构还有用户，不能删除"
  └─ 无关联 → 继续
  ↓
更新：is_deleted = 1
  ↓
返回：成功
  ↓
结束
```

---

## 四、测试场景

### 4.1 创建组织测试

#### 测试场景1：创建总部

**前置条件**:
- 已登录系统
- 有组织管理权限

**操作步骤**:
1. 访问 http://8.210.246.101:5002/organizations.html
2. 点击"新增组织"按钮
3. 填写信息：
   - 机构编码：`HQ001`
   - 机构名称：`美业CRM总部`
   - 机构类型：`platform` (总部)
   - 联系人：`张总`
   - 联系电话：`400-888-8888`
4. 点击"保存"

**数据库验证SQL**:

```sql
-- 1. 验证总部创建
SELECT
    id, org_code, org_name, org_type,
    parent_id, level, status, is_deleted
FROM organizations
WHERE org_code = 'HQ001';

-- 预期结果：
-- org_code: HQ001
-- org_name: 美业CRM总部
-- org_type: platform
-- parent_id: NULL (总部无上级)
-- level: 1
-- status: active (默认)
-- is_deleted: 0

-- 2. 验证自动字段
SELECT created_at, updated_at
FROM organizations
WHERE org_code = 'HQ001';

-- 预期：created_at和updated_at已设置
```

**预期结果**:
- ✅ organizations表新增1条记录
- ✅ org_code唯一
- ✅ org_type='platform', level=1, parent_id=NULL
- ✅ status默认为'active'

#### 测试场景2：创建加盟商（旗舰店）

**前置条件**: 总部已存在(id=1)

**操作步骤**:
1. 新增组织
2. 填写信息：
   - 机构编码：`FC001`
   - 机构名称：`上海静安旗舰店`
   - 机构类型：`franchisee` (加盟商)
   - 上级机构：`美业CRM总部` (id=1)
   - 加盟商等级：`flagship` (旗舰店)
   - 合同编号：`HT20250101`
   - 合同开始日期：`2025-01-01`
   - 合同结束日期：`2030-12-31`
   - 分成比例：`35.00` (35%)
   - 联系人：`李经理`
   - 联系电话：`021-12345678`
   - 省市区：`上海市` / `上海市` / `静安区`
   - 详细地址：`南京西路1000号`
3. 保存

**数据库验证SQL**:

```sql
-- 验证加盟商创建
SELECT
    id, org_code, org_name, org_type,
    parent_id, level, franchisee_level,
    contract_no, revenue_share_rate,
    province, city, district
FROM organizations
WHERE org_code = 'FC001';

-- 预期结果：
-- org_type: franchisee
-- parent_id: 1 (指向总部)
-- level: 2
-- franchisee_level: flagship
-- contract_no: HT20250101
-- revenue_share_rate: 35.00
-- province: 上海市
-- city: 上海市
-- district: 静安区

-- 验证合同日期
SELECT
    contract_start_date,
    contract_end_date,
    DATEDIFF(contract_end_date, contract_start_date) as contract_days
FROM organizations
WHERE org_code = 'FC001';

-- 预期：contract_days 约等于 6*365 = 2190天
```

**预期结果**:
- ✅ 加盟商创建成功
- ✅ parent_id正确指向总部
- ✅ level自动设置为2
- ✅ 合同信息完整保存

#### 测试场景3：创建门店

**前置条件**: 加盟商已存在(FC001, id=6)

**操作步骤**:
1. 新增组织
2. 填写信息：
   - 机构编码：`ST001`
   - 机构名称：`静安旗舰店-VIP区`
   - 机构类型：`store` (门店)
   - 上级机构：`上海静安旗舰店` (id=6)
   - 联系人：`王店长`
   - 联系电话：`021-87654321`
   - 地址：`上海市静安区南京西路1000号3楼`
   - 经度：`121.445678`
   - 纬度：`31.223456`
3. 保存

**数据库验证SQL**:

```sql
-- 验证门店创建
SELECT
    id, org_code, org_name, org_type,
    parent_id, level,
    longitude, latitude
FROM organizations
WHERE org_code = 'ST001';

-- 预期结果：
-- org_type: store
-- parent_id: 6 (指向加盟商FC001)
-- level: 3
-- longitude: 121.445678
-- latitude: 31.223456

-- 验证组织层级关系
SELECT
    o1.org_code as store_code,
    o1.org_name as store_name,
    o2.org_code as franchisee_code,
    o2.org_name as franchisee_name,
    o3.org_code as platform_code,
    o3.org_name as platform_name
FROM organizations o1
LEFT JOIN organizations o2 ON o1.parent_id = o2.id
LEFT JOIN organizations o3 ON o2.parent_id = o3.id
WHERE o1.org_code = 'ST001';

-- 预期：显示完整的三级层级关系
```

**预期结果**:
- ✅ 门店创建成功
- ✅ parent_id正确指向加盟商
- ✅ level自动设置为3
- ✅ 层级关系正确

#### 测试场景4：机构编码重复校验

**前置条件**: 已存在org_code='FC001'的加盟商

**操作步骤**:
1. 新增组织
2. 填写机构编码：`FC001` (已存在)
3. 保存

**数据库验证SQL**:

```sql
-- 验证唯一约束
SELECT COUNT(*) as count
FROM organizations
WHERE org_code = 'FC001'
  AND is_deleted = 0;

-- 预期结果：
-- count: 1 (只有一个，创建失败)

-- 验证唯一索引
SHOW INDEX FROM organizations WHERE Key_name = 'org_code';

-- 预期：org_code唯一索引存在
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"机构编码已存在"
- ✅ 数据库无新增记录

#### 测试场景5：必填字段校验

**测试用例5.1**: 缺少org_code

**操作步骤**:
1. 新增组织，不填机构编码
2. 保存

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"机构编码不能为空"

**测试用例5.2**: 加盟商缺少合同信息

**操作步骤**:
1. 新增加盟商，不填合同编号
2. 保存

**预期结果**:
- ❌ 提示"加盟商必须填写合同信息"

### 4.2 查询组织测试

#### 测试场景6：查询所有加盟商

**API**: `GET /api/organizations?org_type=franchisee`

**数据库验证SQL**:

```sql
-- 验证查询结果
SELECT
    id, org_code, org_name, org_type,
    franchisee_level, status
FROM organizations
WHERE org_type = 'franchisee'
  AND is_deleted = 0
ORDER BY created_at DESC;

-- 对比API返回结果数量
SELECT COUNT(*) as total
FROM organizations
WHERE org_type = 'franchisee'
  AND is_deleted = 0;
```

**预期结果**:
- ✅ 只返回org_type='franchisee'的记录
- ✅ 按创建时间倒序排列
- ✅ 不包含is_deleted=1的记录

#### 测试场景7：查询组织层级树

**API**: `GET /api/organizations/tree`

**数据库验证SQL**:

```sql
-- 查询完整的组织树结构
SELECT
    o1.id as platform_id,
    o1.org_name as platform_name,
    o2.id as franchisee_id,
    o2.org_name as franchisee_name,
    o3.id as store_id,
    o3.org_name as store_name
FROM organizations o1
LEFT JOIN organizations o2 ON o1.id = o2.parent_id AND o2.is_deleted = 0
LEFT JOIN organizations o3 ON o2.id = o3.parent_id AND o3.is_deleted = 0
WHERE o1.org_type = 'platform'
  AND o1.is_deleted = 0
ORDER BY o1.id, o2.id, o3.id;
```

**预期结果**:
- ✅ 返回树形结构数据
- ✅ 总部为根节点
- ✅ 加盟商为第二层
- ✅ 门店为第三层

#### 测试场景8：状态筛选

**API**: `GET /api/organizations?status=active`

**数据库验证SQL**:

```sql
-- 验证状态筛选
SELECT status, COUNT(*) as count
FROM organizations
WHERE is_deleted = 0
GROUP BY status;

-- 对比API返回的active数量
SELECT COUNT(*) as active_count
FROM organizations
WHERE status = 'active' AND is_deleted = 0;
```

**预期结果**:
- ✅ 只返回status='active'的组织
- ✅ 数量与SQL查询一致

### 4.3 更新组织测试

#### 测试场景9：更新加盟商信息

**前置条件**: 加盟商FC001已存在

**操作步骤**:
1. 编辑加盟商FC001
2. 修改信息：
   - 机构名称：`上海静安旗舰店-已升级`
   - 分成比例：`30.00` (从35%降至30%)
   - 联系人：`李总经理`
3. 保存

**数据库验证SQL**:

```sql
-- 验证更新
SELECT
    org_name,
    revenue_share_rate,
    contact_person,
    updated_at
FROM organizations
WHERE org_code = 'FC001';

-- 预期结果：
-- org_name: 上海静安旗舰店-已升级
-- revenue_share_rate: 30.00
-- contact_person: 李总经理
-- updated_at: (更新时间)

-- 验证updated_at自动更新
SELECT
    created_at,
    updated_at,
    TIMESTAMPDIFF(SECOND, created_at, updated_at) as time_diff
FROM organizations
WHERE org_code = 'FC001';

-- 预期：time_diff > 0
```

**预期结果**:
- ✅ 字段成功更新
- ✅ updated_at自动更新
- ✅ 其他字段保持不变

#### 测试场景10：尝试修改不可变字段

**操作步骤**:
1. 编辑组织
2. 尝试修改：
   - 机构编码 (不允许)
   - 机构类型 (不允许)
   - 层级 (不允许)

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"机构编码/类型/层级不可修改"
- ✅ 数据库未改变

#### 测试场景11：更新组织状态

**操作步骤**:
1. 选择组织
2. 修改状态：从'active'改为'suspended'
3. 保存

**数据库验证SQL**:

```sql
-- 验证状态变更
SELECT org_code, status, updated_at
FROM organizations
WHERE org_code = 'FC001';

-- 预期结果：
-- status: suspended
-- updated_at: (更新时间)
```

**预期结果**:
- ✅ status成功更新
- ✅ updated_at自动更新

### 4.4 删除组织测试

#### 测试场景12：删除门店（无下级）

**前置条件**: 门店ST001已存在，无下级机构，无关联客户/用户

**操作步骤**:
1. 选择门店ST001
2. 点击删除按钮
3. 确认删除

**数据库验证SQL**:

```sql
-- 验证软删除
SELECT
    id, org_code, org_name,
    is_deleted, updated_at
FROM organizations
WHERE org_code = 'ST001';

-- 预期结果：
-- is_deleted: 1

-- 验证列表查询（不包含已删除）
SELECT COUNT(*) as count
FROM organizations
WHERE org_code = 'ST001' AND is_deleted = 0;

-- 预期结果：
-- count: 0
```

**预期结果**:
- ✅ is_deleted设为1
- ✅ 记录仍在数据库中（软删除）
- ✅ 列表查询不再显示该组织

#### 测试场景13：删除有下级的组织

**前置条件**: 加盟商FC001有下级门店ST001

**操作步骤**:
1. 选择加盟商FC001
2. 点击删除按钮
3. 确认删除

**数据库验证SQL**:

```sql
-- 检查下级机构
SELECT
    id, org_code, org_name
FROM organizations
WHERE parent_id = (SELECT id FROM organizations WHERE org_code = 'FC001')
  AND is_deleted = 0;

-- 如果有下级，删除应该失败
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"该组织还有下级机构，不能删除"
- ✅ 数据库未改变

#### 测试场景14：删除有客户的组织

**前置条件**: 加盟商有关联客户

**操作步骤**:
1. 选择有客户的组织
2. 点击删除

**数据库验证SQL**:

```sql
-- 检查关联客户
SELECT COUNT(*) as customer_count
FROM customers
WHERE org_id = 6  -- FC001的ID
  AND is_deleted = 0;

-- 如果customer_count > 0，删除应该失败
```

**预期结果**:
- ❌ API返回400错误
- ❌ 提示"该机构还有X个客户，不能删除"
- ✅ 数据库未改变

---

## 五、统计功能测试

### 测试场景15：组织统计

**API**: `GET /api/organizations/stats`

**数据库验证SQL**:

```sql
-- 手动计算统计数据
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN org_type = 'platform' THEN 1 ELSE 0 END) as platform_count,
    SUM(CASE WHEN org_type = 'franchisee' THEN 1 ELSE 0 END) as franchisee_count,
    SUM(CASE WHEN org_type = 'store' THEN 1 ELSE 0 END) as store_count,
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END) as active_count,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_count,
    SUM(CASE WHEN status = 'suspended' THEN 1 ELSE 0 END) as suspended_count
FROM organizations
WHERE is_deleted = 0;

-- 按加盟商等级统计
SELECT
    franchisee_level,
    COUNT(*) as count,
    AVG(revenue_share_rate) as avg_share_rate
FROM organizations
WHERE org_type = 'franchisee'
  AND is_deleted = 0
GROUP BY franchisee_level
ORDER BY FIELD(franchisee_level, 'flagship', 'standard', 'community');

-- 按省份统计门店分布
SELECT
    province,
    COUNT(*) as store_count
FROM organizations
WHERE org_type = 'store'
  AND is_deleted = 0
  AND province IS NOT NULL
GROUP BY province
ORDER BY store_count DESC;
```

**预期结果**:
- ✅ API返回的统计数据与SQL查询一致
- ✅ 各维度统计准确

---

## 六、边界条件测试

### 6.1 字段长度测试

```sql
-- 测试机构编码最大长度（50字符）
INSERT INTO organizations (org_code, org_name, org_type)
VALUES (
    '12345678901234567890123456789012345678901234567890', -- 50字符
    '测试机构',
    'franchisee'
);

-- 预期：成功

-- 测试超长机构编码（51字符）
-- 预期：失败，超出长度限制
```

### 6.2 必填字段测试

```sql
-- 测试缺少org_code
INSERT INTO organizations (org_name, org_type)
VALUES ('测试机构', 'franchisee');

-- 预期：失败，NOT NULL约束

-- 测试缺少org_name
INSERT INTO organizations (org_code, org_type)
VALUES ('FC999', 'franchisee');

-- 预期：失败，NOT NULL约束
```

### 6.3 枚举值测试

```sql
-- 测试非法org_type值
INSERT INTO organizations (org_code, org_name, org_type)
VALUES ('FC999', '测试机构', 'invalid_type');

-- 预期：失败，枚举值约束

-- 测试非法franchisee_level值
UPDATE organizations
SET franchisee_level = 'super_flagship'
WHERE id = 1;

-- 预期：失败，枚举值约束

-- 测试非法status值
UPDATE organizations
SET status = 'deleted'
WHERE id = 1;

-- 预期：失败，枚举值约束
```

### 6.4 分成比例范围测试

```sql
-- 测试负数分成比例
UPDATE organizations
SET revenue_share_rate = -10.00
WHERE id = 6;

-- 预期：成功（数据库允许），但业务层应该验证

-- 测试超过100的分成比例
UPDATE organizations
SET revenue_share_rate = 150.00
WHERE id = 6;

-- 预期：成功（数据库允许），但业务层应该验证

-- 建议添加CHECK约束：
-- ALTER TABLE organizations
-- ADD CONSTRAINT chk_revenue_share_rate
-- CHECK (revenue_share_rate >= 0 AND revenue_share_rate <= 100);
```

### 6.5 层级一致性测试

```sql
-- 测试层级与类型不一致
UPDATE organizations
SET level = 3  -- 设置为门店层级
WHERE org_type = 'platform';  -- 但类型是总部

-- 应该在应用层验证，防止数据不一致
```

---

## 七、性能测试SQL

### 7.1 索引效率测试

```sql
-- 测试org_code唯一索引
EXPLAIN SELECT * FROM organizations WHERE org_code = 'FC001';
-- 预期：type=const, key=org_code

-- 测试parent_id索引
EXPLAIN SELECT * FROM organizations WHERE parent_id = 1;
-- 预期：type=ref, key=idx_parent_id

-- 测试org_type索引
EXPLAIN SELECT * FROM organizations WHERE org_type = 'franchisee';
-- 预期：type=ref, key=idx_org_type

-- 测试组合查询
EXPLAIN SELECT * FROM organizations
WHERE org_type = 'store' AND status = 'active' AND is_deleted = 0;
-- 验证索引使用情况
```

### 7.2 递归查询性能

```sql
-- 测试递归查询组织树（MySQL 8.0+）
WITH RECURSIVE org_tree AS (
    -- 锚点：总部
    SELECT
        id, org_code, org_name, org_type,
        parent_id, level, 0 as depth
    FROM organizations
    WHERE org_type = 'platform' AND is_deleted = 0

    UNION ALL

    -- 递归：获取子组织
    SELECT
        o.id, o.org_code, o.org_name, o.org_type,
        o.parent_id, o.level, t.depth + 1
    FROM organizations o
    INNER JOIN org_tree t ON o.parent_id = t.id
    WHERE o.is_deleted = 0
)
SELECT * FROM org_tree ORDER BY depth, id;

-- 验证执行时间
```

### 7.3 地理位置查询性能

```sql
-- 查询指定范围内的门店（如5公里内）
-- 需要添加空间索引优化

-- 简化版本（使用经纬度距离计算）
SELECT
    org_code, org_name,
    longitude, latitude,
    ROUND(
        6371 * 2 * ASIN(
            SQRT(
                POWER(SIN((31.223456 - ABS(latitude)) * PI() / 180 / 2), 2) +
                COS(31.223456 * PI() / 180) * COS(ABS(latitude) * PI() / 180) *
                POWER(SIN((121.445678 - longitude) * PI() / 180 / 2), 2)
            )
        ), 2
    ) AS distance_km
FROM organizations
WHERE org_type = 'store'
  AND is_deleted = 0
  AND longitude IS NOT NULL
  AND latitude IS NOT NULL
HAVING distance_km <= 5
ORDER BY distance_km;

-- 建议：添加SPATIAL索引提升性能
```

---

## 八、数据完整性检查

### 8.1 层级关系一致性

```sql
-- 检查层级与类型是否一致
SELECT
    id, org_code, org_name, org_type, level,
    CASE
        WHEN org_type = 'platform' AND level != 1 THEN '❌ 层级错误'
        WHEN org_type = 'franchisee' AND level != 2 THEN '❌ 层级错误'
        WHEN org_type = 'store' AND level != 3 THEN '❌ 层级错误'
        ELSE '✅ 正常'
    END as check_result
FROM organizations
WHERE is_deleted = 0
HAVING check_result = '❌ 层级错误';

-- 预期结果：0条记录
```

### 8.2 孤儿记录检查

```sql
-- 检查parent_id是否有效
SELECT
    o1.id,
    o1.org_code,
    o1.org_name,
    o1.parent_id
FROM organizations o1
WHERE o1.parent_id IS NOT NULL
  AND o1.parent_id NOT IN (
      SELECT id FROM organizations WHERE is_deleted = 0
  )
  AND o1.is_deleted = 0;

-- 预期结果：0条记录
```

### 8.3 合同日期逻辑检查

```sql
-- 检查合同结束日期是否晚于开始日期
SELECT
    id, org_code, org_name,
    contract_start_date,
    contract_end_date,
    DATEDIFF(contract_end_date, contract_start_date) as contract_days
FROM organizations
WHERE org_type = 'franchisee'
  AND contract_start_date IS NOT NULL
  AND contract_end_date IS NOT NULL
  AND contract_end_date <= contract_start_date
  AND is_deleted = 0;

-- 预期结果：0条记录

-- 检查合同是否过期
SELECT
    id, org_code, org_name,
    contract_end_date,
    DATEDIFF(contract_end_date, CURDATE()) as days_left
FROM organizations
WHERE org_type = 'franchisee'
  AND contract_end_date IS NOT NULL
  AND contract_end_date < CURDATE()
  AND is_deleted = 0;

-- 显示已过期的合同
```

### 8.4 唯一性检查

```sql
-- 检查org_code唯一性
SELECT org_code, COUNT(*) as count
FROM organizations
WHERE is_deleted = 0
GROUP BY org_code
HAVING count > 1;

-- 预期结果：0条记录
```

---

## 九、测试数据清理

### 测试完成后的清理脚本

```sql
-- 删除测试组织（按层级从下往上删除）
DELETE FROM organizations
WHERE org_code IN ('ST001', 'ST002')  -- 先删门店
  OR (org_code LIKE 'FC%' AND org_code != 'FC001' AND org_code != 'FC006' AND org_code != 'FC999')  -- 再删测试加盟商
  OR org_code = 'HQ001';  -- 最后删测试总部

-- 验证清理结果
SELECT COUNT(*) as remaining_test_orgs
FROM organizations
WHERE org_code LIKE 'TEST_%'
   OR org_code = 'HQ001';

-- 预期结果：0
```

---

## 十、常见问题排查

### 问题1：创建组织失败

**排查SQL**:
```sql
-- 检查机构编码是否已存在
SELECT id, org_code, org_name, is_deleted
FROM organizations
WHERE org_code = 'xxx';

-- 检查parent_id是否有效
SELECT id, org_name
FROM organizations
WHERE id = xxx AND is_deleted = 0;
```

### 问题2：组织层级显示错误

**排查SQL**:
```sql
-- 检查层级关系
SELECT
    o1.id, o1.org_code, o1.org_name, o1.level,
    o2.id as parent_id, o2.org_code as parent_code, o2.org_name as parent_name
FROM organizations o1
LEFT JOIN organizations o2 ON o1.parent_id = o2.id
WHERE o1.is_deleted = 0
ORDER BY o1.level, o1.id;
```

### 问题3：删除组织失败

**排查SQL**:
```sql
-- 检查是否有下级机构
SELECT
    id, org_code, org_name
FROM organizations
WHERE parent_id = xxx
  AND is_deleted = 0;

-- 检查是否有关联客户
SELECT COUNT(*) as customer_count
FROM customers
WHERE org_id = xxx
  AND is_deleted = 0;

-- 检查是否有关联用户
SELECT COUNT(*) as user_count
FROM users
WHERE org_id = xxx
  AND is_deleted = 0;
```

---

## 十一、测试检查清单

### 功能测试
- [ ] 创建总部
- [ ] 创建加盟商（旗舰店）
- [ ] 创建加盟商（标准店）
- [ ] 创建加盟商（社区店）
- [ ] 创建门店
- [ ] 机构编码重复校验
- [ ] 必填字段校验
- [ ] 查询所有加盟商
- [ ] 查询组织层级树
- [ ] 状态筛选
- [ ] 更新组织基本信息
- [ ] 更新组织状态
- [ ] 尝试修改不可变字段
- [ ] 删除门店（无下级）
- [ ] 删除有下级的组织（应失败）
- [ ] 删除有客户的组织（应失败）
- [ ] 组织统计准确性

### 数据库测试
- [ ] organizations表记录正确插入
- [ ] org_code唯一约束生效
- [ ] parent_id外键约束生效
- [ ] 索引使用正确
- [ ] 层级与类型一致性
- [ ] 软删除逻辑正确
- [ ] 时间戳自动更新

### 加盟商等级测试
- [ ] flagship (旗舰店)
- [ ] standard (标准店)
- [ ] community (社区店)

### 组织类型测试
- [ ] platform (总部) - level=1
- [ ] franchisee (加盟商) - level=2
- [ ] store (门店) - level=3

### 边界测试
- [ ] 字段长度限制
- [ ] 必填字段校验
- [ ] 枚举值校验
- [ ] 分成比例范围验证
- [ ] 层级一致性验证

### 性能测试
- [ ] 索引效率
- [ ] 递归查询性能
- [ ] 地理位置查询性能

---

## 十二、快速测试脚本

```sql
-- 完整测试流程脚本

-- 1. 创建总部
INSERT INTO organizations (
    org_code, org_name, org_type,
    level, contact_person, contact_phone, created_by
)
VALUES (
    'AUTO_TEST_HQ',
    '自动测试总部',
    'platform',
    1,
    '测试管理员',
    '400-000-0000',
    1
);

SET @platform_id = LAST_INSERT_ID();

-- 2. 创建加盟商
INSERT INTO organizations (
    org_code, org_name, org_type,
    parent_id, level, franchisee_level,
    contract_no, contract_start_date, contract_end_date,
    revenue_share_rate, province, city, created_by
)
VALUES (
    'AUTO_TEST_FC',
    '自动测试加盟商',
    'franchisee',
    @platform_id,
    2,
    'flagship',
    'AUTO_HT001',
    '2025-01-01',
    '2030-12-31',
    35.00,
    '上海市',
    '上海市',
    1
);

SET @franchisee_id = LAST_INSERT_ID();

-- 3. 创建门店
INSERT INTO organizations (
    org_code, org_name, org_type,
    parent_id, level, province, city,
    longitude, latitude, created_by
)
VALUES (
    'AUTO_TEST_ST',
    '自动测试门店',
    'store',
    @franchisee_id,
    3,
    '上海市',
    '上海市',
    121.445678,
    31.223456,
    1
);

SET @store_id = LAST_INSERT_ID();

-- 4. 验证层级关系
SELECT
    o1.org_code as platform,
    o2.org_code as franchisee,
    o3.org_code as store
FROM organizations o1
LEFT JOIN organizations o2 ON o1.id = o2.parent_id
LEFT JOIN organizations o3 ON o2.id = o3.parent_id
WHERE o1.id = @platform_id;

-- 5. 更新组织信息
UPDATE organizations
SET
    org_name = '自动测试加盟商-已修改',
    revenue_share_rate = 30.00,
    status = 'active'
WHERE id = @franchisee_id;

-- 6. 验证更新
SELECT
    id, org_name, revenue_share_rate, status,
    updated_at > created_at as is_updated
FROM organizations
WHERE id = @franchisee_id;

-- 7. 软删除（从下往上删）
UPDATE organizations SET is_deleted = 1 WHERE id = @store_id;
UPDATE organizations SET is_deleted = 1 WHERE id = @franchisee_id;
UPDATE organizations SET is_deleted = 1 WHERE id = @platform_id;

-- 8. 验证软删除
SELECT
    COUNT(*) as visible_count
FROM organizations
WHERE id IN (@platform_id, @franchisee_id, @store_id)
  AND is_deleted = 0;

-- 预期：visible_count = 0

-- 9. 清理测试数据
DELETE FROM organizations
WHERE id IN (@platform_id, @franchisee_id, @store_id);

-- 10. 验证清理
SELECT COUNT(*) as remaining
FROM organizations
WHERE id IN (@platform_id, @franchisee_id, @store_id);

-- 预期：remaining = 0
```

---

## 十三、监控查询

```sql
-- 实时监控组织增长
SELECT
    DATE(created_at) as date,
    org_type,
    COUNT(*) as new_count
FROM organizations
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND is_deleted = 0
GROUP BY DATE(created_at), org_type
ORDER BY date DESC, org_type;

-- 统计各类型组织数量
SELECT
    org_type,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM organizations WHERE is_deleted = 0), 2) as percentage
FROM organizations
WHERE is_deleted = 0
GROUP BY org_type
ORDER BY FIELD(org_type, 'platform', 'franchisee', 'store');

-- 统计加盟商等级分布
SELECT
    franchisee_level,
    COUNT(*) as count,
    AVG(revenue_share_rate) as avg_share_rate,
    MIN(revenue_share_rate) as min_rate,
    MAX(revenue_share_rate) as max_rate
FROM organizations
WHERE org_type = 'franchisee'
  AND is_deleted = 0
GROUP BY franchisee_level
ORDER BY FIELD(franchisee_level, 'flagship', 'standard', 'community');

-- 统计门店地域分布
SELECT
    province,
    city,
    COUNT(*) as store_count
FROM organizations
WHERE org_type = 'store'
  AND is_deleted = 0
GROUP BY province, city
ORDER BY store_count DESC;

-- 合同到期预警（未来30天内）
SELECT
    org_code,
    org_name,
    contract_end_date,
    DATEDIFF(contract_end_date, CURDATE()) as days_left
FROM organizations
WHERE org_type = 'franchisee'
  AND contract_end_date IS NOT NULL
  AND contract_end_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 30 DAY)
  AND is_deleted = 0
ORDER BY contract_end_date;

-- 状态分布统计
SELECT
    status,
    COUNT(*) as count
FROM organizations
WHERE is_deleted = 0
GROUP BY status
ORDER BY FIELD(status, 'active', 'suspended', 'inactive');
```

---

## 附录A：加盟商等级对照表

| 等级 | 英文值 | 投资额 | 分成比例建议 | 面积要求 | 人员配置 |
|------|--------|--------|-------------|---------|---------|
| 旗舰店 | flagship | 100万+ | 30-40% | 300㎡+ | 15人+ |
| 标准店 | standard | 50-100万 | 40-50% | 150-300㎡ | 8-15人 |
| 社区店 | community | 30-50万 | 50-60% | 80-150㎡ | 5-8人 |

---

## 附录B：组织层级示例

```
美业CRM总部 (HQ001)
├─ 上海静安旗舰店 (FC001) - 旗舰店
│  ├─ 静安店VIP区 (ST001)
│  └─ 静安店标准区 (ST002)
├─ 北京三里屯标准店 (FC002) - 标准店
│  └─ 三里屯店 (ST003)
└─ 成都春熙路社区店 (FC003) - 社区店
   └─ 春熙路店 (ST004)
```

---

## 附录C：API接口清单

| 方法 | 路径 | 说明 | 必需参数 |
|------|------|------|---------|
| GET | /api/organizations | 获取组织列表 | - |
| GET | /api/organizations/:id | 获取单个组织 | id |
| GET | /api/organizations/tree | 获取组织树 | - |
| POST | /api/organizations | 创建组织 | org_code, org_name, org_type |
| PUT | /api/organizations/:id | 更新组织 | id |
| DELETE | /api/organizations/:id | 删除组织（软删除） | id |
| GET | /api/organizations/stats | 获取组织统计 | - |
| GET | /api/organizations/:id/children | 获取下级组织 | id |

---

**测试负责人**: _________
**测试日期**: _________
**测试结果**: ☐ 通过  ☐ 部分通过  ☐ 未通过
**备注**: _________
