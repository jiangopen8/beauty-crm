# å®¢æˆ·è¯¦æƒ…é¡µé¢æ¨¡å—åŒ–é‡æ„æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®ä¿¡æ¯

| é¡¹ç›® | ä¿¡æ¯ |
|------|------|
| æ–‡æ¡£æ ‡é¢˜ | å®¢æˆ·è¯¦æƒ…é¡µé¢æ¨¡å—åŒ–é‡æ„æ–¹æ¡ˆ |
| åˆ›å»ºæ—¥æœŸ | 2025-12-04 |
| åˆ›å»ºäºº | Claude Code |
| ç‰ˆæœ¬ | v1.0 |

---

## ğŸ¯ é‡æ„ç›®æ ‡

### å½“å‰é—®é¢˜

1. **æ–‡ä»¶è¿‡å¤§**ï¼š`customer-detail.html` è¾¾åˆ° 1845 è¡Œä»£ç 
2. **æ¨¡å—è€¦åˆ**ï¼š6ä¸ªåŠŸèƒ½æ¨¡å—ï¼ˆå®¢æˆ·èµ„æ–™ã€è¯Šæ–­ã€æ–¹æ¡ˆã€è®¢å•ã€ä»»åŠ¡ã€AIå¯¹è¯ï¼‰å †å åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­
3. **ç»´æŠ¤å›°éš¾**ï¼šæŸ¥æ‰¾å’Œä¿®å¤bugæ—¶éœ€è¦åœ¨å¤§æ–‡ä»¶ä¸­å®šä½
4. **å¼€å‘æ•ˆç‡ä½**ï¼šå¤šäººåä½œæ—¶å®¹æ˜“äº§ç”Ÿå†²çª
5. **æ€§èƒ½é—®é¢˜**ï¼šæ‰€æœ‰æ¨¡å—ä¸€æ¬¡æ€§åŠ è½½ï¼Œé¦–å±åŠ è½½æ…¢

### é‡æ„ç›®æ ‡

1. âœ… **æ¨¡å—åŒ–å¼€å‘**ï¼šæ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹æˆæ–‡ä»¶
2. âœ… **ä¾¿äºè°ƒè¯•**ï¼šå•ä¸ªæ¨¡å—æ–‡ä»¶å°ï¼Œå®¹æ˜“å®šä½é—®é¢˜
3. âœ… **æŒ‰éœ€åŠ è½½**ï¼šæå‡é¦–å±åŠ è½½æ€§èƒ½
4. âœ… **ç»Ÿä¸€ä½“éªŒ**ï¼šç”¨æˆ·æ“ä½œä¿æŒåŸæœ‰Tabåˆ‡æ¢æ•ˆæœ
5. âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½æ¨¡å—æ›´ç®€å•

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¾è®¡åŸåˆ™

```
ä¸»é¡µé¢ï¼ˆå®¹å™¨ï¼‰ + ç‹¬ç«‹æ¨¡å—ï¼ˆå†…å®¹ï¼‰ = æ¨¡å—åŒ–æ¶æ„
```

### æ•´ä½“æ¶æ„å›¾

```
customer-detail.htmlï¼ˆä¸»å®¹å™¨é¡µé¢ï¼‰
â”œâ”€â”€ é¡¶éƒ¨å¯¼èˆªï¼ˆè¿”å›ã€æ ‡é¢˜ã€æ“ä½œæŒ‰é’®ï¼‰
â”œâ”€â”€ å®¢æˆ·åŸºæœ¬ä¿¡æ¯å¡ç‰‡
â”œâ”€â”€ Tabå¯¼èˆªæ 
â”œâ”€â”€ Tabå†…å®¹åŒºåŸŸï¼ˆåŠ¨æ€åŠ è½½ï¼‰
â”‚   â”œâ”€â”€ [Tab 1] å®¢æˆ·èµ„æ–™ â†’ modules/customer-profile.js
â”‚   â”œâ”€â”€ [Tab 2] è¯Šæ–­ç®¡ç† â†’ modules/diagnosis.js
â”‚   â”œâ”€â”€ [Tab 3] æ–¹æ¡ˆç®¡ç† â†’ modules/plans.js
â”‚   â”œâ”€â”€ [Tab 4] è®¢å•ç®¡ç† â†’ modules/orders.js
â”‚   â”œâ”€â”€ [Tab 5] ä»»åŠ¡ç®¡ç† â†’ modules/tasks.js
â”‚   â””â”€â”€ [Tab 6] AIå¯¹è¯ â†’ modules/chat.js
â””â”€â”€ ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª

js/
â”œâ”€â”€ modules/ï¼ˆæ–°å¢æ¨¡å—ç›®å½•ï¼‰
â”‚   â”œâ”€â”€ customer-profile.js    # å®¢æˆ·èµ„æ–™æ¨¡å—
â”‚   â”œâ”€â”€ diagnosis.js            # è¯Šæ–­ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ plans.js                # æ–¹æ¡ˆç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ orders.js               # è®¢å•ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ tasks.js                # ä»»åŠ¡ç®¡ç†æ¨¡å—
â”‚   â””â”€â”€ chat.js                 # AIå¯¹è¯æ¨¡å—
â”œâ”€â”€ core/ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
â”‚   â”œâ”€â”€ module-loader.js        # æ¨¡å—åŠ è½½å™¨
â”‚   â””â”€â”€ tab-manager.js          # Tabç®¡ç†å™¨
â”œâ”€â”€ utils.jsï¼ˆå·²æœ‰ï¼‰
â””â”€â”€ db.jsï¼ˆå·²æœ‰ï¼‰
```

---

## ğŸ“¦ æ¨¡å—æ‹†åˆ†æ–¹æ¡ˆ

### 1. ä¸»å®¹å™¨é¡µé¢ï¼šcustomer-detail.html

**ä¿ç•™å†…å®¹**ï¼š
- HTMLåŸºç¡€ç»“æ„
- é¡¶éƒ¨å¯¼èˆª
- å®¢æˆ·åŸºæœ¬ä¿¡æ¯å¡ç‰‡
- Tabå¯¼èˆªæ ï¼ˆ6ä¸ªTabæŒ‰é’®ï¼‰
- Tabå†…å®¹å®¹å™¨ï¼ˆç©ºdivï¼ŒåŠ¨æ€å¡«å……ï¼‰
- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª
- åŸºç¡€æ ·å¼å’Œé€šç”¨CSS

**ç§»é™¤å†…å®¹**ï¼š
- å„ä¸ªTabçš„å…·ä½“HTMLå†…å®¹
- å„ä¸ªTabçš„JavaScripté€»è¾‘
- å¤§æ®µçš„å†…è”JavaScriptä»£ç 

**ç²¾ç®€åé¢„è®¡**ï¼šçº¦300-400è¡Œï¼ˆä»1845è¡Œå‡å°‘åˆ°400è¡Œï¼‰

---

### 2. æ¨¡å—ç›®å½•ç»“æ„

```
js/modules/
â”‚
â”œâ”€â”€ customer-profile.js        # å®¢æˆ·èµ„æ–™æ¨¡å—ï¼ˆ200-300è¡Œï¼‰
â”‚   â”œâ”€â”€ CustomerProfileModule ç±»
â”‚   â”œâ”€â”€ render() - æ¸²æŸ“UI
â”‚   â”œâ”€â”€ loadData() - åŠ è½½æ•°æ®
â”‚   â”œâ”€â”€ saveData() - ä¿å­˜æ•°æ®
â”‚   â””â”€â”€ events() - äº‹ä»¶ç»‘å®š
â”‚
â”œâ”€â”€ diagnosis.js               # è¯Šæ–­ç®¡ç†æ¨¡å—ï¼ˆ300-400è¡Œï¼‰
â”‚   â”œâ”€â”€ DiagnosisModule ç±»
â”‚   â”œâ”€â”€ render() - æ¸²æŸ“è¯Šæ–­åˆ—è¡¨
â”‚   â”œâ”€â”€ addDiagnosis() - æ·»åŠ è¯Šæ–­
â”‚   â”œâ”€â”€ editDiagnosis() - ç¼–è¾‘è¯Šæ–­
â”‚   â””â”€â”€ deleteDiagnosis() - åˆ é™¤è¯Šæ–­
â”‚
â”œâ”€â”€ plans.js                   # æ–¹æ¡ˆç®¡ç†æ¨¡å—ï¼ˆ300-400è¡Œï¼‰
â”‚   â”œâ”€â”€ PlansModule ç±»
â”‚   â”œâ”€â”€ render() - æ¸²æŸ“æ–¹æ¡ˆåˆ—è¡¨
â”‚   â”œâ”€â”€ generatePlan() - ç”Ÿæˆæ–¹æ¡ˆ
â”‚   â”œâ”€â”€ selectPlan() - é€‰æ‹©æ–¹æ¡ˆ
â”‚   â””â”€â”€ savePlan() - ä¿å­˜æ–¹æ¡ˆ
â”‚
â”œâ”€â”€ orders.js                  # è®¢å•ç®¡ç†æ¨¡å—ï¼ˆ200-300è¡Œï¼‰
â”‚   â”œâ”€â”€ OrdersModule ç±»
â”‚   â”œâ”€â”€ render() - æ¸²æŸ“è®¢å•åˆ—è¡¨
â”‚   â”œâ”€â”€ loadOrders() - åŠ è½½è®¢å•
â”‚   â””â”€â”€ viewOrderDetail() - æŸ¥çœ‹è®¢å•è¯¦æƒ…
â”‚
â”œâ”€â”€ tasks.js                   # ä»»åŠ¡ç®¡ç†æ¨¡å—ï¼ˆ300-400è¡Œï¼‰
â”‚   â”œâ”€â”€ TasksModule ç±»
â”‚   â”œâ”€â”€ render() - æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
â”‚   â”œâ”€â”€ filterTasks() - ç­›é€‰ä»»åŠ¡
â”‚   â”œâ”€â”€ addTask() - æ·»åŠ ä»»åŠ¡
â”‚   â””â”€â”€ updateTaskStatus() - æ›´æ–°ä»»åŠ¡çŠ¶æ€
â”‚
â””â”€â”€ chat.js                    # AIå¯¹è¯æ¨¡å—ï¼ˆ200-300è¡Œï¼‰
    â”œâ”€â”€ ChatModule ç±»
    â”œâ”€â”€ render() - æ¸²æŸ“èŠå¤©ç•Œé¢
    â”œâ”€â”€ sendMessage() - å‘é€æ¶ˆæ¯
    â”œâ”€â”€ receiveMessage() - æ¥æ”¶AIå›å¤
    â””â”€â”€ loadHistory() - åŠ è½½å†å²è®°å½•
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. æ¨¡å—åŠ è½½å™¨ï¼šjs/core/module-loader.js

**åŠŸèƒ½**ï¼šåŠ¨æ€åŠ è½½å’Œç®¡ç†å„ä¸ªåŠŸèƒ½æ¨¡å—

```javascript
/**
 * æ¨¡å—åŠ è½½å™¨
 * è´Ÿè´£æŒ‰éœ€åŠ è½½å„ä¸ªåŠŸèƒ½æ¨¡å—
 */
class ModuleLoader {
    constructor() {
        this.modules = new Map();  // å·²åŠ è½½çš„æ¨¡å—ç¼“å­˜
        this.loading = new Map();  // æ­£åœ¨åŠ è½½çš„æ¨¡å—
    }

    /**
     * åŠ è½½æ¨¡å—
     * @param {string} moduleName - æ¨¡å—åç§°ï¼ˆå¦‚ 'customer-profile'ï¼‰
     * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
     * @param {object} options - åˆå§‹åŒ–é€‰é¡¹
     * @returns {Promise<Module>}
     */
    async loadModule(moduleName, container, options = {}) {
        // å¦‚æœå·²åŠ è½½ï¼Œç›´æ¥è¿”å›
        if (this.modules.has(moduleName)) {
            const module = this.modules.get(moduleName);
            module.mount(container);
            return module;
        }

        // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
        if (this.loading.has(moduleName)) {
            return await this.loading.get(moduleName);
        }

        // å¼€å§‹åŠ è½½
        const loadPromise = this._loadModuleScript(moduleName, container, options);
        this.loading.set(moduleName, loadPromise);

        try {
            const module = await loadPromise;
            this.modules.set(moduleName, module);
            this.loading.delete(moduleName);
            return module;
        } catch (error) {
            this.loading.delete(moduleName);
            throw error;
        }
    }

    /**
     * åŠ è½½æ¨¡å—è„šæœ¬
     */
    async _loadModuleScript(moduleName, container, options) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `js/modules/${moduleName}.js`;
            script.type = 'module';

            script.onload = () => {
                // è·å–æ¨¡å—ç±»ï¼ˆçº¦å®šï¼šæ¯ä¸ªæ¨¡å—å¯¼å‡ºä¸€ä¸ªç±»ï¼‰
                const ModuleClass = window[this._getModuleClassName(moduleName)];

                if (!ModuleClass) {
                    reject(new Error(`æ¨¡å— ${moduleName} æœªæ‰¾åˆ°å¯¼å‡ºç±»`));
                    return;
                }

                // å®ä¾‹åŒ–æ¨¡å—
                const moduleInstance = new ModuleClass(options);
                moduleInstance.mount(container);
                resolve(moduleInstance);
            };

            script.onerror = () => {
                reject(new Error(`åŠ è½½æ¨¡å— ${moduleName} å¤±è´¥`));
            };

            document.head.appendChild(script);
        });
    }

    /**
     * è·å–æ¨¡å—ç±»åï¼ˆçº¦å®šå‘½åï¼‰
     * customer-profile â†’ CustomerProfileModule
     */
    _getModuleClassName(moduleName) {
        return moduleName
            .split('-')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join('') + 'Module';
    }

    /**
     * å¸è½½æ¨¡å—
     */
    unloadModule(moduleName) {
        if (this.modules.has(moduleName)) {
            const module = this.modules.get(moduleName);
            module.unmount();
            this.modules.delete(moduleName);
        }
    }

    /**
     * æ¸…ç©ºæ‰€æœ‰æ¨¡å—
     */
    clearAll() {
        this.modules.forEach(module => module.unmount());
        this.modules.clear();
    }
}

// å¯¼å‡ºå•ä¾‹
window.moduleLoader = new ModuleLoader();
```

---

### 2. Tabç®¡ç†å™¨ï¼šjs/core/tab-manager.js

**åŠŸèƒ½**ï¼šç®¡ç†Tabåˆ‡æ¢å’Œæ¨¡å—åŠ è½½

```javascript
/**
 * Tabç®¡ç†å™¨
 * è´Ÿè´£Tabåˆ‡æ¢é€»è¾‘å’Œæ¨¡å—åŠ¨æ€åŠ è½½
 */
class TabManager {
    constructor(options = {}) {
        this.currentTab = options.defaultTab || 'profile';
        this.customerId = options.customerId;
        this.tabs = {
            'profile': {
                name: 'å®¢æˆ·èµ„æ–™',
                module: 'customer-profile',
                icon: 'user',
                container: 'profileTab'
            },
            'diagnosis': {
                name: 'è¯Šæ–­ç®¡ç†',
                module: 'diagnosis',
                icon: 'clipboard',
                container: 'diagnosisTab'
            },
            'plans': {
                name: 'æ–¹æ¡ˆç®¡ç†',
                module: 'plans',
                icon: 'file-text',
                container: 'plansTab'
            },
            'orders': {
                name: 'è®¢å•ç®¡ç†',
                module: 'orders',
                icon: 'shopping-cart',
                container: 'ordersTab'
            },
            'tasks': {
                name: 'ä»»åŠ¡ç®¡ç†',
                module: 'tasks',
                icon: 'check-square',
                container: 'tasksTab'
            },
            'chat': {
                name: 'AIå¯¹è¯',
                module: 'chat',
                icon: 'message-circle',
                container: 'chatTab'
            }
        };
    }

    /**
     * åˆå§‹åŒ–Tabç®¡ç†å™¨
     */
    init() {
        this._bindTabEvents();
        this._loadInitialTab();
    }

    /**
     * ç»‘å®šTabç‚¹å‡»äº‹ä»¶
     */
    _bindTabEvents() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = btn.dataset.tab;
                this.switchTab(tabId);
            });
        });

        // ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª
        document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = btn.dataset.tab;
                this.switchTab(tabId);
            });
        });
    }

    /**
     * åˆ‡æ¢Tab
     */
    async switchTab(tabId) {
        if (tabId === this.currentTab) return;

        const tabConfig = this.tabs[tabId];
        if (!tabConfig) {
            console.error(`Tab ${tabId} ä¸å­˜åœ¨`);
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        this._showLoading(tabId);

        try {
            // éšè—æ‰€æœ‰Tabå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰TabæŒ‰é’®çš„activeçŠ¶æ€
            document.querySelectorAll('.tab-btn, .mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ¿€æ´»å½“å‰TabæŒ‰é’®
            document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(btn => {
                btn.classList.add('active');
            });

            // è·å–å®¹å™¨
            const container = document.getElementById(tabConfig.container);
            container.classList.add('active');

            // åŠ è½½æ¨¡å—
            await window.moduleLoader.loadModule(
                tabConfig.module,
                container,
                { customerId: this.customerId }
            );

            // æ›´æ–°å½“å‰Tab
            this.currentTab = tabId;

            // éšè—åŠ è½½çŠ¶æ€
            this._hideLoading(tabId);

            // è§¦å‘Tabåˆ‡æ¢äº‹ä»¶
            this._triggerTabChange(tabId);

        } catch (error) {
            console.error(`åŠ è½½Tab ${tabId} å¤±è´¥:`, error);
            this._showError(tabId, error.message);
        }
    }

    /**
     * åŠ è½½åˆå§‹Tab
     */
    async _loadInitialTab() {
        await this.switchTab(this.currentTab);
    }

    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    _showLoading(tabId) {
        const container = document.getElementById(this.tabs[tabId].container);
        container.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="loading-spinner"></div>
                <p class="ml-3 text-gray-500">æ­£åœ¨åŠ è½½${this.tabs[tabId].name}...</p>
            </div>
        `;
    }

    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    _hideLoading(tabId) {
        // æ¨¡å—åŠ è½½å®Œæˆåä¼šè‡ªåŠ¨å¡«å……å†…å®¹ï¼Œæ— éœ€é¢å¤–æ“ä½œ
    }

    /**
     * æ˜¾ç¤ºé”™è¯¯
     */
    _showError(tabId, message) {
        const container = document.getElementById(this.tabs[tabId].container);
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-red-600">
                <i data-lucide="alert-circle" class="w-12 h-12 mb-3"></i>
                <p class="text-lg font-semibold">åŠ è½½å¤±è´¥</p>
                <p class="text-sm mt-2">${message}</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    åˆ·æ–°é¡µé¢
                </button>
            </div>
        `;
        lucide.createIcons();
    }

    /**
     * è§¦å‘Tabåˆ‡æ¢äº‹ä»¶
     */
    _triggerTabChange(tabId) {
        window.dispatchEvent(new CustomEvent('tabChange', {
            detail: { tabId, tabName: this.tabs[tabId].name }
        }));
    }
}

// å¯¼å‡ºåˆ°å…¨å±€
window.TabManager = TabManager;
```

---

## ğŸ“ æ¨¡å—å¼€å‘è§„èŒƒ

### æ¨¡å—åŸºç±»

æ¯ä¸ªæ¨¡å—éƒ½åº”è¯¥å®ç°ä»¥ä¸‹æ¥å£ï¼š

```javascript
/**
 * æ¨¡å—åŸºç±»ï¼ˆæ‰€æœ‰æ¨¡å—ç»§æ‰¿æ­¤ç±»ï¼‰
 */
class BaseModule {
    constructor(options = {}) {
        this.customerId = options.customerId;
        this.container = null;
        this.data = null;
    }

    /**
     * æŒ‚è½½æ¨¡å—åˆ°å®¹å™¨
     * @param {HTMLElement} container
     */
    mount(container) {
        this.container = container;
        this.init();
    }

    /**
     * åˆå§‹åŒ–æ¨¡å—
     */
    async init() {
        await this.loadData();
        this.render();
        this.bindEvents();
    }

    /**
     * åŠ è½½æ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰
     */
    async loadData() {
        throw new Error('å­ç±»å¿…é¡»å®ç° loadData æ–¹æ³•');
    }

    /**
     * æ¸²æŸ“UIï¼ˆå­ç±»å®ç°ï¼‰
     */
    render() {
        throw new Error('å­ç±»å¿…é¡»å®ç° render æ–¹æ³•');
    }

    /**
     * ç»‘å®šäº‹ä»¶ï¼ˆå­ç±»å®ç°ï¼‰
     */
    bindEvents() {
        // å­ç±»å¯é€‰å®ç°
    }

    /**
     * å¸è½½æ¨¡å—
     */
    unmount() {
        if (this.container) {
            this.container.innerHTML = '';
            this.container = null;
        }
        this.data = null;
    }

    /**
     * åˆ·æ–°æ¨¡å—
     */
    async refresh() {
        await this.loadData();
        this.render();
    }
}

window.BaseModule = BaseModule;
```

---

### ç¤ºä¾‹ï¼šå®¢æˆ·èµ„æ–™æ¨¡å—

**æ–‡ä»¶**ï¼š`js/modules/customer-profile.js`

```javascript
/**
 * å®¢æˆ·èµ„æ–™æ¨¡å—
 */
class CustomerProfileModule extends BaseModule {
    constructor(options) {
        super(options);
        this.template = null;
        this.profile = null;
    }

    /**
     * åŠ è½½æ•°æ®
     */
    async loadData() {
        try {
            // åŠ è½½æ¨¡æ¿
            const templateResponse = await fetch('http://8.210.246.101:3000/api/customer-profile-templates');
            const templateResult = await templateResponse.json();

            if (templateResult.success && templateResult.data && templateResult.data.list) {
                this.template = templateResult.data.list.find(t =>
                    t.apply_scene === 'all' || t.template_name.includes('æ ‡å‡†')
                ) || templateResult.data.list[0];
            }

            // åŠ è½½å®¢æˆ·èµ„æ–™
            if (this.template) {
                const profileResponse = await fetch(
                    `http://8.210.246.101:3000/api/customer-profiles/customer/${this.customerId}/template/${this.template.id}`
                );
                const profileResult = await profileResponse.json();

                if (profileResult.success && profileResult.data) {
                    this.profile = profileResult.data;
                }
            }
        } catch (error) {
            console.error('åŠ è½½å®¢æˆ·èµ„æ–™æ•°æ®å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * æ¸²æŸ“UI
     */
    render() {
        if (!this.template) {
            this.container.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— æ¨¡æ¿é…ç½®</p>';
            return;
        }

        const fields = typeof this.template.fields === 'string'
            ? JSON.parse(this.template.fields)
            : this.template.fields;

        const savedData = this.profile?.profile_data || {};
        const profileData = typeof savedData === 'string' ? JSON.parse(savedData) : savedData;

        // æŒ‰åˆ†ç»„ç»„ç»‡å­—æ®µ
        const groupedFields = this._groupFields(fields);

        let html = `
            <div class="form-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        <i data-lucide="user" class="w-5 h-5 inline mr-2 text-purple-600"></i>
                        å®¢æˆ·è¯¦ç»†èµ„æ–™
                    </h3>
                    <span class="text-sm text-gray-500">
                        æ¨¡æ¿: ${this.template.template_name}
                    </span>
                </div>
                <form id="profileForm">
        `;

        // éå†æ¯ä¸ªåˆ†ç»„
        for (const [groupName, groupFields] of Object.entries(groupedFields)) {
            html += `
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 pb-2 border-b border-gray-200">
                        ${groupName}
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            groupFields.forEach(field => {
                html += this._renderField(field, profileData[field.field_key]);
            });

            html += `
                    </div>
                </div>
            `;
        }

        html += `
                <div class="mt-6 pt-6 border-t border-gray-200 flex justify-end">
                    <button type="button" id="saveProfileBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                        ä¿å­˜èµ„æ–™
                    </button>
                </div>
            </form>
        </div>
        `;

        this.container.innerHTML = html;
        lucide.createIcons();
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    bindEvents() {
        const saveBtn = this.container.querySelector('#saveProfileBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.saveProfile());
        }
    }

    /**
     * æŒ‰åˆ†ç»„ç»„ç»‡å­—æ®µ
     */
    _groupFields(fields) {
        const grouped = {};
        fields.forEach(field => {
            const group = field.group || 'åŸºæœ¬ä¿¡æ¯';
            if (!grouped[group]) {
                grouped[group] = [];
            }
            grouped[group].push(field);
        });
        return grouped;
    }

    /**
     * æ¸²æŸ“å•ä¸ªå­—æ®µ
     */
    _renderField(field, value) {
        // ... å­—æ®µæ¸²æŸ“é€»è¾‘ï¼ˆä¸åŸcustomerProfile.jsç›¸åŒï¼‰
    }

    /**
     * ä¿å­˜èµ„æ–™
     */
    async saveProfile() {
        // ... ä¿å­˜é€»è¾‘
    }
}

// å¯¼å‡ºåˆ°å…¨å±€
window.CustomerProfileModule = CustomerProfileModule;
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šå‡†å¤‡å·¥ä½œï¼ˆ1å¤©ï¼‰

**Step 1**: åˆ›å»ºç›®å½•ç»“æ„
```bash
mkdir js/modules
mkdir js/core
```

**Step 2**: åˆ›å»ºæ ¸å¿ƒæ–‡ä»¶
- [ ] åˆ›å»º `js/core/module-loader.js`
- [ ] åˆ›å»º `js/core/tab-manager.js`
- [ ] åˆ›å»º `js/modules/base-module.js`ï¼ˆå¯é€‰ï¼Œå®šä¹‰åŸºç±»ï¼‰

**Step 3**: å¤‡ä»½ç°æœ‰æ–‡ä»¶
```bash
cp customer-detail.html customer-detail.html.backup
```

---

### é˜¶æ®µäºŒï¼šæ¨¡å—æ‹†åˆ†ï¼ˆ3-5å¤©ï¼‰

**ä¼˜å…ˆçº§æ’åº**ï¼ˆå»ºè®®æŒ‰æ­¤é¡ºåºæ‹†åˆ†ï¼‰ï¼š

| ä¼˜å…ˆçº§ | æ¨¡å— | é¢„è®¡æ—¶é—´ | éš¾åº¦ |
|-------|------|---------|------|
| P0 | å®¢æˆ·èµ„æ–™ | 4å°æ—¶ | â­â­ |
| P0 | è®¢å•ç®¡ç† | 3å°æ—¶ | â­ |
| P1 | è¯Šæ–­ç®¡ç† | 6å°æ—¶ | â­â­â­ |
| P1 | æ–¹æ¡ˆç®¡ç† | 6å°æ—¶ | â­â­â­ |
| P2 | ä»»åŠ¡ç®¡ç† | 5å°æ—¶ | â­â­â­ |
| P2 | AIå¯¹è¯ | 4å°æ—¶ | â­â­ |

**Step 1**: æ‹†åˆ†å®¢æˆ·èµ„æ–™æ¨¡å—
- [ ] åˆ›å»º `js/modules/customer-profile.js`
- [ ] ä» `customer-detail.html` æå–ç›¸å…³ä»£ç 
- [ ] æµ‹è¯•ç‹¬ç«‹è¿è¡Œ
- [ ] é›†æˆåˆ°ä¸»é¡µé¢

**Step 2**: æ‹†åˆ†è®¢å•ç®¡ç†æ¨¡å—
- [ ] åˆ›å»º `js/modules/orders.js`
- [ ] æå–å¹¶é‡æ„ä»£ç 
- [ ] æµ‹è¯•å’Œé›†æˆ

**Step 3**: ä¾æ¬¡æ‹†åˆ†å…¶ä»–æ¨¡å—...

---

### é˜¶æ®µä¸‰ï¼šä¸»é¡µé¢é‡æ„ï¼ˆ1-2å¤©ï¼‰

**Step 1**: ç²¾ç®€ `customer-detail.html`
- [ ] ç§»é™¤æ‰€æœ‰Tabçš„HTMLå†…å®¹ï¼Œä¿ç•™ç©ºå®¹å™¨
- [ ] ç§»é™¤å†…è”JavaScriptä»£ç 
- [ ] å¼•å…¥æ ¸å¿ƒJSæ–‡ä»¶

```html
<!-- ç²¾ç®€åçš„customer-detail.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ... å¤´éƒ¨ä¿æŒä¸å˜ ... -->

    <!-- å¼•å…¥æ ¸å¿ƒæ¨¡å— -->
    <script src="js/core/module-loader.js"></script>
    <script src="js/core/tab-manager.js"></script>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav>...</nav>

    <!-- å®¢æˆ·åŸºæœ¬ä¿¡æ¯ -->
    <div class="customer-info-card">...</div>

    <!-- Tabå¯¼èˆª -->
    <div class="tabs-container">
        <button class="tab-btn active" data-tab="profile">å®¢æˆ·èµ„æ–™</button>
        <button class="tab-btn" data-tab="diagnosis">è¯Šæ–­ç®¡ç†</button>
        <button class="tab-btn" data-tab="plans">æ–¹æ¡ˆç®¡ç†</button>
        <button class="tab-btn" data-tab="orders">è®¢å•ç®¡ç†</button>
        <button class="tab-btn" data-tab="tasks">ä»»åŠ¡ç®¡ç†</button>
        <button class="tab-btn" data-tab="chat">AIå¯¹è¯</button>
    </div>

    <!-- Tabå†…å®¹åŒºåŸŸï¼ˆç©ºå®¹å™¨ï¼ŒåŠ¨æ€å¡«å……ï¼‰ -->
    <div class="tab-content active" id="profileTab"></div>
    <div class="tab-content" id="diagnosisTab"></div>
    <div class="tab-content" id="plansTab"></div>
    <div class="tab-content" id="ordersTab"></div>
    <div class="tab-content" id="tasksTab"></div>
    <div class="tab-content" id="chatTab"></div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
    <div class="mobile-bottom-nav">...</div>

    <script>
        // åˆå§‹åŒ–Tabç®¡ç†å™¨
        const customerId = new URLSearchParams(window.location.search).get('id') || 1;
        const tabManager = new TabManager({
            customerId: customerId,
            defaultTab: 'profile'
        });
        tabManager.init();
    </script>
</body>
</html>
```

---

### é˜¶æ®µå››ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰

**åŠŸèƒ½æµ‹è¯•**ï¼š
- [ ] æ¯ä¸ªTabèƒ½å¦æ­£å¸¸åˆ‡æ¢
- [ ] æ¨¡å—æ˜¯å¦æ­£ç¡®åŠ è½½
- [ ] æ•°æ®æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
- [ ] è¡¨å•æäº¤æ˜¯å¦æ­£å¸¸
- [ ] ç§»åŠ¨ç«¯é€‚é…æ˜¯å¦æ­£å¸¸

**æ€§èƒ½æµ‹è¯•**ï¼š
- [ ] é¦–å±åŠ è½½æ—¶é—´
- [ ] Tabåˆ‡æ¢æµç•…åº¦
- [ ] å†…å­˜å ç”¨æƒ…å†µ
- [ ] æ¨¡å—ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ

**å…¼å®¹æ€§æµ‹è¯•**ï¼š
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge
- [ ] ç§»åŠ¨ç«¯æµè§ˆå™¨

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### é‡æ„å‰ vs é‡æ„å

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æå‡ |
|-----|--------|--------|------|
| **customer-detail.htmlå¤§å°** | 1845è¡Œ | ~400è¡Œ | â†“ 78% |
| **å•ä¸ªæ¨¡å—æ–‡ä»¶å¤§å°** | N/A | 200-400è¡Œ | æ˜“äºç»´æŠ¤ |
| **é¦–å±åŠ è½½æ—¶é—´** | å…¨éƒ¨åŠ è½½ | ä»…åŠ è½½å½“å‰Tab | â†‘ 40-60% |
| **ä»£ç å¯ç»´æŠ¤æ€§** | â­â­ | â­â­â­â­â­ | å¤§å¹…æå‡ |
| **Bugå®šä½é€Ÿåº¦** | æ…¢ | å¿« | â†‘ 50%+ |
| **å¤šäººåä½œ** | å†²çªé¢‘ç¹ | ç‹¬ç«‹å¼€å‘ | å¤§å¹…æ”¹å–„ |

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒä¿æŒ

### æ— ç¼åˆ‡æ¢æ•ˆæœ

ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°ä»»ä½•å˜åŒ–ï¼š
- âœ… Tabåˆ‡æ¢åŠ¨ç”»ä¿æŒä¸€è‡´
- âœ… ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªä¿æŒä¸€è‡´
- âœ… åŠ è½½é€Ÿåº¦å®é™…æ›´å¿«
- âœ… æ‰€æœ‰åŠŸèƒ½å®Œå…¨ç›¸åŒ

### æ€§èƒ½æå‡

ç”¨æˆ·å®é™…ä½“éªŒæ”¹å–„ï¼š
- âœ… é¦–å±åŠ è½½æ›´å¿«ï¼ˆåªåŠ è½½å®¢æˆ·èµ„æ–™æ¨¡å—ï¼‰
- âœ… Tabåˆ‡æ¢æ›´æµç•…ï¼ˆæ¨¡å—å·²ç¼“å­˜ï¼‰
- âœ… å†…å­˜å ç”¨æ›´å°‘ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰

---

## ğŸ” å‘åå…¼å®¹

### æ¸è¿›å¼è¿ç§»

å¦‚æœæ‹…å¿ƒä¸€æ¬¡æ€§é‡æ„é£é™©å¤ªå¤§ï¼Œå¯ä»¥é‡‡ç”¨æ¸è¿›å¼è¿ç§»ï¼š

**æ–¹æ¡ˆ1ï¼šåŒç‰ˆæœ¬å¹¶è¡Œ**
```
customer-detail.htmlï¼ˆæ–°ç‰ˆæœ¬ - æ¨¡å—åŒ–ï¼‰
customer-detail-legacy.htmlï¼ˆæ—§ç‰ˆæœ¬ - å¤‡ä»½ï¼‰
```

**æ–¹æ¡ˆ2ï¼šç°åº¦å‘å¸ƒ**
```javascript
// æ ¹æ®URLå‚æ•°é€‰æ‹©ç‰ˆæœ¬
const useNewVersion = new URLSearchParams(window.location.search).get('v') === '2';
if (useNewVersion) {
    // ä½¿ç”¨æ–°çš„æ¨¡å—åŒ–æ¶æ„
} else {
    // ä½¿ç”¨æ—§çš„æ•´ä½“æ¶æ„
}
```

---

## ğŸ“‹ æŠ€æœ¯æ ˆè¯´æ˜

### ä½¿ç”¨çš„æŠ€æœ¯

- **ES6 Modules**ï¼šæ¨¡å—åŒ–å¼€å‘
- **Dynamic Import**ï¼šæŒ‰éœ€åŠ è½½
- **Classè¯­æ³•**ï¼šé¢å‘å¯¹è±¡è®¾è®¡
- **Promise/Async**ï¼šå¼‚æ­¥å¤„ç†
- **Event System**ï¼šæ¨¡å—é—´é€šä¿¡

### å…¼å®¹æ€§

- âœ… ç°ä»£æµè§ˆå™¨ï¼ˆChrome 61+, Firefox 60+, Safari 11+, Edge 16+ï¼‰
- âœ… æ”¯æŒç§»åŠ¨ç«¯
- âš ï¸ ä¸æ”¯æŒIE11ï¼ˆå¦‚éœ€æ”¯æŒéœ€è¦Babelè½¬è¯‘ï¼‰

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

é‡æ„æˆåŠŸçš„æ ‡å¿—ï¼š

1. âœ… æ‰€æœ‰6ä¸ªTabåŠŸèƒ½æ­£å¸¸
2. âœ… ç”¨æˆ·ä½“éªŒæ— å˜åŒ–
3. âœ… ä»£ç è¡Œæ•°å‡å°‘70%+
4. âœ… åŠ è½½æ€§èƒ½æå‡40%+
5. âœ… Bugä¿®å¤é€Ÿåº¦æå‡50%+
6. âœ… å›¢é˜Ÿå¼€å‘æ•ˆç‡æå‡
7. âœ… ä»£ç å®¡æŸ¥æ›´å®¹æ˜“

---

## ğŸš¨ é£é™©å’Œæ³¨æ„äº‹é¡¹

### æ½œåœ¨é£é™©

1. **æ¨¡å—ä¾èµ–é—®é¢˜**
   - é£é™©ï¼šæ¨¡å—é—´å¯èƒ½å­˜åœ¨éšæ€§ä¾èµ–
   - ç¼“è§£ï¼šæ˜ç¡®å®šä¹‰æ¨¡å—æ¥å£ï¼Œä½¿ç”¨äº‹ä»¶ç³»ç»Ÿé€šä¿¡

2. **æ€§èƒ½å›é€€**
   - é£é™©ï¼šåŠ¨æ€åŠ è½½å¯èƒ½å¯¼è‡´é¦–æ¬¡åˆ‡æ¢Tabå»¶è¿Ÿ
   - ç¼“è§£ï¼šå®ç°æ¨¡å—é¢„åŠ è½½ã€ç¼“å­˜ç­–ç•¥

3. **å…¼å®¹æ€§é—®é¢˜**
   - é£é™©ï¼šES6è¯­æ³•åœ¨è€æµè§ˆå™¨ä¸æ”¯æŒ
   - ç¼“è§£ï¼šä½¿ç”¨Babelè½¬è¯‘ï¼Œæˆ–æä¾›é™çº§æ–¹æ¡ˆ

4. **è°ƒè¯•å›°éš¾**
   - é£é™©ï¼šæ¨¡å—åŒ–åè°ƒè¯•é“¾è·¯å˜é•¿
   - ç¼“è§£ï¼šä¿ç•™Source Mapï¼Œä½¿ç”¨DevTools

### æœ€ä½³å®è·µ

1. **å……åˆ†æµ‹è¯•**ï¼šæ¯æ‹†åˆ†ä¸€ä¸ªæ¨¡å—å°±å®Œæ•´æµ‹è¯•ä¸€æ¬¡
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¯ä¸ªé‡è¦èŠ‚ç‚¹æäº¤Git
3. **æ–‡æ¡£åŒæ­¥**ï¼šåŠæ—¶æ›´æ–°å¼€å‘æ–‡æ¡£
4. **å›¢é˜Ÿæ²Ÿé€š**ï¼šç¡®ä¿æ‰€æœ‰äººç†è§£æ–°æ¶æ„

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ ] ã€Šæ¨¡å—å¼€å‘è§„èŒƒ.mdã€‹ï¼ˆå¾…ç¼–å†™ï¼‰
- [ ] ã€Šæ¨¡å—APIæ–‡æ¡£.mdã€‹ï¼ˆå¾…ç¼–å†™ï¼‰
- [ ] ã€Šé‡æ„æµ‹è¯•æŠ¥å‘Š.mdã€‹ï¼ˆé‡æ„å®Œæˆåç¼–å†™ï¼‰

---

## ğŸ‰ æ€»ç»“

è¿™ä¸ªæ¨¡å—åŒ–é‡æ„æ–¹æ¡ˆèƒ½å¤Ÿï¼š

1. **æ˜¾è‘—å‡å°‘æ–‡ä»¶å¤§å°**ï¼šä»1845è¡Œé™åˆ°400è¡Œï¼ˆ-78%ï¼‰
2. **æå‡å¼€å‘æ•ˆç‡**ï¼šç‹¬ç«‹å¼€å‘ã€æ˜“äºè°ƒè¯•
3. **æ”¹å–„æ€§èƒ½**ï¼šæŒ‰éœ€åŠ è½½ã€ç¼“å­˜æœºåˆ¶
4. **ä¿æŒç”¨æˆ·ä½“éªŒ**ï¼šTabåˆ‡æ¢æ•ˆæœå®Œå…¨ä¸€è‡´
5. **ä¾¿äºæ‰©å±•**ï¼šæ–°å¢æ¨¡å—åªéœ€æ·»åŠ æ–‡ä»¶

å»ºè®®é‡‡ç”¨æ¸è¿›å¼è¿ç§»ç­–ç•¥ï¼Œä¼˜å…ˆæ‹†åˆ†ç®€å•æ¨¡å—ï¼ˆå¦‚è®¢å•ç®¡ç†ï¼‰ï¼ŒéªŒè¯æ–¹æ¡ˆå¯è¡Œæ€§åå†æ‹†åˆ†å¤æ‚æ¨¡å—ï¼ˆå¦‚è¯Šæ–­ç®¡ç†ã€æ–¹æ¡ˆç®¡ç†ï¼‰ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-12-04
**åˆ›å»ºäºº**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
