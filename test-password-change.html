<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ä¿®æ”¹å¯†ç åŠŸèƒ½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/api.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">æµ‹è¯•ä¿®æ”¹å¯†ç åŠŸèƒ½</h1>

        <!-- æµ‹è¯•ä¿¡æ¯ -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
            <h2 class="font-bold text-blue-900 mb-2">æµ‹è¯•è¯´æ˜</h2>
            <p class="text-sm text-blue-800">æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®æ”¹å¯†ç åŠŸèƒ½çš„å„ä¸ªç¯èŠ‚ï¼š</p>
            <ul class="list-disc list-inside text-sm text-blue-800 mt-2 space-y-1">
                <li>æµ‹è¯•ç”¨æˆ·ID: 1 (ç”¨æˆ·å: admin)</li>
                <li>å½“å‰å¯†ç : 123456ï¼ˆé»˜è®¤å¯†ç ï¼‰</li>
                <li>æ–°å¯†ç : è¯·è‡ªå®šä¹‰æµ‹è¯•ï¼ˆå»ºè®®: newpass123ï¼‰</li>
            </ul>
        </div>

        <!-- ä¿®æ”¹å¯†ç è¡¨å• -->
        <form id="password-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·ID</label>
                <input type="number" id="user-id" value="1" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰å¯†ç </label>
                <input type="password" id="current-password" value="123456" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æ–°å¯†ç </label>
                <input type="password" id="new-password" required minlength="6"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç¡®è®¤æ–°å¯†ç </label>
                <input type="password" id="confirm-password" required minlength="6"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <button type="submit"
                class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                æµ‹è¯•ä¿®æ”¹å¯†ç 
            </button>
        </form>

        <!-- æµ‹è¯•ç»“æœ -->
        <div id="result" class="mt-6 hidden">
            <h3 class="font-bold mb-2">æµ‹è¯•ç»“æœ</h3>
            <pre id="result-content" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
        </div>

        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="mt-6">
            <h3 class="font-bold mb-2">æµ‹è¯•æ—¥å¿—</h3>
            <div id="log" class="bg-gray-50 p-4 rounded text-sm space-y-2 min-h-[100px]"></div>
        </div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            const color = colors[type] || colors.info;
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(data) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('result-content');
            resultDiv.classList.remove('hidden');
            resultContent.textContent = JSON.stringify(data, null, 2);
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('password-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = parseInt(document.getElementById('user-id').value);
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            log('å¼€å§‹æµ‹è¯•ä¿®æ”¹å¯†ç åŠŸèƒ½...', 'info');

            // å‰ç«¯éªŒè¯
            if (newPassword !== confirmPassword) {
                log('âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            if (newPassword.length < 6) {
                log('âŒ å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'error');
                alert('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½');
                return;
            }

            log(`ğŸ“ æµ‹è¯•å‚æ•°: ç”¨æˆ·ID=${userId}, å½“å‰å¯†ç =${currentPassword}, æ–°å¯†ç =${newPassword}`, 'info');

            try {
                log('ğŸ”Œ æ­£åœ¨è°ƒç”¨ userAPI.updatePassword()...', 'info');

                const result = await userAPI.updatePassword(userId, currentPassword, newPassword);

                log('ğŸ“¦ æ”¶åˆ°å“åº”:', 'info');
                showResult(result);

                if (result.success) {
                    log('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');
                    alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');

                    // æ›´æ–°è¡¨å•ä¸­çš„å½“å‰å¯†ç ä¸ºæ–°å¯†ç ï¼Œæ–¹ä¾¿ç»§ç»­æµ‹è¯•
                    document.getElementById('current-password').value = newPassword;
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    log(`âŒ å¯†ç ä¿®æ”¹å¤±è´¥: ${result.error?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    alert(`å¯†ç ä¿®æ”¹å¤±è´¥: ${result.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                showResult({ error: error.message, stack: error.stack });
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('DOMContentLoaded', function() {
            log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ“Œ APIåŸºç¡€URL: ' + (window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'ç›¸å¯¹è·¯å¾„'), 'info');
        });
    </script>
</body>
</html>
