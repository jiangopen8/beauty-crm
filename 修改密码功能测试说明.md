# 修改密码功能测试说明

## 测试准备

### 1. 测试用户信息
- **用户ID**: 1
- **用户名**: admin
- **真实姓名**: 系统管理员
- **默认密码**: password123（如果是初始化的测试用户）

### 2. 服务器状态
- 后端服务器运行在: http://localhost:3000
- 前端页面访问: http://localhost:3000/settings.html

## 测试步骤

### 步骤1: 访问设置页面
1. 打开浏览器访问: http://localhost:3000/settings.html
2. 点击顶部导航的"用户信息"标签页

### 步骤2: 打开修改密码对话框
1. 在"安全设置"卡片中，点击"修改密码"按钮
2. 应该弹出"修改密码"模态对话框

### 步骤3: 测试表单验证

#### 测试1: 空字段验证
- 不填写任何内容，直接点击"确认修改"
- **预期结果**: 提示"请填写所有必填字段"

#### 测试2: 密码长度验证
- 当前密码: password123
- 新密码: 123
- 确认新密码: 123
- **预期结果**: 提示"新密码长度至少为6位"

#### 测试3: 密码不匹配验证
- 当前密码: password123
- 新密码: newpass123
- 确认新密码: newpass456
- **预期结果**: 确认密码输入框下方显示红色提示"两次输入的密码不一致"

#### 测试4: 新旧密码相同验证
- 当前密码: password123
- 新密码: password123
- 确认新密码: password123
- **预期结果**: 提示"新密码不能与当前密码相同"

#### 测试5: 密码强度显示
- 在新密码输入框中输入密码时，观察密码强度指示器
- 测试不同强度的密码:
  - `123456` → 很弱（红色）
  - `abc123` → 弱（橙色）
  - `Abc123` → 中等（黄色）
  - `Abc12345` → 强（蓝色）
  - `Abc@123456` → 很强（绿色）

#### 测试6: 密码可见性切换
- 点击密码输入框右侧的眼睛图标
- **预期结果**: 密码从隐藏变为可见，图标从eye变为eye-off

### 步骤4: 测试实际修改密码

#### 测试7: 错误的当前密码
- 当前密码: wrongpassword
- 新密码: newpass123
- 确认新密码: newpass123
- **预期结果**: 提示"原密码错误"

#### 测试8: 成功修改密码
- 当前密码: password123（假设这是正确的密码）
- 新密码: NewPass@123
- 确认新密码: NewPass@123
- 点击"确认修改"
- **预期结果**:
  - 提示"密码修改成功，请使用新密码登录"
  - 模态对话框关闭
  - 密码已在数据库中更新

#### 测试9: 使用新密码再次修改
- 当前密码: NewPass@123
- 新密码: password123
- 确认新密码: password123
- **预期结果**: 成功修改回原密码

## 功能特性

### 1. 表单验证
- ✅ 所有字段必填验证
- ✅ 密码长度验证（至少6位）
- ✅ 两次密码一致性验证
- ✅ 新旧密码不能相同验证

### 2. 用户体验
- ✅ 密码强度实时显示
- ✅ 密码匹配状态实时提示
- ✅ 密码可见性切换
- ✅ 提交按钮防重复点击
- ✅ 友好的错误提示

### 3. 安全性
- ✅ 验证当前密码
- ✅ 密码在传输前加密（后端使用bcrypt）
- ✅ 密码强度建议

### 4. 界面设计
- ✅ 响应式模态对话框
- ✅ 清晰的表单布局
- ✅ 密码安全建议提示
- ✅ 图标和动画效果

## API接口

### 修改密码接口
- **URL**: `PATCH /api/users/:id/password`
- **请求体**:
  ```json
  {
    "old_password": "当前密码",
    "new_password": "新密码"
  }
  ```
- **成功响应**:
  ```json
  {
    "success": true,
    "message": "密码更新成功"
  }
  ```
- **失败响应**:
  ```json
  {
    "success": false,
    "error": {
      "code": "INVALID_PASSWORD",
      "message": "原密码错误"
    }
  }
  ```

## 注意事项

1. **用户ID**: 当前代码中使用固定的用户ID=1，实际应用中应从session/token获取
2. **密码要求**: 建议密码至少8位，包含大小写字母、数字和特殊字符
3. **密码加密**: 后端使用bcrypt进行密码加密存储
4. **登录重定向**: 如需修改密码后强制重新登录，取消代码中的注释

## 技术实现

### 前端
- **文件**: D:\work6\美业客户后台\settings.html
- **功能**:
  - 修改密码模态对话框UI
  - 表单验证逻辑
  - 密码强度计算
  - API调用
- **依赖**: js/api.js, js/utils.js

### 后端
- **路由文件**: D:\work6\美业客户后台\api\routes\users.js
- **模型文件**: D:\work6\美业客户后台\api\models\User.js
- **功能**:
  - 验证当前密码（bcrypt.compare）
  - 加密新密码（bcrypt.hash）
  - 更新数据库密码字段

## 数据库表结构
```sql
-- users表中的密码字段
password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值'
```

## 测试检查清单

- [ ] 页面加载正常，模态框可以打开和关闭
- [ ] 所有表单验证规则正常工作
- [ ] 密码强度指示器显示正确
- [ ] 密码匹配提示正确显示
- [ ] 密码可见性切换正常
- [ ] 错误的当前密码被正确拒绝
- [ ] 正确的密码修改成功
- [ ] 成功后模态框自动关闭
- [ ] 后端密码已加密存储
- [ ] 修改后可以用新密码登录（如果有登录功能）
