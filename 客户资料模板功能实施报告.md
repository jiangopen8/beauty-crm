# 客户资料模板功能实施报告

## 📋 项目概述

实现客户资料模板管理功能，允许灵活配置不同场景下的客户信息采集字段，通过JSON存储实现高度的可扩展性。

---

## ✅ 完成内容

### 1. 数据库层

#### 1.1 新建表：`customer_profile_templates`
- **字段数量**: 18个
- **核心字段**:
  - `fields` (JSON) - 字段定义配置
  - `field_groups` (JSON) - 字段分组配置
  - `scope` (ENUM) - 共享范围（global/org/private）
  - `apply_scene` (ENUM) - 适用场景
  - `usage_count` - 使用统计

#### 1.2 修改表：`customers`
- 新增字段 `profile_template_id` - 关联使用的模板
- 新增字段 `profile_data` (JSON) - 存储自定义字段数据

#### 1.3 初始化数据
- 创建默认模板"客户基础资料模板（标准版）"
- 包含5个预设字段：肤质类型、主要皮肤问题、过敏史、偏好服务时间、职业

---

### 2. 后端API层

#### 2.1 模型文件
- **文件**: `api/models/CustomerProfileTemplate.js`
- **方法**: 
  - `getList()` - 获取模板列表（支持筛选、分页）
  - `getById()` - 获取模板详情
  - `create()` - 创建模板
  - `update()` - 更新模板
  - `delete()` - 删除模板（软删除）
  - `duplicate()` - 复制模板
  - `incrementUsageCount()` - 增加使用次数
  - `getStats()` - 获取统计信息

#### 2.2 路由文件
- **文件**: `api/routes/customer-profile-templates.js`
- **端点**:
  ```
  GET    /api/customer-profile-templates           # 列表
  GET    /api/customer-profile-templates/:id       # 详情
  POST   /api/customer-profile-templates           # 创建
  PUT    /api/customer-profile-templates/:id       # 更新
  DELETE /api/customer-profile-templates/:id       # 删除
  POST   /api/customer-profile-templates/:id/duplicate  # 复制
  GET    /api/customer-profile-templates/stats     # 统计
  POST   /api/customer-profile-templates/:id/increment-usage  # 增加使用次数
  ```

#### 2.3 路由注册
- **文件**: `api/app.js` (第78行)
- 已注册路由: `app.use('/api/customer-profile-templates', ...)`

---

### 3. 前端UI层

#### 3.1 侧边栏菜单更新
- **更新页面**: 12个（所有主要页面）
- **菜单位置**: 系统管理 → 资料模板
- **图标**: file-edit
- **脚本**: `update-sidebars-unified.py`

#### 3.2 管理页面
- **文件**: `customer-profile-templates.html`
- **功能**:
  - 模板列表展示（卡片式）
  - 筛选：状态、范围、适用场景、搜索
  - 统计卡片：模板总数、启用中、全局模板、使用次数
  - 创建/编辑模板表单
  - 复制模板
  - 删除模板（保护默认模板）
  - 查看模板详情

---

## 📊 数据结构设计

### JSON字段配置示例

```json
{
  "field_key": "skin_type",
  "field_name": "肤质类型",
  "field_type": "select",
  "required": true,
  "options": ["干性", "油性", "混合性", "敏感性", "中性"],
  "default_value": "",
  "placeholder": "请选择肤质类型",
  "display_order": 1,
  "group": "皮肤信息",
  "validation": {
    "min": null,
    "max": null,
    "pattern": null
  },
  "help_text": "帮助您制定更精准的护理方案"
}
```

### 支持的字段类型
- `text` - 单行文本
- `textarea` - 多行文本
- `number` - 数字
- `select` - 下拉选择
- `radio` - 单选
- `checkbox` - 多选
- `date` - 日期
- `file` - 文件上传

---

## 🔍 与方案模板的对比

| 特性 | 方案模板 (solution_templates) | 客户资料模板 (customer_profile_templates) |
|------|------------------------------|------------------------------------------|
| **用途** | 护理方案标准化 | 客户信息采集配置 |
| **核心字段** | 疗程、频率、步骤、产品、服务 | 表单字段定义（JSON） |
| **category** | hydration/whitening/anti_aging等 | 无（使用apply_scene） |
| **apply_scene** | 无 | all/new_customer/vip_customer等 |
| **fields结构** | 包含steps/products/services | 统一的field配置数组 |
| **使用场景** | 生成护理方案 | 动态渲染客户资料表单 |

---

## 🚀 使用指南

### 1. 访问管理页面
```
http://localhost:3000/customer-profile-templates.html
```

### 2. 创建新模板
1. 点击右上角"新建模板"按钮
2. 填写模板名称、描述
3. 选择共享范围和适用场景
4. 配置字段（JSON格式）
5. 保存

### 3. 在客户管理中使用
```javascript
// 前端：获取模板
fetch('/api/customer-profile-templates/1')
  .then(res => res.json())
  .then(template => {
    // 根据template.fields动态渲染表单
    renderCustomerForm(template.fields);
  });

// 提交时保存到customers.profile_data
const customerData = {
  name: 'xxx',
  phone: 'xxx',
  profile_template_id: 1,
  profile_data: {
    skin_type: '混合性',
    skin_problems: ['毛孔粗大', '暗沉'],
    allergies: '对酒精过敏'
  }
};
```

---

## 📝 后续优化建议

### 1. 字段配置可视化编辑器
当前版本需要手动编写JSON，建议开发可视化字段编辑器：
- 拖拽式字段添加
- 可视化配置选项、验证规则
- 实时预览表单效果

### 2. 模板版本管理
- 支持模板版本历史
- 模板变更不影响已有客户数据
- 版本回滚功能

### 3. 字段映射与迁移
- 支持模板间字段映射
- 批量客户数据迁移工具

### 4. 权限控制
- 细粒度权限（查看/编辑/删除）
- 机构隔离（机构只能看到自己的模板）

### 5. 导入导出
- 模板导出为JSON文件
- 批量导入模板

---

## 🛠️ 技术栈

- **后端**: Node.js + Express
- **数据库**: MySQL 8.0 (JSON字段)
- **前端**: 原生JavaScript + Tailwind CSS
- **图标**: Lucide Icons

---

## 📌 注意事项

1. **JSON字段验证**: 前端需做好JSON格式验证，避免写入无效数据
2. **默认模板保护**: 系统默认模板不可删除（is_default=1）
3. **软删除机制**: 删除操作仅标记is_deleted=1，不物理删除
4. **机构隔离**: 当前版本org_id固定为1，需根据实际登录用户获取

---

**实施时间**: 2025-12-03  
**实施人**: Claude Code  
**状态**: ✅ 已完成
